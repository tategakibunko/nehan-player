/*!
 * 
 * nehan-player 0.1.1
 * License: MIT
 * Copyright (c) 2021, Watanabe Masaki
 *
 */
(()=>{"use strict";var e={6773:(e,t,s)=>{s.r(t),s.d(t,{NehanPlayer:()=>g});var i=s(7240);const r=32;function n(e){return"1x2"===e||"2x2"===e}function o(e,t){switch(e){case"1x1":return new i.PhysicalSize({width:t.width,height:t.height});case"1x2":return new i.PhysicalSize({width:(t.width-r-1)/2,height:t.height});case"2x1":return new i.PhysicalSize({width:t.width,height:(t.height-r-1)/2});case"2x2":return new i.PhysicalSize({width:(t.width-r-1)/2,height:(t.height-r-1)/2})}}class a{constructor(e,t,s,r,n,a,l,c,h,d=0,u=o(n,l),p=function(e){switch(e){case"1x1":return 1;case"1x2":case"2x1":return 2;case"2x2":return 4}}(n),g=function(e,t){const s=t.isVerticalRl();switch(e){case"1x1":return[1];case"1x2":return s?[3,1]:[1,3];case"2x1":return[1,2];case"2x2":return s?[3,4,1,2]:[1,2,3,4]}}(n,a),m=function(e,t,s,r){const n=s.getLogicalSize(r);let o={writingMode:r.value,measure:`${n.measure}px`,extent:`${n.extent}px`,fontSize:`${e}px`};return t&&(o.fontFamily=t),new i.CssStyleSheet({body:o,a:{color:"#d61111"}})}(c,h,u,a),f=s.getElementById("screen"),x=s.getElementById("page-no"),b=s.getElementById("page-count"),y=s.getElementById("goto-left"),v=s.getElementById("goto-right"),E=[s.getElementById("page-1"),s.getElementById("page-2"),s.getElementById("page-3"),s.getElementById("page-4")],S=s.getElementById("slider"),w=s.getElementById("slider-range"),C=s.getElementById("title"),k=s.getElementById("sub-title")){this.config=e,this.$host=t,this.$shadow=s,this.content=r,this.layout=n,this.nehanWritingMode=a,this.size=l,this.fontSize=c,this.fontFamily=h,this.pageIndex=d,this.pageSize=u,this.screenPageCount=p,this.pageOrder=g,this.nehanBodyStyle=m,this.$screen=f,this.$pageNo=x,this.$pageCount=b,this.$gotoLeft=y,this.$gotoRight=v,this.$pages=E,this.$slider=S,this.$sliderRange=w,this.$title=C,this.$subTitle=k;const B=this,R=[this.nehanBodyStyle].concat(e.onCreateNehanStyles?e.onCreateNehanStyles(this):[]);b.innerHTML="- -",this.reader=new i.PagedNehanDocument(this.content,{styleSheets:R}).render({onPage(t){t.page.index<=p-1&&B.gotoPage(0),e.onParsePage&&e.onParsePage(B,t.page.index)},onComplete(t){const s=B.getNombrePageCount(t.pageCount);b.innerHTML=String(s),w.setAttribute("max",String(s)),w.oninput=e=>{const t=parseInt(w.value||"0");B.gotoPage(t)},S.style.visibility="visible",e.onParseComplete&&e.onParseComplete(B,t.pageCount,t.time)}}),y.onclick=()=>{a.isVerticalRl()?this.gotoNextPage():this.gotoPrevPage()},v.onclick=()=>{a.isVerticalRl()?this.gotoPrevPage():this.gotoNextPage()},f.onclick=t=>{const s=f.getBoundingClientRect(),i=t.pageX-s.left-window.pageXOffset;t.pageY,s.top,window.pageYOffset,i<f.clientWidth/2&&e.onClickLeftPage?e.onClickLeftPage(B):e.onClickRightPage&&e.onClickRightPage(B)},e.onPlayerReady&&e.onPlayerReady(B)}get id(){return this.$host.id}get src(){return this.$host.getAttribute("src")||""}get width(){return this.size.width}get height(){return this.size.height}get writingMode(){return this.nehanWritingMode.value}get currentPageIndex(){return this.pageIndex}set currentPageIndex(e){this.gotoPage(e)}get currentSection(){return this.reader.getSectionAt(this.pageIndex)}get pageCount(){return this.reader.pageCount}setTitle(e){this.$title.innerHTML=e}setSubTitle(e){this.$subTitle.innerHTML=e}createOutline(e){return this.reader.createOutline(new i.LayoutOutlineEvaluator((t=>{const s=document.createElement("a");return s.innerHTML=t.header?t.header.innerHTML:t.title,s.href="#"+t.pageIndex,e&&(s.onclick=s=>(s.preventDefault(),e(t),!1)),s})))}refresh(e=!1){this.$host.refresh(e)}update(e){this.$host.update(e)}gotoLeftPage(){this.nehanWritingMode.isVerticalRl()?this.gotoNextPage():this.gotoPrevPage()}gotoRightPage(){this.nehanWritingMode.isVerticalRl()?this.gotoPrevPage():this.gotoNextPage()}gotoNextPage(){const e=this.pageIndex+this.screenPageCount;e>=this.pageCount||this.gotoPage(e)}gotoPrevPage(){const e=Math.max(0,this.pageIndex-this.screenPageCount);e!==this.pageIndex&&this.gotoPage(e)}getNombrePageNo(e){return Math.ceil((e+1)/this.screenPageCount)}getNombrePageCount(e){return Math.ceil(e/this.screenPageCount)}gotoPage(e){if(e<0||e>=this.pageCount)return;const t=this,s=this.getNombrePageNo(e);this.pageIndex=e,this.$sliderRange.value=String(s),this.$pageNo.innerHTML=String(s),this.$pages.forEach((e=>{e.firstChild&&e.removeChild(e.firstChild)})),this.pageOrder.forEach(((s,i)=>{const r=e+i;if(r>=this.reader.pageCount)return;const n=this.reader.getPage(r),o=this.$pages[s-1];n&&n.dom&&(o.appendChild(n.dom),this.config.onSetPage&&this.config.onSetPage(t,n))}))}}var l=function(e,t,s,i){return new(s||(s=Promise))((function(r,n){function o(e){try{l(i.next(e))}catch(e){n(e)}}function a(e){try{l(i.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))};const c="theme-css";let h={},d={cssFiles:[],onFetchContent:(e,t)=>t,onClickLeftPage(e){e.gotoLeftPage()},onClickRightPage(e){e.gotoRightPage()}};function u(){Object.values(h).forEach((e=>e.refresh(!0)))}function p(e,t,s){return Math.max(t,Math.min(s,e))}class g extends HTMLElement{constructor(){super(),this.src="",this.html="",this.$shadow=this.attachShadow({mode:"open"}),this.getAttribute("id")||(this.id=`player-${(new Date).getTime()}`)}static initialize(e){e&&(d=Object.assign(Object.assign({},d),e)),customElements.define("nehan-player",g)}static get observedAttributes(){return["class"]}connectedCallback(){this.render()}attributeChangedCallback(e,t,s){return l(this,void 0,void 0,(function*(){"class"===e&&this.classList.contains("update")&&(yield this.render(),this.classList.remove("update"))}))}update(e){let t=!1;if(e.theme&&1===Object.keys(e).length){const t=this.$shadow.getElementById(c),s=this.createCssLink(e.theme,!0),i=this.$shadow.firstElementChild;return t?this.$shadow.replaceChild(s,t):i?this.$shadow.insertBefore(s,i):this.$shadow.appendChild(s),void this.setAttribute("theme",e.theme)}for(const[s,r]of Object.entries(e)){const e=i.Utils.String.camelToChain(s),n=this.getAttribute(e)||"";r!==n&&("width"===s&&"responsive"===n&&delete h[this.id],this.setAttribute(e,r),t=!0)}t&&this.refresh(!1)}createCssLink(e,t=!1){const s=document.createElement("link");return t&&(s.id=c),s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.setAttribute("href",e),s}refresh(e){const t=(new Date).getTime();e&&this.lastUpdate&&t-this.lastUpdate<200||(this.lastUpdate=t,this.classList.add("update"))}parseWidth(){const e=this.getAttribute("width")||"responsive";if(!e)throw new Error("System Error: width can't be resolved!");return"responsive"===e?this.parentElement?this.parentElement.clientWidth:this.clientWidth:"number"==typeof e?e:parseInt(e)}render(){var e;return l(this,void 0,void 0,(function*(){const t=this.getAttribute("src")||"",s=this.getAttribute("theme")||"",r=Math.max(this.parseWidth(),300),l=Math.max(parseInt(this.getAttribute("height")||String(450)),300);let c=this.getAttribute("layout")||"1x1";n(c)&&r<600&&(c=function(e){return"1x2"===e?"1x1":"2x2"===e?"2x1":e}(c)),function(e){return"2x1"===e||"2x2"===e}(c)&&l<500&&(c=function(e){return"2x1"===e?"1x1":"2x2"===e?"1x2":e}(c));const g=p(parseFloat(this.getAttribute("line-height")||String(2)),1.5,2),m=p(parseInt(this.getAttribute("font-size")||String(16)),10,48),f=this.getAttribute("font-family")||"",x=Math.min(parseInt(this.getAttribute("border-size")||String(1)),20),b=this.getAttribute("writing-mode")||"horizontal-tb",y=new i.WritingMode(b),v=new i.PhysicalSize({width:r,height:l}),E=function(e,t,s,i,r,o){if(e.isTextHorizontal())return i;const a=i*r,l=2*i;let c=s.width-l-2*o;n(t)&&(c-=33);const h=Math.floor(c/a);return i+Math.floor((c-a*h)/2)}(y,c,v,m,g,x),S=function(e,t,s,i,r,n){return 1.5*i}(0,0,0,m),w=function(e,t,s,r,n){return new i.PhysicalSize({width:e.width-2*s-2*n,height:e.height-48-r})}(v,0,E,S,x);this.$shadow.innerHTML="";const C=document.createElement("style"),k=document.createElement("style");if(C.textContent=function(e,t,s,i,r,n){const o=e.isVerticalRl()?"rtl":"ltr";return`\n  .player {\n    margin-bottom: 2em;\n    overflow: hidden;\n  }\n  .screen-wrap {\n    background: wheat;\n    border-width: ${n}px ${n}px 0 ${n}px;\n  }\n  #screen-header {\n    position: relative;\n    font-size: 12px;\n    top: 32px;\n    left: 32px;\n    width: ${t.width}px;\n    white-space: nowrap;\n  }\n  #title {\n    color: rgba(80,80,80, 0.8);\n  }\n  #sub-title {\n    color: rgba(80,80,80, 0.8);\n  }\n  #screen{\n    width: ${t.width}px;\n    height: ${t.height}px;\n    padding: 48px ${i}px ${r}px;\n  }\n  #screen-footer {\n    padding-bottom: 16px;\n  }\n  #menu {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    gap: 10px;\n    margin-top: 0;\n    width: ${t.width}px;\n    color: white;\n    font-size: 14px;\n    background: #3c3c4e;\n    padding: 10px ${i}px;\n    border-width: 0 ${n}px ${n}px ${n}px;\n  }\n  #slider {\n    margin-top: 10px;\n    visibility: hidden; /* hide until onCompletePage is called. */\n    width: ${t.width}px;\n    padding: 0 ${i}px;\n  }\n  #slider input[type="range"] {\n    width: ${t.width}px;\n  }\n  #footer {\n    width: ${t.width}px;\n    padding: 0 32px;\n    text-align: right;\n    font-size: 0.82em;\n  }\n  #direct-content {\n    visibility: hidden;\n  }\n  input[type="range"] {\n    direction: ${o};\n  }\n  .nehan-line a {\n    color:#d61111;\n  }\n  .pager {\n    flex-basis: 100px;\n    padding: 4px 0px;\n  }\n  .nombre {\n    font-size: 0.92em;\n    text-align: center;\n    flex-basis: 150px;\n  }\n  .vline {\n    border-left: 1px dotted #7a7a7a;\n  }\n  .hline {\n    border-bottom: 1px dotted #7a7a7a;\n  }\n  `}(y,w,0,E,S,x),k.textContent=function(e,t){const s=o(e,t);switch(e){case"1x1":return"\n      #page-2, #page-3, #page-4, .vline, .hline {\n        display:none;\n      }\n      ";case"1x2":return`\n      #screen {\n        display: grid;\n        grid-template-rows: 100%;\n        grid-template-columns: ${s.width}px 1px ${s.width}px;\n        gap: 0 16px; /* vline makes 2*gapSize, so we use half for colGap. */\n      }\n      #page-1 {\n        grid-row: 1/2;\n        grid-column: 1/2;\n      }\n      .vline {\n        grid-row: 1/3;\n        grid-column: 2/3;\n      }\n      #page-3 {\n        grid-row: 1/2;\n        grid-column: 3/4;\n      }\n      #page-2, #page-4, .hline {\n        display: none;\n      }\n      `;case"2x1":return`\n      #screen {\n        display: grid;\n        grid-template-rows: ${s.height}px 1px ${s.height}px;\n        grid-template-columns: 100%;\n        gap: 16px 0px; /* hline makes 2*gapSize, so we use halt for rowGap. */\n      }\n      #page-1 {\n        grid-row: 1/2;\n        grid-column: 1/2;\n      }\n      #hline-12 {\n        grid-row: 2/3;\n        grid-column: 1/2;\n      }\n      #page-2 {\n        grid-row: 3/4;\n        grid-column: 1/2;\n      }\n      #page-3, #page-4, #hline-34, .vline {\n        display: none;\n      }\n      `;case"2x2":return`\n      #screen {\n        display: grid;\n        grid-template-rows: ${s.height}px 1px ${s.height}px;\n        grid-template-columns: ${s.width}px 1px ${s.width}px;\n        gap: 16px; /* vline and hline make 2*gapSize so we use half gap size */\n      }\n      #page-1 {\n        grid-row: 1/2;\n        grid-column: 1/2;\n      }\n      #hline-12 {\n        grid-row: 2/3;\n        grid-column: 1/2;\n      }\n      #page-2 {\n        grid-row: 3/4;\n        grid-column: 1/2;\n      }\n      .vline {\n        grid-row: 1/4;\n        grid-column: 2/3;\n      }\n      #page-3 {\n        grid-row: 1/2;\n        grid-column: 3/4;\n      }\n      #hline-34 {\n        grid-row: 2/3;\n        grid-column: 3/4;\n      }\n      #page-4 {\n        grid-row: 3/4;\n        grid-column: 3/4;\n      }\n      `}}(c,w),this.$shadow.appendChild(C),this.$shadow.appendChild(k),s){const e=this.createCssLink(s,!0);this.$shadow.appendChild(e)}(d.cssFiles||[]).forEach((e=>{const t=this.createCssLink(e,!1);this.$shadow.appendChild(t)}));const B=d.cssText||"";if(B){const e=document.createElement("style");e.innerHTML=B,this.$shadow.appendChild(e)}const R=document.createElement("template");R.innerHTML='\n    <div class="player">\n      <div class="screen-wrap">\n        <div id="screen-header">\n          <span id="title"><slot name="title"></slot></span>\n          <span id="sub-title"><slot name="sub-title"></slot></span>\n        </div>\n        <div id="screen">\n          <div class="page" id="page-1"></div>\n          <div class="hline" id="hline-12"></div>\n          <div class="page" id="page-2"></div>\n          <div class="vline"></div>\n          <div class="page" id="page-3"></div>\n          <div class="hline" id="hline-34"></div>\n          <div class="page" id="page-4"></div>\n        </div>\n        <div id="screen-footer">\n          <div class="nombre">\n            <span id="page-no"></span>\n            <span id="separator">/</span>\n            <span id="page-count"></span>\n          </div>\n        </div>\n      </div>\n      <menu id="menu">\n        <button class="pager" id="goto-left">\n          <slot name="goto-left-label">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M9.78 12.78a.75.75 0 01-1.06 0L4.47 8.53a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L6.06 8l3.72 3.72a.75.75 0 010 1.06z"></path></svg>\n          </slot>\n        </button>\n        <button class="pager" id="goto-right">\n          <slot name="goto-right-label">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M6.22 3.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 010-1.06z"></path></svg>\n          </slot>\n        </button>\n      </menu>\n      <div id="slider">\n        <input id="slider-range" type="range" min="1" max="1" step="1" value="0">\n      </div>\n      <footer id="footer"><slot name="footer"></slot></footer>\n      <div id="direct-content"><slot name="content"></slot></div>\n    </div>',this.$shadow.appendChild(R.content.cloneNode(!0));const T=(null===(e=this.$shadow.host.querySelector("div[slot='content']"))||void 0===e?void 0:e.innerHTML)||"";""!==T?this.html=d.onFetchContent?d.onFetchContent("content.slot",T):T:t?t===this.src&&this.html||(this.src=t,this.html=yield fetch(this.src).then((e=>e.ok?e.text():`Failed to load ${t}`)).then((e=>d.onFetchContent?d.onFetchContent(t,e):e))):this.html="Can't resolve content. Neither 'content' slot or 'src' attribute is specified!";const N=new a(d,this,this.$shadow,this.html,c,y,w,m,f);"responsive"===this.getAttribute("width")&&(0===Object.entries(h).length&&window.addEventListener("resize",u),h[this.id]=N)}))}}},7240:(e,t,s)=>{var i,r;s.d(t,{CssStyleSheet:()=>q,LayoutOutlineEvaluator:()=>ts,PagedNehanDocument:()=>Ii,PhysicalSize:()=>Nt,Utils:()=>r,WritingMode:()=>es}),function(e){e.lang="ja",e.engineVersion=7,e.pageRootTagName="body",e.normalizeHtml=e=>e.replace(/\r/g,"").replace(/<rp>(.*?)<\/rp>/gi,"").replace(/<!--[\s\S]*?-->/g,"").replace(/\u2015{2}/g,"——").replace(/\s+$/,"").replace(/(?:<page-break>)|(?:<pbr>)/g,"<hr style='border-width:0px; margin:0; page-break-after: always'>"),e.maxPageCount=2e3,e.maxJustifyGap=1,e.ignoreEmptyLine=!1,e.ignoreEmptyInline=!1,e.ignoreZeroRe=!0,e.debugImageLoader=!1,e.debugCharacter=!1,e.debugLayout=!1,e.useStrictFormatContextName=!1,e.defaultFontSize=16,e.defaultFontFamily=["'ヒラギノ明朝 Pro W3'","'Hiragino Mincho Pro'","'HiraMinProN-W3'","'Meiryo'","'メイリオ'","'IPA明朝'","'IPA Mincho'","'ＭＳ 明朝'","'MS Mincho'","monospace"].join(","),e.defaultFont=[e.defaultFontSize+"px",e.defaultFontFamily].join(" "),e.defaultBodyMeasure=640,e.defaultBodyExtent=480,e.defaultLineHeight=2,e.defaultBorderColor="transparent",e.defaultTableBorderColor="rgba(0,0,0,0.4)",e.defaultFloatMeasure=100,e.defaultInlineBlockMeasure=200,e.nonOmitWhiteSpaces=["　"],e.unmanagedCssProps=["background","background-image","background-color","background-position","text-decoration","z-index"],e.nonLayoutTags=["br"],e.fontSizeOnlyTags=["b","br","em","rb","rt","rp","ruby","strong"],e.edgeSkipTags=["rb","rt","rp","ruby"],e.boxSizeSkipTags=["b","em","rb","rt","rp","ruby","strong"],e.ignoredTags=["script","noscript","meta"],e.IgnoredInlineStyleProps=[],e.rexWord=/^[\u0021-\u007E\u00C0-\u02A8\u2000-\u206F\uFB00-\uFB06]+/,e.rexRefChar=/^&[\S]+?;/,e.isTcyWord=(e,t)=>!1,e.rexHalfChar=/^[\uFF66-\uFF69\uFF71-\uFF9D][\uFF9E-\uFF9F]?/,e.rexSpace=/^[ \f\n\r\t\v\u00A0\u1680\u180e\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]/,e.rexSpaceCharRef=/^&(nb|en|em|thin)sp;/,e.rexVoicedMark=/^[\u3099-\u309C]/}(i||(i={})),function(e){e.atoi=(e,t=0)=>{const s=parseInt(e,10);return isNaN(s)?(i.debugLayout&&console.warn(`${e} is not a number, so use ${t}`),t):s},e.isNumber=e=>!1===isNaN(Number(e)),e.mergeDefault=(e,t)=>Object.assign(Object.assign({},t),e);class t{static fromArray(e){return e.reduce(((e,t)=>(e[t]=t,e)),Object.create(null))}static toObjArray(e){return Object.keys(e).map((t=>({id:e[t],name:t})))}static toValueArray(e){return Object.keys(e).map((t=>e[t]))}static member(e,s){return t.toValueArray(e).indexOf(s)>=0}}e.Enum=t,e.Choice=class{static select(e){return e.values.indexOf(e.value)>=0?e.value:e.initial}},e.String=class{static getUnicodeProp(e){let t=e.charCodeAt(0).toString(16).toUpperCase();switch(t.length){case 0:return"U+0000";case 1:return"U+000"+t;case 2:return"U+00"+t;case 3:return"U+0"+t}return"U+"+t}static multiSpaceToSingle(e){return e.replace(/\s+/g," ")}static multiSpaceToSingle2(e){return e.replace(/[\u0020\f\n\r\t\v\u00A0\u1680\u180e\u2000-\u200A\u2028\u2029\u202F\u205F\uFEFF]+/gm," ")}static capitalize(e){return""===e?"":e.charAt(0).toUpperCase()+e.slice(1)}static camelToChain(e){return e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase()))}static chainToCamel(e){return e.indexOf("-")<0?e:e.split("-").map(((e,t)=>0===t?e:this.capitalize(e))).join("")}}}(r||(r={}));class n{constructor(e){this.text=e,this.size=new St({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size,this.empha=e.empha,e.empha&&(this.size.extent=2*e.font.size)}toString(){return this.text}acceptEvaluator(e){return this.empha?e.visitCharEmpha(this,this.empha):e.visitChar(this)}}const o={parenType:"open",kinsokuPos:"tail",kernEnable:!0,hangEnable:!1,rotatable:!1,isSmall:!1},a={parenType:"open",kinsokuPos:"tail",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!0},l={parenType:"close",kinsokuPos:"head",kernEnable:!0,hangEnable:!0,rotatable:!1,isSmall:!1},c={parenType:"close",kinsokuPos:"head",kernEnable:!1,hangEnable:!0,rotatable:!1,isSmall:!0},h={parenType:"none",kinsokuPos:"head",kernEnable:!0,hangEnable:!0,rotatable:!1,isSmall:!1},d={parenType:"none",kinsokuPos:"head",kernEnable:!1,hangEnable:!0,rotatable:!1,isSmall:!0},u={parenType:"none",kinsokuPos:"none",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!1},p={parenType:"none",kinsokuPos:"head",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!0},g={parenType:"none",kinsokuPos:"none",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!1},m={"U+0028":a,"U+0029":c,"U+002C":d,"U+002D":u,"U+002E":d,"U+003A":d,"U+003D":g,"U+005B":a,"U+005D":c,"U+007B":a,"U+007D":c,"U+00AB":a,"U+00BB":c,"U+2014":u,"U+2015":u,"U+201C":a,"U+201D":c,"U+2025":u,"U+2026":u,"U+2190":g,"U+2191":g,"U+2192":g,"U+2193":g,"U+21D2":g,"U+2212":u,"U+2252":g,"U+2260":g,"U+226A":o,"U+226B":l,"U+22EF":u,"U+2500":u,"U+2772":o,"U+2773":l,"U+3001":h,"U+3002":h,"U+3008":o,"U+3009":l,"U+300A":o,"U+300B":l,"U+300C":o,"U+300D":l,"U+300E":o,"U+300F":l,"U+3010":o,"U+3011":l,"U+3014":o,"U+3015":l,"U+3016":o,"U+3017":l,"U+3018":o,"U+3019":l,"U+301A":o,"U+301B":l,"U+301C":u,"U+301D":o,"U+301E":l,"U+301F":l,"U+3041":p,"U+3043":p,"U+3045":p,"U+3047":p,"U+3049":p,"U+3063":p,"U+3083":p,"U+3085":p,"U+3087":p,"U+308E":p,"U+30A1":p,"U+30A3":p,"U+30A5":p,"U+30A7":p,"U+30A9":p,"U+30C3":p,"U+30E3":p,"U+30E5":p,"U+30E7":p,"U+30EE":p,"U+30F5":p,"U+30F6":p,"U+30FC":u,"U+FF08":o,"U+FF09":l,"U+FF0C":h,"U+FF0D":u,"U+FF0E":h,"U+FF1A":{parenType:"none",kinsokuPos:"none",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!1},"U+FF1C":o,"U+FF1D":g,"U+FF1E":g,"U+FF3B":o,"U+FF3D":l,"U+FF3F":u,"U+FF5B":o,"U+FF5C":u,"U+FF5D":l,"U+FF5E":u,"U+FF61":d,"U+FF62":a,"U+FF63":c,"U+FF64":h,"U+FF70":u};class f{constructor(e,t){this.text=e,this.size=new St({measure:0,extent:0}),this.info=t,this.kerning=!1,this.spacing=0,this.charCount=1}isParen(){return this.isOpenParen()||this.isCloseParen()}isOpenParen(){return"open"===this.info.parenType}isCloseParen(){return"close"===this.info.parenType}isTailNg(){return"tail"===this.info.kinsokuPos}isHeadNg(){return"head"===this.info.kinsokuPos}isKernEnable(){return this.info.kernEnable}isHangEnable(){return this.info.hangEnable}isSmall(){return this.info.isSmall}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size,this.kerning&&this.isKernEnable()&&(this.size.measure=Math.floor(e.font.size/2))}setKerning(e,t){this.info.kernEnable?this.kerning=t:console.warn("kerning is not allowed for this character:",this)}toString(){return this.text}acceptEvaluator(e){return this.kerning?e.visitDualCharKern(this):e.visitDualChar(this)}}class x{constructor(e){this.text=e,this.size=new St({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.isVertical?e.font.size:Math.floor(e.font.size/2),this.size.extent=e.font.size,this.empha=e.empha,e.empha&&(this.size.extent=2*e.font.size)}toString(){return this.text}acceptEvaluator(e){return e.visitHalfChar(this)}}class b{constructor(e){this.text=e,this.size=new St({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size}toString(){return this.text}acceptEvaluator(e){return this.empha?e.visitRefCharEmpha(this,this.empha):e.visitRefChar(this)}}b.softHyphen="&shy;";class y{constructor(e){this.text=e,this.size=new St({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size,this.empha=e.empha,e.empha&&(this.size.extent=Math.floor(1.5*e.font.size))}toString(){return this.text}acceptEvaluator(e){return e.visitSmpUniChar(this)}}let v=e=>({advanceRate:e,isNoBreak:!1,isControl:!1}),E={advanceRate:0,isNoBreak:!1,isControl:!1},S={advanceRate:0,isNoBreak:!1,isControl:!0},w=v(1),C=v(.5),k={"U+0009":C,"U+000A":S,"U+000B":S,"U+000C":S,"U+000D":S,"U+001C":C,"U+001D":C,"U+001E":C,"U+001F":C,"U+0020":C,"U+00A0":{advanceRate:.38,isNoBreak:!0,isControl:!1},"U+034F":E,"U+1680":C,"U+180E":C,"U+2000":C,"U+2001":w,"U+2002":C,"U+2003":w,"U+2004":v(1/3),"U+2005":v(1/4),"U+2006":v(1/6),"U+2007":C,"U+2008":C,"U+2009":v(.2),"U+200A":v(.1),"U+200B":E,"U+200C":E,"U+200D":E,"U+200E":E,"U+200F":E,"U+2028":S,"U+2029":S,"U+202A":S,"U+202B":S,"U+202C":S,"U+202D":S,"U+202E":S,"U+202F":{advanceRate:.33,isNoBreak:!0,isControl:!1},"U+2061":S,"U+2062":S,"U+2063":S,"U+3000":w,"U+FEFE":{advanceRate:0,isNoBreak:!0,isControl:!1}};class B{constructor(e){this.text=this.normalize(e),this.size=new St({measure:0,extent:0}),this.info=class{static load(e){let t=r.String.getUnicodeProp(e),s=k[t];if(!s)throw new Error("SpaceChar("+t+") not exists.");return s}}.load(e),this.kerning=!1,this.spacing=0,this.charCount=0}static charRefToStr(e){switch(e){case"&nbsp;":return" ";case"&thinsp;":return" ";case"&ensp;":return" ";case"&emsp;":return" "}throw new Error("invalid space char ref("+e+")")}normalize(e){return 0===e.indexOf("&")?B.charRefToStr(e):e}getCssVert(){let e=new kt;return e.set("height",this.size.measure+"px"),e}setMetrics(e){this.size=L.getWordSize(e.font,this.text),0===this.size.measure&&(this.size.measure=this.size.extent*this.info.advanceRate)}toString(){return this.text}isNoBreak(){return this.info.isNoBreak}isZeroWidth(){return 0===this.info.advanceRate}isCarriageReturn(){return"\r"===this.text}isLineFeed(){return"\n"===this.text}acceptEvaluator(e){return e.visitSpaceChar(this)}}B.zeroWidthSpace="​",B.enSpace=" ",B.emSpace=" ",B.noBreakSpace=" ",B.ideographicSpace="　",B.markerSpace=B.enSpace;class R{constructor(e){this.text=e,this.size=new St({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=e.length}setMetrics(e){e.isVertical?(this.size.measure=e.font.size,this.size.extent=e.font.size):this.size=L.getWordSize(e.font,this.text)}toString(){return this.text}acceptEvaluator(e){return e.visitTcy(this)}}class T{static isEnabled(){return null!==this.offCanvasCtx}getMeasure(e,t){const s=T.offCanvasCtx;return s?(s.font=t.css,s.measureText(e).width):0}}T.offCanvasCtx="undefined"==typeof OffscreenCanvas?null:new OffscreenCanvas(0,0).getContext("2d");class N{static isEnabled(){return null!==this.canvasCtx}getMeasure(e,t){const s=N.canvasCtx;return s?(s.font=t.css,s.measureText(e).width):0}}N.canvasCtx=function(){const e=document.createElement("canvas");return e.style.display="hidden",e.style.width=e.style.height="0",document.body&&document.body.appendChild(e),e.getContext("2d")}();class P{getMeasure(e,t){const s=P.node;if(!s)return 0;s.style.font=t.css,s.innerHTML=e,document.body.appendChild(s);const i=s.getBoundingClientRect();return document.body.removeChild(s),i.width}}P.node=function(){const e=document.createElement("span"),t=e.style;return t.display="inline",t.margin="0",t.padding="0",t.borderWidth="0",t.lineHeight="1",t.width="auto",t.height="auto",t.visibility="hidden",e}();const z=T.isEnabled()?new T:N.isEnabled()?new N:new P;class L{static getWordSize(e,t){const s=z.getMeasure(t,e),i=e.size;return new St({measure:s,extent:i})}}class M{constructor(e){this.text=e,this.size=new St({measure:0,extent:0}),this.kerning=!1,this.spacing=0}get charCount(){return this.text.length}toString(){return this.text}setMetrics(e){this.size=L.getWordSize(e.font,this.text)}toTcys(){return this.text.split("").map((e=>new R(e)))}breakWord(e){const t=Math.floor(this.text.length*e/this.size.measure),s=this.text.substring(0,t),i=this.text.substring(t);return this.text=i,new M(s)}restoreBrokenWord(e){this.text=e.text+this.text}acceptEvaluator(e){return e.visitWord(this)}}class I{constructor(e){this.text=e,this.size=new St({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){e.isVertical?this.size.measure=e.font.size:this.size.measure=Math.floor(1.25*e.font.size),this.size.extent=e.font.size}toString(){return this.text}acceptEvaluator(e){return e.visitMixChar(this)}}class A{visit(e){return e.reduce(((e,t)=>t instanceof M?e.concat(t.toTcys()):e.concat(t)),[])}}class V{visit(e){return e.map(((t,s)=>{if(t instanceof M==0)return t;const r=e[s-1],n=e[s+1];return i.isTcyWord(t.text,{prev:r,next:n})?new R(t.text):t}))}}class F{constructor(e,t={}){this.src=this.normalize(e,t),this.buff=this.src,this.pos=0,this.tokens=[],this.setupTokens(t)}acceptTokenMapper(e){this.tokens=e.visit(this.tokens)}normalize(e,t={}){return e}stepBuff(e){this.buff=this.buff.substring(e)}getChar(){let e=this.peekChar();return this.stepBuff(1),e}peekChar(){return this.buff.substring(0,1)}get progress(){return 0===this.tokens.length?1:this.pos/this.tokens.length}hasNext(){return this.pos<this.tokens.length}getNext(){return this.tokens[this.pos++]}setupTokens(e){for(;this.hasNextBuff();)this.addToken(this.createToken(e));return this.tokens}addToken(e){this.tokens.push(e)}createToken(e){throw new Error("BufferedLexer.createToken must be overrided")}hasNextBuff(){return""!==this.buff}peek(e=0){return this.tokens[this.pos+e]}pushBack(e){this.pos=Math.max(0,this.pos-Math.abs(e))}}class O{constructor(){this.specificity=new Ht(0,0,0)}test(e){return!1}}class U{constructor(e){this.value=e}static load(e){const t=Ne.getValue(e,"box-sizing");return new U(t)}isContentBox(){return"content-box"===this.value}isPaddingBox(){return"padding-box"===this.value}isBorderBox(){return"border-box"===this.value}}class ${constructor(e){this.element=e,this.color=oe.load(e),this.measure=St.loadMeasure(e),this.extent=St.loadExtent(e),this.float=ut.load(e),this.display=this.loadDisplay(e),this.position=Pt.load(e),this.absPos=yt.load(e),this.writingMode=es.load(e),this.font=st.load(e),this.edge=this.loadEdge(e,this.display),this.verticalAlign=Ct.load(e),this.textAlign=wt.load(e),this.textCombineUpright=qt.load(e),this.textOrientation=Zt.load(e),this.textEmphasis=Kt.load(e),this.overflowWrap=Bt.load(e),this.wordBreak=Qt.load(e),this.content=Te.load(e),this.listStyle=ct.load(e),this.whiteSpace=Jt.load(e),this.pageBreakBefore=Tt.load(e),this.pageBreakAfter=Rt.load(e),this.backgroundPos=vt.load(e),this.borderCollapse=Ce.load(e)}loadDisplay(e){const t=qe.load(e);if("a"===e.tagName&&t.isInlineLevel()){const s=e.firstElementChild;return s?(le.load(s),qe.load(s)):t}return t}loadEdge(e,t){return t.isNone()?ne.none:ne.load(e)}}class D{constructor(e){this.macro=e}call(e){return this.macro(e)}}class W{constructor(e){this.value=this.normalize(e)}toString(){return this.value}normalize(e){let t=e.replace(/\s/g,"");return t=r.String.camelToChain(t),t}replace(e,t){return this.value.replace(e,t)}join(e,t="-"){return[this.value].concat(e).join(t)}isDynamicStyleProp(){return"!"===this.value.charAt(0)}getDynamicStylePropName(){return this.isDynamicStyleProp()?this.value.substring(1):""}isDomCallback(){return"@"===this.value.charAt(0)}getDomCallbackName(){return this.isDomCallback()?this.value.substring(1):""}}class _{constructor(e,t){this.selector=e,this.style=t}toString(){return"(rule):"+this.selector.toString()}test(e,t=!1){return this.selector.test(e,t)}get pseudoElementName(){return this.peSelector?this.peSelector.tagName:""}get peSelector(){return this.selector.peSelector}getPropertyValue(e){return this.style.getPropertyValue(e)}static compare(e,t){return Be.compare(e.selector,t.selector)}}class H{constructor(){this.styles=new Map,this.dynamicStyles=[],this.domCallbacks=[]}hasDomCallbacks(){return this.domCallbacks.length>0}hasDynamicStyles(){return this.dynamicStyles.length>0}isEmpty(){return 0===this.styles.size&&0===this.dynamicStyles.length&&0===this.domCallbacks.length}callDomCallbacks(e,t,s){this.domCallbacks.forEach((i=>i.call(e,t,s)))}getPropertyValue(e){return this.styles.get(e)||null}setProperty(e,t){const s=new W(e),i=new G({prop:s.value,value:t});return ae.parseDeclaration(s,i).reduce(((e,t)=>(e.styles.set(t.prop,t.value),e)),this)}addDynamicStyle(e){return this.dynamicStyles.push(e),this}addDomCallback(e){return this.domCallbacks.push(e),this}removeProperty(e){return this.styles.delete(e)}forEach(e){this.styles.forEach(((t,s)=>e(s,t)))}mergeFrom(e){return e.styles.forEach(((e,t)=>{this.styles.set(t,e)})),this.dynamicStyles=this.dynamicStyles.concat(e.dynamicStyles),this.domCallbacks=this.domCallbacks.concat(e.domCallbacks),this}getDynamicStyle(e,t){return this.dynamicStyles.reduce(((s,i)=>{const r=i.call(e,t)||{};return s.mergeFrom(r)}),new H)}acceptCssEvaluator(e){return e.visitUnmanagedCssProps(this)}}class q{constructor(e){this.rules=[],e&&this.addCssRules(e)}sort(){return this.rules.sort(_.compare),this}mergeStyleSheet(e){return this.rules=this.rules.concat(e.rules),this.sort(),this}getPseudoRules(){return this.rules.filter((e=>null!==e.peSelector))}getStyleOfElement(e){return this.rules.filter((t=>t.test(e))).reduce(((e,t)=>e.mergeFrom(t.style)),new H)}addCssRules(e){for(let t in e){let s=ae.parseRule(t,e[t]);this.rules=this.rules.concat(s)}return this.sort()}addRule(e,t){const s=ae.parseRule(e,t);return this.rules=this.rules.concat(s),this.sort()}}class G{constructor(e){this.value=this.getValue(e)}getValue(e){switch(e.prop){case"content":return e.value;default:return G.normalize(e.value)}}split(e=/\s/){return this.value.split(e)}static normalize(e){let t=e.trim();return t=t.replace(/[\n\t]/g,""),t=t.replace(/!important/g,""),t=r.String.multiSpaceToSingle(t),t=t.replace(/\s*([,/;])\s*/g,"$1"),t}static getValue4D(e){let t=e.split(/\s/);switch(t.length){case 1:return[t[0],t[0],t[0],t[0]];case 2:return[t[0],t[1],t[0],t[1]];case 3:return[t[0],t[1],t[2],t[1]];case 4:return[t[0],t[1],t[2],t[3]]}throw new Error("invalid shorthanded 4d value:"+e)}static getValue4D2(e){let t=e.split("/").map((e=>G.getValue4D(e)));return 1===t.length&&t.push(t[0]),t}}const j=["before","end","after","start"];class K{constructor(e){this.top=e.top,this.right=e.right,this.bottom=e.bottom,this.left=e.left}get items(){return[{prop:"top",value:this.top},{prop:"right",value:this.right},{prop:"bottom",value:this.bottom},{prop:"left",value:this.left}]}}class Z{constructor(e){this.before=e.before,this.end=e.end,this.after=e.after,this.start=e.start}static isBlockEdge(e){return"before"===e||"after"===e}static isInlineEdge(e){return"start"===e||"end"===e}getPhysicalEdgeValue(e){return this.items.reduce(((t,s)=>(t[mt.select(e).get(s.prop)]=s.value,t)),{})}getPhysicalEdge(e){return new K(this.getPhysicalEdgeValue(e))}getPropByLogicalDirection(e){throw new Error("LogicalEdge<T>::getPropByLogicalDirection must be overrided.")}get values(){return{before:this.before,end:this.end,after:this.after,start:this.start}}get items(){return[{prop:"before",value:this.before},{prop:"end",value:this.end},{prop:"after",value:this.after},{prop:"start",value:this.start}]}}class Y extends Z{static loadDirection(e,t){return r.atoi(Ne.getValue(e,t))}static get zeroValue(){return{before:0,end:0,after:0,start:0}}isZero(){return 0===this.before&&0===this.end&&0===this.after&&0===this.start}clone(){return new Y({before:this.before,end:this.end,after:this.after,start:this.start})}get extent(){return this.before+this.after}get measure(){return this.start+this.end}}class X extends Z{static parseShorthand(e){let t=G.getValue4D(e.value);return[{prop:"border-before-color",value:t[0]},{prop:"border-end-color",value:t[1]},{prop:"border-after-color",value:t[2]},{prop:"border-start-color",value:t[3]}]}static load(e){return new X(j.reduce(((t,s)=>(t[s]=Ne.getValue(e,`border-${s}-color`),t)),{}))}static get none(){return new X(X.noneValue)}static get noneValue(){return{before:"transparent",end:"transparent",after:"transparent",start:"transparent"}}clone(){return new X(this.values)}getPropByLogicalDirection(e){return`border-${e}-color`}acceptCssEvaluator(e){return e.visitLogicalBorderColor(this)}}class J{constructor(e){this.beforeStart=e.beforeStart,this.beforeEnd=e.beforeEnd,this.afterEnd=e.afterEnd,this.afterStart=e.afterStart}clone(){return new J({beforeStart:this.beforeStart,beforeEnd:this.beforeEnd,afterEnd:this.afterEnd,afterStart:this.afterStart})}static get none(){return new J(J.noneValue)}static get noneValue(){return{beforeStart:0,beforeEnd:0,afterEnd:0,afterStart:0}}static load(e){let t=J.corners.reduce(((t,s)=>{let i=`border-${s}-radius`,n=Ne.getValue(e,i);return t[r.String.chainToCamel(s)]=n,t}),{});return new J(t)}static parseShorthand(e){let t=G.getValue4D2(e.value),s=t[0],i=t[1];return[{prop:"border-before-start-radius",value:[s[0],i[0]].join(" ")},{prop:"border-before-end-radius",value:[s[1],i[1]].join(" ")},{prop:"border-after-end-radius",value:[s[2],i[2]].join(" ")},{prop:"border-after-start-radius",value:[s[3],i[3]].join(" ")}]}get items(){return[{prop:"before-start",value:this.beforeStart},{prop:"before-end",value:this.beforeEnd},{prop:"after-end",value:this.afterEnd},{prop:"after-start",value:this.afterStart}]}}var Q,ee;J.corners=["before-start","before-end","after-end","after-start"],function(e){e.NONE="none",e.HIDDEN="hidden",e.DOTTED="dotted",e.DASHED="dashed",e.SOLID="solid",e.DOUBLE="double",e.GROOVE="groove",e.RIDGE="ridge",e.INSET="inset",e.OUTSET="outset"}(Q||(Q={}));class te extends Z{static parseShorthand(e){let t=G.getValue4D(e.value);return[{prop:"border-before-style",value:t[0]},{prop:"border-end-style",value:t[1]},{prop:"border-after-style",value:t[2]},{prop:"border-start-style",value:t[3]}]}static load(e){return new te(j.reduce(((t,s)=>(t[s]=Ne.getValue(e,`border-${s}-style`),t)),{}))}static get noneValue(){return{before:"none",end:"none",after:"none",start:"none"}}static get none(){return new te(te.noneValue)}clone(){return new te(this.values)}getPropByLogicalDirection(e){return`border-${e}-style`}acceptCssEvaluator(e){return e.visitLogicalBorderStyle(this)}}te.values=r.Enum.toValueArray(Q),function(e){e.THIN="thin",e.MEDIUM="medium",e.THICK="thick"}(ee||(ee={}));const se={thin:2,medium:4,thick:6};class ie extends Y{static parseShorthand(e){const t=G.getValue4D(e.value);return[{prop:"border-before-width",value:t[0]},{prop:"border-end-width",value:t[1]},{prop:"border-after-width",value:t[2]},{prop:"border-start-width",value:t[3]}]}static load(e){return new ie(j.reduce(((t,s)=>(t[s]=Y.loadDirection(e,`border-${s}-width`),t)),{}))}static get none(){return new ie(Y.zeroValue)}clone(){return new ie(this.values)}clearBefore(){this.before=0}clearEnd(){this.end=0}clearAfter(){this.after=0}clearStart(){this.start=0}getPropByLogicalDirection(e){return`border-${e}-width`}acceptCssEvaluator(e){return e.visitLogicalBorderWidth(this)}}ie.keywords=r.Enum.toValueArray(ee);class re{constructor(e){this.style=e.style,this.width=e.width,this.color=e.color,this.radius=e.radius}clone(){return new re({style:this.style.clone(),width:this.width.clone(),color:this.color.clone(),radius:this.radius.clone()})}static load(e){return new re({style:te.load(e),width:ie.load(e),color:X.load(e),radius:J.load(e)})}static get none(){return new re({style:te.none,width:ie.none,color:X.none,radius:J.none})}acceptCssEvaluator(e){const t=new kt;return e.visitLogicalBorderWidth(this.width).mergeTo(t),e.visitLogicalBorderStyle(this.style).mergeTo(t),e.visitLogicalBorderColor(this.color).mergeTo(t),e.visitLogicalBorderRadius(this.radius,this.width).mergeTo(t),t}clearBefore(){this.width.clearBefore()}clearEnd(){this.width.clearEnd()}clearAfter(){this.width.clearAfter()}clearStart(){this.width.clearStart()}get beforeWidth(){return this.width.before}get endWidth(){return this.width.end}get afterWidth(){return this.width.after}get startWidth(){return this.width.start}static expand(e){return e.reduce(((e,t)=>{switch(t.prop){case"width":return e.concat(ie.parseShorthand(new G(t)));case"style":return e.concat(te.parseShorthand(new G(t)));case"color":return e.concat(X.parseShorthand(new G(t)))}return console.error(`undefined prop for logical-border:${t.prop}`),e}),[])}static inferPropType(e){return te.values.indexOf(e)>=0?"style":ie.keywords.indexOf(e)>=0||ze.hasUnit(e)?"width":"color"}static parseShorthandWidthStyleColor(e){let t={width:"medium",style:"none",color:"currentcolor"};return("none"===e.value?[]:e.split().slice(0,3)).forEach((e=>{let s=re.inferPropType(e);t[s]=e}),t),Object.keys(t).map((e=>({prop:e,value:t[e]})))}static parseShorthand(e){let t=re.parseShorthandWidthStyleColor(e);return re.expand(t)}static parseShorthandEach(e,t){return re.parseShorthandWidthStyleColor(e).map((e=>({prop:`border-${t}-${e.prop}`,value:e.value})))}}class ne{constructor(e){this.padding=e.padding,this.border=e.border,this.margin=e.margin}static load(e){return e.tagName===i.pageRootTagName?this.loadRootBoxEdge(e):this.loadBoxEdge(e)}static loadRootBoxEdge(e){return i.engineVersion<=6?new ne({padding:bt.load(e),border:re.none,margin:xt.none}):this.none}static loadBoxEdge(e){return new ne({padding:bt.load(e),border:re.load(e),margin:xt.load(e)})}static get none(){return new ne({padding:bt.none,border:re.none,margin:xt.none})}clone(){return new ne({padding:this.padding.clone(),border:this.border.clone(),margin:this.margin.clone()})}clearBefore(){this.padding.before=0,this.border.clearBefore(),this.margin.before=0}clearAfter(){this.padding.after=0,this.border.clearAfter(),this.margin.after=0}clearStart(){this.padding.start=0,this.border.clearStart(),this.margin.start=0}clearEnd(){this.padding.end=0,this.border.clearEnd(),this.margin.end=0}get start(){return this.padding.start+this.border.startWidth+this.margin.start}get end(){return this.padding.end+this.border.endWidth+this.margin.end}get before(){return this.padding.before+this.border.beforeWidth+this.margin.before}get after(){return this.padding.after+this.border.afterWidth+this.margin.after}get extent(){return this.before+this.after}get measure(){return this.start+this.end}get borderBoxBefore(){return this.padding.before+this.border.width.before}get borderBoxAfter(){return this.padding.after+this.border.width.after}get borderBoxStart(){return this.padding.start+this.border.width.start}get borderBoxEnd(){return this.padding.end+this.border.width.end}get borderBoxExtent(){return this.borderBoxBefore+this.borderBoxAfter}get borderBoxMeasure(){return this.borderBoxStart+this.borderBoxStart}getInnerBoxOffset(){return{start:this.padding.start,before:this.padding.before}}}class oe{constructor(e){this.value=e}static load(e){const t=e.computedStyle.getPropertyValue("color")||"inherit";return new oe(t)}acceptCssEvaluator(e){return e.visitColor(this)}}class ae{static parseInlineStyle(e){return G.normalize(e).split(";").reduce(((e,t)=>{const s=t.split(":");if(2===s.length&&""!==s[0]&&""!==s[1]){const t=new W(s[0]);if(i.IgnoredInlineStyleProps.indexOf(t.value)>=0)return e;const r=new G({prop:t.value,value:s[1]});ae.parseDeclaration(t,r).forEach((t=>{e.setProperty(t.prop,t.value)}))}return e}),new H)}static parseRule(e,t){return new _t(e).split().map((e=>{const s=new Dt(e),i=new Wt(s).parse(),r=this.parseDeclarationBlock(e,t);return new _(i,r)}))}static parseDeclarationBlock(e,t){return Object.keys(t).reduce(((s,i)=>{const r=t[i],n=new W(i);if("string"==typeof r)return s.setProperty(n.value,r);if("number"==typeof r)return s.setProperty(n.value,String(r));if("function"==typeof r){if(n.isDynamicStyleProp()){const t=n.getDynamicStylePropName(),i=r;return s.addDynamicStyle(new Ze(e,t,i))}if(n.isDomCallback()){const t=n.getDomCallbackName(),i=r;return s.addDomCallback(new Ge(e,t,i))}const t=new D(r).call(e);if(""!==t){const e=new G({prop:n.value,value:t});return s.setProperty(n.value,e.value)}}return s}),new H)}static parseDeclaration(e,t){switch(e.value){case"border":return re.parseShorthand(t);case"border-before":return re.parseShorthandEach(t,"before");case"border-end":return re.parseShorthandEach(t,"end");case"border-after":return re.parseShorthandEach(t,"after");case"border-start":return re.parseShorthandEach(t,"start");case"border-radius":return J.parseShorthand(t);case"font":return st.parseShorthand(t);case"list-style":return ct.parseShorthand(t);case"margin":return xt.parseShorthand(t);case"padding":return bt.parseShorthand(t);case"border-width":return ie.parseShorthand(t);case"border-color":return X.parseShorthand(t);case"border-style":return te.parseShorthand(t);case"text-emphasis":return Kt.parseShorthand(t)}return[{prop:e.value,value:t.value}]}}class le{static loadAll(e){e.isTextElement()||(this.load(e),e.children.forEach((e=>this.loadAll(e))),"body"===e.tagName&&this.loadDynamic(e))}static load(e){e.isTextElement()||(e.acceptEffector(xe.instance),e.acceptEffector(ye.instance),e.acceptEffector(ve.instance),e.acceptEffector(Ee.instance))}static loadDynamic(e,t){return!!e.style.hasDynamicStyles()&&(e.acceptEffector(new be(t)),e.acceptEffector(ye.instance),e.acceptEffector(ve.instance),e.acceptEffector(Ee.instance),!0)}}let ce={styleSheets:[]};class he{constructor(){}visit(e){if(e.isTextElement())return!0;if(i.ignoredTags.includes(e.tagName))return!1;if(["br","hr","img","wbr","video","iframe"].includes(e.tagName))return!0;if(At.isPseudoElement(e))return!0;const t=qe.load(e);return!(t.isNone()||t.isBlockLevel()&&(e.acceptChildFilter(this),0===e.childNodes.length||e.childNodes.every((e=>Jt.isWhiteSpaceElement(e)))))}}he.instance=new he;class de{constructor(){}visit(e){const t=qe.load(e);if(!t.isListItem()||t.isNone()||!e.parent)return;const s=ct.load(e);if(s.isNone())return;let i=s.getMarkerText(e.indexOfType);const r=e.firstChild;if(!r||r.tagName!==Mt.MARKER)throw new Error("marker element is not created yet!");const n=e.ownerDocument.createTextNode(i);r.appendChild(n)}}de.instance=new de;class ue{constructor(){}visit(e){const t=e.parent;if(!Ce.load(e).isCollapse()||!t)return;const s=parseInt(t.computedStyle.getPropertyValue("measure")||"0"),i=ie.load(t).measure,r=ie.load(e).measure,n=s-Math.max(0,r-i);e.computedStyle.setProperty("measure",n+"px")}}ue.instance=new ue;class pe{constructor(){}visit(e){const t=e.parent;if(!Ce.load(e).isCollapse()||!t)return;const s=parseInt(t.computedStyle.getPropertyValue("measure")||"0"),i=ie.load(t).measure,r=ie.load(e).measure,n=s-Math.max(0,r-i);e.computedStyle.setProperty("measure",n+"px")}}pe.instance=new pe;class ge{constructor(){}getCollapsedInternalEdgeSize(e,t){let s=e.reduce(((t,s,i)=>(t+=s.padding.measure,i<e.length-1?t+Math.max(s.border.width.end,e[i+1].border.width.start):t)),0);return s+=Math.max(0,e[0].border.width.start-t.border.width.start),s+=Math.max(0,e[e.length-1].border.width.end-t.border.width.end),s}getTableCells(e){return e.children.filter((e=>"table-cell"===e.computedStyle.getPropertyValue("display")))}findPrevCells(e,t){let s=e.previousElementSibling;for(;s;){const e=this.getTableCells(s);if(e.length===t)return e;s=s.previousElementSibling}}visit(e){const t=e.parent;if(!t||"table-cell"!==e.computedStyle.getPropertyValue("display"))return;const s=this.getTableCells(t);if(s.every((e=>"auto"!==e.computedStyle.getPropertyValue("measure"))))return;if(qe.load(t).isTableRow()){const e=this.findPrevCells(t,s.length);if(e)return void s.forEach(((t,s)=>{const i=e[s].computedStyle.getPropertyValue("measure");if(!i)throw new Error("cell partition is not defined properly.");t.computedStyle.setProperty("measure",i)}))}s.forEach((e=>{j.forEach((t=>{e.computedStyle.setProperty(`margin-${t}`,"0")}))}));const r=ne.load(t),n=s.map((e=>ne.load(e))),o=Ce.load(e).isCollapse()?this.getCollapsedInternalEdgeSize(n,r):n.reduce(((e,t)=>e+t.measure),0),a=parseInt(t.computedStyle.getPropertyValue("measure")||"0",10),l=s.map((e=>{const t=e.computedStyle.getPropertyValue("measure")||"0";return"auto"===t?0:parseInt(t,10)})),c=s.filter((e=>"auto"===e.computedStyle.getPropertyValue("measure"))),h=l.reduce(((e,t)=>e+t),0),d=a-h-o,u=Math.max(Math.floor(d/c.length),0),p=d%c.length;i.debugLayout&&console.log("cell size:(parent:%d, fixedSize:%d, iedge:%d, auto:%d(fraction:%d)), cell:",a,h,o,u,p,e),c.forEach(((e,t)=>{const s=0===t?u+p:u;e.computedStyle.setProperty("measure",s+"px")}))}}ge.instance=new ge;class me{constructor(){}visit(e){if("ruby"!==e.tagName)return;const t=e.root;e.childNodes=e.childNodes.filter((e=>"rp"!==e.tagName&&(!e.isTextElement()||""!==e.textContent.trim()))),e.childNodes=e.childNodes.map((s=>{if(!s.isTextElement())return s;const i=t.createElement("rb");return i.parent=e,i.appendChild(s),le.load(i),i}))}}me.instance=new me;class fe{constructor(e){this.pseudoRules=e}addMarker(e){const t=e.root.createElement(Mt.MARKER);return t.parent=e,e.insertBefore(t,e.firstChild),t}addBefore(e){const t=e.root.createElement(Mt.BEFORE);return e.insertBefore(t,e.firstChild),t}addAfter(e){const t=e.root.createElement(Mt.AFTER);return e.appendChild(t),t}addFirstLine(e){const t=e.root.createElement(Mt.FIRST_LINE),s=e.firstTextElement;if(!s)return null;const i=s.parent;return i?(t.appendChild(s),i.replaceChild(t,s),t):null}addFirstLetter(e){const t=e.firstTextElement;if(!t)return null;const s=t.parent;if(!s)return null;const i=t.textContent,r=i.trim(),n=(r.length>1?r:i).substring(0,1),o=i.substring(1),a=e.root.createElement(Mt.FIRST_LETTER);a.appendChild(e.root.createTextNode(n));const l=e.root.createTextNode(o);l.appendChild(e.root.createTextNode(o));const c=t.nextSibling;return s.removeChild(t),s.insertBefore(l,c),s.insertBefore(a,l),a}addPseudoElement(e,t){switch(t){case Mt.MARKER:return this.addMarker(e);case Mt.BEFORE:return this.addBefore(e);case Mt.AFTER:return this.addAfter(e);case Mt.FIRST_LETTER:return this.addFirstLetter(e);case Mt.FIRST_LINE:return this.addFirstLine(e)}throw new Error("undefined pseudo element:"+t)}visit(e){this.pseudoRules.forEach((t=>{if(t.test(e,!0)&&t.peSelector){const s=t.peSelector.tagName,i=e.querySelector(s)||this.addPseudoElement(e,s);i&&i.style.mergeFrom(t.style)}}))}}class xe{constructor(){}visit(e){if(e.isTextElement()||At.isPseudoElement(e))return;const t=e.ownerDocument.specStyleSheet.getStyleOfElement(e);e.style=t}}xe.instance=new xe;class be{constructor(e){this.parentCxt=e}visit(e){const t=e.style.getDynamicStyle(e,this.parentCxt);e.style.mergeFrom(t),t.forEach(((t,s)=>{e.computedStyle.removeProperty(t)}))}}class ye{constructor(){}visit(e){const t=e.getAttribute("style")||"",s=ae.parseInlineStyle(t);e.style.mergeFrom(s)}}ye.instance=new ye;class ve{getLineHeightString(e){return ze.computeLineHeight(e)}setCascadedValue(e,t){const s=Ne.getValue(e,t);return e.computedStyle.setProperty(t,s),s}setFontSize(e){const t=ze.computeFontSize(e);e.computedStyle.setProperty("font-size",t+"px")}setLineHeight(e){const t=this.getLineHeightString(e);e.computedStyle.setProperty("line-height",t)}setBoxLength(e,t){const s=ze.computeBoxLength(e,t);e.computedStyle.setProperty(t,s+"px")}setAutableBoxLength(e,t){const s=ze.computeAutableBoxLength(e,t),i="auto"===s?s:s+"px";e.computedStyle.setProperty(t,i)}setOptionalBoxLength(e,t){const s=ze.computeOptionalBoxLength(e,t),i="none"===s?s:s+"px";e.computedStyle.setProperty(t,i)}setMargin(e){j.forEach((t=>{this.setAutableBoxLength(e,`margin-${t}`)}))}setPadding(e){j.forEach((t=>{this.setBoxLength(e,`padding-${t}`)}))}setBorderWidth(e){j.forEach((t=>{const s=`border-${t}-width`,i=ze.computeBorderWidth(e,s);e.computedStyle.setProperty(s,i+"px")}))}setBorderStyle(e){j.forEach((t=>{const s=`border-${t}-style`,i=Ne.getValue(e,s);e.computedStyle.setProperty(s,i)}))}setBorderColor(e){j.forEach((t=>{const s=`border-${t}-color`,i=Ne.getValue(e,s);e.computedStyle.setProperty(s,i)}))}setBorderRadius(e){J.corners.forEach((t=>{const s=`border-${t}-radius`,i=ze.computeBoxLength(e,s);e.computedStyle.setProperty(s,i+"px")}))}setPosition(e){j.forEach((t=>{this.setAutableBoxLength(e,t)}))}visit(e){e.isTextElement()||"none"!==this.setCascadedValue(e,"display")&&(i.nonLayoutTags.includes(e.tagName)||(this.setCascadedValue(e,"writing-mode"),this.setCascadedValue(e,"color"),this.setFontSize(e),this.setLineHeight(e),i.fontSizeOnlyTags.includes(e.tagName)||(i.edgeSkipTags.includes(e.tagName)||(this.setPadding(e),this.setBorderWidth(e),this.setBorderStyle(e),this.setBorderColor(e),this.setBorderRadius(e)),i.boxSizeSkipTags.includes(e.tagName)||(this.setMargin(e),this.setPosition(e),this.setAutableBoxLength(e,"measure"),this.setAutableBoxLength(e,"extent"),this.setAutableBoxLength(e,"width"),this.setAutableBoxLength(e,"height"),this.setOptionalBoxLength(e,"min-measure"),this.setOptionalBoxLength(e,"max-measure"),this.setOptionalBoxLength(e,"min-extent"),this.setOptionalBoxLength(e,"max-extent")),this.setCascadedValue(e,"box-sizing"),this.setCascadedValue(e,"float"),this.setCascadedValue(e,"font-family"),this.setCascadedValue(e,"font-style"),this.setCascadedValue(e,"font-weight"),this.setCascadedValue(e,"font-variant"),this.setCascadedValue(e,"font-stretch"),this.setCascadedValue(e,"text-orientation"),this.setCascadedValue(e,"text-combine-upright"),this.setCascadedValue(e,"text-emphasis-style"),this.setCascadedValue(e,"text-emphasis-color"),this.setCascadedValue(e,"text-align"),this.setCascadedValue(e,"vertical-align"),this.setCascadedValue(e,"list-style-type"),this.setCascadedValue(e,"list-style-position"),this.setCascadedValue(e,"list-style-image"),this.setCascadedValue(e,"content"),this.setCascadedValue(e,"word-break"),this.setCascadedValue(e,"overflow-wrap"),this.setCascadedValue(e,"white-space"),this.setCascadedValue(e,"page-break-before"),this.setCascadedValue(e,"page-break-after"),this.setCascadedValue(e,"position"),this.setCascadedValue(e,"border-collapse"))))}}ve.instance=new ve;class Ee{constructor(){}visit(e){const t=qe.load(e);if(t.isNone())return;if(i.boxSizeSkipTags.includes(e.tagName))return;const s=ps.load(e);s&&(class{static select(e){const t=qe.load(e),s=Ne.getValue(e,"float"),i=Ne.getValue(e,"position"),r=Vt.isReplacedElement(e);return"none"!==s?r?xs.instance:fs.instance:"absolute"===i?r?ws.instance:Ss.instance:t.isInlineBlockFlow()?r?Es.instance:vs.instance:t.isInlineLevel()?r?ys.instance:bs.instance:t.isBlockLevel()?r?ms.instance:gs.instance:(console.error("select resolver failed."),bs.instance)}}.select(e).resolve(e,s,t),s.save(e.computedStyle))}}Ee.instance=new Ee;class Se{constructor(e,t){this.$node=e,this.$dom=void 0,this.tagName=this.getTagName(),this.childNodes=[],this.parent=null,this.root=t,this.style=new H,this.computedStyle=new H,this.id=this.$node instanceof Element?this.$node.id:"",this.classList=this.createClassList(),this.setupChildren(this.$node,t)}acceptChildFilter(e){return this.childNodes=this.childNodes.filter((t=>e.visit(t))),this}acceptEffector(e){return e.visit(this),this}acceptEffectorAll(e){return e.visit(this),this.childNodes.forEach((t=>t.acceptEffectorAll(e))),this}get nextSibling(){if(!this.parent)return null;const e=this.parent.childNodes.indexOf(this);return e<0||e+1>=this.parent.childNodes.length?null:this.parent.childNodes[e+1]}get previousSibling(){if(!this.parent)return null;const e=this.parent.childNodes.indexOf(this);return e>0?this.parent.childNodes[e-1]:null}clone(e=!1){const t=this.ownerDocument.createNehanElement(this.$node.cloneNode(e));return t.style=this.style,t.computedStyle=this.computedStyle,t}createClassList(){if(this.$node instanceof Element){let e=[];for(let t=0;t<this.$node.classList.length;t++){let s=this.$node.classList.item(t);null!==s&&e.push(s)}return new je(e)}return new je([])}setupChildren(e,t){if(e instanceof Element)for(let s=0;s<e.childNodes.length;s++){let i=e.childNodes.item(s),r=t.createNehanElement(i);this.appendChild(r)}}set innerHTML(e){this.$node.innerHTML=e,this.childNodes=[],this.setupChildren(this.$node,this.root),le.loadAll(this)}get innerHTML(){return this.isTextElement()?this.textContent:this.$node.innerHTML}get className(){return this.classList.values().join(" ")}set className(e){let t=e.split(" ").filter((e=>""!==e));this.classList=new je(t)}get pureTagName(){return this.tagName.replace("::","")}get attributes(){return this.$node instanceof Element?this.$node.attributes:null}get dataset(){if(this.$node instanceof Element)return this.$node.dataset;throw new Error("dataset is not defined(not HTMLElement)")}get textContent(){return this.$node.textContent||""}getTagName(){return this.$node instanceof Text?"(text)":this.$node instanceof Element?this.$node.tagName.toLowerCase():(console.info("unsupported node type:%o",this),"???")}getNodeName(){let e=this.tagName;this.id&&(e+="#"+this.id);for(let t=0;t<this.classList.length;t++)e+="."+this.classList.item(t);return e}getPath(e=!1){let t=this.getNodeName();if(!e)return t;let s=this.parent;for(;s;)t=s.getNodeName()+">"+t,s=s.parent;return t}toString(e=!1){let t=this.getPath(!0);return e?(t+="("+this.indexOfType+")",t):t}querySelectorAll(e){const t=new Dt(e);return new Wt(t).parse().querySelectorAll(this)}querySelector(e){const t=new Dt(e);return new Wt(t).parse().querySelector(this)}queryLeafs(e){return this.root.getSelectorCache(e).filter((e=>{let t=e.parent;for(;t;){if(t===this)return!0;t=t.parent}return!1}))}appendChild(e){return e.parent=this,this.childNodes.push(e),this}replaceChild(e,t){if(t){const s=this.childNodes.indexOf(t);s>=0&&(e.parent=this,this.childNodes[s]=e)}return e}removeChild(e){const t=this.childNodes.indexOf(e);return t>=0&&this.childNodes.splice(t,1),e}insertBefore(e,t){if(!t)return this.appendChild(e),null;if(t.parent!==this)throw new Error("reference node is not included in this element");e.parent=this;const s=this.childNodes.indexOf(t);return s>=0&&this.childNodes.splice(s,0,e),t.nextSibling?e:null}hasAttribute(e){return this.$node instanceof Element&&this.$node.hasAttribute(e)}isOnlyChild(){return 1===this.siblings.length}isOnlyOfType(){return 1===this.siblings.filter((e=>e.tagName===this.tagName)).length}isFirstChild(){return!this.parent||0===this.parent.childNodes.indexOf(this)}isLastChild(){if(!this.parent)return!0;const e=this.parent.childNodes;return e[e.length-1]===this}isFirstElementChild(){return!this.parent||this.parent.children[0]===this}isLastElementChild(){if(!this.parent)return!0;const e=this.parent.children;return e[e.length-1]===this}isNthChild(e){return this.index===Math.max(e-1,0)}isElement(){return this.$node instanceof HTMLElement}isTextElement(){return this.$node instanceof Text}setAttribute(e,t){this.$node instanceof Element&&this.$node.setAttribute(e,t)}get ownerDocument(){return this.root}get firstChild(){return this.childNodes[0]||null}get firstTextElement(){const e=this.firstChild;if(!e)return null;if(e.isTextElement())return e;const t=e.nextSibling;return t?t.firstTextElement:null}get lastChild(){return this.childNodes[this.childNodes.length-1]||null}get lastElementChild(){const e=this.children;return e[e.length-1]||null}get firstElementChild(){return this.children[0]||null}get nextElementSibling(){let e=this.nextSibling;for(;e&&!e.isElement();)e=e.nextSibling;return e}get previousElementSibling(){let e=this.previousSibling;for(;e&&!e.isElement();)e=e.previousSibling;return e}get firstAtomChild(){for(let e=0;e<this.childNodes.length;e++){const t=this.childNodes[e];if(t.isTextElement()&&!Jt.isWhiteSpaceElement(t))return t;if(Vt.isReplacedElement(t)&&!Nt.load(t).hasZero())return t;const s=t.firstAtomChild;if(s)return s}return null}get siblings(){return this.parent?this.parent.childNodes:[]}get index(){return this.parent?this.parent.childNodes.indexOf(this):0}get indexOfType(){return this.parent?this.parent.childNodes.filter((e=>e.tagName===this.tagName)).indexOf(this):0}get indexOfElement(){return this.parent?this.parent.children.indexOf(this):0}get children(){return this.childNodes.filter((e=>!e.isTextElement()))}getAttribute(e){return this.$node instanceof Element?this.$node.getAttribute(e):null}}class we extends O{constructor(e,t,s){super(),this.left=e,this.operator=t,this.right=s,this.specificity.b=1}toString(){let e="["+this.left;return this.operator&&(e+=this.operator),this.right&&(e+=this.right),e+="]",e}test(e){if(!this.operator)return this.testAttr(e);switch(this.operator){case"=":return this.testEqual(e);case"*=":return this.testStarEqual(e);case"^=":return this.testCaretEqual(e);case"$=":return this.testDollarEqual(e);case"~=":return this.testTildeEqual(e);case"|=":return this.testPipeEqual(e)}throw new Error("invalid operator["+this.operator+"](attr selector)")}testAttr(e){return e.hasAttribute(this.left)}testEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&t===this.right}testStarEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&t.indexOf(this.right)>=0}testCaretEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&new RegExp("^"+this.right).test(t)}testDollarEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&new RegExp(this.right+"$").test(t)}testTildeEqual(e){let t=e.getAttribute(this.left);if(!t||!this.right)return!1;let s=t.trim().replace(/\s+/g," ").split(" "),i=this.right;return s.some((function(e){return e===i}))}testPipeEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&(t===this.right||t.indexOf(this.right+"-")>=0)}}class Ce{constructor(e){this.value=e}isCollapse(){return"collapse"===this.value}isSeparate(){return"separate"===this.value}static load(e){const t=Ne.getValue(e,"border-collapse");return new Ce(t)}}class ke extends O{constructor(e){super(),this.className=e,this.specificity.b=1}toString(){return"."+this.className}test(e){return e.classList.contains(this.className)}}class Be extends O{constructor(e,t){super(),this.selectors=e,this.combinators=t,this.specificity=this.getSpecificity()}getSelectorItem(e){if(e<0||e>=this.selectors.length)throw new Error("getSelectorItem: out of range");return this.selectors[e]}getCombinatorItem(e){if(e<0||e>=this.combinators.length)throw new Error("getCombinatorItem: out of range");return this.combinators[e]}static compare(e,t){return Ht.compare(e.specificity,t.specificity)}getSpecificity(){let e=new Ht(0,0,0);return e=this.selectors.reduce(((e,t)=>Ht.add(e,t.specificity)),e),e}get leafSelector(){return this.selectors[0]}get peSelector(){for(let e=0;e<this.selectors.length;e++){let t=this.selectors[e];if(null!==t.pseudoElement)return t.pseudoElement}return null}toString(){let e=this.leafSelector.toString();for(var t=1,s=0;t<this.selectors.length;t++,s++)e=this.selectors[t].toString()+this.combinators[s]+e;return e}queryDirectParent(e,t){return e.parent&&t.test(e.parent)?e.parent:null}queryParent(e,t){let s=e.parent;for(;s;){if(t.test(s))return s;s=s.parent}return s}queryDirectSibling(e,t){let s=e.previousSibling;return s&&t.test(s)?s:null}querySibling(e,t){let s=e.previousSibling;for(;s;){if(!s.isTextElement()&&t.test(s))return s;s=s.previousSibling}return s}queryLeft(e,t,s){switch(t){case" ":return this.queryParent(s,e);case">":return this.queryDirectParent(s,e);case"+":return this.queryDirectSibling(s,e);case"~":return this.querySibling(s,e);default:throw new Error("Invalid combinator["+t+"]")}}querySelectorAll(e){return this.leafSelector.querySelectorAll(e).filter((e=>this.test(e)))}querySelector(e){let t=this.leafSelector.querySelectorAll(e);for(let e=0;e<t.length;e++){let s=t[e];if(this.test(s))return s}return null}test(e,t=!1){let s=0,i=0,r=this.selectors.length,n=this.combinators.length,o=e;for(;!(s>=r);){let e=this.selectors[s];if(0===s&&!e.test(o,t))return!1;if(i>=n)break;let a=this.combinators[i++];if(s+1>=r)return!1;if(e=this.selectors[s+1],o=this.queryLeft(e,a,o),null===o)return!1;s++}return!0}}class Re extends O{constructor(e){super(),this.univSelector=e.univSelector||null,this.idSelector=e.idSelector||null,this.typeSelector=e.typeSelector||null,this.attrSelector=e.attrSelector||null,this.classSelectors=e.classSelectors||[],this.pseudoClasses=e.pseudoClasses||[],this.pseudoElement=e.pseudoElement||null,this.specificity=this.getSpecificity()}getTagName(){return this.typeSelector?this.typeSelector.tagName:"*"}getSpecificity(){let e=new Ht(0,0,0);return this.idSelector&&(e=Ht.add(e,this.idSelector.specificity)),this.typeSelector&&(e=Ht.add(e,this.typeSelector.specificity)),this.attrSelector&&(e=Ht.add(e,this.attrSelector.specificity)),this.pseudoElement&&(e=Ht.add(e,this.pseudoElement.specificity)),e=this.classSelectors.reduce(((e,t)=>Ht.add(e,t.specificity)),e),e=this.pseudoClasses.reduce(((e,t)=>Ht.add(e,t.specificity)),e),e}toString(){let e="";return this.univSelector&&(e+=this.univSelector.toString()),this.typeSelector&&(e+=this.typeSelector.toString()),this.idSelector&&(e+=this.idSelector.toString()),e+=this.classSelectors.reduce(((e,t)=>e+t.toString()),""),this.attrSelector&&(e+=this.attrSelector.toString()),e+=this.pseudoClasses.reduce(((e,t)=>e+t.toString()),""),this.pseudoElement&&(e+=this.pseudoElement.toString()),e}get leafSelector(){return this.typeSelector?this.typeSelector.tagName:"*"}querySelector(e){let t=e.queryLeafs(this.leafSelector);for(let e=0;e<t.length;e++){let s=t[e];if(this.test(s))return s}return null}querySelectorAll(e){return e.queryLeafs(this.leafSelector).filter((e=>this.test(e)))}testClasses(e){return this.classSelectors.every((t=>t.test(e)))}testPseudoClasses(e){return this.pseudoClasses.every((t=>t.test(e)))}test(e,t=!1){return!(this.pseudoElement&&!t||null!==this.typeSelector&&!this.typeSelector.test(e)||null!==this.attrSelector&&!this.attrSelector.test(e)||null!==this.idSelector&&!this.idSelector.test(e)||!this.testClasses(e)||!this.testPseudoClasses(e))}}class Te{constructor(e){this.value=this.normalize(e)}isEmpty(){return""===this.value}normalize(e){return e}static load(e){let t=Ne.getValue(e,"content");return new Te(t)}}class Ne{static getValue(e,t){const s=e.computedStyle.getPropertyValue(t);return null!=s?s:this.getSpecValue(e,t)}static getSpecValue(e,t){var s;const i=null!==(s=e.style.getPropertyValue(t))&&void 0!==s?s:"",r=Me.get(t);switch(i){case"":return r.inherit&&e.parent?this.getValue(e.parent,t):r.initial;case"initial":return r.initial;case"inherit":return e.parent?r.inherit?this.getValue(e.parent,t):this.getSpecValue(e.parent,t):r.initial;default:return i}}}const Pe=["%","em","rem","px","pt","vw","vh"];class ze{static hasUnit(e){return void 0!==Pe.find((t=>e.endsWith(t)))}static computeRootFontSize(e){const t=Ne.getValue(e.ownerDocument.body,"font-size");return this.computeFontSize(e.ownerDocument.body,t)}static computeContainingMeasure(e){const t=parseInt(Ne.getValue(e,"measure"));return"static"===Ne.getValue(e,"position")?t:t+bt.load(e).measure}static computeContainingExtent(e){const t=parseInt(Ne.getValue(e,"extent"));return"static"===Ne.getValue(e,"position")?t:t+bt.load(e).extent}static computeParentFontSize(e){return e.parent?parseInt(Ne.getValue(e.parent,"font-size")):i.defaultFontSize}static computeFontSize(e,t){const s=t||Ne.getValue(e,"font-size");if(s.endsWith("em")){const t=parseFloat(s),i=this.computeParentFontSize(e);return Math.floor(t*i)}if(s.endsWith("rem")){const t=parseFloat(s),i=this.computeRootFontSize(e);return Math.floor(t*i)}if(s.endsWith("px"))return parseInt(s);if(s.endsWith("pt"))return Math.floor(4*parseInt(s)/3);if(s.endsWith("%")){const t=this.computeParentFontSize(e);return Math.floor(t*parseFloat(s)/100)}return Xe.includes(s)?this.computeFontSize(e,Qe[s]||"1.0em"):Ye.includes(s)?Je[s]:i.defaultFontSize}static computeLineHeight(e,t){const s=t||Ne.getValue(e,"line-height");if("normal"===s)return String(i.defaultLineHeight);if(s.endsWith("em")){const t=parseFloat(s),i=Ne.getValue(e,"font-size"),r=this.computeFontSize(e,i);return Math.floor(t*r)+"px"}if(s.endsWith("rem")||s.endsWith("px")||s.endsWith("pt"))return this.computeFontSize(e,s)+"px";if(s.endsWith("vw")||s.endsWith("vh"))return this.computeBoxLength(e,"line-height",s)+"px";if(s.endsWith("%")){const t=parseFloat(s),i=Ne.getValue(e,"font-size"),r=this.computeFontSize(e,i);return Math.floor(t*r/100)+"px"}return String(parseFloat(s))}static computeBaseBoxLength(e,t){const s=function(e){if("static"===Ne.getValue(e,"position"))return e.parent||e.ownerDocument.body;let t=e.parent;for(;t;){const e=Ne.getValue(t,"position");if("absolute"===e||"relative"===e)break;t=t.parent}return t||e.ownerDocument.body}(e),i=es.load(e).isTextVertical();switch(t){case"width":return i?this.computeContainingExtent(s):this.computeContainingMeasure(s);case"height":return i?this.computeContainingMeasure(s):this.computeContainingExtent(s);case"measure":case"min-measure":case"max-measure":case"start":case"end":case"padding-start":case"padding-end":case"margin-start":case"margin-end":case"border-start-width":case"border-end-width":return this.computeContainingMeasure(s);case"extent":case"min-extent":case"max-extent":case"before":case"after":case"padding-before":case"padding-after":case"margin-after":case"margin-before":case"border-before-width":case"border-after-width":return this.computeContainingExtent(s)}return 0}static computeOptionalBoxLength(e,t,s){const i=s||Ne.getValue(e,t);return"none"===i?"none":this.computeBoxLength(e,t,i)}static computeAutableBoxLength(e,t,s){const i=s||Ne.getValue(e,t);return"auto"===i?i:this.computeBoxLength(e,t,i)}static computeBoxLength(e,t,s){const i=s||Ne.getValue(e,t);if(i.endsWith("em")){const t=parseFloat(i),s=this.computeFontSize(e);return Math.floor(t*s)}if(i.endsWith("rem")||i.endsWith("px")||i.endsWith("pt"))return this.computeFontSize(e,i);if(i.endsWith("vw")){const e=parseFloat(i),t=window.innerWidth;return Math.floor(e*t)}if(i.endsWith("vh")){const e=parseFloat(i),t=window.innerHeight;return Math.floor(e*t)}if(i.endsWith("%")){const s=parseFloat(i),r=this.computeBaseBoxLength(e,t);return Math.floor(s*r/100)}return parseFloat(i)}static computeBorderWidth(e,t,s){const i=s||Ne.getValue(e,t);return ie.keywords.includes(i)?se[i]:this.computeBoxLength(e,t,i)}static computeBorderRadius(e,t,s){throw new Error("todo(compute border radius)")}}let Le={after:{initial:"auto",inherit:!1},"background-position":{initial:"0% 0%",inherit:!1},before:{initial:"auto",inherit:!1},"box-sizing":{initial:"content-box",inherit:!1},border:{initial:"medium none currentcolor",inherit:!1},"border-collapse":{initial:"collapse",inherit:!0},"border-style":{initial:"0 none black",inherit:!1},"border-color":{initial:i.defaultBorderColor,inherit:!1},"border-width":{initial:"0",inherit:!1},"border-before":{initial:"none",inherit:!1},"border-end":{initial:"none",inherit:!1},"border-after":{initial:"none",inherit:!1},"border-start":{initial:"none",inherit:!1},"border-before-width":{initial:"0",inherit:!1},"border-end-width":{initial:"0",inherit:!1},"border-after-width":{initial:"0",inherit:!1},"border-start-width":{initial:"0",inherit:!1},"border-before-color":{initial:i.defaultBorderColor,inherit:!1},"border-end-color":{initial:i.defaultBorderColor,inherit:!1},"border-after-color":{initial:i.defaultBorderColor,inherit:!1},"border-start-color":{initial:i.defaultBorderColor,inherit:!1},"border-before-style":{initial:"none",inherit:!1},"border-end-style":{initial:"none",inherit:!1},"border-after-style":{initial:"none",inherit:!1},"border-start-style":{initial:"none",inherit:!1},"border-radius":{initial:"0 0 0 0",inherit:!1},"border-before-start-radius":{initial:"0",inherit:!1},"border-before-end-radius":{initial:"0",inherit:!1},"border-after-end-radius":{initial:"0",inherit:!1},"border-after-start-radius":{initial:"0",inherit:!1},"break-after":{initial:"auto",inherit:!1},"break-before":{initial:"auto",inherit:!1},"caption-side":{initial:"before",inherit:!0},clear:{initial:"none",inherit:!1},color:{initial:"black",inherit:!0},content:{initial:"",inherit:!1},direction:{initial:"ltr",inherit:!0},display:{initial:"inline",inherit:!1},end:{initial:"auto",inherit:!1},extent:{initial:"auto",inherit:!1},float:{initial:"none",inherit:!1},font:{initial:i.defaultFont,inherit:!0},"font-family":{initial:i.defaultFontFamily,inherit:!0},"font-size":{initial:i.defaultFontSize+"px",inherit:!0},"font-size-adjust":{initial:"none",inherit:!0},"font-stretch":{initial:"normal",inherit:!0},"font-style":{initial:"normal",inherit:!0},"font-variant":{initial:"normal",inherit:!0},"font-weight":{initial:"normal",inherit:!0},"block-size":{initial:"auto",inherit:!1},height:{initial:"auto",inherit:!1},"letter-spacing":{initial:"normal",inherit:!0},"line-height":{initial:String(i.defaultLineHeight),inherit:!0},"list-style":{initial:"disc outside none",inherit:!0},"list-style-type":{initial:"disc",inherit:!0},"list-style-position":{initial:"outside",inherit:!0},"list-style-image":{initial:"none",inherit:!0},margin:{initial:"0",inherit:!1},"margin-before":{initial:"0",inherit:!1},"margin-end":{initial:"0",inherit:!1},"margin-after":{initial:"0",inherit:!1},"margin-start":{initial:"0",inherit:!1},"max-extent":{initial:"none",inherit:!1},"max-measure":{initial:"none",inherit:!1},measure:{initial:"auto",inherit:!1},"min-extent":{initial:"none",inherit:!1},"min-measure":{initial:"none",inherit:!1},"overflow-wrap":{initial:"normal",inherit:!0},page:{initial:"auto",inherit:!0},padding:{initial:"0",inherit:!1},"padding-before":{initial:"0",inherit:!1},"padding-end":{initial:"0",inherit:!1},"padding-after":{initial:"0",inherit:!1},"padding-start":{initial:"0",inherit:!1},"page-break-after":{initial:"auto",inherit:!1},"page-break-before":{initial:"auto",inherit:!1},position:{initial:"static",inherit:!1},size:{initial:"auto",inherit:!1},start:{initial:"auto",inherit:!1},"table-layout":{initial:"auto",inherit:!1},"text-align":{initial:"start",inherit:!0},"text-combine-upright":{initial:"none",inherit:!0},"text-emphasis-color":{initial:"currentcolor",inherit:!1},"text-emphasis-style":{initial:"none",inherit:!1},"text-emphasis-style-stroke":{initial:"none",inherit:!1},"text-emphasis-style-mark":{initial:"dot",inherit:!1},"text-decoration":{initial:"none",inherit:!1},"text-indent":{initial:"0",inherit:!0},"text-justify":{initial:"none",inherit:!0},"text-orientation":{initial:"mixed",inherit:!0},"text-shadow":{initial:"0",inherit:!1},"text-transform":{initial:"none",inherit:!0},"unicode-bidi":{initial:"normal",inherit:!1},"vertical-align":{initial:"baseline",inherit:!1},visibility:{initial:"inherit",inherit:!1},width:{initial:"auto",inherit:!1},"white-space":{initial:"normal",inherit:!0},"word-break":{initial:"normal",inherit:!0},"writing-mode":{initial:"horizontal-tb",inherit:!0}};class Me{static selectOrDefault(e,t,s){return r.Choice.select({name:e,value:t,values:s,initial:Me.getInitialValue(e)})}static get(e){let t=Le[e];if(!t)throw new Error("Invalid property:"+e);return t}static getInitialValue(e){return this.get(e).initial}static isInheritable(e){return this.get(e).inherit}}const Ie={"*[dir=ltr]":{direction:"ltr","unicode-bidi":"embed"},"*[dir=rtl]":{direction:"rtl","unicode-bidi":"embed"},abbr:{},address:{display:"block","font-style":"italic"},area:{display:"none"},article:{display:"block"},aside:{display:"block"},b:{display:"inline","font-weight":"bold"},base:{},bdi:{},bdo:{display:"inline","unicode-bidi":"bidi-override"},"bdo[dir=ltr]":{direction:"ltr","unicode-bidi":"bidi-override"},"bdo[dir=rtl]":{direction:"rtl","unicode-bidi":"bidi-override"},blockquote:{display:"block",margin:"1.12em 40px"},body:{display:"flow-root","font-size":"16px","overflow-wrap":"break-word",measure:i.defaultBodyMeasure+"px",extent:i.defaultBodyExtent+"px",margin:"0"},br:{display:"inline"},button:{},canvas:{},caption:{display:"table-caption","text-align":"center"},cite:{display:"inline","font-style":"italic"},code:{display:"inline","font-family":"monospace"},col:{display:"table-column"},colgroup:{display:"table-column-group"},datalist:{display:"none"},dd:{display:"block","margin-start":"40px"},del:{"text-decoration":"line-through"},details:{display:"block"},dfn:{display:"inline","font-style":"italic"},dialog:{},div:{display:"block"},dl:{display:"block","unicode-bidi":"embed",margin:"1em 0"},dt:{display:"block","unicode-bidi":"embed"},em:{display:"inline","font-style":"italic"},fieldset:{display:"block","unicode-bidi":"embed",margin:"0 2px",padding:"0.35em 0.75em 0.625em",border:"2px solid #ccc"},figcaption:{display:"block"},figure:{display:"block",margin:"1em 40px"},footer:{display:"block"},form:{display:"none","unicode-bidi":"embed","margin-before":"0"},h1:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":"2em","font-weight":"bold",margin:".67em 0"},h2:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":"1.5em","font-weight":"bold",margin:"0.75em 0"},h3:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":"1.17em","font-weight":"bold",margin:".83em 0"},h4:{display:"block","text-align":"start","unicode-bidi":"embed","font-weight":"bold",margin:"1.12em 0"},h5:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":".83em","font-weight":"bold",margin:"1.5em 0"},h6:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":".75em","font-weight":"bold",margin:"1.67em 0"},head:{display:"none"},header:{display:"block"},hr:{display:"block","unicode-bidi":"embed",margin:"0.5em auto","border-after-width":"1px","border-after-style":"inset"},html:{display:"block"},i:{display:"inline","font-style":"italic"},iframe:{display:"none"},img:{display:"inline"},input:{display:"none"},ins:{"text-decoration":"underline"},kbd:{display:"inline","font-family":"monospace"},label:{display:"inline",cursor:"default"},legend:{display:"block","padding-start":"2px","padding-end":"2px",border:"none"},li:{display:"list-item"},"li::marker":{"margin-end":"0.5em"},link:{display:"none"},main:{display:"block"},map:{display:"inline"},mark:{"background-color":"yellow",color:"black"},menu:{display:"block","unicode-bidi":"embed","list-style-type":"disc",margin:"1.12em 0","padding-start":"40px"},menuitem:{},meta:{display:"none"},meter:{},nav:{display:"block"},noscript:{display:"none"},object:{},ol:{display:"block","unicode-bidi":"embed","list-style-type":"decimal",margin:"1em 0","padding-start":"1em"},"ol ul, ul ol, ul ul, ol ol":{"margin-before":"0","margin-after":"0"},optgroup:{},option:{},output:{display:"inline"},p:{display:"block","unicode-bidi":"embed",margin:"1.12em 0"},param:{display:"none"},picture:{},pre:{display:"block","unicode-bidi":"embed","white-space":"pre",margin:"1em 0"},progress:{},q:{display:"inline"},"q::before":{content:"open-quote"},"q::after":{content:"close-quote"},rb:{display:"ruby-base","white-space":"nowrap","line-height":"1"},rbc:{display:"ruby-base-container"},rp:{display:"none"},rt:{display:"ruby-text","font-size":"0.5em","line-height":"1"},rtc:{display:"ruby-text-container"},ruby:{display:"ruby"},samp:{display:"inline","font-family":"monospace"},script:{display:"none"},section:{display:"block"},select:{display:"inline"},small:{display:"inline","font-size":"smaller"},source:{},span:{display:"inline"},strong:{display:"inline","font-weight":"bold"},style:{display:"none"},sub:{display:"inline","vertical-align":"sub","font-size":"smaller"},summary:{display:"block"},sup:{display:"inline","vertical-align":"super","font-size":"smaller"},svg:{display:"none"},table:{display:"table","border-collapse":"collapse","border-spacing":"2px","border-color":i.defaultTableBorderColor,"border-width":"1px","border-style":"solid","margin-after":"1em"},tbody:{display:"table-row-group","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},td:{display:"table-cell","vertical-align":"inherit","border-width":"1px","border-style":"solid","border-color":"inherit"},template:{},textarea:{display:"inline"},tfoot:{display:"table-footer-group","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},th:{display:"table-cell","vertical-align":"inherit","font-weight":"bold","text-align":"center","border-width":"1px","border-style":"solid","border-color":"inherit"},thead:{display:"table-header-group","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},time:{},title:{display:"none"},tr:{display:"table-row","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},track:{},ul:{display:"block","unicode-bidi":"embed","list-style-type":"disc",margin:"1em 0","padding-start":"1em"},var:{display:"inline","font-style":"italic"},video:{display:"block"},wbr:{},"::first-line":{display:"block"}};class Ae extends F{hasWord(){return this.tokens.findIndex((e=>e instanceof M))>=0}normalize(e,t){let s=e.replace(/&#x([0-9A-F]+);/gi,((e,t)=>String.fromCodePoint(r.atoi(t,16)))).replace(/&#([0-9]+);/gi,((e,t)=>String.fromCodePoint(r.atoi(t,10))));return t.isPre||(s=s.replace(/^\n+/,""),s=s.replace(/\n+$/,""),s=r.String.multiSpaceToSingle2(s)),s}getShy(){return 0!==this.buff.indexOf(b.softHyphen)?null:(this.stepBuff(b.softHyphen.length),b.softHyphen)}getWord(){let e="";for(;this.hasNextBuff();){let t=i.rexWord.exec(this.buff);if(t){e+=t[0],this.stepBuff(t[0].length);continue}let s=this.getShy();if(!s)break;e+=s}return""===e?null:new M(e)}getSpaceChar(){let e=i.rexSpaceCharRef.exec(this.buff);if(e){let t=e[0];this.stepBuff(t.length);let s=B.charRefToStr(t);return new B(s)}let t=i.rexSpace.exec(this.buff);if(t){let e=t[0];return this.stepBuff(e.length),new B(e)}return null}getRefChar(){let e=i.rexRefChar.exec(this.buff);if(!e)return null;let t=e[0];return this.stepBuff(t.length),new b(t)}getHalfChar(){let e=i.rexHalfChar.exec(this.buff);if(!e)return null;let t=e[0];return this.stepBuff(t.length),new x(t)}getSmpUniChar(){let e=this.buff.charCodeAt(0);if(55296<=e&&e<=56319){let e=this.buff.charCodeAt(1);if(e&&56320<=e&&e<=57343){let e=this.buff.substring(0,2);return this.stepBuff(2),new y(e)}}return null}getMixChar(e){let t=e,s=i.rexVoicedMark.exec(this.buff);return s?(t+=s[0],this.stepBuff(s[0].length),new I(t)):null}getDualChar(e){let t=class{static load(e){let t=r.String.getUnicodeProp(e);return m[t]||null}}.load(e);return t?new f(e,t):null}createToken(){const e=this.peekChar(),t=this.getDualChar(e);if(null!==t)return this.stepBuff(1),t;const s=this.getWord();if(null!==s)return s;const i=this.getSpaceChar();if(null!==i)return i;const r=this.getRefChar();if(null!==r)return r;const o=this.getHalfChar();if(null!==o)return o;const a=this.getSmpUniChar();if(null!==a)return a;const l=this.getChar(),c=this.getMixChar(l);if(null!==c)return c;const h=this.getDualChar(l);return null!==h?h:new n(l)}}class Ve extends Ae{createToken(){const e=new R(this.src);return this.stepBuff(this.src.length),e}}var Fe,Oe,Ue,$e,De,We,_e,He;!function(e){e.BLOCK="block",e.INLINE="inline",e.RUN_IN="run-in"}(Fe||(Fe={})),function(e){e.FLOW="flow",e.FLOW_ROOT="flow-root",e.TABLE="table",e.FLEX="flex",e.GRID="grid",e.RUBY="ruby"}(Oe||(Oe={})),function(e){e.LIST_ITEM="list-item"}(Ue||(Ue={})),function(e){e.TABLE_ROW_GROUP="table-row-group",e.TABLE_HEADER_GROUP="table-header-group",e.TABLE_FOOTER_GROUP="table-footer-group",e.TABLE_ROW="table-row",e.TABLE_CELL="table-cell",e.TABLE_COLUMN_GROUP="table-column-group",e.TABLE_COLUMN="table-column",e.TABLE_CAPTION="table-caption",e.RUBY_BASE="ruby-base",e.RUBY_TEXT="ruby-text",e.RUBY_BASE_CONTAINER="ruby-base-container",e.RUBY_TEXT_CONTAINER="ruby-text-container"}($e||($e={})),function(e){e.NONE="none",e.CONTENTS="contents"}(De||(De={})),function(e){e.NONE="none",e.CONTENTS="contents",e.BLOCK="block",e.INLINE="inline",e.INLINE_BLOCK="inline-block",e.FLOW_ROOT="flow-root",e.RUN_IN="run-in",e.LIST_ITEM="list-item",e.INLINE_LIST_ITEM="inline-list-item",e.FLEX="flex",e.INLINE_FLEX="inline-flex",e.GRID="grid",e.INLINE_GRID="inline-grid",e.RUBY="ruby",e.BLOCK_RUBY="block-ruby",e.TABLE="table",e.INLINE_TABLE="inline-table"}(We||(We={}));class qe{constructor(e){switch(qe.internalValues.includes(e)&&(this.internal=e),qe.listItemValues.includes(e)&&(this.listItem=e),qe.boxValues.includes(e)&&(this.box=e),this.value=Me.selectOrDefault("display",e,qe.allValues),this.value){case We.NONE:this.box=De.NONE;break;case We.CONTENTS:this.box=De.CONTENTS;break;case We.BLOCK:this.outside=Fe.BLOCK,this.inside=Oe.FLOW;break;case We.INLINE_BLOCK:this.outside=Fe.INLINE,this.inside=Oe.FLOW_ROOT;break;case We.FLOW_ROOT:this.outside=Fe.BLOCK,this.inside=Oe.FLOW_ROOT;break;case We.LIST_ITEM:this.outside=Fe.BLOCK,this.inside=Oe.FLOW,this.listItem=Ue.LIST_ITEM;break;case We.INLINE_LIST_ITEM:this.outside=Fe.INLINE,this.inside=Oe.FLOW,this.listItem=Ue.LIST_ITEM;break;case We.RUN_IN:this.outside=Fe.RUN_IN,this.inside=Oe.FLOW;break;case We.FLEX:this.outside=Fe.BLOCK,this.inside=Oe.FLEX;break;case We.INLINE_FLEX:this.outside=Fe.INLINE,this.inside=Oe.FLEX;break;case We.GRID:this.outside=Fe.BLOCK,this.inside=Oe.GRID;break;case We.INLINE_GRID:this.outside=Fe.INLINE,this.inside=Oe.GRID;break;case We.BLOCK_RUBY:this.outside=Fe.BLOCK,this.inside=Oe.RUBY;break;case We.RUBY:this.outside=Fe.INLINE,this.inside=Oe.RUBY;break;case We.TABLE:this.outside=Fe.BLOCK,this.inside=Oe.TABLE;break;case We.INLINE_TABLE:this.outside=Fe.INLINE,this.inside=Oe.TABLE;break;case $e.TABLE_ROW_GROUP:case $e.TABLE_HEADER_GROUP:case $e.TABLE_FOOTER_GROUP:case $e.TABLE_ROW:this.outside=Fe.BLOCK,this.inside=Oe.FLOW;break;case $e.TABLE_CELL:this.outside=Fe.INLINE,this.inside=Oe.FLOW_ROOT;break;case $e.TABLE_CAPTION:this.outside=Fe.BLOCK,this.inside=Oe.FLOW_ROOT;break;case We.INLINE:default:this.outside=Fe.INLINE,this.inside=Oe.FLOW}}static load(e){const t=Ne.getValue(e,"display"),s=new qe(t),i=ut.load(e),r=Pt.load(e);return(!i.isNone()||r.isAbsolute()||r.isFixed())&&s.setFlowRoot(),s.isInlineLevel()&&!i.isNone()&&s.setBlockLevel(),s}setBlockLevel(){this.outside=Fe.BLOCK}setFlowRoot(){this.inside=Oe.FLOW_ROOT}toString(){return this.value}isNone(){return!!this.box&&this.box===De.NONE}isContents(){return!!this.box&&this.box===De.CONTENTS}isListItem(){return!!this.listItem}isTable(){return!!this.inside&&this.inside===Oe.TABLE}isTableRowGroup(){if(!this.internal)return!1;switch(this.internal){case $e.TABLE_ROW_GROUP:case $e.TABLE_HEADER_GROUP:case $e.TABLE_FOOTER_GROUP:return!0}return!1}isTableRow(){return!!this.internal&&this.internal===$e.TABLE_ROW}isTableCell(){return!!this.internal&&this.internal===$e.TABLE_CELL}isBorderCollapsable(){return this.isTableRowGroup()||this.isTableRow()||this.isTableCell()}isRubyChild(){return this.isRubyBase()||this.isRubyText()}isRubyBase(){return!!this.internal&&this.internal===$e.RUBY_BASE}isRubyText(){return!!this.internal&&this.internal===$e.RUBY_TEXT}isFlow(){return this.isFlowInside()||this.isFlowRoot()}isInlineFlow(){return this.isInlineLevel()&&this.isFlowInside()}isBlockFlow(){return this.isBlockLevel()&&this.isFlowInside()}isInlineBlockFlow(){return this.isInlineLevel()&&this.isFlowRoot()}isFlowInside(){return!!this.inside&&this.inside===Oe.FLOW}isFlowRoot(){return!!this.inside&&this.inside===Oe.FLOW_ROOT}isFlowTable(){return!!this.inside&&this.inside===Oe.TABLE}isFlowRuby(){return!!this.inside&&this.inside===Oe.RUBY}isBlockLevel(){return!!this.outside&&this.outside===Fe.BLOCK}isInlineLevel(){return!!this.outside&&this.outside===Fe.INLINE}}qe.values=r.Enum.toValueArray(We),qe.listItemValues=r.Enum.toValueArray(Ue),qe.internalValues=r.Enum.toValueArray($e),qe.boxValues=r.Enum.toValueArray(De),qe.allValues=qe.values.concat(qe.listItemValues).concat(qe.internalValues).concat(qe.boxValues);class Ge{constructor(e,t,s){this.selector=e,this.name=t,this.callback=s}call(e,t,s){return this.callback({selector:this.selector,name:this.name,box:e,dom:t,flowRoot:s})}}class je{constructor(e){this.tokens=e||[]}get length(){return this.tokens.length}item(e){return this.tokens[e]}contains(e){return this.tokens.some((t=>t===e))}add(e){this.tokens.push(e)}remove(e){return this.tokens=this.tokens.filter((t=>t!==e))}replace(e,t){return this.tokens=this.tokens.map((s=>s===e?t:s))}supports(e){throw new Error("Sorry, not implemented yet")}toggle(e,t){let s=this.contains(e);return!0===t?(!1===s&&this.add(e),!0):!1===t?(!0===s&&this.remove(e),!1):!0===s?(this.remove(e),!1):(this.add(e),!0)}entries(){return this.tokens}keys(){return Object.keys(this.tokens)}values(){return this.tokens}forEach(e){Array.prototype.forEach.call(this.tokens,e)}}class Ke{constructor(e){this.selector=e.selector,this.name=e.name,this.element=e.element,this.parentContext=e.parentContext}setExternalDOM(e){this.element.$dom=e}get fontSize(){return ze.computeFontSize(this.element)}get remSize(){return this.parentContext instanceof Ks&&this.parentContext.pageRoot?this.parentContext.pageRoot.env.font.size:this.emSize}get emSize(){return ze.computeFontSize(this.element)}get lineHeight(){const e=this.element.computedStyle.getPropertyValue("line-height");if(!e)throw new Error("line-height is not defined!");return e.indexOf("px")<0?Math.floor(this.emSize*parseFloat(e)):r.atoi(e)}get restContextBoxExtent(){if(this.parentContext)return this.parentContext.restExtent;throw new Error("parent context is not defined")}}class Ze{constructor(e,t,s){this.selector=e,this.name=t,this.callback=s}call(e,t){const s=new Ke({selector:this.selector,name:this.name,element:e,parentContext:t}),i=this.callback(s)||{};if("string"==typeof i){const e={[this.name]:i};return ae.parseDeclarationBlock(this.selector,e)}return ae.parseDeclarationBlock(this.selector,i)}}!function(e){e.XX_SMALL="xx-small",e.X_SMALL="x-small",e.SMALL="small",e.MEDIUM="medium",e.LARGE="large",e.X_LARGE="x-large",e.XX_LARGE="xx-large"}(_e||(_e={})),function(e){e.SMALLER="smaller",e.LARGER="larger"}(He||(He={}));const Ye=r.Enum.toValueArray(_e),Xe=r.Enum.toValueArray(He),Je={"xx-small":8,"x-small":10,small:13,medium:16,large:18,"x-large":24,"xx-large":33},Qe={smaller:"0.8em",larger:"1.2em"};class et extends F{normalize(e){return e.trim()}peekQuotedString(){const e=et.rexQuotedString.exec(this.buff);if(e){const t=e[0];return this.stepBuff(t.length),t}return""}peekUntilSpace(){const e=this.buff.indexOf(" ");if(e<0){const e=this.buff;return this.stepBuff(this.buff.length),e}const t=this.buff.substring(0,e);return this.stepBuff(e+1),t}createToken(){return this.peekQuotedString()||this.peekUntilSpace()}}et.rexQuotedString=/^'[^']+'/;class tt{constructor(e){this.lexer=e}parseFontSize(e){return e.indexOf("/")<0?e:e.split("/")[0].trim()}parseLineHeight(e){return e.indexOf("/")<0?"normal":e.split("/")[1].trim()}inferOptPropByValue(e,t){if(/^[1-9]00$/.test(e))return"font-weight";if(e.indexOf("condensed")>=0||e.indexOf("expanded")>=0)return"font-stretch";const s=["font-style","font-variant","font-weight","font-stretch"];switch(e){case"normal":return s[t]||"font-style";case"italic":case"oblique":return"font-style";case"none":case"small-caps":return"font-variant";case"bold":case"lighter":case"bolder":return"font-weight"}return console.error(`invalid optinal value for shorthanded font css:${e}`),"font-style"}parse(){const e=this.lexer.src,t=this.lexer.tokens;if(t.length<2)return console.warn(`invalid font shorthand, both font-size and font-family must be specified: ${e}`),[];if(2===t.length){const e=this.parseFontSize(t[0]);return[{prop:"font-family",value:t[1]},{prop:"font-size",value:e},{prop:"line-height",value:this.parseLineHeight(t[0])}]}if(2<t.length&&t.length<6){const e=t.slice(0,-2),s=this.parseFontSize(t[t.length-2]),i=this.parseLineHeight(t[t.length-2]);let r=[{prop:"font-family",value:t[t.length-1]},{prop:"font-size",value:s},{prop:"line-height",value:i}];return e.forEach(((e,t)=>{const s=this.inferOptPropByValue(e,t);r.push({prop:s,value:e})})),r}const s=t[0],i=t[1],r=t[2],n=t[3],o=this.parseFontSize(t[4]),a=this.parseLineHeight(t[4]);return[{prop:"font-style",value:s},{prop:"font-variant",value:i},{prop:"font-weight",value:r},{prop:"font-stretch",value:n},{prop:"font-family",value:t[5]},{prop:"font-size",value:o},{prop:"line-height",value:a}]}}class st{constructor(){this.style=Me.getInitialValue("font-style"),this.variant=Me.getInitialValue("font-variant"),this.weight=Me.getInitialValue("font-weight"),this.stretch=Me.getInitialValue("font-stretch"),this.size=i.defaultFontSize,this.lineHeight=String(i.defaultLineHeight),this.family=i.defaultFontFamily}get css(){return[this.style,this.variant,this.weight,this.stretch,[this.size+"px",this.lineHeight].join("/"),this.family].join(" ")}get lineExtent(){return this.lineHeight.indexOf("px")>=0?r.atoi(this.lineHeight):Math.floor(parseFloat(this.lineHeight)*this.size)}static parseShorthand(e){const t=new et(e.value);return new tt(t).parse()}static load(e){let t=new st;return t.style=Ne.getValue(e,"font-style"),t.variant=Ne.getValue(e,"font-variant"),t.weight=Ne.getValue(e,"font-weight"),t.stretch=Ne.getValue(e,"font-stretch"),t.family=Ne.getValue(e,"font-family"),t.size=r.atoi(Ne.getValue(e,"font-size"),i.defaultFontSize),t.lineHeight=Ne.getValue(e,"line-height"),t}acceptCssEvaluator(e){return e.visitFont(this)}}class it extends O{constructor(e){super(),this.idName=e,this.specificity.a=1}toString(){return"#"+this.idName}test(e){return e.id===this.idName}}class rt{constructor(){this.headers={},this.rootSection=new nt,this.curSection=this.rootSection}getSectionAt(e){const t=this.rootSection.children;let s=this.rootSection;for(let i=0;i<t.length;i++){const r=t[i].getClosestSectionByPageIndex(e,s);if(r.pageIndex===e)return r;if(r.pageIndex>e)return s;s=r}return s}acceptEvaluator(e){return e.visitSectionRoot(this.rootSection)}createElement(e){return class{static parseSection(e,t){return t=t||{},e.isRoot()?this.parseSectionRoot(e,t):e.isNode()?this.parseSectionNode(e,t):this.parseSectionLeaf(e,t)}static parseSectionRoot(e,t){let s=t.onRoot?t.onRoot():document.createElement("ul");return this.appendSectionChildren(s,e.children,t),s}static parseSectionNode(e,t){let s=document.createElement("li"),i=document.createElement("ul"),r=t.onSection?t.onSection(e):document.createTextNode(e.title);return s.appendChild(r),this.appendSectionChildren(i,e.children,t),s.appendChild(i),s}static parseSectionLeaf(e,t){let s=document.createElement("li"),i=t.onSection?t.onSection(e):document.createTextNode(e.title);return s.appendChild(i),s}static appendSectionChildren(e,t,s){t.forEach((t=>{e.appendChild(this.parseSection(t,s))}))}}.parseSection(this.rootSection,e)}openElement(e,t){return nt.isSectioningRootElement(e)?this.openSectionRoot(e,t):nt.isSectioningElement(e)?this.openSection(t):nt.isHeaderElement(e)?this.openHeader(e,t):void 0}closeElement(e){return e&&!1===nt.isSectioningElement(e)?this.curSection:this.closeSection()}getHeaderSection(e){return this.headers[e.getPath(!0)]}openSectionRoot(e,t){return this.rootElement?(this.rootElement=e,this.openSection(t)):this.curSection}openSection(e){return this.curSection.closed?this.curSection=this.createNextSection(e):this.curSection=this.createSubSection(e),this.curSection}closeSection(){return this.curTitle,this.curSection.parent&&(this.curSection=this.curSection.parent),this.curSection}openHeader(e,t){return this.curSection=this.addHeader(e,t),this.curSection}get curTitle(){let e=this.curSection.closed?"(closed)":"(open)";return this.curSection.title+e}createContextSection(e,t){let s=new nt(t);return s.pageIndex=t?-1:e,t&&(this.headers[t.getPath(!0)]=s),s}createStandAloneSubSection(e,t){const s=this.createContextSection(e,t);return s.closed=!0,this.curSection.addChild(s),s}createSubSection(e,t){const s=this.createContextSection(e,t);return this.curSection.addChild(s),s}createNextSection(e,t){const s=this.createContextSection(e,t);return this.closeSection().addChild(s),s}closeHigherSection(e,t){return!e.parent||!e.parent.parent||e.level<=t?e:(e.closed=!0,this.closeHigherSection(e.parent,t))}createHigherSection(e,t,s){return this.curSection.parent&&(this.curSection=this.closeHigherSection(this.curSection.parent,s)),this.createNextSection(e,t)}addHeader(e,t){if(!this.curSection.header)return this.curSection.parent?(this.curSection.setHeader(e),this.curSection):this.createSubSection(t,e);const s=this.curSection.level,i=nt.getHeaderLevel(e);return i>s?this.createStandAloneSubSection(t,e):i===s?this.createNextSection(t,e):(this.curSection.closed=!0,this.createHigherSection(t,e,i))}}class nt{constructor(e){this.header=e,this.children=[],this.closed=!1,this.pageIndex=0}isRoot(){return!this.parent}isNode(){return this.children.length>0}isLeaf(){return 0===this.children.length}setHeader(e){this.header||(this.header=e)}addChild(e){return this.children.push(e),e.parent=this,this}get level(){return this.header?nt.getHeaderLevel(this.header):-1}get title(){return this.header?this.header.textContent:this.parent?"no title":"(root)"}getClosestSectionByPageIndex(e,t){if(this.pageIndex>=e)return this;let s=this;for(let t=0;t<this.children.length;t++){const i=this.children[t].getClosestSectionByPageIndex(e,s);if(i.pageIndex===e)return i;if(i.pageIndex>e)return s;s=i}return s}static isHeaderElement(e){switch(e.tagName){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":return!0}return!1}static getHeaderLevel(e){switch(e.tagName){case"h1":return 1;case"h2":return 2;case"h3":return 3;case"h4":return 4;case"h5":return 5;case"h6":return 6}throw new Error(`Invalid header:${e.tagName}`)}static isSectioningElement(e){switch(e.tagName){case"body":case"section":case"nav":case"article":case"aside":return!0}return!1}static isSectioningRootElement(e){switch(e.tagName){case"body":case"blockquote":case"fieldset":case"figure":case"td":return!0}return!1}}class ot{constructor(e){this.value=e}isOutside(){return"outside"===this.value}isInside(){return"inside"===this.value}static load(e){let t=Ne.getValue(e,"list-style-position");return new ot(t)}}let at={none:B.markerSpace,disc:"•",circle:"◦",square:"▪"};class lt{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,this.property);return new lt(t)}isNone(){return"none"===this.value}isTcyMarker(){return"decimal"===this.value}getMarkerText(e){switch(this.value){case"none":case"circle":case"disc":case"square":return at[this.value];case"decimal":return String(e+1)+".";default:return at.disc}}}lt.property="list-style-type";class ct{isNone(){return this.type_.isNone()}isPositionOutside(){return this.position.isOutside()}isPositionInside(){return this.position.isInside()}isTcyMarker(){return this.type_.isTcyMarker()}getMarkerText(e){return this.type_.getMarkerText(e)}getCssListMarkerHori(){let e=new kt;return e.set("display","inline-block"),e}getCssListBodyHori(){let e=new kt;return e.set("display","inline-block"),e}insertMarkerText(e){const t=e.firstChild;if(!t||t.tagName!==Mt.MARKER)return;if(t.firstChild&&t.firstChild.isTextElement())return;let s=this.getMarkerText(e.indexOfType);e.querySelector("li")&&(s=B.markerSpace);const i=e.root.createTextNode(s);t.appendChild(i)}static load(e){const t=new ct;return t.type_=lt.load(e),t.position=ot.load(e),t.image=ct.loadImage(e),t}static loadImage(e){return Ne.getValue(e,"list-style-image")}static inferProp(e){if(e.indexOf("url(")>=0)return"list-style-image";switch(e){case"inside":case"outside":return"list-style-position"}return"list-style-type"}static parseShorthand(e){let t={"list-style-image":"none","list-style-type":"none","list-style-position":"outside"};return e.split().forEach((e=>{const s=ct.inferProp(e);t[s]=e})),Object.keys(t).map((e=>({prop:e,value:t[e]})))}}class ht{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"clear");return new ht(t)}isNone(){return"none"===this.value}isStart(){return"start"===this.value}isEnd(){return"end"===this.value}isBoth(){return"both"===this.value}}class dt{constructor(e){this.start=e.start,this.before=e.before}static get zero(){return new dt(this.zeroValue)}static get zeroValue(){return{start:0,before:0}}zero(){this.start=0,this.before=0}clone(){return new dt({start:this.start,before:this.before})}cloneValue(){return{start:this.start,before:this.before}}get logicalPos(){return new yt({before:this.before,start:this.start})}toString(){return`(${this.start}, ${this.before})`}translate(e){return new dt({before:this.before+e.before,start:this.start+e.start})}acceptCssEvaluator(e){return e.visitPos(this)}}class ut{constructor(e){this.value="start"!==e&&"end"!==e&&"none"!==e?"none":e}isFloat(){return!1===this.isNone()}isStart(){return"start"===this.value}isEnd(){return"end"===this.value}isNone(){return"none"===this.value}static load(e){let t=Ne.getValue(e,"float");return new ut(t)}}class pt extends Map{get(e){const t=super.get(e);if(!t)throw new Error(`property(${e}) is not defined in map`);return t}}class gt{constructor(){this.horiTb=new pt,this.vertRl=new pt,this.vertLr=new pt}select(e){return e.isTextHorizontal()?this.horiTb:e.isVerticalRl()?this.vertRl:this.vertLr}}const mt=new class extends gt{constructor(){super(),this.horiTb.set("before","top"),this.horiTb.set("end","right"),this.horiTb.set("after","bottom"),this.horiTb.set("start","left"),this.vertRl.set("before","right"),this.vertRl.set("end","bottom"),this.vertRl.set("after","left"),this.vertRl.set("start","top"),this.vertLr.set("before","left"),this.vertLr.set("end","bottom"),this.vertLr.set("after","right"),this.vertLr.set("start","top")}},ft=new class extends gt{constructor(){super(),this.horiTb.set("before-start","top-left"),this.horiTb.set("before-end","top-right"),this.horiTb.set("after-end","bottom-right"),this.horiTb.set("after-start","bottom-left"),this.vertRl.set("before-start","top-right"),this.vertRl.set("before-end","bottom-right"),this.vertRl.set("after-end","bottom-left"),this.vertRl.set("after-start","top-left"),this.vertLr.set("before-start","top-left"),this.vertLr.set("before-end","bottom-left"),this.vertLr.set("after-end","bottom-right"),this.vertLr.set("after-start","top-right")}};class xt extends Y{static parseShorthand(e){let t=G.getValue4D(e.value);return[{prop:"margin-before",value:t[0]},{prop:"margin-end",value:t[1]},{prop:"margin-after",value:t[2]},{prop:"margin-start",value:t[3]}]}static load(e){return new xt(j.reduce(((t,s)=>(t[s]=Y.loadDirection(e,`margin-${s}`),t)),{}))}static get none(){return new xt(Y.zeroValue)}clone(){return new xt(this.values)}getPropByLogicalDirection(e){return`margin-${e}`}acceptCssEvaluator(e){return e.visitLogicalMargin(this)}}class bt extends Y{static parseShorthand(e){let t=G.getValue4D(e.value);return[{prop:"padding-before",value:t[0]},{prop:"padding-end",value:t[1]},{prop:"padding-after",value:t[2]},{prop:"padding-start",value:t[3]}]}static load(e){return new bt(j.reduce(((t,s)=>(t[s]=Y.loadDirection(e,`padding-${s}`),t)),{}))}static get none(){return new bt(Y.zeroValue)}clone(){return new bt(this.values)}getPropByLogicalDirection(e){return`padding-${e}`}acceptCssEvaluator(e){return e.visitLogicalMargin(this)}}class yt{constructor(e){this.before=e.before,this.end=e.end,this.after=e.after,this.start=e.start}static load(e){let t={};return t.before=this.loadEach(e,"before"),t.end=this.loadEach(e,"end"),t.after=this.loadEach(e,"after"),t.start=this.loadEach(e,"start"),new yt(t)}static loadEach(e,t){let s=Ne.getValue(e,t);return"auto"===s?void 0:r.atoi(s,10)}hasValue(){return void 0!==this.before||void 0!==this.end||void 0!==this.after||void 0!==this.start}acceptCssEvaluator(e){return e.visitLogicalPos(this)}}class vt{constructor(e){this.value=e}static load(e){const t=Ne.getValue(e,"background-position");return new vt(t)}acceptCssEvaluator(e){return e.visitBackgroundPos(this)}}class Et{constructor(e,t){this.pos=e,this.size=t}toString(){return`rect(${JSON.stringify({pos:this.pos,size:this.size})})`}canContain(e){return this.size.canContain(e)}translate(e){return new Et(this.pos.translate(e),this.size)}collideWith(e){const t=Math.abs(this.start-e.start),s=(this.measure+e.measure)/2,i=Math.abs(this.before-e.before),r=(this.extent+e.extent)/2;return t<s&&i<r}get extent(){return this.size.extent}set extent(e){this.size.extent=e}get measure(){return this.size.measure}set measure(e){this.size.measure=e}get start(){return this.pos.start}set start(e){this.pos.start=e}get before(){return this.pos.before}set before(e){this.pos.before=e}get end(){return this.pos.start+this.size.measure}get after(){return this.pos.before+this.size.extent}}class St{constructor(e){this.measure=e.measure,this.extent=e.extent}static load(e){let t=this.loadMeasure(e);if(null===t)return null;let s=this.loadExtent(e);return null===s?null:new St({measure:t,extent:s})}static loadMeasure(e){let t=e.computedStyle.getPropertyValue("measure")||"auto";return"auto"===t?null:r.atoi(t)}static loadExtent(e){let t=e.computedStyle.getPropertyValue("extent")||"auto";return"auto"===t?null:r.atoi(t)}static get zero(){return new St({measure:0,extent:0})}toString(){return`m:${this.measure}, e:${this.extent}`}clone(){return new St({measure:this.measure,extent:this.extent})}canContain(e){return this.measure>=e.measure&&this.extent>=e.extent}isZero(){return 0===this.measure&&0===this.extent}hasZero(){return 0===this.measure||0===this.extent}getPhysicalSize(e){return new Nt({width:this.getWidth(e),height:this.getHeight(e)})}getWidth(e){return e.isTextVertical()?this.extent:this.measure}getHeight(e){return e.isTextVertical()?this.measure:this.extent}resize(e){if(this.measure<=e.measure&&this.extent<=e.extent)return this.clone();const t={measure:this.measure,extent:this.extent},s=this.extent/this.measure,i=this.measure/this.extent;for(;t.measure>e.measure||t.extent>e.extent;){const r=t.measure-e.measure,n=t.extent-e.extent;r>n?(t.measure=e.measure,t.extent=t.extent-r*s):(t.extent=e.extent,t.measure=t.measure-n*i)}return new St({measure:Math.floor(t.measure),extent:Math.floor(t.extent)})}acceptCssEvaluator(e){return e.visitSize(this)}getCss(e){return e?this.getCssVert():this.getCssHori()}getCssVert(){const e=new kt;return e.set("width",this.extent+"px"),e.set("height",this.measure+"px"),e}getCssHori(){const e=new kt;return e.set("width",this.measure+"px"),e.set("height",this.extent+"px"),e}}class wt{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"text-align");return new wt(t)}isStart(){return"start"===this.value}isEnd(){return"end"===this.value}isCenter(){return"center"===this.value}isJustify(){return"justify"===this.value}}class Ct{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"vertical-align");return new Ct(t)}}class kt{constructor(){this._map=new Map}set(e,t){return this._map.set(e,t),this}delete(e){return this._map.delete(e),this}forEach(e){this._map.forEach(e)}mergeTo(e){return this.forEach(((t,s)=>{e.set(s,t)})),e}applyTo(e){return this._map.forEach(((t,s)=>{e.setProperty(s,t)})),this}}class Bt{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"overflow-wrap");return new Bt(t)}isNormal(){return"normal"===this.value}isBreakWord(){return"break-word"===this.value}}class Rt{constructor(e){this.value=e}isAlways(){return"always"===this.value}static load(e){let t=Ne.getValue(e,"page-break-after");return new Rt(t)}}class Tt{constructor(e){this.value=e}isAlways(){return"always"===this.value}static load(e){let t=Ne.getValue(e,"page-break-before");return new Tt(t)}}class Nt{constructor(e){this.width=e.width,this.height=e.height}static load(e){const t=e.getAttribute("width"),s=e.getAttribute("height"),i=t||e.computedStyle.getPropertyValue("width"),n=s||e.computedStyle.getPropertyValue("height"),o="auto"===i?0:r.atoi(t||i||"0"),a="auto"===n?0:r.atoi(s||n||"0");return new Nt({width:o,height:a})}getLogicalSize(e){return new St({measure:this.getMeasure(e),extent:this.getExtent(e)})}getExtent(e){return e.isTextVertical()?this.width:this.height}getMeasure(e){return e.isTextVertical()?this.height:this.width}getWidthPerHeight(){return 0===this.height?1:this.width/this.height}isZero(){return 0===this.width&&0===this.height}hasZero(){return 0===this.width||0===this.height}}class Pt{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"position");return new Pt(t)}isAbsolute(){return"absolute"===this.value}isRelative(){return"relative"===this.value}isStatic(){return"static"===this.value}isFixed(){return"fixed"===this.value}isSticky(){return"sticky"===this.value}}class zt extends O{constructor(e){super(),this.src=e,this.specificity.b=1}toString(){return":"+this.src}testEven(e){return(e.index+1)%2==0}testOdd(e){return!1===this.testEven(e)}getNthExpr(e){return e.replace(/\s/g,"").replace(/^nth-child\((.+)\)/,"$1")}testNthFuncExpr(e,t){let s=t.match(/\d+(?=n)/);if(!s)return console.error("invalid nth-child expr:%s",t),!1;let i=r.atoi(s[0]),n=t.replace(/\d+n/g,"").replace(/[+-]/g,""),o=n?r.atoi(n[0]):0;return 0===i?e===o:!(e<o)&&(e-o)%i==0}testNthExpr(e){let t=this.getNthExpr(this.src);return/^\d+$/.test(t)?e+1===r.atoi(t):this.testNthFuncExpr(e,t)}testNthChild(e){return this.testNthExpr(e.indexOfElement)}testMatch(e){throw new Error("pseudo-class 'match' is not implemented yet")}test(e){return"first-child"===this.src?e.isFirstElementChild():"last-child"===this.src?e.isLastElementChild():"odd"===this.src?this.testOdd(e):"even"===this.src?this.testEven(e):this.src.indexOf("nth-child(")>=0?this.testNthChild(e):this.src.indexOf("match(")>=0&&this.testMatch(e)}}class Lt extends O{constructor(e){super(),this.src=e,this.specificity.c=1,It.includes(this.tagName)||console.error("pseudo element("+this.pseudoName+") is not defined.")}toString(){return this.tagName}get pseudoName(){return this.src}get tagName(){return"::"+this.pseudoName}test(e){return e.tagName===this.tagName}}var Mt;!function(e){e.MARKER="::marker",e.BEFORE="::before",e.AFTER="::after",e.FIRST_LINE="::first-line",e.FIRST_LETTER="::first-letter"}(Mt||(Mt={}));const It=r.Enum.toValueArray(Mt);class At{static isPseudoElement(e){return"::"===e.tagName.substring(0,2)}static isFirstLine(e){return e.tagName===Mt.FIRST_LINE}}class Vt{static isReplacedElement(e){switch(e.tagName){case"img":case"video":case"iframe":return!0}return!1}}var Ft;class Ot{constructor(e){this.totalItemCount=e,this.successCount=0,this.errorCount=0}get progress(){return(this.successCount+this.errorCount)/this.totalItemCount}get percent(){return Math.floor(100*this.progress)}}class Ut{constructor(e,t){this.imageElements=e,this.context=t}load(e){return t=this,s=void 0,n=function*(){try{return yield Promise.all(this.imageElements.map((t=>{const s=t.$node;if(s.width&&s.height)return this.context.successCount++,e.onProgressImage&&e.onProgressImage(this.context),Promise.resolve(t);const i=this.getImageAttr(t.tagName);return this.loadImage(t,i,e)}))),e.onCompleteImage&&e.onCompleteImage(this.context),!0}catch(e){return i.debugImageLoader&&console.error(e),!1}},new((r=void 0)||(r=Promise))((function(e,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof r?s:new r((function(e){e(s)}))).then(o,a)}l((n=n.apply(t,s||[])).next())}));var t,s,r,n}getImageAttr(e){switch(e){case"video":return"poster";default:return"src"}}loadImage(e,t,s){return new Promise(((r,n)=>{const o=e.$node,a=document.createElement("img"),l=o.getAttribute(t);l&&a.setAttribute("src",l);const c=o.getAttribute("data-src");if(c&&a.setAttribute("data-src",c),!l&&!c)return i.debugImageLoader&&console.error("Invalid resource. Both src and data-src are not defined:",e),this.context.errorCount++,s.onProgressImage&&s.onProgressImage(this.context),void r(e);a.onload=t=>{o.setAttribute("width",String(a.width)),o.setAttribute("height",String(a.height)),i.debugImageLoader&&console.info("%s is successfully loaded(%dx%d)",a.src,a.width,a.height),this.context.successCount++,s.onProgressImage&&s.onProgressImage(this.context),r(e)},a.onerror=t=>{i.debugImageLoader&&console.error(t),this.context.errorCount++,s.onProgressImage&&s.onProgressImage(this.context),e.getAttribute("alt")||o.setAttribute("style","display:none"),r(e)}}))}}class $t{constructor(){this.cache={}}clear(){this.cache={}}hasCache(e){return void 0!==this.cache[e]}getCache(e){return this.cache[e]||[]}addCache(e,t){return this.hasCache(e)?this.cache[e].push(t):this.cache[e]=[t],t}}class Dt extends F{normalize(e){let t=e.trim();return t=r.String.multiSpaceToSingle(e),t=t.replace(/\s*([=>~+])\s*/g,"$1"),t}addToken(e){this.tokens.unshift(e)}createToken(){let e=this.peekChar();if(","===e)throw new Error("comma separator is not allowed");if("*"===e)return this.stepBuff(1),{type:Ft.UNIVERSAL_SELECTOR,value:e};let t=Dt.rexTypeSelector.exec(this.buff);if(null!==t){let e=t[0];return this.stepBuff(e.length),{type:Ft.TYPE_SELECTOR,value:e}}let s=Dt.rexClassSelector.exec(this.buff);if(null!==s){let e=s[0],t=e.substring(1);return this.stepBuff(e.length),{type:Ft.CLASS_SELECTOR,value:t}}let i=Dt.rexIdSelector.exec(this.buff);if(null!==i){let e=i[0],t=e.substring(1);return this.stepBuff(e.length),{type:Ft.ID_SELECTOR,value:t}}let r=Dt.rexAttrSelector.exec(this.buff);if(null!==r){let e=r[0],t=RegExp.$1;return this.stepBuff(e.length),{type:Ft.ATTR_SELECTOR,value:t}}let n=Dt.rexPseudoClass.exec(this.buff);if(null!==n){let e=n[0],t=e.substring(1);return this.stepBuff(e.length),{type:Ft.PSEUDO_CLASS,value:t}}let o=Dt.rexPseudoElement.exec(this.buff);if(null!==o){let e=o[0],t=e.substring(2);return this.stepBuff(e.length),this.src==e?{type:Ft.TYPE_SELECTOR,value:e}:{type:Ft.PSEUDO_ELEMENT,value:t}}switch(e){case" ":case"+":case"~":case">":return this.stepBuff(1),{type:Ft.COMBINATOR,value:e}}throw new Error(this.src)}}Dt.rexMediaSelector=/^@[a-z]*/,Dt.rexTypeSelector=/^[a-zA-Z][_a-zA-Z0-9-]*/,Dt.rexClassSelector=/^\.[_a-zA-Z][_a-zA-Z0-9-]*/,Dt.rexAttrSelector=/^\[(.*?)\]/,Dt.rexIdSelector=/^#[_a-zA-Z][_a-zA-Z0-9-]*/,Dt.rexPseudoClass=/^:[_a-z][_a-z0-9-]*[_a-z0-9-.,()]*/,Dt.rexPseudoElement=/^::[_a-z][_a-z0-9-]*/;class Wt{constructor(e){this.lexer=e}normalizeAttr(e){return e.trim().replace(/^\[/,"").replace(/\]$/,"").replace(/["']/g,"").replace(/\s/g,"")}parseAttrSelector(e){let t=this.normalizeAttr(e);if(t.indexOf("=")<0)return new we(t);let s=["*=","^=","$=","~=","|=","="];for(var i=0;i<s.length;i++){let e=s[i],r=t.split(e);if(r.length>=2)return new we(r[0],e,r[1])}throw new Error("syntax error(attribute selector)")}parseCompoundSelector(){let e=!0,t=0,s={classSelectors:[],pseudoClasses:[]};for(;e&&this.lexer.hasNext();){let i=this.lexer.getNext();switch(i.type){case Ft.UNIVERSAL_SELECTOR:s.univSelector=new Xt,t++;break;case Ft.TYPE_SELECTOR:s.typeSelector=new Yt(i.value),t++;break;case Ft.ID_SELECTOR:s.idSelector=new it(i.value),t++;break;case Ft.CLASS_SELECTOR:s.classSelectors.push(new ke(i.value)),t++;break;case Ft.ATTR_SELECTOR:s.attrSelector=this.parseAttrSelector(i.value),t++;break;case Ft.PSEUDO_CLASS:s.pseudoClasses.push(new zt(i.value)),t++;break;case Ft.PSEUDO_ELEMENT:s.pseudoElement=new Lt(i.value),t++;break;default:this.lexer.pushBack(1),e=!1}}if(0===t)throw new Error("syntax error. selector required");return new Re(s)}parseCombinator(){let e=this.lexer.getNext();if(e.type!==Ft.COMBINATOR)throw new Error("syntax error. combinator required.");return e.value}parse(){let e=[],t=[],s=null;for(;this.lexer.hasNext()&&(s||(s=this.parseCompoundSelector(),e.push(s)),this.lexer.hasNext());){let i=this.parseCombinator();if(t.push(i),!this.lexer.hasNext())throw new Error("missing left value for combinator["+i+"]");let r=this.parseCompoundSelector();e.push(r),s=r}return new Be(e,t)}}class _t{constructor(e){this.value=this.normalize(e)}toString(){return this.value}split(){return this.value.split(",")}normalize(e){let t=e.trim();return t=t.replace(/\s*,\s*/g,","),t=r.String.multiSpaceToSingle(t),t}}!function(e){e[e.UNIVERSAL_SELECTOR=0]="UNIVERSAL_SELECTOR",e[e.TYPE_SELECTOR=1]="TYPE_SELECTOR",e[e.CLASS_SELECTOR=2]="CLASS_SELECTOR",e[e.ID_SELECTOR=3]="ID_SELECTOR",e[e.ATTR_SELECTOR=4]="ATTR_SELECTOR",e[e.PSEUDO_CLASS=5]="PSEUDO_CLASS",e[e.PSEUDO_ELEMENT=6]="PSEUDO_ELEMENT",e[e.COMBINATOR=7]="COMBINATOR"}(Ft||(Ft={}));class Ht{constructor(e,t,s){this.a=e,this.b=t,this.c=s}static add(e,t){let s=new Ht(0,0,0);return s.a=e.a+t.a,s.b=e.b+t.b,s.c=e.c+t.c,s}static compare(e,t){return e.a>t.a?1:e.a<t.a?-1:e.b>t.b?1:e.b<t.b?-1:e.c>t.c?1:e.c<t.c?-1:0}incA(){return this.a++,this.a}incB(){return this.b++,this.b}incC(){return this.c++,this.c}}class qt{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"text-combine-upright");return new qt(t)}isNone(){return"none"===this.value}}const Gt={"filled dot":"•","open dot":"◦","filled circle":"●","open circle":"○","filled double-circle":"◉","open double-circle":"◎","filled triangle":"▲","open triangle":"△","filled sesame":"﹅","open sesame":"﹆"};class jt{constructor(e,t){this.stroke=e,this.mark=t}static isStrokeValue(e){return"filled"===e||"open"===e}static isMarkValue(e){return"dot"===e||"circle"===e||"double-circle"===e||"triangle"===e||"sesame"===e}static load(e){const t=Ne.getValue(e,this.property),s=new G({prop:this.property,value:t});let i="none",r="dot";return s.split().forEach((e=>{this.isStrokeValue(e)?i=e:this.isMarkValue(e)&&(r=e)})),new jt(i,r)}get values(){return[this.stroke,this.mark]}get scale(){switch(this.mark){case"circle":case"double-circle":case"triangle":case"sesame":return.5}return 1}get text(){const e=this.values.join(" ");return Gt[e]||"•"}isNone(){return"none"===this.stroke}}jt.property="text-emphasis-style";class Kt{constructor(){}static parseShorthand(e){let t=e.split(),s=[];if("none"===e.value||0===t.length)return s;let i="",r="",n="";t.forEach((e=>{jt.isStrokeValue(e)?i=e:jt.isMarkValue(e)?r=e:n=e}));let o=[i,r].join(" ").trim();return""!==o&&s.push({prop:"text-emphasis-style",value:o}),""!==n&&s.push({prop:"text-emphasis-color",value:n}),s}static load(e){let t=new Kt;return t.style=jt.load(e),t.color=Kt.loadColor(e),t}static loadColor(e){return Ne.getValue(e,"text-emphasis-color")}get textEmphaData(){return{text:this.text,styles:this.style.values,scale:this.style.scale}}get text(){return this.style.text}isNone(){return this.style.isNone()}}class Zt{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"text-orientation");return new Zt(t)}isSideways(){return"sideways"===this.value}isUpright(){return"upright"===this.value}isMixed(){return"mixed"===this.value}}class Yt extends O{constructor(e){super(),this.tagName=e,this.specificity.c=1}toString(){return this.tagName}test(e){return this.tagName===e.tagName}}class Xt extends O{toString(){return"*"}test(e){return!0}}class Jt{constructor(e){this.value=e}isPre(){return"pre"===this.value}static load(e){let t=Ne.getValue(e,"white-space");return new Jt(t)}static isWhiteSpaceElement(e){if(!e.isTextElement())return!1;let t=e.textContent;return!i.nonOmitWhiteSpaces.some((e=>t.indexOf(e)>=0))&&""===t.replace(/\s/gm,"")}}class Qt{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"word-break");return new Qt(t)}isNormal(){return"normal"===this.value}isBreakAll(){return"break-all"===this.value}isKeepAll(){return"keep-all"===this.value}}class es{constructor(e){this.value=e}static load(e){let t=Ne.getValue(e,"writing-mode");return new es(t)}isVerticalRl(){return"vertical-rl"===this.value}isVerticalLr(){return"vertical-lr"===this.value}isTextVertical(){return 0===this.value.indexOf("vertical")}isTextHorizontal(){return 0===this.value.indexOf("horizontal")}}class ts{constructor(e){this.createTitle=e}visitSectionRoot(e){const t=document.createElement("ul");return this.visitSectionChildren(e.children,t)}visitSectionNode(e){const t=document.createElement("li"),s=this.createTitle?this.createTitle(e):document.createTextNode(e.title);t.appendChild(s);const i=this.visitSectionChildren(e.children);return t.appendChild(i),t}visitSectionLeaf(e){const t=document.createElement("li"),s=this.createTitle?this.createTitle(e):document.createTextNode(e.title);return t.appendChild(s),t}visitSectionChildren(e,t){const s=t||document.createElement("ul");return e.forEach((e=>{e.isRoot()?s.appendChild(this.visitSectionRoot(e)):e.isNode()?s.appendChild(this.visitSectionNode(e)):s.appendChild(this.visitSectionLeaf(e))})),s}}function ss(e,t){const s=Ne.getValue(e,t);return"none"===s?s:parseInt(s,10)}class is{constructor(e,t){this.length=e,this.prop=t}static load(e,t){const s=function(e,t){const s=Ne.getValue(e,t);return"auto"===s?s:parseInt(s,10)}(e,t);return new is(s,t)}get number(){if("auto"===this.length)throw new Error("length is not resolved.");return this.length}set number(e){this.length=e}isAuto(){return"auto"===this.length}setAutoZero(){this.length="auto"===this.length?0:this.length}save(e){"auto"!==this.length&&e.setProperty(this.prop,this.length+"px")}}class rs{constructor(e,t,s,i){this.before=e,this.end=t,this.after=s,this.start=i}static load(e){return new rs(is.load(e,"before"),is.load(e,"end"),is.load(e,"after"),is.load(e,"start"))}save(e){this.before.save(e),this.end.save(e),this.after.save(e),this.start.save(e)}isAutoInline(){return this.start.isAuto()&&this.end.isAuto()}}class ns{constructor(e,t){this.minSize=e,this.prop=t}static load(e,t){return new ns(ss(e,t),t)}save(e){"none"!==this.minSize&&e.setProperty(this.prop,this.minSize+"px")}apply(e){return"none"!==this.minSize?Math.max(this.minSize,e):e}}class os{constructor(e,t){this.maxSize=e,this.prop=t}static load(e,t){return new os(ss(e,t),t)}save(e){"none"!==this.maxSize&&e.setProperty(this.prop,this.maxSize+"px")}apply(e){return"none"!==this.maxSize?Math.min(this.maxSize,e):e}}class as{constructor(e,t){this.minSize=e,this.maxSize=t}static load(e,t,s){return new as(ns.load(e,t),os.load(e,s))}save(e){this.minSize.save(e),this.maxSize.save(e)}apply(e){return this.maxSize.apply(this.minSize.apply(e))}}class ls{constructor(e,t){this.minMaxMeasure=e,this.minMaxExtent=t}static load(e){return new ls(as.load(e,"min-measure","max-measure"),as.load(e,"min-extent","max-extent"))}save(e){this.minMaxMeasure.save(e),this.minMaxExtent.save(e)}apply(e,t){return new St({measure:this.minMaxMeasure.apply(e),extent:this.minMaxExtent.apply(t)})}}class cs{constructor(e,t){this.measure=e,this.extent=t}static load(e){let t=is.load(e,"measure"),s=is.load(e,"extent");return e.parent||(t=t.isAuto()?new is(i.defaultBodyMeasure,"measure"):t,s=s.isAuto()?new is(i.defaultBodyExtent,"extent"):s),new cs(t,s)}save(e){this.measure.save(e),this.extent.save(e)}}class hs{constructor(e,t){this.width=e,this.height=t}static load(e){const t=this.loadPhysicalSize(e,"width"),s=this.loadPhysicalSize(e,"height");return new hs(t,s)}static loadPhysicalSize(e,t){let s=e.getAttribute(t);return s?new is(parseInt(s),t):is.load(e,t)}save(e){this.width.save(e),this.height.save(e)}}class ds{constructor(e,t,s,i){this.before=e,this.end=t,this.after=s,this.start=i}static load(e){return new ds(is.load(e,"margin-before"),is.load(e,"margin-end"),is.load(e,"margin-after"),is.load(e,"margin-start"))}save(e){this.before.save(e),this.end.save(e),this.after.save(e),this.start.save(e)}get measure(){return this.start.number+this.end.number}get extent(){return this.before.number+this.after.number}isAutoMeasure(){return this.start.isAuto()||this.end.isAuto()}isAutoExtent(){return this.before.isAuto()||this.after.isAuto()}clearAutoInline(){this.start.setAutoZero(),this.end.setAutoZero()}clearAutoBlock(){this.before.setAutoZero(),this.after.setAutoZero()}clearInline(){this.start.number=0,this.end.number=0}clearBlock(){this.before.number=0,this.after.number=0}}class us{constructor(e,t,s){this.padding=e,this.border=t,this.margin=s}static load(e){return new us(bt.load(e),re.load(e),ds.load(e))}save(e){this.margin.save(e)}get measure(){return this.borderBoxMeasure+this.margin.measure}get extent(){return this.borderBoxExtent+this.margin.extent}get borderBoxMeasure(){return this.border.width.measure+this.padding.measure}get borderBoxExtent(){return this.border.width.extent+this.padding.extent}}class ps{constructor(e,t,s,i,r,n,o,a){this.boxSizing=e,this.containingMeasure=t,this.containingExtent=s,this.logicalSize=i,this.physicalSize=r,this.position=n,this.edges=o,this.minMaxBoxSize=a}static load(e){const t=class{static getAbsAncestor(e){let t=e.parent;for(;t&&"static"===t.computedStyle.getPropertyValue("position");)t=t.parent;return t||e.ownerDocument.body}static getBlockAncestor(e){let t=e.parent;for(;t;){const e=qe.load(t);if(e.isBlockLevel()||e.isFlowRoot())return t;t=t.parent}return e.ownerDocument.body}static get(e){const t=Ne.getValue(e,"position");return"body"===e.tagName?e:e.parent?"absolute"===t||"fixed"===t?this.getAbsAncestor(e):qe.load(e).isBlockLevel()?this.getBlockAncestor(e):e.parent:e.ownerDocument.body}}.get(e),s=is.load(t,"measure"),i=is.load(t,"extent");if(!s.isAuto())return new ps(U.load(e),s.number,i,cs.load(e),hs.load(e),rs.load(e),us.load(e),ls.load(e))}save(e){this.logicalSize.save(e),this.physicalSize.save(e),this.position.save(e),this.edges.save(e),this.minMaxBoxSize.save(e)}get borderBoxMeasure(){if("auto"===this.logicalSize.measure.length)throw new Error("measure is not resolved.");return this.boxSizing.isBorderBox()?this.logicalSize.measure.length:this.boxSizing.isPaddingBox()?this.logicalSize.measure.length+this.edges.border.width.measure:this.logicalSize.measure.length+this.edges.borderBoxMeasure}}class gs{constructor(){}resolve(e,t,s){if(s.isTableRow()||s.isTableRowGroup()){const t=e.parent,s=Ce.load(e);if(t&&s.isCollapse())return parseInt(t.computedStyle.getPropertyValue("measure")||"0")}if("auto"===t.logicalSize.measure.length)return t.edges.margin.clearAutoInline(),void(t.logicalSize.measure.length=t.containingMeasure-t.edges.measure);const i=t.borderBoxMeasure;if(t.boxSizing.isBorderBox()?t.logicalSize.measure.length-=t.edges.borderBoxMeasure:t.boxSizing.isPaddingBox()&&(t.logicalSize.measure.length-=t.edges.padding.measure),i>t.containingMeasure&&t.edges.margin.clearInline(),t.edges.margin.isAutoMeasure()){const e=Math.floor((t.containingMeasure-t.logicalSize.measure.length)/2);t.edges.margin.start.length=t.edges.margin.end.length=e}}}gs.instance=new gs;class ms{constructor(){}resolve(e,t,s){if("auto"!==t.logicalSize.measure.length){if("auto"===t.edges.margin.start.length&&"auto"===t.edges.margin.end.length){const e=Math.floor((t.containingMeasure-t.logicalSize.measure.length)/2);t.edges.margin.start.length=t.edges.margin.end.length=e}else if("auto"===t.edges.margin.start.length&&"auto"!==t.edges.margin.end.length){const e=t.containingMeasure-t.logicalSize.measure.length-t.edges.margin.end.length;t.edges.margin.start.length=e}else if("auto"!==t.edges.margin.start.length&&"auto"===t.edges.margin.end.length){const e=t.containingMeasure-t.logicalSize.measure.length-t.edges.margin.start.length;t.edges.margin.end.length=e}}else t.edges.margin.clearAutoInline()}}ms.instance=new ms;class fs{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&(i.debugLayout&&console.info("auto measure for float element is not allowed in nehan, so use %dpx by default:",i.defaultFloatMeasure,e),t.logicalSize.measure.length=i.defaultFloatMeasure)}}fs.instance=new fs;class xs{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&(i.debugLayout&&console.info("auto measure for float element is not allowed in nehan, so use %dpx by default:",i.defaultFloatMeasure,e),t.logicalSize.measure.length=i.defaultFloatMeasure)}}xs.instance=new xs;class bs{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline()}}bs.instance=new bs;class ys{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline()}}ys.instance=new ys;class vs{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&"table-cell"!==e.computedStyle.getPropertyValue("display")&&(i.debugLayout&&console.info("auto measure for inline-block element is not allowed in nehan, so use %dpx by default:",i.defaultInlineBlockMeasure,e),t.logicalSize.measure.length=i.defaultInlineBlockMeasure)}}vs.instance=new vs;class Es{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&(i.debugLayout&&console.info("auto measure for inline-block element is not allowed in nehan, so use %dpx by default:",i.defaultInlineBlockMeasure,e),t.logicalSize.measure.length=i.defaultInlineBlockMeasure)}}Es.instance=new Es;class Ss{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline()}}Ss.instance=new Ss;class ws{constructor(){}resolve(e,t,s){t.edges.margin.clearAutoInline()}}function Cs(e){if(e.isTextElement())return!1;if(!ut.load(e).isNone())return!1;const t=Pt.load(e);return!t.isAbsolute()&&!t.isFixed()}function ks(e){let t=e.firstChild;for(;t&&t.isTextElement()&&Jt.isWhiteSpaceElement(t);)t=t.nextSibling;return t}function Bs(e){let t=e.lastChild;for(;t&&t.isTextElement()&&Jt.isWhiteSpaceElement(t);)t=t.previousSibling;return t}ws.instance=new ws;class Rs{static getMarginFromParentBlock(e){return parseInt(e.computedStyle.getPropertyValue("margin-start")||"0")}static getMarginFromLastInline(e){const t=e.previousSibling,s=parseInt(e.computedStyle.getPropertyValue("margin-start")||"0");return!t||t.isTextElement()?s:parseInt(t.computedStyle.getPropertyValue("margin-end")||"0")+s}}class Ts{static getLastChildren(e){let t=Bs(e),s=[];for(;t&&Cs(t)&&"0px"===t.computedStyle.getPropertyValue("border-after-width");)s.push(t),t=Bs(t);return s}static getFirstChildren(e){let t=ks(e),s=[];for(;t&&Cs(t)&&"0px"===t.computedStyle.getPropertyValue("border-before-width");)s.push(t),t=ks(t);return s}static getMaxMarginBefore(e){const t=this.getFirstChildren(e).concat(e);return Math.max(0,...t.map((e=>parseInt(e.computedStyle.getPropertyValue("margin-before")||"0"))))}static getMaxMarginAfter(e){const t=this.getLastChildren(e).concat(e);return Math.max(0,...t.map((e=>parseInt(e.computedStyle.getPropertyValue("margin-after")||"0"))))}static getFlowMarginFromLastElement(e,t,s){const i=t.context.env;if(i.position.isAbsolute())return 0;const r=s?s.context.env:void 0;if(!i.float.isNone()){if(!r)return parseInt(i.element.computedStyle.getPropertyValue("margin-before")||"0");if(!r.float.isNone())return 0;if(r.position.isAbsolute())return 0;if(s instanceof Ti||r.display.isInlineLevel())return 0;if(r.display.isBlockLevel()){const e=parseInt(i.element.computedStyle.getPropertyValue("margin-before")||"0");return this.getMaxMarginAfter(r.element)+e}}if(t instanceof Ti||i.display.isInlineLevel()){if(!r)return 0;if(!r.float.isNone())return 0;if(r.position.isAbsolute())return 0;if(s instanceof Ti||r.display.isInlineLevel())return 0;if(r.display.isBlockLevel())return this.getMaxMarginAfter(r.element)}if(i.display.isBlockLevel()){if(i.edge.border.width.before>0){if(r){const e=this.getMaxMarginAfter(r.element);return Math.max(i.edge.margin.before,e)}return i.edge.margin.before}const t=!e.display.isFlowRoot()&&e.display.isBlockLevel()&&!e.position.isAbsolute()&&e.float.isNone();if(!r&&t)return 0;const n=this.getMaxMarginBefore(i.element);if(!r)return n;if(s instanceof Ti||r.display.isInlineLevel())return n;if(!r.float.isNone())return n;if(r.position.isAbsolute())return n;if(r.display.isBlockLevel()){const e=this.getMaxMarginAfter(r.element);return Math.max(n,e)}}return 0}}class Ns{constructor(){this.state={before:!1,end:!1,after:!1,start:!1}}mask(e){j.forEach((t=>{e[t]=this.state[t]?e[t]:0}))}clear(){this.state.before=!1,this.state.end=!1,this.state.after=!1,this.state.start=!1}clearBlock(){this.state.before=!1,this.state.after=!1}addEdge(e){this.state[e]=!0}isEnable(e){return this.state[e]}}class Ps{constructor(e,t=new Ns){this.edgeSize=e,this.edgeState=t}mask(e){this.edgeState.mask(e)}clear(){this.edgeState.clear()}clearBlock(){this.edgeState.clearBlock()}addEdge(e){this.edgeState.addEdge(e)}getSize(e){return this.edgeState.isEnable(e)?this.edgeSize[e]:0}get measure(){return this.getSize("start")+this.getSize("end")}get extent(){return this.getSize("before")+this.getSize("after")}}class zs{constructor(e){this.envEdge=e,this.padding=new Ps(e.padding),this.margin=new Ps(e.margin),this.borderWidth=new Ps(e.border.width)}clear(){this.padding.clear(),this.margin.clear(),this.borderWidth.clear()}clearBlock(){this.padding.clearBlock(),this.margin.clearBlock(),this.borderWidth.clearBlock()}get currentBorder(){const e=this.envEdge.border.clone();return this.borderWidth.mask(e.width),e}get currentPadding(){const e=this.envEdge.padding.clone();return this.padding.mask(e),e}get currentMargin(){const e=this.envEdge.margin.clone();return this.margin.mask(e),e}get currentBorderBoxEdge(){const e=this.currentBorder,t=this.currentPadding,s=xt.none;return new ne({padding:t,border:e,margin:s})}get currentMarginBoxEdge(){const e=this.currentBorder,t=this.currentPadding,s=this.currentMargin;return new ne({padding:t,border:e,margin:s})}getBorderBoxEdgeSize(e){return this.borderWidth.getSize(e)+this.padding.getSize(e)}getMarginBoxEdgeSize(e){return this.borderWidth.getSize(e)+this.padding.getSize(e)+this.margin.getSize(e)}get borderBoxAfterSize(){return this.borderWidth.getSize("after")+this.padding.getSize("after")}get borderBoxStartSize(){return this.borderWidth.getSize("start")+this.padding.getSize("start")}get borderBoxBeforeSize(){return this.borderWidth.getSize("before")+this.padding.getSize("before")}get borderBoxMeasure(){return this.borderWidth.measure+this.padding.measure}get borderBoxExtent(){return this.borderWidth.extent+this.padding.extent}}class Ls{constructor(e,t){this.flowRootRegion=new Et(dt.zero,e),this.cursorBefore=t,this.startRects=[],this.endRects=[],this.startLedgePositions=new Set,this.endLedgePositions=new Set}toString(){return`FloatRegion(${this.flowRootRegion.toString()})`}isEmpty(){return 0===this.startRects.length&&0===this.endRects.length}get maxRegionExtent(){return Math.max(this.maxStartRegionExtent,this.maxEndRegionExtent)}pushStart(e,t,s){if(!1===this.flowRootRegion.canContain(t))throw new Error("FloatRegion:too large size");this.cursorBefore=Math.max(this.cursorBefore,e);const i=this.getSpaceMeasureAt(this.cursorBefore,s);if(0===this.startRects.length&&0===this.endRects.length&&t.measure>i)throw new Error("FloatRegion:too large size");if(t.measure<i){const e=this.getStartSideRect(this.cursorBefore),s=e?e.end:0,i=this.cursorBefore,r=new dt({start:s,before:i});return this.pushStartRect(new Et(r,t))}const r=this.getSkipExtentAt(this.cursorBefore);if(this.cursorBefore+=r,this.cursorBefore+t.extent>=this.flowRootRegion.extent)throw new Error("FloatRegion:no more space left.");return this.pushStart(this.cursorBefore,t)}pushEnd(e,t,s){if(!1===this.flowRootRegion.canContain(t))throw new Error("FloatRegion:too large size");this.cursorBefore=Math.max(this.cursorBefore,e);const i=this.getSpaceMeasureAt(this.cursorBefore,s);if(0===this.startRects.length&&0===this.endRects.length&&t.measure>i)throw new Error("FloatRegion:too large size");if(t.measure<i){const e=this.getEndSideRect(this.cursorBefore),i=this.getMaxMeasure(s),r=e?e.start-t.measure:i-t.measure,n=new dt({start:r,before:this.cursorBefore});return this.pushEndRect(new Et(n,t))}const r=this.getSkipExtentAt(this.cursorBefore);if(this.cursorBefore+=r,this.cursorBefore+t.extent>=this.flowRootRegion.extent)throw new Error("FloatRegion:no more space left.");return this.pushEnd(this.cursorBefore,t)}clearBoth(){const e=Math.max(this.maxStartRegionExtent,this.maxEndRegionExtent);return this.startRects=[],this.endRects=[],this.startLedgePositions.clear(),this.endLedgePositions.clear(),this.cursorBefore=e,e}clearStart(){const e=this.maxStartRegionExtent;return this.startRects=[],this.startLedgePositions.clear(),this.cursorBefore=e,e}clearEnd(){const e=this.maxEndRegionExtent;return this.endRects=[],this.endLedgePositions.clear(),this.cursorBefore=e,e}getSpacePosFromStartBound(e){let t=this.getStartSideRect(e);return t?t.end:0}getSpaceMeasureAt(e,t){return this.getMaxMeasure(t)-this.getSideRectMeasureAt(e)}hasSpaceForSize(e,t,s){if(this.getSpaceMeasureAt(e,s)<t.measure)return!1;const i=new dt({start:this.getSpacePosFromStartBound(e),before:e}),r=new Et(i,t);return this.allRects.filter((t=>t.after>e)).every((e=>!r.collideWith(e)))}findSpace(e,t,s){if(this.hasSpaceForSize(e,t)){const t=this.getSpacePosFromStartBound(e);return new dt({before:e,start:t})}const i=this.ledgePositions.filter((t=>t>e)).find((e=>this.hasSpaceForSize(e,t,s)));if(void 0===i)return;const r=this.getSpacePosFromStartBound(i);return new dt({before:i,start:r})}getSideRectMeasureAt(e){return this.getStartSideRectMeasure(e)+this.getEndSideRectMeasure(e)}getMaxMeasure(e){return Math.min(this.flowRootRegion.measure,e||1/0)}getSkipExtentAt(e){if(0===this.startRects.length&&0===this.endRects.length)return 0;const t=this.startRects[this.startRects.length-1],s=this.endRects[this.endRects.length-1];return t?s?t.after<s.after?t.extent:s.extent:t.extent:s.extent}get ledgePositions(){const e=new Set;this.startLedgePositions.forEach((t=>e.add(t))),this.endLedgePositions.forEach((t=>e.add(t)));const t=[];return e.forEach((e=>t.push(e))),t.sort()}addLedgePos(e,t,s){t?t.before===s.before?(s.extent>t.extent&&e.delete(t.after),e.add(s.after)):(t.measure===s.measure&&e.delete(t.after),e.add(s.after)):(e.add(0),e.add(s.after))}pushStartRect(e){const t=this.startRects[this.startRects.length-1];return this.addLedgePos(this.startLedgePositions,t,e),this.startRects.push(e),e}pushEndRect(e){const t=this.endRects[this.endRects.length-1];return this.addLedgePos(this.endLedgePositions,t,e),this.endRects.push(e),e}get allRects(){return this.startRects.concat(this.endRects)}get maxStartRegionExtent(){return this.getMaxSideCursorBeforeFrom(this.startRects)}get maxEndRegionExtent(){return this.getMaxSideCursorBeforeFrom(this.endRects)}getStartSideRect(e){return this.getSideRect(this.startRects,e)}getEndSideRect(e){return this.getSideRect(this.endRects,e)}getStartSideRectMeasure(e){let t=this.getStartSideRect(e);return t?t.end:0}getEndSideRectMeasure(e){let t=this.getEndSideRect(e);return t?this.flowRootRegion.measure-t.start:0}getMaxSideCursorBeforeFrom(e){return e.reduce(((e,t)=>Math.max(e,t.after)),this.cursorBefore)}getSideRect(e,t){for(let s=e.length-1;s>=0;s--){let i=e[s];if(i.before<=t&&t<i.after)return i}return null}}class Ms{constructor(e){this.writingMode=e}visitUnmanagedCssProps(e){const t=new kt;return i.unmanagedCssProps.forEach((s=>{const i=e.getPropertyValue(s);null!==i&&t.set(s,i)})),t}visitFont(e){const t=new kt;return t.set("font-style",e.style),t.set("font-variant",e.variant),t.set("font-weight",e.weight),t.set("font-stretch",e.stretch),t.set("font-size",e.size+"px"),t.set("font-family",e.family),t}visitColor(e){const t=new kt;return t.set("color",e.value),t}visitSizeHori(e){const t=new kt;return t.set("width",e.measure+"px"),t.set("height",e.extent+"px"),t}visitSizeVert(e){const t=new kt;return t.set("width",e.extent+"px"),t.set("height",e.measure+"px"),t}visitSize(e){return this.writingMode.isTextHorizontal()?this.visitSizeHori(e):this.visitSizeVert(e)}visitPosHori(e){const t=new kt;return t.set("top",e.before+"px"),t.set("left",e.start+"px"),t}visitPosVertLtr(e){const t=new kt;return t.set("top",e.start+"px"),t.set("left",e.before+"px"),t}visitPosVertRtl(e){const t=new kt;return t.set("top",e.start+"px"),t.set("right",e.before+"px"),t}visitPos(e){return this.writingMode.isTextHorizontal()?this.visitPosHori(e):this.writingMode.isVerticalRl()?this.visitPosVertRtl(e):this.visitPosVertLtr(e)}visitBackgroundPos(e){const t=new kt;let s=e.value;return mt.select(this.writingMode).forEach(((e,t)=>{s=s.replace(e,t)})),t.set("background-position",s),t}visitLogicalMargin(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,s)=>t.set(e.getPropByLogicalDirection(s.prop),s.value+"px")),new kt)}visitLogicalPadding(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,s)=>t.set(e.getPropByLogicalDirection(s.prop),s.value+"px")),new kt)}visitLogicalBorderColor(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,s)=>t.set(e.getPropByLogicalDirection(s.prop),String(s.value))),new kt)}visitLogicalBorderWidth(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,s)=>t.set(e.getPropByLogicalDirection(s.prop),s.value+"px")),new kt)}visitLogicalBorderStyle(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,s)=>t.set(e.getPropByLogicalDirection(s.prop),String(s.value))),new kt)}visitLogicalBorderRadius(e,t){const s=ft.select(this.writingMode);return e.items.reduce(((e,i)=>i.prop.indexOf("before")>=0&&t.before<=0||i.prop.indexOf("after")>=0&&t.after<=0?e:e.set(`border-${s.get(i.prop)}-radius`,String(i.value))),new kt)}visitLogicalPos(e){const t=new kt,s=mt.select(this.writingMode);return void 0!==e.before&&t.set(s.get("before"),e.before+"px"),void 0!==e.end&&t.set(s.get("end"),e.end+"px"),void 0!==e.after&&t.set(s.get("after"),e.after+"px"),void 0!==e.start&&t.set(s.get("start"),e.start+"px"),t}}class Is{constructor(){}getJustifyTargetChars(e){return e.reduce(((e,t)=>t instanceof Os?e.concat(t.children):t instanceof Ds?e.concat(this.getJustifyTargetChars(t.children)):e),[])}justify(e){const t=e.env.font.size/4,s=e.env.font.size,r=e.size.measure-e.autoSize.measure;if(r<t||r>s)return;const n=this.getJustifyTargetChars(e.children);if(n.length<=1)return;const o=r/(n.length-1);o>=i.maxJustifyGap||n.forEach((e=>e.spacing=o))}}Is.instance=new Is;class As{constructor(e,t,s){this.pageRoot=e,this.cssVisitor=t,this.textJustifier=s}visitChar(e){return document.createTextNode(e.text)}visitCharEmpha(e,t){const s=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");return i.appendChild(document.createTextNode(t.text)),r.appendChild(document.createTextNode(e.text)),t.scale<1&&(i.style.fontSize=String(t.scale)+"em",i.style.paddingBottom=String(t.scale/2)+"em"),s.style.display="inline-block",s.style.textAlign="center",s.appendChild(i),s.appendChild(r),s}visitRefChar(e){return document.createTextNode(e.text)}visitRefCharEmpha(e,t){return this.visitCharEmpha(e,t)}visitSpaceChar(e){const t=document.createElement("span");return t.style.display="inline-block",t.style.width=e.size.measure+"px",t.appendChild(document.createTextNode(e.text)),t}visitHalfChar(e){return document.createTextNode(e.text)}visitMixChar(e){const t=document.createElement("span");return t.style.display="inline-block",t.style.width="1.25em",t.appendChild(document.createTextNode(e.text)),t}visitDualChar(e){return document.createTextNode(e.text)}visitDualCharKern(e){const t=document.createElement("span");return t.style.marginLeft="-0.5em",t.appendChild(document.createTextNode(e.text)),t}visitSmpUniChar(e){return document.createTextNode(e.text)}visitTcy(e){return document.createTextNode(e.text)}visitWord(e){return document.createTextNode(e.text)}visitText(e){const t=document.createElement("div");return t.className="nehan-text",t.style.display="inline-block",t.style.lineHeight="1",e.children.forEach((e=>{const s=e.acceptEvaluator(this);if(e.spacing){const i=document.createElement("span");i.style.paddingRight=e.spacing+"px",i.appendChild(s),t.appendChild(i)}else t.appendChild(s)})),t.normalize(),t}visitRuby(e){const t=document.createElement("div");t.className="nehan-ruby";const s=document.createElement("div").appendChild(e.rb.acceptEvaluator(this)),i=document.createElement("div").appendChild(e.rt.acceptEvaluator(this));return s.style.display="block",i.style.display="block",i.style.lineHeight="1",t.appendChild(i),t.appendChild(s),t.style.display="inline-block",t.style.textAlign="center",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitLine(e){const t=document.createElement("div");t.className="nehan-line",t.style.boxSizing="content-box",t.style.position="absolute",t.style.overflow="visible",t.style.top=e.linePos.before+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style);const s=document.createElement("div");return s.className="nehan-baseline",s.style.position="absolute",s.style.left=e.linePos.start+e.baseline.startOffset+"px",s.style.width=e.size.measure+2*e.env.font.size+"px",s.style.height=e.baseline.size.extent+"px",s.style.bottom=e.baseline.blockOffset+"px",e.env.textAlign.isJustify()&&this.textJustifier.justify(e),t.appendChild(s),e.children.forEach((e=>{s.appendChild(e.acceptEvaluator(this))})),t}visitInline(e){const t=this.pageRoot.createElement("span",["inline"],e);return t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineEmpha(e){const t=this.pageRoot.createElement("span",["inline","empha"],e);return t.style.display="inline-block",t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineBlock(e){const t=this.pageRoot.createElement("span",["iblock"],e);return t.style.display="inline-block",t.style.boxSizing="content-box",t.style.position="relative",t.style.paddingLeft=e.env.edge.padding.start+"px",t.style.paddingRight=e.env.edge.padding.end+"px",t.style.marginLeft=e.env.edge.margin.start+"px",t.style.marginRight=e.env.edge.margin.end+"px",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlock(e){const t=this.pageRoot.createElement("div",["block"],e);return t.style.boxSizing="content-box",t.style.position=e.env.element.tagName===i.pageRootTagName?"relative":"absolute",t.style.paddingLeft=e.env.edge.padding.start+"px",t.style.paddingRight=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitRootBlock(e){const t=this.pageRoot.createElement("div",["root"],e),s=ne.loadBoxEdge(e.env.element);return t.className="nehan-root",t.style.width=e.measure+s.measure+"px",t.style.height=e.extent+s.extent+"px",s.margin.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),s.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),s.padding.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitTableCells(e){const t=this.pageRoot.createElement("div",["table-cells"],e);return t.style.boxSizing="content-box",t.style.position="absolute",e.rowPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockImage(e){const t=this.pageRoot.createElement("img",["block"],e);return t.style.position="absolute",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineImage(e){const t=this.pageRoot.createElement("img",["inline"],e);return t.style.display="inline",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",t.style.verticalAlign="bottom",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitBlockVideo(e){const t=e.env.element.$node.cloneNode(!0);return t.setAttribute("width",String(e.physicalSize.width)),t.setAttribute("height",String(e.physicalSize.height)),t.removeAttribute("style"),t.style.position="absolute",t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",t.style.verticalAlign="bottom",e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineVideo(e){const t=this.pageRoot.createElement("span",["inline"],e);return t.style.display="none",t.style.width="0",t.style.height="0",t.innerHTML="Sorry, inline video is not supported yet!",t}visitBlockReFixed(e,t){const s=this.pageRoot.createElement("div",["block"],e);return s.style.position="absolute",s.style.width=e.physicalSize.width+"px",s.style.height=e.physicalSize.height+"px",s.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(s.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),s}visitInlineReFixed(e,t){const s=this.pageRoot.createElement("div",["inline"],e);return s.style.display="inline-block",s.style.width=e.physicalSize.width+"px",s.style.height=e.physicalSize.height+"px",s.style.marginLeft=e.edge.margin.start+"px",s.style.marginRight=e.edge.margin.end+"px",s.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),s}visitInlineLink(e){const t=this.pageRoot.createElement("a",["inline"],e);return t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockLink(e){const t=this.pageRoot.createElement("a",["block"],e);return t.style.boxSizing="content-box",t.style.position="absolute",t.style.paddingLeft=e.env.edge.padding.start+"px",t.style.paddingRight=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{const s=e.acceptEvaluator(this);t.appendChild(s)})),t}}class Vs{constructor(e,t,s){this.pageRoot=e,this.cssVisitor=t,this.textJustifier=s}isReOrIblock(e){return e instanceof Gs||e instanceof _s||e instanceof Ds&&e.children.some((e=>this.isReOrIblock(e)))}visitChar(e){return document.createTextNode(e.text)}visitCharEmpha(e,t){const s=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");return r.appendChild(document.createTextNode(e.text)),i.appendChild(document.createTextNode(t.text)),t.scale<1&&(i.style.fontSize=String(t.scale)+"em",i.style.paddingLeft=String(t.scale/2)+"em"),s.style.textAlign="center",s.style.display="flex",s.style.alignItems="center",s.appendChild(r),s.appendChild(i),s}visitRefChar(e){return document.createTextNode(e.text)}visitRefCharEmpha(e,t){return this.visitCharEmpha(e,t)}visitSpaceChar(e){const t=document.createElement("div");return t.style.height=e.size.measure+"px",t}visitHalfChar(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e.text)),t.style.textAlign="center",t.style.width="1em",t}visitMixChar(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e.text)),t}visitDualChar(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.appendChild(document.createTextNode(e.text)),t}visitDualCharKern(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.style.marginTop="-0.5em",t.appendChild(document.createTextNode(e.text)),t}visitSmpUniChar(e){return document.createTextNode(e.text)}visitTcy(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.style.textCombineUpright="all",t.style.setProperty("-webkit-text-combine","horizontal"),t.appendChild(document.createTextNode(e.text)),t}visitWord(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.style.textOrientation="sideways",t.appendChild(document.createTextNode(e.text)),t}visitText(e){const t=document.createElement("div");return t.className="nehan-text",t.style.lineHeight="1",e.children.forEach((e=>{const s=e.acceptEvaluator(this);if(t.appendChild(s),s instanceof Text&&t.appendChild(document.createElement("br")),e.spacing){const s=document.createElement("div");s.style.height=e.spacing+"px",s.appendChild(document.createTextNode(" ")),t.appendChild(s)}})),t.normalize(),t}visitRuby(e){const t=document.createElement("div");t.className="nehan-ruby";const s=document.createElement("div").appendChild(e.rb.acceptEvaluator(this)),i=document.createElement("div").appendChild(e.rt.acceptEvaluator(this));return t.appendChild(s),t.appendChild(i),t.style.display="flex",t.style.textAlign="center",t.style.alignItems="center",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitLine(e){const t=e.env.writingMode.isVerticalLr()?"left":"right",s=document.createElement("div");s.className="nehan-line",s.style.boxSizing="content-box",s.style.position="absolute",s.style.overflow="visible",s.style[t]=e.linePos.before+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(s.style);const i=document.createElement("div");return i.className="nehan-baseline",i.style.position="absolute",i.style.top=e.linePos.start+e.baseline.startOffset+"px",i.style.height="100%",i.style.width=e.baseline.size.extent+"px",i.style.left=e.baseline.blockOffset+"px",s.appendChild(i),e.env.textAlign.isJustify()&&this.textJustifier.justify(e),e.children.forEach((t=>{const s=t.acceptEvaluator(this),r=this.isReOrIblock(t)?t.extent:t.env.font.size,n=Math.floor((e.baseline.textBodySize.extent-r)/2);if(0===n)i.appendChild(s);else{const e=document.createElement("div");e.style.marginLeft=Math.max(0,n)+"px",e.appendChild(s),i.appendChild(e)}})),s}visitInline(e){const t=this.pageRoot.createElement("div",["inline"],e);return t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineEmpha(e){const t=this.pageRoot.createElement("div",["inline","empha"],e);return t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineBlock(e){const t=this.pageRoot.createElement("div",["iblock"],e);return t.style.boxSizing="content-box",t.style.position="relative",t.style.paddingTop=e.env.edge.padding.start+"px",t.style.paddingBottom=e.env.edge.padding.end+"px",t.style.marginTop=e.env.edge.margin.start+"px",t.style.marginBottom=e.env.edge.margin.end+"px",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlock(e){const t=this.pageRoot.createElement("div",["block"],e);return t.style.boxSizing="content-box",t.style.position=e.env.element.tagName===i.pageRootTagName?"relative":"absolute",t.style.paddingTop=e.env.edge.padding.start+"px",t.style.paddingBottom=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitRootBlock(e){const t=this.pageRoot.createElement("div",["root"],e),s=ne.loadBoxEdge(e.env.element);return t.style.width=e.extent+s.extent+"px",t.style.height=e.measure+s.measure+"px",s.margin.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),s.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),s.padding.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitTableCells(e){const t=this.pageRoot.createElement("div",["table-cells"],e);return t.style.boxSizing="content-box",t.style.position="absolute",e.rowPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockImage(e){const t=this.pageRoot.createElement("img",["block"],e);return t.style.position="absolute",t.style.display="block",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineImage(e){const t=this.pageRoot.createElement("img",["inline"],e);return t.style.display="block",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitBlockVideo(e){const t=e.env.element.$node.cloneNode(!0);return t.setAttribute("width",String(e.physicalSize.width)),t.setAttribute("height",String(e.physicalSize.height)),t.removeAttribute("style"),t.style.position="absolute",t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineVideo(e){const t=this.pageRoot.createElement("div",["inline"],e);return t.style.display="none",t.style.width="0",t.style.height="0",t.innerHTML="Sorry, inline video is not supported yet!",t}visitBlockReFixed(e,t){const s=this.pageRoot.createElement("div",["block"],e);return s.style.position="absolute",s.style.width=e.physicalSize.width+"px",s.style.height=e.physicalSize.height+"px",s.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(s.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),s}visitInlineReFixed(e,t){const s=this.pageRoot.createElement("div",["inline"],e);return s.style.display="block",s.style.width=e.physicalSize.width+"px",s.style.height=e.physicalSize.height+"px",s.style.marginLeft=e.edge.margin.start+"px",s.style.marginRight=e.edge.margin.end+"px",s.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(s.style),s}visitInlineLink(e){const t=this.pageRoot.createElement("a",["inline"],e);return t.style.textDecoration="none",t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockLink(e){const t=this.pageRoot.createElement("a",["block"],e);return t.style.boxSizing="content-box",t.style.position="absolute",t.style.paddingTop=e.env.edge.padding.start+"px",t.style.paddingBottom=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{const s=e.acceptEvaluator(this);t.appendChild(s)})),t}}class Fs{constructor(e){this.pageRoot=e}visitNode(e){e.dom&&e.env.element.style.hasDomCallbacks()&&e.env.element.style.callDomCallbacks(e,e.dom,this.pageRoot)}visitTree(e){this.visitNode(e),this.visitChildren(e.children)}visitChildren(e){e.forEach((e=>e.acceptEffector(this)))}visitLine(e){this.visitChildren(e.children)}visitRuby(e){this.visitNode(e),this.visitNode(e.rt),this.visitNode(e.rb)}visitInline(e){this.visitTree(e)}visitBlock(e){this.visitTree(e)}visitInlineBlock(e){this.visitTree(e)}visitTableCells(e){e.children.forEach((e=>e.acceptEffector(this)))}visitBlockImage(e){this.visitNode(e)}visitInlineImage(e){this.visitNode(e)}visitBlockVideo(e){this.visitNode(e)}visitInlineVideo(e){this.visitNode(e)}}class Os{constructor(e,t,s,i,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=s,this.text=i,this.skipBr=r,this.children=n,this.progress=o,this.dom=a}get measure(){return this.size.measure}get extent(){return this.size.extent}acceptEvaluator(e){return e.visitText(this)}acceptEffector(e){}}class Us{constructor(e,t,s,i,r,n,o,a,l=1,c){this.env=e,this.boxPos=t,this.linePos=s,this.size=i,this.autoSize=r,this.text=n,this.children=o,this.baseline=a,this.progress=l,this.dom=c,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure}get extent(){return this.size.extent}acceptEvaluator(e){return e.visitLine(this)}acceptEffector(e){e.visitLine(this)}}class $s{constructor(e,t,s,i,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=s,this.text=i,this.rb=r,this.rt=n,this.progress=o,this.dom=a}get measure(){return this.size.measure}get extent(){return this.size.extent}get lineExtent(){const e=this.env.font.lineHeight;return e.indexOf("px")<0?Math.floor(this.rb.env.font.size*parseFloat(e)):parseInt(e)}acceptEvaluator(e){return e.visitRuby(this)}acceptEffector(e){e.visitRuby(this)}}class Ds{constructor(e,t,s,i,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=s,this.text=i,this.edge=r,this.children=n,this.progress=o,this.dom=a,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure+this.edge.measure}get extent(){return this.size.extent+this.edge.extent}acceptEvaluator(e){return this.env.textEmphasis.isNone()?"a"===this.env.element.tagName?e.visitInlineLink(this):e.visitInline(this):e.visitInlineEmpha(this)}acceptEffector(e){e.visitInline(this)}}class Ws{constructor(e,t,s,i,r,n,o,a,l,c){this.env=e,this.boxPos=t,this.layoutPos=s,this.size=i,this.autoSize=r,this.text=n,this.border=o,this.children=a,this.progress=l,this.dom=c,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure+this.env.edge.measure}get extent(){return this.size.extent+this.border.width.extent}acceptEvaluator(e){switch(this.env.element.tagName){case"a":return e.visitBlockLink(this);case i.pageRootTagName:const t=e.visitRootBlock(this);return t.appendChild(e.visitBlock(this)),t}return e.visitBlock(this)}acceptEffector(e){e.visitBlock(this)}}class _s{constructor(e,t,s,i,r,n,o,a,l=1,c){this.env=e,this.boxPos=t,this.layoutPos=s,this.size=i,this.autoSize=r,this.text=n,this.edge=o,this.children=a,this.progress=l,this.dom=c,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure+this.edge.measure}get extent(){return this.size.extent+this.edge.extent}acceptEvaluator(e){return e.visitInlineBlock(this)}acceptEffector(e){e.visitInlineBlock(this)}}class Hs{constructor(e,t,s,i,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=s,this.rowPos=i,this.text=r,this.children=n,this.progress=o,this.dom=a,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure}get extent(){return this.size.extent}acceptEvaluator(e){return e.visitTableCells(this)}acceptEffector(e){e.visitTableCells(this)}}class qs{constructor(e,t,s,i,r,n,o,a=1,l){this.env=e,this.boxPos=t,this.size=s,this.physicalSize=i,this.edge=r,this.layoutPos=n,this.text=o,this.progress=a,this.dom=l}get measure(){return this.size.measure+this.edge.borderBoxMeasure}get extent(){return this.size.extent+this.env.edge.borderBoxExtent}acceptEvaluator(e){if(this.env.element.$dom)return e.visitBlockReFixed(this,this.env.element.$dom);switch(this.env.element.tagName){case"img":return e.visitBlockImage(this);case"video":return e.visitBlockVideo(this)}throw console.error("unsupported replaced element:",this),new Error("unsupported replaced element")}acceptEffector(e){switch(this.env.element.tagName){case"img":e.visitBlockImage(this);break;case"video":e.visitBlockVideo(this)}}}class Gs{constructor(e,t,s,i,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=s,this.physicalSize=i,this.edge=r,this.text=n,this.progress=o,this.dom=a}get measure(){return this.size.measure+this.edge.measure}get extent(){return this.size.extent+this.edge.extent}acceptEvaluator(e){if(this.env.element.$dom)return e.visitInlineReFixed(this,this.env.element.$dom);switch(this.env.element.tagName){case"img":return e.visitInlineImage(this);case"video":return e.visitInlineVideo(this)}throw console.error("unsupported replaced element:",this),new Error("unsupported replaced element")}acceptEffector(e){switch(this.env.element.tagName){case"img":e.visitInlineImage(this);break;case"video":e.visitInlineVideo(this)}}}class js{constructor(e,t){this.type=e,this.body=t}static skip(e,t=""){return i.debugLayout&&console.log("created skip(%s):",t,e),new js("skip",e)}static lineBreak(e,t=""){return i.debugLayout&&console.log("created line-break(%s):",t,e),new js("line-break",e)}static iblockInlineBreak(e,t=""){return i.debugLayout&&console.log("created iblock-inline-break(%s):",t,e),new js("iblock-inline-break",e)}static pageBreak(e,t=""){return i.debugLayout&&console.log("created page break(%s):",t,e),new js("page-break",e)}static logicalNode(e,t){return new js(e,t)}isFloatable(){switch(this.type){case"block":case"inline-block":case"re-block":return!0}return!1}isBlockLevel(){switch(this.type){case"block":case"block-link":case"re-block":case"table":case"table-cells":case"table-row-group":case"table-row":return!0}return!1}getBodyAsBlockNode(){if(this.body&&this.body instanceof Ws)return this.body;throw console.log("Type error: body is not LogicalBlockNode. %o",this),new Error("Type error: body is not LogicalBlockNode")}}class Ks{constructor(e,t){this.env=e,this.parent=t,this.name=i.useStrictFormatContextName?e.element.toString(!0):e.element.getNodeName(),this.cursorPos=dt.zero,this.contextBoxEdge=new zs(e.edge),this.suspendedGens=[],this.curChildStartMargin=0,this.blockNodes=[],this.inlineNodes=[],this.blockNodeHistory=[],this.inlineText="",this.text="",this.progress=0}get inlineRoot(){let e=this;for(;e;){if(e.env.display.isBlockLevel()||e.env.display.isFlowRoot())return e;e=e.parent}throw new Error("inline root not found!")}get pageRoot(){let e=this;for(;e;){if(e instanceof Ys)return e;e=e.parent}throw new Error(`[${this.env.element.tagName}] root context not found!`)}get flowRoot(){let e=this;for(;e;){if(e.env.display.isFlowRoot()||e instanceof Ys)return e;e=e.parent}throw new Error(`[${this.env.element.tagName}] flow root context not found!`)}get parentBlock(){let e=this.parent;for(;e;){if(e.env.display.isBlockLevel()||e.env.display.isFlowRoot())return e;e=e.parent}}acceptLayoutReducer(e,...t){return e.visit(this,...t)}get restExtent(){const e=this.parentBlock;return e?e.restExtent-this.cursorPos.before:this.maxExtent-this.cursorPos.before}get lastBlockNode(){return this.blockNodeHistory[this.blockNodeHistory.length-1]||void 0}get totalLineCount(){return this.blockNodeHistory.filter((e=>e instanceof Us)).length}get localLineCount(){return this.blockNodes.filter((e=>e instanceof Us)).length}get listMarkerOffset(){return this.listMarker?this.env.listStyle.isPositionInside()?0:this.totalLineCount>0?this.listMarker.measure:0:0}get floatStartOffset(){if(!this.flowRoot.floatRegion)return 0;const e=this.contextBoxEdge.borderWidth.getSize("start"),t=this.flowRoot.floatRegion.getSpacePosFromStartBound(this.flowRootPos.before);return e>t?e:t-e}get textAlignOffset(){return this.env.textAlign.isEnd()?this.maxMeasure-this.textStartPos:this.env.textAlign.isCenter()?Math.floor((this.maxMeasure-this.textStartPos)/2):0}get textStartPos(){let e=this.cursorPos.start;return e+=this.listMarkerOffset,e}get parentInlineEdgeSize(){let e=this.parent,t=0;for(;e&&(t+=e.env.edge.measure,e!==this.flowRoot);)e=e.parent;return t}get contextRestMeasure(){if(this.flowRoot.floatRegion){const e=this.contextBoxEdge.borderBoxMeasure+this.parentInlineEdgeSize,t=this.flowRoot.floatRegion.getSpaceMeasureAt(this.flowRootPos.before)-e;return Math.min(t,this.maxMeasure)-this.textStartPos}return this.restMeasure}get lineBoxStartOffset(){let e=0;return e+=this.floatStartOffset,e+=this.listMarkerOffset,e+=this.textAlignOffset,e}get restMeasure(){return this.parent?Math.min(this.parent.restMeasure,this.maxMeasure)-this.cursorPos.start:this.maxMeasure-this.textStartPos}get rootMeasure(){if(this.parent)return this.parent.rootMeasure;if(!this.env.measure)throw new Error("root measure is not defined!");return this.env.measure}get rootExtent(){if(this.parent)return this.parent.rootExtent;if(!this.env.extent)throw new Error("root extent is not defined!");return this.env.extent}get maxMeasure(){return null!==this.env.measure?this.env.measure:this.parent?this.parent.maxMeasure:this.rootMeasure}get maxExtent(){return null!==this.env.extent?this.env.extent:this.rootExtent}get contentBlockSize(){const e=this.maxMeasure,t=(this.env.extent||this.cursorPos.before)-this.contextBoxEdge.borderWidth.extent;return new St({measure:e,extent:t})}get autoContentBlockSize(){return new St({measure:this.maxMeasure,extent:this.cursorPos.before-this.contextBoxEdge.borderWidth.extent})}get contentInlineBlockSize(){const e=null!==this.env.measure?this.env.measure:Math.max(...this.blockNodes.map((e=>e.measure))),t=(null!==this.env.extent?this.env.extent:this.cursorPos.before)-this.contextBoxEdge.borderWidth.extent;return new St({measure:e,extent:t})}get autoContentInlineBlockSize(){const e=null!==this.env.measure?this.env.measure:Math.max(...this.blockNodes.map((e=>e.measure))),t=this.cursorPos.before-this.contextBoxEdge.borderWidth.extent;return new St({measure:e,extent:t})}get boxPos(){return{offsetPos:this.parent?this.parent.flowRootPos.translate({start:this.curChildStartMargin,before:this.contextBoxEdge.margin.getSize("before")}):this.cursorPos.cloneValue(),clientPos:{start:this.contextBoxEdge.borderBoxStartSize,before:this.contextBoxEdge.borderBoxBeforeSize}}}get localPos(){return new dt({start:this.cursorPos.start+this.curChildStartMargin+this.contextBoxEdge.borderBoxStartSize,before:this.cursorPos.before})}get flowRootPos(){return!this.parent||this.env.display.isFlowRoot()?this.localPos:this.parent.flowRootPos.translate(this.localPos)}get globalPos(){return this.parent?this.parent.globalPos.translate(this.localPos):this.localPos}get blockPos(){const e=this.parentBlock;return e?e.localPos:dt.zero}get lineHeadPos(){const e=this.cursorPos.before-this.contextBoxEdge.borderWidth.getSize("before");return new dt({start:0,before:e})}addBorderBoxEdge(e){if(this.contextBoxEdge.padding.addEdge(e),this.contextBoxEdge.borderWidth.addEdge(e),"before"===e||"after"===e){const t=this.cursorPos.before;this.cursorPos.before+=this.contextBoxEdge.padding.getSize(e),this.cursorPos.before+=this.contextBoxEdge.borderWidth.getSize(e),i.debugLayout&&console.log("[%s] addBorderBoxEdge(%s): %d -> %d",this.name,e,t,this.cursorPos.before)}}addInlineMarginEdge(e,t){this.contextBoxEdge.margin.addEdge(e),this.cursorPos.start+=t}addBlockMarginEdge(e,t){const s=this.cursorPos.before;this.contextBoxEdge.margin.addEdge(e),this.cursorPos.before+=t,i.debugLayout&&console.log("[%s] addBlockMarginEdge(%s): %d -> %d",this.name,e,s,this.cursorPos.before)}getBorderCollapseAfterSize(){const e=this.contextBoxEdge.borderWidth.getSize("after");if(e<=0)return 0;const t=this.blockNodes.find((e=>e instanceof Hs));if(t instanceof Hs)return Math.min(e,...t.children.map((e=>e instanceof Ws?e.border.width.after:0)));const s=this.blockNodes[this.blockNodes.length-1];return s instanceof Ws?Math.min(s.border.width.after,e):0}setFloat(e,t){this.flowRoot.addFloat(e,t,this.maxMeasure,this.flowRootPos)}addLine(e){i.ignoreEmptyLine&&0===e.children.length||this.pushBlockNode(e)}addBlock(e){this.pushBlockNode(e)}addBlockRe(e){i.ignoreZeroRe&&e.size.hasZero()||this.pushBlockNode(e)}addTable(e){this.pushBlockNode(e)}addTableRowGroup(e){this.env.borderCollapse.isCollapse()&&this.collapseBeforeStartBorder(e),this.pushBlockNode(e)}addTableRow(e){this.env.borderCollapse.isCollapse()&&this.collapseBeforeStartBorder(e),this.pushBlockNode(e)}addTableCells(e){if(this.env.borderCollapse.isCollapse()&&e.children.some((e=>e instanceof Ws&&e.border.width.before>0))){const t=e.children.map((e=>e instanceof Ws?e.border.width.before:0)),s=this.contextBoxEdge.borderWidth.getSize("before");if(Math.min(...t)>0&&s>0){const r=Math.min(s,...t);e.rowPos.before-=r,this.cursorPos.before-=r,i.debugLayout&&console.log("[%s] collapse before %d",this.name,r)}}this.pushBlockNode(e)}addBlockLink(e){this.pushBlockNode(e)}addInlineBlock(e){i.ignoreEmptyInline&&e.size.hasZero()&&0===e.children.length||this.pushInlineNode(e)}addInline(e){i.ignoreEmptyInline&&0===e.children.length||this.pushInlineNode(e)}addInlineRe(e){i.ignoreZeroRe&&e.size.hasZero()||this.pushInlineNode(e)}addInlineLink(e){const t=e.env.element.id;!t&&i.ignoreEmptyInline&&0===e.children.length||(t&&0===e.children.length&&(e.size.extent=0),this.pushInlineNode(e))}addListMarker(e){this.pushInlineNode(e,!1)}addText(e){0!==e.children.length&&this.pushInlineNode(e)}addRuby(e){this.pushInlineNode(e)}addAnchorElement(e,t){const s=this.pageRoot.getAnchor(e);s&&(s.box=t,s.pageIndex<0&&(s.pageIndex=this.pageRoot.pageCount))}pushInlineNode(e,t=!0){const s=this.cursorPos.start;this.inlineNodes.push(e),this.cursorPos.start+=e.measure,t&&(this.inlineText+=e.text),e.env.element.id&&this.addAnchorElement(e.env.element.id,e),i.debugLayout&&console.log("[%s] pushInlineNode:%o(%d -> %d)",this.name,e,s,this.cursorPos.start)}pushBlockNode(e){const t=this.cursorPos.before;switch(this.text+=e.text,this.progress=Math.min(1,this.progress+e.progress/this.env.element.childNodes.length),this.blockNodes.push(e),this.blockNodeHistory.push(e),e.env.position.isAbsolute()||(this.cursorPos.before+=e.extent),e.env.element.id&&this.addAnchorElement(e.env.element.id,e),e.env.element.tagName){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":const t=this.pageRoot.getHeaderSection(e.env.element);t&&t.pageIndex<0&&(t.pageIndex=this.pageRoot.pageCount)}i.debugLayout&&console.log("[%s] pushBlockNode:%o(%d -> %d)",this.name,e,t,this.cursorPos.before)}getBorderCollapseStartSize(e){return Math.min(this.contextBoxEdge.borderWidth.getSize("start"),e.border.width.start)}getBorderCollapseBeforeSize(e){const t=this.blockNodes[this.blockNodes.length-1];return t instanceof Ws?Math.min(t.border.width.after,e.border.width.before):Math.min(this.contextBoxEdge.borderWidth.getSize("before"),e.border.width.before)}collapseBeforeStartBorder(e){const t=this.getBorderCollapseStartSize(e),s=this.getBorderCollapseBeforeSize(e);e.layoutPos.start=-t,e.layoutPos.before-=this.contextBoxEdge.borderWidth.getSize("before")+s,this.cursorPos.before-=s}}class Zs extends Ks{constructor(e,t){super(e,t),this.env=e,this.parent=t,this.floatNodes=[],this.pageCount=0,this.anchors={},this.outline=new rt}get flowRoot(){return this}getSectionAt(e){return this.outline.getSectionAt(e)}get boxPos(){return{offsetPos:{start:0,before:0},clientPos:{start:this.contextBoxEdge.borderBoxStartSize,before:this.contextBoxEdge.borderBoxBeforeSize}}}openElement(e){this.outline.openElement(e,this.pageCount)}closeElement(e){this.outline.closeElement(e)}createOutline(e){return this.outline.acceptEvaluator(e)}createElement(e,t,s){const i=document.createElement(e),r=s.env.element,n=r.tagName,o=s.env.element.id,a=this.getAnchor(o);switch(a&&!a.dom&&(a.dom=i),n){case"a":const e=r.getAttribute("href");e&&i.setAttribute("href",e);const t=r.getAttribute("name");t&&i.setAttribute("name",t)}return i.className=t.concat(n).map((e=>`nehan-${e}`)).concat(r.classList.values().map((e=>`nehan-e-${e}`))).join(" "),s.dom=i,i}createLogicalNodeEvaluator(){const e=new Ms(this.env.writingMode);switch(this.env.writingMode.value){case"horizontal-tb":return new As(this,e,Is.instance);case"vertical-rl":case"vertical-lr":return new Vs(this,e,Is.instance);default:throw new Error(`undefined writing mode: ${this.env.writingMode.value}`)}}setAnchor(e,t){this.anchors[e]=t}getAnchor(e){return this.anchors[e]}getHeaderSection(e){return this.outline.getHeaderSection(e)}clearFloat(e){if(!this.floatRegion)throw new Error("float region is not defined");if(e.isStart())return this.floatRegion.clearStart();if(e.isEnd())return this.floatRegion.clearEnd();if(e.isBoth())return this.floatRegion.clearBoth();throw new Error("clear direction is not defined")}addFloat(e,t,s,r){if(t.isNone())console.error("float direction is not set! ignored.");else{if(!this.floatRegion){const e=new St({measure:this.maxMeasure,extent:this.maxExtent});this.floatRegion=new Ls(e,r.before)}try{i.debugLayout&&console.log("addFloat(%o, %o, ctxM:%d, flowRootPos:%o)",e,t,s,r);const n=new St({measure:e.size.measure+e.env.edge.measure,extent:e.size.extent+e.env.edge.extent}),o=t.isStart()?this.floatRegion.pushStart(r.before,n,s):this.floatRegion.pushEnd(r.before,n,s),a=t.isStart()?r.start:o.start+e.env.edge.start;e.layoutPos=new dt({start:a,before:o.before}),this.floatNodes.push(e),i.debugLayout&&(console.log("added float. rect:%o, pos:%o",o,e.layoutPos),console.log("spaceMeasure at %d = %d",e.layoutPos.before,this.floatRegion.getSpaceMeasureAt(e.layoutPos.before)))}catch(e){console.error(e)}}}}class Ys extends Zs{}class Xs extends Ks{addLine(e){0===this.totalLineCount&&this.parent&&(this.env=this.parent.env),super.addLine(e)}}class Js{constructor(){}hyphenate(e){const t=e.lexer,s=this.getHyphenateCount(t);if(s<0){const i=-s;if(i>=e.characters.length)return 0;e.characters=e.characters.slice(0,-i),e.text=e.characters.reduce(((e,t)=>e+t.text),""),t.pushBack(i)}else if(s>0)for(let i=0;i<s;i++)e.addCharacter(t.getNext());return s}getHyphenateCount(e){const t=e.peek(-1),s=e.peek(0),i=e.peek(1);if(s instanceof f&&s.isHeadNg()&&s.isHangEnable()){if(null===i||i instanceof f==0)return 1;if(i&&i instanceof f&&!1===i.isHeadNg())return 1;if(t&&t instanceof f==0)return-1;if(t&&t instanceof f&&!1===t.isHeadNg())return-1}if(t instanceof f&&t.isTailNg()){let t=-1;for(;;){let s=e.peek(t-1);if(!s)break;if(s&&s instanceof f==0)break;if(s&&s instanceof f&&!1===s.isTailNg())break;t--}return t}return 0}}Js.instance=new Js;class Qs{constructor(){}set(e,t){return!(!t.isKernEnable()||t.isOpenParen()&&e.isCloseParen()||t.isCloseParen()&&e.isOpenParen()||t.isOpenParen()&&!e.isParen()||!e.isKernEnable()||(e.kerning=!0,0))}}Qs.instance=new Qs;class ei{constructor(e,t){this.lexer=e,this.parent=t,this.name="(text)",this.progress=1,this.cursorPos=dt.zero,this.characters=[],this.text=""}get env(){return this.parent.env}get boxPos(){return{offsetPos:this.parent.flowRootPos,clientPos:{start:0,before:0}}}get globalPos(){return this.parent.globalPos.translate(this.cursorPos)}get flowRootPos(){return this.parent.flowRootPos.translate(this.cursorPos)}get localPos(){return this.parent.localPos.translate(this.cursorPos)}get lineHeadPos(){return this.parent.lineHeadPos}get pageRoot(){return this.parent.pageRoot}get flowRoot(){return this.parent.flowRoot}get inlineRoot(){return this.parent.inlineRoot}isLineHead(){if(this.cursorPos.start>0)return!1;let e=this.parent;for(;e;){if(e.env.display.isBlockLevel()||e.env.display.isFlowRoot())return 0===e.inlineNodes.length;if(e.cursorPos.start>0)return!1;e=e.parent}throw new Error("inline root not found!")}get maxMeasure(){return this.parent.maxMeasure}get maxExtent(){return this.parent.maxExtent}get rootMeasure(){return this.parent.rootMeasure}get rootExtent(){return this.parent.rootExtent}get contextRestMeasure(){return this.parent.contextRestMeasure}get restMeasure(){return this.parent.contextRestMeasure-this.cursorPos.start}get restExtent(){return this.parent.restExtent-this.cursorPos.before}addCharacter(e){this.characters.push(e),this.cursorPos.start+=e.size.measure,this.text+=e.text}acceptLayoutReducer(e,t){return e.visit(this,t)}}class ti extends Ks{get restMeasure(){return 1/0}get restExtent(){return 1/0}}class si{constructor(e,t){this.env=e,this.parent=t,this.cursorPos=dt.zero,this.rubyGroups=[],this.progress=1}acceptLayoutReducer(e,t){return e.visit(this,t)}get boxPos(){return{offsetPos:this.parent.flowRootPos,clientPos:{start:0,before:0}}}get globalPos(){return this.parent.globalPos.translate(this.cursorPos)}get flowRootPos(){return this.parent.flowRootPos.translate(this.cursorPos)}get localPos(){return this.parent.localPos.translate(this.cursorPos)}get lineHeadPos(){return this.parent.lineHeadPos}get pageRoot(){return this.parent.pageRoot}get flowRoot(){return this.parent.flowRoot}get inlineRoot(){return this.parent.inlineRoot}get contextRestMeasure(){return this.parent.contextRestMeasure}get restMeasure(){return this.parent.contextRestMeasure-this.cursorPos.start}get restExtent(){return this.parent.restExtent-this.cursorPos.before}get maxMeasure(){return this.parent.maxMeasure}get maxExtent(){return this.parent.maxExtent}get rootMeasure(){return this.parent.rootMeasure}get rootExtent(){return this.parent.rootExtent}addRubyBase(e){this.rb=e,this.groupRuby()}addRubyText(e){this.rt=e,this.groupRuby()}groupRuby(){this.rb&&this.rt&&(this.rubyGroups.push({rb:this.rb,rt:this.rt}),this.rb=this.rt=void 0)}}class ii extends Ks{constructor(e,t,s){super(t,s),this.elements=e,this.env=t,this.parent=s,this.cells=[]}acceptLayoutReducer(e){return e.visit(this)}setCells(e){this.cells=e;const t=this.env.borderCollapse.isCollapse(),s=e.reduce(((e,t)=>e.size.extent>t.size.extent?e:t),e[0]),i=s.size.extent,r=Math.max(...e.map((e=>e.extent)));let n=0;this.cells.forEach(((e,o)=>{if(e.size.extent=i,e.size.extent+=r-e.extent,e.layoutPos.start=n,n+=e.measure,e.autoSize.extent!==s.extent&&0===s.border.afterWidth&&e.border.clearAfter(),t){const t=0===o?this.env.edge.border.width.start:this.cells[o-1].border.width.end,s=Math.min(t,e.border.width.start);e.layoutPos.start-=s,n-=s}const a=e.size.extent-e.autoSize.extent,l=e.env.verticalAlign.value;if(a>0&&("middle"===l||"after"===l)){const t="middle"===l?Math.floor(a/2):a;e.children.forEach((e=>{e instanceof Us?e.linePos.before+=t:(e instanceof Ws||e instanceof qs)&&(e.layoutPos.before+=t)}))}}))}}class ri extends Ks{get maxMeasure(){return this.parent?this.parent.maxMeasure:super.maxMeasure}get maxExtent(){return this.parent?this.parent.maxExtent:super.maxExtent}}class ni{constructor(){}resize(e,t,s){return t.resize(s)}}ni.instance=new ni;class oi{constructor(){}resize(e,t,s){return t}}oi.instance=new oi;class ai{constructor(){}visit(e,t=!1){const s=e.cursorPos.start,i=e.env.font.size,r=new St({measure:s,extent:i}),n=e.text,o=e.characters,a=!e.lexer.hasNext()&&t,l=new Os(e.env,e.boxPos,r,n,a,o);return e.characters=[],e.text="",t&&(e.cursorPos.start=0),js.logicalNode("text",l)}}ai.instance=new ai;class li{constructor(e){this.type=e}visit(e,t){const s=e.cursorPos.start,i=Math.max(e.env.font.size,...e.inlineNodes.map((e=>e.extent))),r=e.inlineNodes,n=e.inlineText,o=new St({measure:s,extent:i}),a=e.contextBoxEdge.currentMarginBoxEdge,l=new Ds(e.env,e.boxPos,o,n,a,r);return e.contextBoxEdge.clear(),e.inlineNodes=[],e.inlineText="",t&&(e.cursorPos.start=0),js.logicalNode(this.type,l)}}li.instance=new li("inline");class ci{constructor(){}visit(e,t){const s=t.rb,i=t.rt,r=Math.max(s.size.measure,i.size.measure),n=s.size.extent+i.size.extent,o=new St({measure:r,extent:n}),a=s.text,l=new $s(e.env,e.boxPos,o,a,s,i);return js.logicalNode("ruby",l)}}ci.instance=new ci;class hi extends li{}hi.instance=new hi("ruby-base");class di extends li{}di.instance=new di("ruby-text");class ui extends li{}ui.instance=new ui("list-marker");class pi{constructor(){}isDecoratedText(e){return!e.env.textEmphasis.isNone()||e instanceof $s}getDecoratedExtent(e){return e.env.textEmphasis.isNone()?e instanceof $s?e.extent:0:2*e.env.font.size}isReChild(e){return e instanceof Gs||e instanceof Ds&&e.children.some((e=>this.isReChild(e)))}isEmptyLine(e,t){return 0===e.length||""===e[0].text.trim()&&""===t.trim()}visit(e,t=!1){const s=e.lineHeadPos,i=e.env.display.isInlineBlockFlow()?e.cursorPos.start:e.maxMeasure,r=e.inlineNodes,n=r.filter((e=>this.isReChild(e))),o=r.filter((e=>e instanceof _s)),a=r.filter((e=>this.isDecoratedText(e))),l=r.reduce(((e,t)=>t.env.font.size>e.size?t.env.font:e),e.env.font),c=Math.min(...r.map((e=>e.extent))),h=Math.max(...a.map((e=>this.getDecoratedExtent(e)))),d=Math.max(...n.map((e=>e.extent))),u=Math.max(...o.map((e=>e.extent))),p=Math.max(d,u),g=Math.max(l.size,h,p),m=l.lineExtent,f=Math.max(m,...r.map((e=>e.extent))),x=Math.max(m,f),b=Math.max(l.size,p),y=m-l.size,v=r.length===o.length+n.length;let E=x===p&&e.restExtent>=y?x+y:x;E=Math.min(E,e.rootExtent);const S=new St({measure:i,extent:E}),w=e.inlineText,C=Math.floor(y/2),k={size:new St({measure:i,extent:g}),textBodySize:new St({measure:e.cursorPos.start,extent:b}),startOffset:e.lineBoxStartOffset,blockOffset:C},B=k.startOffset+e.cursorPos.start,R=new St({measure:B,extent:E});if(0===r.length||c<e.env.font.size&&v){const t=v&&r.length>0?c:e.env.font.size;S.extent=R.extent=k.size.extent=k.textBodySize.extent=t,k.blockOffset=0}const T=new Us(e.env,e.boxPos,s,S,R,w,r,k);return!t&&this.isEmptyLine(r,w)&&(T.size.extent=k.size.extent=0),e.cursorPos.start=0,e.inlineNodes=[],e.inlineText="",js.logicalNode("line",T)}}pi.instance=new pi;class gi{constructor(e){this.type=e}visit(e){const t=e.blockPos,s=e.contentBlockSize,i=e.autoContentBlockSize,r=e.contextBoxEdge.currentBorder,n=e.text,o=e.blockNodes;e.env.borderCollapse.isCollapse()&&(s.extent-=e.getBorderCollapseAfterSize());const a=new Ws(e.env,e.boxPos,t,s,i,n,r,o,e.progress);return e.text="",e.blockNodes=[],e.cursorPos=dt.zero,e.contextBoxEdge.clearBlock(),js.logicalNode(this.type,a)}}gi.instance=new gi("block");class mi{constructor(e){this.type=e}visit(e){const t=e.blockPos,s=e.contentBlockSize,i=e.autoContentBlockSize;if(e.floatRegion){const t=e.floatRegion.maxRegionExtent;s.extent=Math.max(s.extent,t),i.extent=Math.max(i.extent,t)}const r=e.contextBoxEdge.currentBorder,n=e.text,o=e.floatNodes?e.blockNodes.concat(e.floatNodes):e.blockNodes,a=new Ws(e.env,e.boxPos,t,s,i,n,r,o,e.progress);return e.text="",e.blockNodes=[],e.floatNodes=[],e.cursorPos=dt.zero,e.contextBoxEdge.clearBlock(),e.floatRegion&&(delete e.floatRegion,e.floatRegion=void 0),e.pageCount++,js.logicalNode(this.type,a)}}mi.instance=new mi("block");class fi{visit(e){const t=e.blockPos,s=e.contentInlineBlockSize;e.floatRegion&&(s.extent=Math.max(s.extent,e.floatRegion.maxRegionExtent));const i=e.autoContentInlineBlockSize,r=e.contextBoxEdge.currentBorder,n=e.env.edge.clone();n.border=r;const o=e.text,a=e.floatNodes?e.blockNodes.concat(e.floatNodes):e.blockNodes,l=new _s(e.env,e.boxPos,t,s,i,o,n,a);return e.text="",e.blockNodes=[],e.floatNodes=[],e.cursorPos=dt.zero,e.contextBoxEdge.clearBlock(),e.floatRegion&&(delete e.floatRegion,e.floatRegion=void 0),js.logicalNode("inline-block",l)}}fi.instance=new fi;class xi extends mi{}xi.instance=new xi("table-cell");class bi{constructor(){}visit(e){const t=e.maxMeasure,s=Math.max(...e.cells.map((e=>e.extent))),i=new St({measure:t,extent:s}),r=dt.zero,n=e.cells.reduce(((e,t)=>e+t.text),""),o=new Hs(e.env,e.boxPos,i,r,n,e.cells);return e.contextBoxEdge.clearBlock(),e.cursorPos=dt.zero,js.logicalNode("table-cells",o)}}bi.instance=new bi;class yi extends gi{}yi.instance=new yi("table");class vi extends gi{}vi.instance=new vi("table-row-group");class Ei extends gi{}Ei.instance=new Ei("table-row");class Si extends gi{}Si.instance=new gi("block-link");class wi extends li{}wi.instance=new li("inline-link");class Ci{constructor(){}visitBlock(e,t,s){const i=e.env.edge,r=e.parent?e.parent.localPos:dt.zero,n=`(${e.env.element.tagName})`,o=new qs(e.env,e.boxPos,t,s,i,r,n);return js.logicalNode("re-block",o)}visitInline(e,t,s){const i=e.env.edge,r=`(${e.env.element.tagName})`,n=new Gs(e.env,e.boxPos,t,s,i,r);return js.logicalNode("re-inline",n)}visit(e,t,s){return e.env.display.isBlockLevel()?this.visitBlock(e,t,s):this.visitInline(e,t,s)}}Ci.instance=new Ci;class ki{static createRoot(e){const t=new $(e),s=new Ys(t);return new Mi(s,mi.instance)}static createTextLexer(e,t){const s=t.whiteSpace.isPre(),i=e.textContent||e.computedStyle.getPropertyValue("content")||"",r=t.textCombineUpright.isNone()?new Ae(i,{isPre:s}):new Ve(i);return t.textOrientation.isUpright()?r.acceptTokenMapper(new A):r.hasWord()&&r.acceptTokenMapper(new V),r}static createChild(e,t){if(e.isTextElement()){const s=this.createTextLexer(e,t.env),i=e.nextSibling;return{generator:new Ti(new ei(s,t)),nextElement:i}}i.debugLayout&&console.log("createChild, element: %o, parentContext: %o",e,t),le.loadDynamic(e,t);const s=new $(e),r=s.display;if(r.isNone())return{generator:new zi(new Ks(s,t),js.skip(t,"display:none")),nextElement:e.nextSibling};if(e.id){const s=t.flowRoot,i={name:e.id,element:e,pageIndex:-1};s.setAnchor(e.id,i)}if(Vt.isReplacedElement(e))return{generator:new Li(new ri(s,t),Ci.instance,ni.instance),nextElement:e.nextSibling};if(e.$dom)return{generator:new Li(new ri(s,t),Ci.instance,oi.instance),nextElement:e.nextSibling};if("a"===e.tagName){const i=new Ks(s,t);return{generator:r.isInlineLevel()?new Ni(i,wi.instance):new Mi(i,Si.instance),nextElement:e.nextSibling}}if("br"===e.tagName)return{generator:new Pi(new Ks(s,t)),nextElement:e.nextSibling};if(r.isFlowRuby())return s.element.acceptEffector(me.instance),{generator:new Ri(new si(s,t)),nextElement:e.nextSibling};if(r.isRubyBase())return{generator:new Ni(new ti(s,t),hi.instance),nextElement:e.nextSibling};if(r.isRubyText())return{generator:new Ni(new ti(s,t),di.instance),nextElement:e.nextSibling};if(e.tagName===Mt.FIRST_LINE)return{generator:new Mi(new Xs(s,t)),nextElement:e.nextSibling};if(e.tagName===Mt.MARKER)return{generator:new Ni(new Ks(s,t),ui.instance),nextElement:e.nextSibling};if(r.isTableCell()&&e.parent){e.acceptEffector(ge.instance);const s=e.parent.children.filter((e=>qe.load(e).isTableCell()));return{generator:new Bi(new ii(s,t.env,t)),nextElement:s[s.length-1].nextSibling}}return r.isTable()?{generator:new Mi(new Ks(s,t),yi.instance),nextElement:e.nextSibling}:r.isTableRowGroup()?(e.acceptEffector(ue.instance),{generator:new Mi(new Ks(s,t),vi.instance),nextElement:e.nextElementSibling}):r.isTableRow()?(e.acceptEffector(pe.instance),{generator:new Mi(new Ks(s,t),Ei.instance),nextElement:e.nextElementSibling}):r.isInlineBlockFlow()?{generator:new Mi(new Zs(s,t),fi.instance),nextElement:e.nextSibling}:r.isInlineLevel()?{generator:new Ni(new Ks(s,t)),nextElement:e.nextSibling}:r.isFlowRoot()?{generator:new Mi(new Zs(s,t)),nextElement:e.nextSibling}:(r.isListItem()&&e.acceptEffector(de.instance),{generator:new Mi(new Ks(s,t)),nextElement:e.nextSibling})}}class Bi{constructor(e,t=bi.instance){this.context=e,this.reducer=t,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){i.debugLayout&&console.group(`table-cells: ${this.context.name}`);const e=this.context.elements.map((e=>{le.loadDynamic(e,this),e.acceptEffectorAll(Ee.instance);const t=new $(e);return new Mi(new Zs(t,this.context),xi.instance)}));let t=0;for(;;){const s=e.map((e=>e.getNext()));if(s.every((e=>void 0===e)))break;if(0===t&&s.some((e=>e&&"page-break"===e.type)))yield js.pageBreak(this.context,"some table-cell has page-break, propagate to parent");else{if(t%2==0){const i=s.map(((s,i)=>{if(s&&"table-cell"===s.type)return s.body;const r=e[i].context;return r.addBorderBoxEdge("start"),r.addBorderBoxEdge("end"),0===t&&r.addBorderBoxEdge("before"),t>=2&&r.addBorderBoxEdge("after"),r.acceptLayoutReducer(xi.instance).body}));this.context.setCells(i)}else yield this.context.acceptLayoutReducer(this.reducer),yield js.pageBreak(this.context,"table devided.");t++}}yield this.context.acceptLayoutReducer(this.reducer),i.debugLayout&&console.groupEnd()}}class Ri{constructor(e,t=ci.instance){this.context=e,this.reducer=t,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){i.debugLayout&&console.group("ruby");let e=this.context.env.element.firstChild;for(;null!==e;){const t=ki.createChild(e,this.context);for(this.context.child=t.generator;;){const e=this.context.child.getNext();if(!e)break;switch(e.type){case"ruby-base":this.context.addRubyBase(e.body);break;case"ruby-text":this.context.addRubyText(e.body)}}e=t.nextElement}for(let e of this.context.rubyGroups){const t=this.context.acceptLayoutReducer(this.reducer,e),s=t.body,i=s.lineExtent;if(s.size.measure>this.context.maxMeasure)console.warn("too large ruby, can't be included, ignored:%o(maxM=%d)",t,this.context.maxMeasure);else{for(;this.context.restExtent<i;)yield js.pageBreak(this.context,`restExtent is not enough for rubyNode.lineExtent(${i})`);for(;this.context.restMeasure<s.measure;)yield js.lineBreak(this.context,"restMeasure is not enough for rubyNode.measure");for(;this.context.restExtent<i;)yield js.pageBreak(this.context,`restExtent is not enough for rubyNode.lineExtent(${i}) even after pageBreak`);yield t}}i.debugLayout&&console.groupEnd()}}class Ti{constructor(e,t=ai.instance,s=Js.instance,i=Qs.instance){this.context=e,this.reducer=t,this.hyphenator=s,this.kerning=i,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){const e=this.context.lexer;for(;this.context.lexer.hasNext();){const t=this.context.env.font,s=t.lineExtent,r=this.context.env.textEmphasis.isNone()?void 0:this.context.env.textEmphasis.textEmphaData,n=this.context.env.whiteSpace.isPre(),o={font:t,isVertical:this.context.env.writingMode.isTextVertical(),empha:r},a=this.context.isLineHead();if(this.context.restExtent<s&&(yield js.pageBreak(this.context,"lineExtent is not enough for text-fmt-context")),a&&this.context.restMeasure<t.size){if(!this.context.inlineRoot.env.display.isInlineBlockFlow()){const e=`too narrow space: restM:${this.context.restMeasure}, start:${this.context.inlineRoot.cursorPos.start}`;yield js.skip(this.context,e);break}yield js.iblockInlineBreak(this.context,"iblock starts from too narrow space")}const l=e.getNext();if(i.debugCharacter&&console.log("restM:%d, token:%o",this.context.restMeasure,l),n&&"\n"===l.text)yield this.context.acceptLayoutReducer(this.reducer,!1),yield js.lineBreak(this.context,"CRLF in white-space:pre");else{if((0===l.size.measure||l instanceof M)&&l.setMetrics(o),l instanceof f&&l.isKernEnable()){const t=e.peek(-2);t instanceof f&&this.kerning.set(l,t)&&l.setMetrics(o)}if(this.context.restMeasure<l.size.measure)if(l instanceof M)a&&this.context.env.overflowWrap.isBreakWord()||this.context.env.wordBreak.isBreakAll()?(e.pushBack(1),this.context.addCharacter(l.breakWord(this.context.restMeasure))):a?this.context.addCharacter(l):(e.pushBack(1),this.hyphenator.hyphenate(this.context)),yield this.context.acceptLayoutReducer(this.reducer,!0),yield js.lineBreak(this.context,"long word is broken by word-break: break-all");else if(l instanceof B){const t=e.peek(-2),s=e.peek(0);t instanceof M&&s instanceof M||e.pushBack(1),this.hyphenator.hyphenate(this.context),yield this.context.acceptLayoutReducer(this.reducer,!0),yield js.lineBreak(this.context,"char token overflows measure(by spaceChar)")}else e.pushBack(1),this.hyphenator.hyphenate(this.context),this.context.characters.length>0&&(yield this.context.acceptLayoutReducer(this.reducer,!0)),yield js.lineBreak(this.context,"char token overflows measure");else this.context.addCharacter(l)}}this.context.characters.length>0&&(yield this.context.acceptLayoutReducer(this.reducer,!1))}}class Ni{constructor(e,t=li.instance){this.context=e,this.reducer=t,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){let e;if(i.debugLayout&&console.group(`inline: ${this.context.name}`),this.context.rootExtent<this.context.contextBoxEdge.borderBoxExtent||this.context.rootMeasure<this.context.contextBoxEdge.borderBoxMeasure)return void(yield js.skip(this.context,"Too large edge size: this layout can't be included!"));this.context.restExtent<this.context.contextBoxEdge.borderBoxExtent&&(yield js.pageBreak(this.context,"inline rest extent not enough for border size")),this.context.addBorderBoxEdge("before"),this.context.addBorderBoxEdge("after");const t=this.context.contextBoxEdge.getBorderBoxEdgeSize("start");this.context.restMeasure<t&&(yield js.lineBreak(this.context,"Start edge is not enough for restMeasure")),this.context.addBorderBoxEdge("start");let s=this.context.env.element.firstChild;for(;null!==s;){const t=Rs.getMarginFromLastInline(s);t>0&&this.context.restMeasure>t&&this.context.addInlineMarginEdge("start",t);const i=ki.createChild(s,this.context);this.context.child=i.generator,this.context.child.context.env.display.isBlockLevel()&&(this.context.inlineNodes.length>0&&(yield this.context.acceptLayoutReducer(this.reducer,!0),yield js.lineBreak(this.context,"sweep out inlines for next block(inside inline)")),this.context.parentBlock&&this.context.parentBlock.localPos.start>0&&(yield js.lineBreak(this.context,"line break from inner inline")));const r=Ts.getFlowMarginFromLastElement(this.context.env,this.context.child,e),n=this.context.parentBlock;for(n&&r>0&&(n.restExtent<r&&(yield js.pageBreak(this.context,`block-fmt-context: before-margin(${r}) is not enough.`)),n instanceof Ks&&n.addBlockMarginEdge("before",r));;){const e=this.context.child.getNext();if(!e)break;if("skip"===e.type)break;if("line-break"===e.type)yield this.context.acceptLayoutReducer(this.reducer,!0),yield e;else if("iblock-inline-break"==e.type)this.context.inlineNodes.length>0?(yield this.context.acceptLayoutReducer(this.reducer,!0),yield js.lineBreak(this.context,"inline: iblock-inline-break -> line-break")):yield e;else if("page-break"===e.type)this.context.inlineNodes.length>0?(yield this.context.acceptLayoutReducer(this.reducer,!0),yield e):yield e;else if("inline"===e.type)this.context.addInline(e.body);else if("text"===e.type){const t=e.body;t.skipBr&&i.nextElement&&"br"===i.nextElement.tagName&&(i.nextElement=i.nextElement.nextSibling),this.context.addText(t)}else"ruby"===e.type?this.context.addRuby(e.body):"inline-link"===e.type?this.context.addInlineLink(e.body):"re-inline"===e.type?this.context.addInlineRe(e.body):"inline-block"===e.type?this.context.addInlineBlock(e.body):e.isBlockLevel()&&(yield e)}e=i.generator,s=i.nextElement}this.context.contextBoxEdge.getBorderBoxEdgeSize("end")<this.context.restMeasure&&this.context.addBorderBoxEdge("end");const r=this.context.contextBoxEdge.margin.getSize("end");r<this.context.restMeasure&&this.context.addInlineMarginEdge("end",r),yield this.context.acceptLayoutReducer(this.reducer,!1),i.debugLayout&&console.groupEnd()}}class Pi extends Ni{*createGenerator(){for(;this.context.restExtent<this.context.env.font.lineExtent;)yield js.pageBreak(this.context,"line break, lineExtent not enough");yield js.lineBreak(this.context,"<br>")}}class zi extends Ni{constructor(e,t){super(e),this.value=t}*createGenerator(){yield this.value}}class Li{constructor(e,t=Ci.instance,s=ni.instance){this.context=e,this.reducer=t,this.resizer=s,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){i.debugLayout&&console.group(`${this.context.name}`);const e=this.context.env.writingMode,t=new St({measure:this.context.maxMeasure-this.context.env.edge.measure,extent:this.context.maxExtent-this.context.env.edge.extent});let s=Nt.load(this.context.env.element),r=s.getLogicalSize(e);(r.extent>t.extent||r.measure>t.measure)&&(r=this.resizer.resize(this.context,r,t),s=r.getPhysicalSize(e)),this.context.restExtent<r.extent&&(yield js.pageBreak(this.context,"re extent is not enough for restExtent")),this.context.env.display.isInlineLevel()&&this.context.restMeasure<r.measure&&(yield js.lineBreak(this.context,"restMeasure is not enough for inline re")),this.context.restExtent<r.extent&&(yield js.pageBreak(this.context,"re extent is not enough for restExtent"));const n=this.context.restMeasure;yield this.context.acceptLayoutReducer(this.reducer,r,s),this.context.env.display.isInlineLevel()&&n===r.measure&&(yield js.lineBreak(this.context,"restMeasure is just filled by measure of re(inline)")),i.debugLayout&&console.groupEnd()}}class Mi{constructor(e,t=gi.instance,s=pi.instance){this.context=e,this.blockReducer=t,this.lineReducer=s,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){i.debugLayout&&console.group(`block: ${this.context.name}`),this.context.flowRoot.openElement(this.context.env.element);const e=1/this.context.env.element.childNodes.length,t=this.context instanceof Ys;let s;if(this.context.env.pageBreakBefore.isAlways()&&(yield js.pageBreak(this.context,"block-fmt-context: page-break-before")),this.context.env.measure&&this.context.env.measure<=0)return void(yield js.skip(this.context,"Minus size measure"));!t&&this.context.restExtent<this.context.env.edge.borderBoxBefore&&(yield js.pageBreak(this.context,"block-fmt-context: before border can't be included")),this.context.addBorderBoxEdge("before"),this.context.addBorderBoxEdge("start"),this.context.addBorderBoxEdge("end");let r=this.context.env.element.firstChild;for(;null!==r;){const n=qe.load(r),o=Jt.load(r);if(n.isNone()||!o.isPre()&&Jt.isWhiteSpaceElement(r)){r=r.nextSibling;continue}const a=ut.load(r);if((!a.isNone()||n.isBlockLevel())&&this.context.inlineNodes.length>0){const e=this.context.acceptLayoutReducer(this.lineReducer);this.context.addLine(e.body)}this.context.curChildStartMargin=Rs.getMarginFromParentBlock(r);const l=ki.createChild(r,this.context);this.context.child=l.generator;const c=ht.load(r);if(!c.isNone()&&this.context.flowRoot.floatRegion){const e=this.context.flowRoot.clearFloat(c);i.debugLayout&&console.log("float clearance:%d (cur before = %d)",e,this.context.cursorPos.before),this.context.cursorPos.before=Math.max(this.context.cursorPos.before,e)}const h=Ts.getFlowMarginFromLastElement(this.context.env,this.context.child,s);for(this.context.restExtent<h&&(yield this.context.acceptLayoutReducer(this.blockReducer),t||(yield js.pageBreak(this.context,`block-fmt-context: before-margin(${h}) overflow.`))),h>0&&this.context.addBlockMarginEdge("before",h);;){this.context.suspendedGens=this.context.suspendedGens.filter((e=>{const t=e.getNext();if(!t)return!1;if("block"===t.type){const s=e.context.env.float;this.context.setFloat(t.body,s)}return!0}));const e=this.context.child.getNext();if(!e)break;if(!a.isNone()&&e.isFloatable()){this.context.setFloat(e.body,a),this.context.suspendedGens.push(this.context.child);break}if("skip"===e.type)break;if("line-break"===e.type){const t="br"===e.body.env.element.tagName,s=this.context.acceptLayoutReducer(this.lineReducer,t);this.context.addLine(s.body)}else if("iblock-inline-break"===e.type)if(this.context.env.display.isInlineBlockFlow()){const t=this.context.acceptLayoutReducer(this.lineReducer,!1);t.body.size.hasZero()?yield e:this.context.addLine(t.body)}else{const e=this.context.acceptLayoutReducer(this.lineReducer,!1);this.context.addLine(e.body)}else if("page-break"===e.type){if(this.context.inlineNodes.length>0){const e=this.context.acceptLayoutReducer(this.lineReducer,!1);this.context.addLine(e.body)}const s=this.context.acceptLayoutReducer(this.blockReducer);t?""!==s.body.text.trim()&&(yield s):(yield s,yield e)}else if("block"===e.type)this.context.addBlock(e.body);else if("inline-block"===e.type)this.context.addInlineBlock(e.body);else if("table"===e.type)this.context.addTable(e.body);else if("table-row-group"===e.type)this.context.addTableRowGroup(e.body);else if("table-row"===e.type)this.context.addTableRow(e.body);else if("table-cells"===e.type)this.context.addTableCells(e.body);else if("inline"===e.type)this.context.addInline(e.body);else if("list-marker"===e.type)this.context.addListMarker(e.body);else if("text"===e.type){const t=e.body;t.skipBr&&l.nextElement&&"br"===l.nextElement.tagName&&(l.nextElement=l.nextElement.nextSibling),this.context.addText(t)}else"ruby"===e.type?this.context.addRuby(e.body):"re-block"===e.type?this.context.addBlockRe(e.body):"re-inline"===e.type?this.context.addInlineRe(e.body):"inline-link"===e.type?this.context.addInlineLink(e.body):"block-link"===e.type&&this.context.addBlockLink(e.body)}this.context.progress=(r.index+1)*e,s=l.generator,r=l.nextElement}if(this.context.inlineNodes.length>0){const e=this.context.acceptLayoutReducer(this.lineReducer,!1);this.context.addLine(e.body)}!t&&this.context.restExtent<this.context.contextBoxEdge.getBorderBoxEdgeSize("after")&&(yield js.pageBreak(this.context,"block-fmt-context: after border can't be included")),this.context.addBorderBoxEdge("after");const n=this.context.contextBoxEdge.margin.getSize("after");!this.context.env.float.isNone()&&this.context.restExtent>=n&&this.context.addBlockMarginEdge("after",n),this.context.flowRoot.closeElement(this.context.env.element),yield this.context.acceptLayoutReducer(this.blockReducer),!t&&this.context.env.pageBreakAfter.isAlways()&&(yield js.pageBreak(this.context,"block-fmt-context: page-break-after")),i.debugLayout&&console.groupEnd()}}class Ii extends class{constructor(e,t=ce){this.source=i.normalizeHtml(e),this.styleSheets=[new q(Ie)].concat(t.styleSheets||[]),this.specStyleSheet=this.styleSheets.reduce(((e,t)=>e.mergeStyleSheet(t)),new q({})),this.selectorCache=new $t,this.selectorCache.clear(),this.$document=(new DOMParser).parseFromString(this.source,"text/html"),i.debugLayout&&console.log(this.$document.body),this.documentElement=this.createNehanElement(this.$document.documentElement);const s=this.documentElement.querySelector("body");if(!s)throw new Error("body not found");this.body=s,this.body.parent=this.documentElement,this.body.acceptEffectorAll(new fe(this.specStyleSheet.getPseudoRules())),le.loadAll(this.body),this.body.acceptChildFilter(he.instance)}querySelectorAll(e){return this.documentElement.querySelectorAll(e)}querySelector(e){return this.documentElement.querySelector(e)}getElementById(e){return this.querySelector("#"+e)}getSelectorCache(e){return this.selectorCache.getCache(e)}addStyleSheet(e){return this.styleSheets.push(e),this}addSelectorCache(e,t){this.selectorCache.addCache(e,t)}createElement(e){let t=this.createNativeElement(e);return this.createNehanElement(t)}createNativeElement(e){return this.$document.createElement(e)}createNehanElement(e){const t=(e instanceof Element?e.tagName:e instanceof Text?"(text)":"??").toLowerCase();if(("body"===t||"html"===t)&&this.selectorCache.hasCache(t))return this.selectorCache.getCache(t)[0];const s=new Se(e,this);return"body"===s.tagName&&(this.body=s),s.root=this,this.selectorCache.addCache(t,s),this.selectorCache.addCache("*",s),s}createTextNode(e){const t=this.$document.createTextNode(e);return this.createNehanElement(t)}}{constructor(e,t={styleSheets:[]}){super(e,t),this.generator=t.generator||ki.createRoot(this.body),this.evaluator=t.evaluator||this.generator.context.pageRoot.createLogicalNodeEvaluator(),this.effector=new Fs(this.generator.context.pageRoot),this.pages=[],this.timestamp=0}addPageNode(e){const t=this.pages.length,s=0===t?this.evalNode(e,!0):void 0,i=this.pages[t-1],r=e.progress,n=e.text.length,o={node:e,dom:s,index:t,progress:r,charCount:n,acmCharCount:i?i.acmCharCount+n:n};return this.pages.push(o),o}get pageCount(){return this.pages.length}getAnchor(e){return this.generator.context.pageRoot.getAnchor(e)}getAnchorPage(e){const t=this.getAnchor(e);if(!t)throw new Error(`anchor(${e}) is not found!`);return this.getPage(t.pageIndex)}evalNode(e,t=!0){const s=e.acceptEvaluator(this.evaluator);return t&&e.acceptEffector(this.effector),s}getPage(e){const t=this.pages[e];if(!t)throw new Error(`page ${e} is not found!`);return t.dom||(t.dom=this.evalNode(t.node,!0)),t}createOutline(e){const t=e||new ts;return this.generator.context.flowRoot.createOutline(t)}getSectionAt(e){return this.generator.context.flowRoot.getSectionAt(e)}render(e={}){const t=this.querySelectorAll("img").concat(this.querySelectorAll("video")),s=new Ot(t.length);return new Ut(t,s).load(e).then((t=>{this.timestamp=performance.now(),this.renderAsync(e)})),this}renderAsync(e){return requestAnimationFrame((()=>{const t=this.generator.getNext();if(!t){const t=performance.now()-this.timestamp,s=this.pages.length;return void(e.onComplete&&e.onComplete({caller:this,time:t,pageCount:s}))}const s=t.getBodyAsBlockNode();if(s.children.some((e=>e.extent>0))){const t=this.addPageNode(s);e.onPage&&e.onPage({caller:this,page:t})}this.pages.length>i.maxPageCount?console.error("too many pages, abort."):this.renderAsync(e)})),this}}}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,s),n.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=s(6773);window.NehanPlayer||(window.NehanPlayer=e.NehanPlayer)})()})();
