(()=>{"use strict";var e={6773:(e,t,i)=>{i.r(t),i.d(t,{NehanPlayer:()=>g});var s=i(7240);const r=32;function n(e){return"1x2"===e||"2x2"===e}function o(e,t){switch(e){case"1x1":return new s.PhysicalSize({width:t.width,height:t.height});case"1x2":return new s.PhysicalSize({width:(t.width-r-1)/2,height:t.height});case"2x1":return new s.PhysicalSize({width:t.width,height:(t.height-r-1)/2});case"2x2":return new s.PhysicalSize({width:(t.width-r-1)/2,height:(t.height-r-1)/2})}}class a{constructor(e,t,i,r,n,a,l,c,h,d=0,u=o(n,l),p=function(e){switch(e){case"1x1":return 1;case"1x2":case"2x1":return 2;case"2x2":return 4}}(n),g=function(e,t){const i=t.isVerticalRl();switch(e){case"1x1":return[1];case"1x2":return i?[3,1]:[1,3];case"2x1":return[1,2];case"2x2":return i?[3,4,1,2]:[1,2,3,4]}}(n,a),m=function(e,t,i,r){const n=i.getLogicalSize(r);let o={writingMode:r.value,measure:`${n.measure}px`,extent:`${n.extent}px`,fontSize:`${e}px`};return t&&(o.fontFamily=t),new s.CssStyleSheet({body:o,a:{color:"#d61111"}})}(c,h,u,a),f=i.getElementById("screen"),x=i.getElementById("page-no"),b=i.getElementById("page-count"),y=i.getElementById("goto-left"),v=i.getElementById("goto-right"),E=[i.getElementById("page-1"),i.getElementById("page-2"),i.getElementById("page-3"),i.getElementById("page-4")],S=i.getElementById("slider"),w=i.getElementById("slider-range"),C=i.getElementById("title"),k=i.getElementById("sub-title")){this.config=e,this.$host=t,this.$shadow=i,this.content=r,this.layout=n,this.nehanWritingMode=a,this.size=l,this.fontSize=c,this.fontFamily=h,this.pageIndex=d,this.pageSize=u,this.screenPageCount=p,this.pageOrder=g,this.nehanBodyStyle=m,this.$screen=f,this.$pageNo=x,this.$pageCount=b,this.$gotoLeft=y,this.$gotoRight=v,this.$pages=E,this.$slider=S,this.$sliderRange=w,this.$title=C,this.$subTitle=k;const B=this,R=[this.nehanBodyStyle].concat(e.onCreateNehanStyles?e.onCreateNehanStyles(this):[]);b.innerHTML="- -",this.reader=new s.PagedNehanDocument(this.content,{styleSheets:R}).render({onPage(t){t.page.index<=p-1&&B.gotoPage(0),e.onParsePage&&e.onParsePage(B,t.page.index)},onComplete(t){const i=B.getNombrePageCount(t.pageCount);b.innerHTML=String(i),w.setAttribute("max",String(i)),w.oninput=e=>{const t=parseInt(w.value||"0");B.gotoPage(t)},S.style.visibility="visible",e.onParseComplete&&e.onParseComplete(B,t.pageCount,t.time)}}),y.onclick=()=>{a.isVerticalRl()?this.gotoNextPage():this.gotoPrevPage()},v.onclick=()=>{a.isVerticalRl()?this.gotoPrevPage():this.gotoNextPage()},f.onclick=t=>{const i=f.getBoundingClientRect(),s=t.pageX-i.left-window.pageXOffset;t.pageY,i.top,window.pageYOffset,s<f.clientWidth/2&&e.onClickLeftPage?e.onClickLeftPage(B):e.onClickRightPage&&e.onClickRightPage(B)},e.onPlayerReady&&e.onPlayerReady(B)}get id(){return this.$host.id}get src(){return this.$host.getAttribute("src")||""}get width(){return this.size.width}get height(){return this.size.height}get writingMode(){return this.nehanWritingMode.value}get currentPageIndex(){return this.pageIndex}set currentPageIndex(e){this.gotoPage(e)}get currentSection(){return this.reader.getSectionAt(this.pageIndex)}get pageCount(){return this.reader.pageCount}setTitle(e){this.$title.innerHTML=e}setSubTitle(e){this.$subTitle.innerHTML=e}createOutline(e){return this.reader.createOutline(new s.LayoutOutlineEvaluator((t=>{const i=document.createElement("a");return i.innerHTML=t.header?t.header.innerHTML:t.title,i.href="#"+t.pageIndex,e&&(i.onclick=i=>(i.preventDefault(),e(t),!1)),i})))}refresh(e=!1){this.$host.refresh(e)}update(e){this.$host.update(e)}gotoLeftPage(){this.nehanWritingMode.isVerticalRl()?this.gotoNextPage():this.gotoPrevPage()}gotoRightPage(){this.nehanWritingMode.isVerticalRl()?this.gotoPrevPage():this.gotoNextPage()}gotoNextPage(){const e=this.pageIndex+this.screenPageCount;e>=this.pageCount||this.gotoPage(e)}gotoPrevPage(){const e=Math.max(0,this.pageIndex-this.screenPageCount);e!==this.pageIndex&&this.gotoPage(e)}getNombrePageNo(e){return Math.ceil((e+1)/this.screenPageCount)}getNombrePageCount(e){return Math.ceil(e/this.screenPageCount)}gotoPage(e){if(e<0||e>=this.pageCount)return;const t=this,i=this.getNombrePageNo(e);this.pageIndex=e,this.$sliderRange.value=String(i),this.$pageNo.innerHTML=String(i),this.$pages.forEach((e=>{e.firstChild&&e.removeChild(e.firstChild)})),this.pageOrder.forEach(((i,s)=>{const r=e+s;if(r>=this.reader.pageCount)return;const n=this.reader.getPage(r),o=this.$pages[i-1];n&&n.dom&&(o.appendChild(n.dom),this.config.onSetPage&&this.config.onSetPage(t,n))}))}}var l=function(e,t,i,s){return new(i||(i=Promise))((function(r,n){function o(e){try{l(s.next(e))}catch(e){n(e)}}function a(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((s=s.apply(e,t||[])).next())}))};const c="theme-css";let h={},d={cssFiles:[],onFetchContent:(e,t)=>t,onClickLeftPage(e){e.gotoLeftPage()},onClickRightPage(e){e.gotoRightPage()}};function u(){Object.values(h).forEach((e=>e.refresh(!0)))}function p(e,t,i){return Math.max(t,Math.min(i,e))}class g extends HTMLElement{constructor(){super(),this.src="",this.html="",this.$shadow=this.attachShadow({mode:"open"}),this.getAttribute("id")||(this.id=`player-${(new Date).getTime()}`)}static initialize(e){e&&(d=Object.assign(Object.assign({},d),e)),customElements.define("nehan-player",g)}static get observedAttributes(){return["class"]}connectedCallback(){this.render()}attributeChangedCallback(e,t,i){return l(this,void 0,void 0,(function*(){"class"===e&&this.classList.contains("update")&&(yield this.render(),this.classList.remove("update"))}))}update(e){let t=!1;if(e.theme&&1===Object.keys(e).length){const t=this.$shadow.getElementById(c),i=this.createCssLink(e.theme,!0),s=this.$shadow.firstElementChild;return t?this.$shadow.replaceChild(i,t):s?this.$shadow.insertBefore(i,s):this.$shadow.appendChild(i),void this.setAttribute("theme",e.theme)}for(const[i,r]of Object.entries(e)){const e=s.Utils.String.camelToChain(i),n=this.getAttribute(e)||"";r!==n&&("width"===i&&"responsive"===n&&delete h[this.id],this.setAttribute(e,r),t=!0)}t&&this.refresh(!1)}createCssLink(e,t=!1){const i=document.createElement("link");return t&&(i.id=c),i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.setAttribute("href",e),i}refresh(e){const t=(new Date).getTime();e&&this.lastUpdate&&t-this.lastUpdate<200||(this.lastUpdate=t,this.classList.add("update"))}parseWidth(){const e=this.getAttribute("width")||"responsive";if(!e)throw new Error("System Error: width can't be resolved!");return"responsive"===e?this.parentElement?this.parentElement.clientWidth:this.clientWidth:"number"==typeof e?e:parseInt(e)}render(){var e;return l(this,void 0,void 0,(function*(){const t=this.getAttribute("src")||"",i=this.getAttribute("theme")||"",r=Math.max(this.parseWidth(),300),l=Math.max(parseInt(this.getAttribute("height")||String(450)),300);let c=this.getAttribute("layout")||"1x1";n(c)&&r<600&&(c=function(e){return"1x2"===e?"1x1":"2x2"===e?"2x1":e}(c)),function(e){return"2x1"===e||"2x2"===e}(c)&&l<500&&(c=function(e){return"2x1"===e?"1x1":"2x2"===e?"1x2":e}(c));const g=p(parseFloat(this.getAttribute("line-height")||String(2)),1.5,2),m=p(parseInt(this.getAttribute("font-size")||String(16)),10,48),f=this.getAttribute("font-family")||"",x=Math.min(parseInt(this.getAttribute("border-size")||String(1)),20),b=this.getAttribute("writing-mode")||"horizontal-tb",y=new s.WritingMode(b),v=new s.PhysicalSize({width:r,height:l}),E=function(e,t,i,s,r,o){if(e.isTextHorizontal())return s;const a=s*r,l=2*s;let c=i.width-l-2*o;n(t)&&(c-=33);const h=Math.floor(c/a);return s+Math.floor((c-a*h)/2)}(y,c,v,m,g,x),S=function(e,t,i,s,r,n){return 1.5*s}(0,0,0,m),w=function(e,t,i,r,n){return new s.PhysicalSize({width:e.width-2*i-2*n,height:e.height-48-r})}(v,0,E,S,x);this.$shadow.innerHTML="";const C=document.createElement("style"),k=document.createElement("style");if(C.textContent=function(e,t,i,s,r,n){const o=e.isVerticalRl()?"rtl":"ltr";return`\n  .player {\n    margin-bottom: 2em;\n    overflow: hidden;\n  }\n  #screen-header {\n    position: relative;\n    font-size: 12px;\n    top: 32px;\n    left: 32px;\n    width: ${t.width}px;\n    white-space: nowrap;\n  }\n  #title {\n    color: rgba(80,80,80, 0.8);\n  }\n  #sub-title {\n    color: rgba(80,80,80, 0.8);\n  }\n  #screen{\n    width: ${t.width}px;\n    height: ${t.height}px;\n    padding: 48px ${s}px ${r}px;\n    background: wheat;\n    border-width: ${n}px ${n}px 0 ${n}px;\n  }\n  #screen-footer {\n    padding: 10px;\n  }\n  #menu {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    gap: 10px;\n    margin-top: 0;\n    width: ${t.width}px;\n    color: white;\n    font-size: 14px;\n    background: #3c3c4e;\n    padding: 10px ${s}px;\n    border-width: 0 ${n}px ${n}px ${n}px;\n  }\n  #slider {\n    visibility: hidden; /* hide until onCompletePage is called. */\n    width: ${t.width}px;\n    padding: 0 ${s}px;\n  }\n  #slider input[type="range"] {\n    width: ${t.width}px;\n  }\n  #footer {\n    width: ${t.width}px;\n    padding: 0 32px;\n    text-align: right;\n    font-size: 0.82em;\n  }\n  #direct-content {\n    visibility: hidden;\n  }\n  input[type="range"] {\n    direction: ${o};\n  }\n  .nehan-line a {\n    color:#d61111;\n  }\n  .pager {\n    flex-basis: 100px;\n    padding: 4px 0px;\n  }\n  .nombre {\n    font-size: 0.92em;\n    text-align: center;\n    flex-basis: 150px;\n  }\n  .vline {\n    border-left: 1px dotted #7a7a7a;\n  }\n  .hline {\n    border-bottom: 1px dotted #7a7a7a;\n  }\n  `}(y,w,0,E,S,x),k.textContent=function(e,t){const i=o(e,t);switch(e){case"1x1":return"\n      #page-2, #page-3, #page-4, .vline, .hline {\n        display:none;\n      }\n      ";case"1x2":return`\n      #screen {\n        display: grid;\n        grid-template-rows: 100%;\n        grid-template-columns: ${i.width}px 1px ${i.width}px;\n        gap: 0 16px; /* vline makes 2*gapSize, so we use half for colGap. */\n      }\n      #page-1 {\n        grid-row: 1/2;\n        grid-column: 1/2;\n      }\n      .vline {\n        grid-row: 1/3;\n        grid-column: 2/3;\n      }\n      #page-3 {\n        grid-row: 1/2;\n        grid-column: 3/4;\n      }\n      #page-2, #page-4, .hline {\n        display: none;\n      }\n      `;case"2x1":return`\n      #screen {\n        display: grid;\n        grid-template-rows: ${i.height}px 1px ${i.height}px;\n        grid-template-columns: 100%;\n        gap: 16px 0px; /* hline makes 2*gapSize, so we use halt for rowGap. */\n      }\n      #page-1 {\n        grid-row: 1/2;\n        grid-column: 1/2;\n      }\n      #hline-12 {\n        grid-row: 2/3;\n        grid-column: 1/2;\n      }\n      #page-2 {\n        grid-row: 3/4;\n        grid-column: 1/2;\n      }\n      #page-3, #page-4, #hline-34, .vline {\n        display: none;\n      }\n      `;case"2x2":return`\n      #screen {\n        display: grid;\n        grid-template-rows: ${i.height}px 1px ${i.height}px;\n        grid-template-columns: ${i.width}px 1px ${i.width}px;\n        gap: 16px; /* vline and hline make 2*gapSize so we use half gap size */\n      }\n      #page-1 {\n        grid-row: 1/2;\n        grid-column: 1/2;\n      }\n      #hline-12 {\n        grid-row: 2/3;\n        grid-column: 1/2;\n      }\n      #page-2 {\n        grid-row: 3/4;\n        grid-column: 1/2;\n      }\n      .vline {\n        grid-row: 1/4;\n        grid-column: 2/3;\n      }\n      #page-3 {\n        grid-row: 1/2;\n        grid-column: 3/4;\n      }\n      #hline-34 {\n        grid-row: 2/3;\n        grid-column: 3/4;\n      }\n      #page-4 {\n        grid-row: 3/4;\n        grid-column: 3/4;\n      }\n      `}}(c,w),this.$shadow.appendChild(C),this.$shadow.appendChild(k),i){const e=this.createCssLink(i,!0);this.$shadow.appendChild(e)}(d.cssFiles||[]).forEach((e=>{const t=this.createCssLink(e,!1);this.$shadow.appendChild(t)}));const B=document.createElement("template");B.innerHTML='\n    <div class="player">\n      <div id="screen-header">\n        <span id="title"><slot name="title"></slot></span>\n        <span id="sub-title"><slot name="sub-title"></slot></span>\n      </div>\n      <div id="screen">\n        <div class="page" id="page-1"></div>\n        <div class="hline" id="hline-12"></div>\n        <div class="page" id="page-2"></div>\n        <div class="vline"></div>\n        <div class="page" id="page-3"></div>\n        <div class="hline" id="hline-34"></div>\n        <div class="page" id="page-4"></div>\n      </div>\n      <div id="screen-footer">\n        <div class="nombre">\n          <span id="page-no"></span>\n          <span id="separator">/</span>\n          <span id="page-count"></span>\n        </div>\n      </div>\n      <menu id="menu">\n        <button class="pager" id="goto-left">\n          <slot name="goto-left-label">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M9.78 12.78a.75.75 0 01-1.06 0L4.47 8.53a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L6.06 8l3.72 3.72a.75.75 0 010 1.06z"></path></svg>\n          </slot>\n        </button>\n        <button class="pager" id="goto-right">\n          <slot name="goto-right-label">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M6.22 3.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 010-1.06z"></path></svg>\n          </slot>\n        </button>\n      </menu>\n      <div id="slider">\n        <input id="slider-range" type="range" min="1" max="1" step="1" value="0">\n      </div>\n      <footer id="footer"><slot name="footer"></slot></footer>\n      <div id="direct-content"><slot name="content"></slot></div>\n    </div>',this.$shadow.appendChild(B.content.cloneNode(!0));const R=(null===(e=this.$shadow.host.querySelector("div[slot='content']"))||void 0===e?void 0:e.innerHTML)||"";""!==R?this.html=d.onFetchContent?d.onFetchContent("content.slot",R):R:t?t===this.src&&this.html||(this.src=t,this.html=yield fetch(this.src).then((e=>e.ok?e.text():`Failed to load ${t}`)).then((e=>d.onFetchContent?d.onFetchContent(t,e):e))):this.html="Can't resolve content. Neither 'content' slot or 'src' attribute is specified!";const L=new a(d,this,this.$shadow,this.html,c,y,w,m,f);"responsive"===this.getAttribute("width")&&(0===Object.entries(h).length&&window.addEventListener("resize",u),h[this.id]=L)}))}}},7240:(e,t,i)=>{var s,r;i.r(t),i.d(t,{AttrSelector:()=>Re,BasicStyle:()=>Fe,BlockLinkReducer:()=>Ds,BlockMargin:()=>qi,BlockNodeGenerator:()=>Xs,BlockReducer:()=>zs,BorderCollapse:()=>Le,BoxEnv:()=>W,BoxSizing:()=>$,Char:()=>n,ClassSelector:()=>Te,Color:()=>ce,ComplexSelector:()=>Pe,CompoundSelector:()=>Ne,ComputedRegion:()=>Pi,Config:()=>s,ConstantValueGenerator:()=>Ys,ContainingElement:()=>bi,Content:()=>ze,ContextBoxEdge:()=>Yi,ContextEdgeSize:()=>Ki,ContextEdgeState:()=>ji,CssCascade:()=>Me,CssComputedValueLoader:()=>Ce,CssLength:()=>Ae,CssLengthUnits:()=>Ie,CssLoader:()=>de,CssMacro:()=>H,CssParser:()=>he,CssProp:()=>_,CssRule:()=>G,CssSpecifiedDynamicValueLoader:()=>Se,CssSpecifiedInlineValueLoader:()=>we,CssSpecifiedValueLoader:()=>Ee,CssStyleDeclaration:()=>q,CssStyleSheet:()=>j,CssText:()=>K,CssUsedRegionLoader:()=>ke,Display:()=>Ze,DisplayBox:()=>qe,DisplayInside:()=>He,DisplayInternal:()=>Ge,DisplayListItem:()=>_e,DisplayOutside:()=>We,DisplayValue:()=>je,DomCallback:()=>Xe,DomCallbackEffector:()=>ts,DomTokenList:()=>Je,DualChar:()=>x,DualCharTable:()=>f,DynamicStyle:()=>tt,DynamicStyleContext:()=>Qe,DynamicStyleUtils:()=>et,FirstLineFormatContext:()=>ms,FloatRegion:()=>Zi,FlowFormatContext:()=>us,FlowRootFormatContext:()=>ps,Font:()=>lt,FontSizeKeyword:()=>Ke,FontSizeKeywordRelative:()=>Ye,FontSizeKeywordRelativeSize:()=>nt,FontSizeKeywordSize:()=>rt,FontSizeKeywords:()=>it,FontSizeKeywordsRelative:()=>st,HalfChar:()=>b,HoriLogicalNodeEvaluator:()=>Qi,Hyphenator:()=>fs,IdSelector:()=>ct,ImageLoader:()=>qt,ImageLoaderContext:()=>Gt,InlineBlockReducer:()=>Is,InlineLinkReducer:()=>$s,InlineMargin:()=>Gi,InlineNodeGenerator:()=>js,InlineReducer:()=>Bs,Kerning:()=>xs,LayoutOutline:()=>dt,LayoutOutlineEvaluator:()=>xi,LayoutOutlineParser:()=>ht,LayoutResult:()=>ds,LayoutSection:()=>ut,Lexer:()=>U,LineBreakGenerator:()=>Ks,LineReducer:()=>Ns,ListItemInitializer:()=>me,ListMarkerReducer:()=>Ps,ListStyle:()=>ft,ListStylePosition:()=>pt,ListStyleType:()=>mt,LogicalBackgroundPos:()=>Rt,LogicalBlockNode:()=>os,LogicalBlockReNode:()=>cs,LogicalBorder:()=>ae,LogicalBorderColor:()=>ee,LogicalBorderRadius:()=>te,LogicalBorderStyle:()=>re,LogicalBorderStyleValue:()=>ie,LogicalBorderWidth:()=>oe,LogicalBorderWidthKeyword:()=>se,LogicalBorderWidthKeywordSize:()=>ne,LogicalBoxEdge:()=>le,LogicalClear:()=>xt,LogicalCornerMap:()=>wt,LogicalCssEvaluator:()=>Xi,LogicalCursorPos:()=>bt,LogicalEdge:()=>J,LogicalEdgeDirections:()=>Y,LogicalEdgeMap:()=>St,LogicalEdgeSize:()=>Q,LogicalFloat:()=>yt,LogicalInlineBlockNode:()=>as,LogicalInlineNode:()=>ns,LogicalInlineReNode:()=>hs,LogicalLineNode:()=>ss,LogicalMargin:()=>Ct,LogicalNodeGenerator:()=>Hs,LogicalPadding:()=>kt,LogicalPos:()=>Bt,LogicalRect:()=>Lt,LogicalRubyNode:()=>rs,LogicalSize:()=>Tt,LogicalTableCellsNode:()=>ls,LogicalTextAlign:()=>Pt,LogicalTextJustifier:()=>Ji,LogicalTextNode:()=>is,LogicalVerticalAlign:()=>Nt,MixChar:()=>V,NativeStyleMap:()=>zt,NehanDocument:()=>pe,NehanElement:()=>Be,OverflowWrap:()=>Mt,PageBreakAfter:()=>It,PageBreakBefore:()=>At,PageRootFormatContext:()=>gs,PagedNehanDocument:()=>Js,PhysicalEdge:()=>X,PhysicalEdgeDirections:()=>Z,PhysicalSize:()=>Vt,Position:()=>Ft,PseudoClassSelector:()=>Ot,PseudoElement:()=>Wt,PseudoElementInitializer:()=>ve,PseudoElementSelector:()=>Ut,PseudoElementTagName:()=>Dt,PseudoElementTagNames:()=>$t,ReFormatContext:()=>Ss,ReIdResizer:()=>Cs,ReNodeGenerator:()=>Zs,ReReducer:()=>Ws,ReShrinkResizer:()=>ws,RefChar:()=>y,ReplacedElement:()=>Ht,RootBlockReducer:()=>Ms,RubyBaseReducer:()=>Ls,RubyChildFormatContext:()=>ys,RubyFormatContext:()=>vs,RubyNodeGenerator:()=>Gs,RubyNormalizer:()=>ye,RubyReducer:()=>Rs,RubyTextReducer:()=>Ts,Selector:()=>D,SelectorCache:()=>jt,SelectorLexer:()=>Kt,SelectorParser:()=>Yt,SelectorText:()=>Zt,SelectorTokenType:()=>_t,SemanticStyle:()=>fi,SmpUniChar:()=>v,SpaceChar:()=>L,SpaceCharTable:()=>R,Specificity:()=>Xt,TableCellInitializer:()=>be,TableCellReducer:()=>As,TableCellsFormatContext:()=>Es,TableCellsGenerator:()=>_s,TableCellsReducer:()=>Vs,TableReducer:()=>Fs,TableRowGroupInitializer:()=>fe,TableRowGroupReducer:()=>Os,TableRowInitializer:()=>xe,TableRowReducer:()=>Us,Tcy:()=>T,TcyLexer:()=>$e,TcyTokenMapper:()=>O,TextCombineUpright:()=>Jt,TextEmphasis:()=>ti,TextEmphasisStyle:()=>ei,TextFormatContext:()=>bs,TextLexer:()=>De,TextMeasure:()=>I,TextNodeGenerator:()=>qs,TextOrientation:()=>ii,TextReducer:()=>ks,TypeSelector:()=>si,UniversalSelector:()=>ri,UprightTokenMapper:()=>F,UsedRegionResolver:()=>Ni,UserAgentStyle:()=>Ue,UserAgentStyles:()=>Oe,Utils:()=>r,ValidBlockSelector:()=>ge,VertLogicalNodeEvaluator:()=>es,WhiteSpace:()=>ni,Word:()=>A,WordBreak:()=>oi,WritingMode:()=>ai}),function(e){e.lang="ja",e.engineVersion=7,e.pageRootTagName="body",e.normalizeHtml=e=>e.replace(/\r/g,"").replace(/<rp>(.*?)<\/rp>/gi,"").replace(/<!--[\s\S]*?-->/g,"").replace(/\u2015{2}/g,"——").replace(/\s+$/,"").replace(/(?:<page-break>)|(?:<pbr>)/g,"<hr style='border-width:0px; margin:0; page-break-after: always'>"),e.maxPageCount=2e3,e.maxJustifyGap=1,e.ignoreEmptyLine=!1,e.ignoreEmptyInline=!1,e.ignoreZeroRe=!0,e.debugImageLoader=!1,e.debugCharacter=!1,e.debugLayout=!1,e.useStrictFormatContextName=!1,e.defaultFontSize=16,e.defaultFontFamily=["'ヒラギノ明朝 Pro W3'","'Hiragino Mincho Pro'","'HiraMinProN-W3'","'Meiryo'","'メイリオ'","'IPA明朝'","'IPA Mincho'","'ＭＳ 明朝'","'MS Mincho'","monospace"].join(","),e.defaultFont=[e.defaultFontSize+"px",e.defaultFontFamily].join(" "),e.defaultBodyMeasure=640,e.defaultBodyExtent=480,e.defaultLineHeight=2,e.defaultBorderColor="transparent",e.defaultTableBorderColor="rgba(0,0,0,0.4)",e.defaultFloatMeasure=100,e.defaultInlineBlockMeasure=200,e.nonOmitWhiteSpaces=["　"],e.unmanagedCssProps=["background","background-image","background-color","background-position","text-decoration","z-index"],e.nonLayoutTags=["br"],e.fontSizeOnlyTags=["b","br","em","rb","rt","rp","ruby","strong"],e.edgeSkipTags=["rb","rt","rp","ruby"],e.boxSizeSkipTags=["b","em","rb","rt","rp","ruby","strong"],e.ignoredTags=["script","noscript","meta"],e.IgnoredInlineStyleProps=[],e.rexWord=/^[\u0021-\u007E\u00C0-\u02A8\u2000-\u206F\uFB00-\uFB06]+/,e.rexRefChar=/^&[\S]+?;/,e.isTcyWord=(e,t)=>!1,e.rexHalfChar=/^[\uFF66-\uFF69\uFF71-\uFF9D][\uFF9E-\uFF9F]?/,e.rexSpace=/^[ \f\n\r\t\v\u00A0\u1680\u180e\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]/,e.rexSpaceCharRef=/^&(nb|en|em|thin)sp;/,e.rexVoicedMark=/^[\u3099-\u309C]/}(s||(s={})),function(e){e.atoi=(e,t=0)=>{const i=parseInt(e,10);return isNaN(i)?(s.debugLayout&&console.warn(`${e} is not a number, so use ${t}`),t):i},e.isNumber=e=>!1===isNaN(Number(e)),e.mergeDefault=(e,t)=>Object.assign(Object.assign({},t),e);class t{static fromArray(e){return e.reduce(((e,t)=>(e[t]=t,e)),Object.create(null))}static toObjArray(e){return Object.keys(e).map((t=>({id:e[t],name:t})))}static toValueArray(e){return Object.keys(e).map((t=>e[t]))}static member(e,i){return t.toValueArray(e).indexOf(i)>=0}}e.Enum=t,e.Choice=class{static select(e){return e.values.indexOf(e.value)>=0?e.value:e.initial}},e.String=class{static getUnicodeProp(e){let t=e.charCodeAt(0).toString(16).toUpperCase();switch(t.length){case 0:return"U+0000";case 1:return"U+000"+t;case 2:return"U+00"+t;case 3:return"U+0"+t}return"U+"+t}static multiSpaceToSingle(e){return e.replace(/\s+/g," ")}static multiSpaceToSingle2(e){return e.replace(/[\u0020\f\n\r\t\v\u00A0\u1680\u180e\u2000-\u200A\u2028\u2029\u202F\u205F\uFEFF]+/gm," ")}static capitalize(e){return""===e?"":e.charAt(0).toUpperCase()+e.slice(1)}static camelToChain(e){return e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase()))}static chainToCamel(e){return e.indexOf("-")<0?e:e.split("-").map(((e,t)=>0===t?e:this.capitalize(e))).join("")}}}(r||(r={}));class n{constructor(e){this.text=e,this.size=new Tt({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size,this.empha=e.empha,e.empha&&(this.size.extent=2*e.font.size)}toString(){return this.text}acceptEvaluator(e){return this.empha?e.visitCharEmpha(this,this.empha):e.visitChar(this)}}const o={parenType:"open",kinsokuPos:"tail",kernEnable:!0,hangEnable:!1,rotatable:!1,isSmall:!1},a={parenType:"open",kinsokuPos:"tail",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!0},l={parenType:"close",kinsokuPos:"head",kernEnable:!0,hangEnable:!0,rotatable:!1,isSmall:!1},c={parenType:"close",kinsokuPos:"head",kernEnable:!1,hangEnable:!0,rotatable:!1,isSmall:!0},h={parenType:"none",kinsokuPos:"head",kernEnable:!0,hangEnable:!0,rotatable:!1,isSmall:!1},d={parenType:"none",kinsokuPos:"head",kernEnable:!1,hangEnable:!0,rotatable:!1,isSmall:!0},u={parenType:"none",kinsokuPos:"none",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!1},p={parenType:"none",kinsokuPos:"head",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!0},g={parenType:"none",kinsokuPos:"none",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!1},m={"U+0028":a,"U+0029":c,"U+002C":d,"U+002D":u,"U+002E":d,"U+003A":d,"U+003D":g,"U+005B":a,"U+005D":c,"U+007B":a,"U+007D":c,"U+00AB":a,"U+00BB":c,"U+2014":u,"U+2015":u,"U+201C":a,"U+201D":c,"U+2025":u,"U+2026":u,"U+2190":g,"U+2191":g,"U+2192":g,"U+2193":g,"U+21D2":g,"U+2212":u,"U+2252":g,"U+2260":g,"U+226A":o,"U+226B":l,"U+22EF":u,"U+2500":u,"U+2772":o,"U+2773":l,"U+3001":h,"U+3002":h,"U+3008":o,"U+3009":l,"U+300A":o,"U+300B":l,"U+300C":o,"U+300D":l,"U+300E":o,"U+300F":l,"U+3010":o,"U+3011":l,"U+3014":o,"U+3015":l,"U+3016":o,"U+3017":l,"U+3018":o,"U+3019":l,"U+301A":o,"U+301B":l,"U+301C":u,"U+301D":o,"U+301E":l,"U+301F":l,"U+3041":p,"U+3043":p,"U+3045":p,"U+3047":p,"U+3049":p,"U+3063":p,"U+3083":p,"U+3085":p,"U+3087":p,"U+308E":p,"U+30A1":p,"U+30A3":p,"U+30A5":p,"U+30A7":p,"U+30A9":p,"U+30C3":p,"U+30E3":p,"U+30E5":p,"U+30E7":p,"U+30EE":p,"U+30F5":p,"U+30F6":p,"U+30FC":u,"U+FF08":o,"U+FF09":l,"U+FF0C":h,"U+FF0D":u,"U+FF0E":h,"U+FF1A":{parenType:"none",kinsokuPos:"none",kernEnable:!1,hangEnable:!1,rotatable:!1,isSmall:!1},"U+FF1C":o,"U+FF1D":g,"U+FF1E":g,"U+FF3B":o,"U+FF3D":l,"U+FF3F":u,"U+FF5B":o,"U+FF5C":u,"U+FF5D":l,"U+FF5E":u,"U+FF61":d,"U+FF62":a,"U+FF63":c,"U+FF64":h,"U+FF70":u};class f{static load(e){let t=r.String.getUnicodeProp(e);return m[t]||null}}class x{constructor(e,t){this.text=e,this.size=new Tt({measure:0,extent:0}),this.info=t,this.kerning=!1,this.spacing=0,this.charCount=1}isParen(){return this.isOpenParen()||this.isCloseParen()}isOpenParen(){return"open"===this.info.parenType}isCloseParen(){return"close"===this.info.parenType}isTailNg(){return"tail"===this.info.kinsokuPos}isHeadNg(){return"head"===this.info.kinsokuPos}isKernEnable(){return this.info.kernEnable}isHangEnable(){return this.info.hangEnable}isSmall(){return this.info.isSmall}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size,this.kerning&&this.isKernEnable()&&(this.size.measure=Math.floor(e.font.size/2))}setKerning(e,t){this.info.kernEnable?this.kerning=t:console.warn("kerning is not allowed for this character:",this)}toString(){return this.text}acceptEvaluator(e){return this.kerning?e.visitDualCharKern(this):e.visitDualChar(this)}}class b{constructor(e){this.text=e,this.size=new Tt({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.isVertical?e.font.size:Math.floor(e.font.size/2),this.size.extent=e.font.size,this.empha=e.empha,e.empha&&(this.size.extent=2*e.font.size)}toString(){return this.text}acceptEvaluator(e){return e.visitHalfChar(this)}}class y{constructor(e){this.text=e,this.size=new Tt({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size}toString(){return this.text}acceptEvaluator(e){return this.empha?e.visitRefCharEmpha(this,this.empha):e.visitRefChar(this)}}y.softHyphen="&shy;";class v{constructor(e){this.text=e,this.size=new Tt({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){this.size.measure=e.font.size,this.size.extent=e.font.size,this.empha=e.empha,e.empha&&(this.size.extent=Math.floor(1.5*e.font.size))}toString(){return this.text}acceptEvaluator(e){return e.visitSmpUniChar(this)}}let E=e=>({advanceRate:e,isNoBreak:!1,isControl:!1}),S={advanceRate:0,isNoBreak:!1,isControl:!1},w={advanceRate:0,isNoBreak:!1,isControl:!0},C=E(1),k=E(.5),B={"U+0009":k,"U+000A":w,"U+000B":w,"U+000C":w,"U+000D":w,"U+001C":k,"U+001D":k,"U+001E":k,"U+001F":k,"U+0020":k,"U+00A0":{advanceRate:.38,isNoBreak:!0,isControl:!1},"U+034F":S,"U+1680":k,"U+180E":k,"U+2000":k,"U+2001":C,"U+2002":k,"U+2003":C,"U+2004":E(1/3),"U+2005":E(1/4),"U+2006":E(1/6),"U+2007":k,"U+2008":k,"U+2009":E(.2),"U+200A":E(.1),"U+200B":S,"U+200C":S,"U+200D":S,"U+200E":S,"U+200F":S,"U+2028":w,"U+2029":w,"U+202A":w,"U+202B":w,"U+202C":w,"U+202D":w,"U+202E":w,"U+202F":{advanceRate:.33,isNoBreak:!0,isControl:!1},"U+2061":w,"U+2062":w,"U+2063":w,"U+3000":C,"U+FEFE":{advanceRate:0,isNoBreak:!0,isControl:!1}};class R{static load(e){let t=r.String.getUnicodeProp(e),i=B[t];if(!i)throw new Error("SpaceChar("+t+") not exists.");return i}}class L{constructor(e){this.text=this.normalize(e),this.size=new Tt({measure:0,extent:0}),this.info=R.load(e),this.kerning=!1,this.spacing=0,this.charCount=0}static charRefToStr(e){switch(e){case"&nbsp;":return" ";case"&thinsp;":return" ";case"&ensp;":return" ";case"&emsp;":return" "}throw new Error("invalid space char ref("+e+")")}normalize(e){return 0===e.indexOf("&")?L.charRefToStr(e):e}getCssVert(){let e=new zt;return e.set("height",this.size.measure+"px"),e}setMetrics(e){this.size=I.getWordSize(e.font,this.text),0===this.size.measure&&(this.size.measure=this.size.extent*this.info.advanceRate)}toString(){return this.text}isNoBreak(){return this.info.isNoBreak}isZeroWidth(){return 0===this.info.advanceRate}isCarriageReturn(){return"\r"===this.text}isLineFeed(){return"\n"===this.text}acceptEvaluator(e){return e.visitSpaceChar(this)}}L.zeroWidthSpace="​",L.enSpace=" ",L.emSpace=" ",L.noBreakSpace=" ",L.ideographicSpace="　",L.markerSpace=L.enSpace;class T{constructor(e){this.text=e,this.size=new Tt({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=e.length}setMetrics(e){e.isVertical?(this.size.measure=e.font.size,this.size.extent=e.font.size):this.size=I.getWordSize(e.font,this.text)}toString(){return this.text}acceptEvaluator(e){return e.visitTcy(this)}}class P{static isEnabled(){return null!==this.offCanvasCtx}getMeasure(e,t){const i=P.offCanvasCtx;return i?(i.font=t.css,i.measureText(e).width):0}}P.offCanvasCtx="undefined"==typeof OffscreenCanvas?null:new OffscreenCanvas(0,0).getContext("2d");class N{static isEnabled(){return null!==this.canvasCtx}getMeasure(e,t){const i=N.canvasCtx;return i?(i.font=t.css,i.measureText(e).width):0}}N.canvasCtx=function(){const e=document.createElement("canvas");return e.style.display="hidden",e.style.width=e.style.height="0",document.body&&document.body.appendChild(e),e.getContext("2d")}();class z{getMeasure(e,t){const i=z.node;if(!i)return 0;i.style.font=t.css,i.innerHTML=e,document.body.appendChild(i);const s=i.getBoundingClientRect();return document.body.removeChild(i),s.width}}z.node=function(){const e=document.createElement("span"),t=e.style;return t.display="inline",t.margin="0",t.padding="0",t.borderWidth="0",t.lineHeight="1",t.width="auto",t.height="auto",t.visibility="hidden",e}();const M=P.isEnabled()?new P:N.isEnabled()?new N:new z;class I{static getWordSize(e,t){const i=M.getMeasure(t,e),s=e.size;return new Tt({measure:i,extent:s})}}class A{constructor(e){this.text=e,this.size=new Tt({measure:0,extent:0}),this.kerning=!1,this.spacing=0}get charCount(){return this.text.length}toString(){return this.text}setMetrics(e){this.size=I.getWordSize(e.font,this.text)}toTcys(){return this.text.split("").map((e=>new T(e)))}breakWord(e){const t=Math.floor(this.text.length*e/this.size.measure),i=this.text.substring(0,t),s=this.text.substring(t);return this.text=s,new A(i)}restoreBrokenWord(e){this.text=e.text+this.text}acceptEvaluator(e){return e.visitWord(this)}}class V{constructor(e){this.text=e,this.size=new Tt({measure:0,extent:0}),this.kerning=!1,this.spacing=0,this.charCount=1}setMetrics(e){e.isVertical?this.size.measure=e.font.size:this.size.measure=Math.floor(1.25*e.font.size),this.size.extent=e.font.size}toString(){return this.text}acceptEvaluator(e){return e.visitMixChar(this)}}class F{visit(e){return e.reduce(((e,t)=>t instanceof A?e.concat(t.toTcys()):e.concat(t)),[])}}class O{visit(e){return e.map(((t,i)=>{if(t instanceof A==0)return t;const r=e[i-1],n=e[i+1];return s.isTcyWord(t.text,{prev:r,next:n})?new T(t.text):t}))}}class U{constructor(e,t={}){this.src=this.normalize(e,t),this.buff=this.src,this.pos=0,this.tokens=[],this.setupTokens(t)}acceptTokenMapper(e){this.tokens=e.visit(this.tokens)}normalize(e,t={}){return e}stepBuff(e){this.buff=this.buff.substring(e)}getChar(){let e=this.peekChar();return this.stepBuff(1),e}peekChar(){return this.buff.substring(0,1)}get progress(){return 0===this.tokens.length?1:this.pos/this.tokens.length}hasNext(){return this.pos<this.tokens.length}getNext(){return this.tokens[this.pos++]}setupTokens(e){for(;this.hasNextBuff();)this.addToken(this.createToken(e));return this.tokens}addToken(e){this.tokens.push(e)}createToken(e){throw new Error("BufferedLexer.createToken must be overrided")}hasNextBuff(){return""!==this.buff}peek(e=0){return this.tokens[this.pos+e]}pushBack(e){this.pos=Math.max(0,this.pos-Math.abs(e))}}class D{constructor(){this.specificity=new Xt(0,0,0)}test(e){return!1}}class ${constructor(e){this.value=e}static load(e){const t=Me.getValue(e,"box-sizing");return new $(t)}isContentBox(){return"content-box"===this.value}isPaddingBox(){return"padding-box"===this.value}isBorderBox(){return"border-box"===this.value}}class W{constructor(e){this.element=e,this.color=ce.load(e),this.measure=Tt.loadMeasure(e),this.extent=Tt.loadExtent(e),this.float=yt.load(e),this.display=this.loadDisplay(e),this.position=Ft.load(e),this.absPos=Bt.load(e),this.writingMode=ai.load(e),this.font=lt.load(e),this.edge=this.loadEdge(e,this.display),this.verticalAlign=Nt.load(e),this.textAlign=Pt.load(e),this.textCombineUpright=Jt.load(e),this.textOrientation=ii.load(e),this.textEmphasis=ti.load(e),this.overflowWrap=Mt.load(e),this.wordBreak=oi.load(e),this.content=ze.load(e),this.listStyle=ft.load(e),this.whiteSpace=ni.load(e),this.pageBreakBefore=At.load(e),this.pageBreakAfter=It.load(e),this.backgroundPos=Rt.load(e),this.borderCollapse=Le.load(e)}loadDisplay(e){const t=Ze.load(e);if("a"===e.tagName&&t.isInlineLevel()){const i=e.firstElementChild;return i?(de.load(i),Ze.load(i)):t}return t}loadEdge(e,t){return t.isNone()?le.none:le.load(e)}}class H{constructor(e){this.macro=e}call(e){return this.macro(e)}}class _{constructor(e){this.value=this.normalize(e)}toString(){return this.value}normalize(e){let t=e.replace(/\s/g,"");return t=r.String.camelToChain(t),t}replace(e,t){return this.value.replace(e,t)}join(e,t="-"){return[this.value].concat(e).join(t)}isDynamicStyleProp(){return"!"===this.value.charAt(0)}getDynamicStylePropName(){return this.isDynamicStyleProp()?this.value.substring(1):""}isDomCallback(){return"@"===this.value.charAt(0)}getDomCallbackName(){return this.isDomCallback()?this.value.substring(1):""}}class G{constructor(e,t){this.selector=e,this.style=t}toString(){return"(rule):"+this.selector.toString()}test(e,t=!1){return this.selector.test(e,t)}get pseudoElementName(){return this.peSelector?this.peSelector.tagName:""}get peSelector(){return this.selector.peSelector}getPropertyValue(e){return this.style.getPropertyValue(e)}static compare(e,t){return Pe.compare(e.selector,t.selector)}}class q{constructor(){this.styles=new Map,this.dynamicStyles=[],this.domCallbacks=[]}hasDomCallbacks(){return this.domCallbacks.length>0}hasDynamicStyles(){return this.dynamicStyles.length>0}isEmpty(){return 0===this.styles.size&&0===this.dynamicStyles.length&&0===this.domCallbacks.length}callDomCallbacks(e,t,i){this.domCallbacks.forEach((s=>s.call(e,t,i)))}getPropertyValue(e){return this.styles.get(e)||null}setProperty(e,t){const i=new _(e),s=new K({prop:i.value,value:t});return he.parseDeclaration(i,s).reduce(((e,t)=>(e.styles.set(t.prop,t.value),e)),this)}addDynamicStyle(e){return this.dynamicStyles.push(e),this}addDomCallback(e){return this.domCallbacks.push(e),this}removeProperty(e){return this.styles.delete(e)}forEach(e){this.styles.forEach(((t,i)=>e(i,t)))}mergeFrom(e){return e.styles.forEach(((e,t)=>{this.styles.set(t,e)})),this.dynamicStyles=this.dynamicStyles.concat(e.dynamicStyles),this.domCallbacks=this.domCallbacks.concat(e.domCallbacks),this}getDynamicStyle(e,t){return this.dynamicStyles.reduce(((i,s)=>{const r=s.call(e,t)||{};return i.mergeFrom(r)}),new q)}acceptCssEvaluator(e){return e.visitUnmanagedCssProps(this)}}class j{constructor(e){this.rules=[],e&&this.addCssRules(e)}sort(){return this.rules.sort(G.compare),this}mergeStyleSheet(e){return this.rules=this.rules.concat(e.rules),this.sort(),this}getPseudoRules(){return this.rules.filter((e=>null!==e.peSelector))}getStyleOfElement(e){return this.rules.filter((t=>t.test(e))).reduce(((e,t)=>e.mergeFrom(t.style)),new q)}addCssRules(e){for(let t in e){let i=he.parseRule(t,e[t]);this.rules=this.rules.concat(i)}return this.sort()}addRule(e,t){const i=he.parseRule(e,t);return this.rules=this.rules.concat(i),this.sort()}}class K{constructor(e){this.value=this.getValue(e)}getValue(e){switch(e.prop){case"content":return e.value;default:return K.normalize(e.value)}}split(e=/\s/){return this.value.split(e)}static normalize(e){let t=e.trim();return t=t.replace(/[\n\t]/g,""),t=t.replace(/!important/g,""),t=r.String.multiSpaceToSingle(t),t=t.replace(/\s*([,/;])\s*/g,"$1"),t}static getValue4D(e){let t=e.split(/\s/);switch(t.length){case 1:return[t[0],t[0],t[0],t[0]];case 2:return[t[0],t[1],t[0],t[1]];case 3:return[t[0],t[1],t[2],t[1]];case 4:return[t[0],t[1],t[2],t[3]]}throw new Error("invalid shorthanded 4d value:"+e)}static getValue4D2(e){let t=e.split("/").map((e=>K.getValue4D(e)));return 1===t.length&&t.push(t[0]),t}}const Y=["before","end","after","start"],Z=["top","right","bottom","left"];class X{constructor(e){this.top=e.top,this.right=e.right,this.bottom=e.bottom,this.left=e.left}get items(){return[{prop:"top",value:this.top},{prop:"right",value:this.right},{prop:"bottom",value:this.bottom},{prop:"left",value:this.left}]}}class J{constructor(e){this.before=e.before,this.end=e.end,this.after=e.after,this.start=e.start}static isBlockEdge(e){return"before"===e||"after"===e}static isInlineEdge(e){return"start"===e||"end"===e}getPhysicalEdgeValue(e){return this.items.reduce(((t,i)=>(t[St.select(e).get(i.prop)]=i.value,t)),{})}getPhysicalEdge(e){return new X(this.getPhysicalEdgeValue(e))}getPropByLogicalDirection(e){throw new Error("LogicalEdge<T>::getPropByLogicalDirection must be overrided.")}get values(){return{before:this.before,end:this.end,after:this.after,start:this.start}}get items(){return[{prop:"before",value:this.before},{prop:"end",value:this.end},{prop:"after",value:this.after},{prop:"start",value:this.start}]}}class Q extends J{static loadDirection(e,t){return r.atoi(Me.getValue(e,t))}static get zeroValue(){return{before:0,end:0,after:0,start:0}}isZero(){return 0===this.before&&0===this.end&&0===this.after&&0===this.start}clone(){return new Q({before:this.before,end:this.end,after:this.after,start:this.start})}get extent(){return this.before+this.after}get measure(){return this.start+this.end}}class ee extends J{static parseShorthand(e){let t=K.getValue4D(e.value);return[{prop:"border-before-color",value:t[0]},{prop:"border-end-color",value:t[1]},{prop:"border-after-color",value:t[2]},{prop:"border-start-color",value:t[3]}]}static load(e){return new ee(Y.reduce(((t,i)=>(t[i]=Me.getValue(e,`border-${i}-color`),t)),{}))}static get none(){return new ee(ee.noneValue)}static get noneValue(){return{before:"transparent",end:"transparent",after:"transparent",start:"transparent"}}clone(){return new ee(this.values)}getPropByLogicalDirection(e){return`border-${e}-color`}acceptCssEvaluator(e){return e.visitLogicalBorderColor(this)}}class te{constructor(e){this.beforeStart=e.beforeStart,this.beforeEnd=e.beforeEnd,this.afterEnd=e.afterEnd,this.afterStart=e.afterStart}clone(){return new te({beforeStart:this.beforeStart,beforeEnd:this.beforeEnd,afterEnd:this.afterEnd,afterStart:this.afterStart})}static get none(){return new te(te.noneValue)}static get noneValue(){return{beforeStart:0,beforeEnd:0,afterEnd:0,afterStart:0}}static load(e){let t=te.corners.reduce(((t,i)=>{let s=`border-${i}-radius`,n=Me.getValue(e,s);return t[r.String.chainToCamel(i)]=n,t}),{});return new te(t)}static parseShorthand(e){let t=K.getValue4D2(e.value),i=t[0],s=t[1];return[{prop:"border-before-start-radius",value:[i[0],s[0]].join(" ")},{prop:"border-before-end-radius",value:[i[1],s[1]].join(" ")},{prop:"border-after-end-radius",value:[i[2],s[2]].join(" ")},{prop:"border-after-start-radius",value:[i[3],s[3]].join(" ")}]}get items(){return[{prop:"before-start",value:this.beforeStart},{prop:"before-end",value:this.beforeEnd},{prop:"after-end",value:this.afterEnd},{prop:"after-start",value:this.afterStart}]}}var ie,se;te.corners=["before-start","before-end","after-end","after-start"],function(e){e.NONE="none",e.HIDDEN="hidden",e.DOTTED="dotted",e.DASHED="dashed",e.SOLID="solid",e.DOUBLE="double",e.GROOVE="groove",e.RIDGE="ridge",e.INSET="inset",e.OUTSET="outset"}(ie||(ie={}));class re extends J{static parseShorthand(e){let t=K.getValue4D(e.value);return[{prop:"border-before-style",value:t[0]},{prop:"border-end-style",value:t[1]},{prop:"border-after-style",value:t[2]},{prop:"border-start-style",value:t[3]}]}static load(e){return new re(Y.reduce(((t,i)=>(t[i]=Me.getValue(e,`border-${i}-style`),t)),{}))}static get noneValue(){return{before:"none",end:"none",after:"none",start:"none"}}static get none(){return new re(re.noneValue)}clone(){return new re(this.values)}getPropByLogicalDirection(e){return`border-${e}-style`}acceptCssEvaluator(e){return e.visitLogicalBorderStyle(this)}}re.values=r.Enum.toValueArray(ie),function(e){e.THIN="thin",e.MEDIUM="medium",e.THICK="thick"}(se||(se={}));const ne={thin:2,medium:4,thick:6};class oe extends Q{static parseShorthand(e){const t=K.getValue4D(e.value);return[{prop:"border-before-width",value:t[0]},{prop:"border-end-width",value:t[1]},{prop:"border-after-width",value:t[2]},{prop:"border-start-width",value:t[3]}]}static load(e){return new oe(Y.reduce(((t,i)=>(t[i]=Q.loadDirection(e,`border-${i}-width`),t)),{}))}static get none(){return new oe(Q.zeroValue)}clone(){return new oe(this.values)}clearBefore(){this.before=0}clearEnd(){this.end=0}clearAfter(){this.after=0}clearStart(){this.start=0}getPropByLogicalDirection(e){return`border-${e}-width`}acceptCssEvaluator(e){return e.visitLogicalBorderWidth(this)}}oe.keywords=r.Enum.toValueArray(se);class ae{constructor(e){this.style=e.style,this.width=e.width,this.color=e.color,this.radius=e.radius}clone(){return new ae({style:this.style.clone(),width:this.width.clone(),color:this.color.clone(),radius:this.radius.clone()})}static load(e){return new ae({style:re.load(e),width:oe.load(e),color:ee.load(e),radius:te.load(e)})}static get none(){return new ae({style:re.none,width:oe.none,color:ee.none,radius:te.none})}acceptCssEvaluator(e){const t=new zt;return e.visitLogicalBorderWidth(this.width).mergeTo(t),e.visitLogicalBorderStyle(this.style).mergeTo(t),e.visitLogicalBorderColor(this.color).mergeTo(t),e.visitLogicalBorderRadius(this.radius,this.width).mergeTo(t),t}clearBefore(){this.width.clearBefore()}clearEnd(){this.width.clearEnd()}clearAfter(){this.width.clearAfter()}clearStart(){this.width.clearStart()}get beforeWidth(){return this.width.before}get endWidth(){return this.width.end}get afterWidth(){return this.width.after}get startWidth(){return this.width.start}static expand(e){return e.reduce(((e,t)=>{switch(t.prop){case"width":return e.concat(oe.parseShorthand(new K(t)));case"style":return e.concat(re.parseShorthand(new K(t)));case"color":return e.concat(ee.parseShorthand(new K(t)))}return console.error(`undefined prop for logical-border:${t.prop}`),e}),[])}static inferPropType(e){return re.values.indexOf(e)>=0?"style":oe.keywords.indexOf(e)>=0||Ae.hasUnit(e)?"width":"color"}static parseShorthandWidthStyleColor(e){let t={width:"medium",style:"none",color:"currentcolor"};return("none"===e.value?[]:e.split().slice(0,3)).forEach((e=>{let i=ae.inferPropType(e);t[i]=e}),t),Object.keys(t).map((e=>({prop:e,value:t[e]})))}static parseShorthand(e){let t=ae.parseShorthandWidthStyleColor(e);return ae.expand(t)}static parseShorthandEach(e,t){return ae.parseShorthandWidthStyleColor(e).map((e=>({prop:`border-${t}-${e.prop}`,value:e.value})))}}class le{constructor(e){this.padding=e.padding,this.border=e.border,this.margin=e.margin}static load(e){return e.tagName===s.pageRootTagName?this.loadRootBoxEdge(e):this.loadBoxEdge(e)}static loadRootBoxEdge(e){return s.engineVersion<=6?new le({padding:kt.load(e),border:ae.none,margin:Ct.none}):this.none}static loadBoxEdge(e){return new le({padding:kt.load(e),border:ae.load(e),margin:Ct.load(e)})}static get none(){return new le({padding:kt.none,border:ae.none,margin:Ct.none})}clone(){return new le({padding:this.padding.clone(),border:this.border.clone(),margin:this.margin.clone()})}clearBefore(){this.padding.before=0,this.border.clearBefore(),this.margin.before=0}clearAfter(){this.padding.after=0,this.border.clearAfter(),this.margin.after=0}clearStart(){this.padding.start=0,this.border.clearStart(),this.margin.start=0}clearEnd(){this.padding.end=0,this.border.clearEnd(),this.margin.end=0}get start(){return this.padding.start+this.border.startWidth+this.margin.start}get end(){return this.padding.end+this.border.endWidth+this.margin.end}get before(){return this.padding.before+this.border.beforeWidth+this.margin.before}get after(){return this.padding.after+this.border.afterWidth+this.margin.after}get extent(){return this.before+this.after}get measure(){return this.start+this.end}get borderBoxBefore(){return this.padding.before+this.border.width.before}get borderBoxAfter(){return this.padding.after+this.border.width.after}get borderBoxStart(){return this.padding.start+this.border.width.start}get borderBoxEnd(){return this.padding.end+this.border.width.end}get borderBoxExtent(){return this.borderBoxBefore+this.borderBoxAfter}get borderBoxMeasure(){return this.borderBoxStart+this.borderBoxStart}getInnerBoxOffset(){return{start:this.padding.start,before:this.padding.before}}}class ce{constructor(e){this.value=e}static load(e){const t=e.computedStyle.getPropertyValue("color")||"inherit";return new ce(t)}acceptCssEvaluator(e){return e.visitColor(this)}}class he{static parseInlineStyle(e){return K.normalize(e).split(";").reduce(((e,t)=>{const i=t.split(":");if(2===i.length&&""!==i[0]&&""!==i[1]){const t=new _(i[0]);if(s.IgnoredInlineStyleProps.indexOf(t.value)>=0)return e;const r=new K({prop:t.value,value:i[1]});he.parseDeclaration(t,r).forEach((t=>{e.setProperty(t.prop,t.value)}))}return e}),new q)}static parseRule(e,t){return new Zt(e).split().map((e=>{const i=new Kt(e),s=new Yt(i).parse(),r=this.parseDeclarationBlock(e,t);return new G(s,r)}))}static parseDeclarationBlock(e,t){return Object.keys(t).reduce(((i,s)=>{const r=t[s],n=new _(s);if("string"==typeof r)return i.setProperty(n.value,r);if("number"==typeof r)return i.setProperty(n.value,String(r));if("function"==typeof r){if(n.isDynamicStyleProp()){const t=n.getDynamicStylePropName(),s=r;return i.addDynamicStyle(new tt(e,t,s))}if(n.isDomCallback()){const t=n.getDomCallbackName(),s=r;return i.addDomCallback(new Xe(e,t,s))}const t=new H(r).call(e);if(""!==t){const e=new K({prop:n.value,value:t});return i.setProperty(n.value,e.value)}}return i}),new q)}static parseDeclaration(e,t){switch(e.value){case"border":return ae.parseShorthand(t);case"border-before":return ae.parseShorthandEach(t,"before");case"border-end":return ae.parseShorthandEach(t,"end");case"border-after":return ae.parseShorthandEach(t,"after");case"border-start":return ae.parseShorthandEach(t,"start");case"border-radius":return te.parseShorthand(t);case"font":return lt.parseShorthand(t);case"list-style":return ft.parseShorthand(t);case"margin":return Ct.parseShorthand(t);case"padding":return kt.parseShorthand(t);case"border-width":return oe.parseShorthand(t);case"border-color":return ee.parseShorthand(t);case"border-style":return re.parseShorthand(t);case"text-emphasis":return ti.parseShorthand(t)}return[{prop:e.value,value:t.value}]}}class de{static loadAll(e){e.isTextElement()||(this.load(e),e.children.forEach((e=>this.loadAll(e))),"body"===e.tagName&&this.loadDynamic(e))}static load(e){e.isTextElement()||(e.acceptEffector(Ee.instance),e.acceptEffector(we.instance),e.acceptEffector(Ce.instance),e.acceptEffector(ke.instance))}static loadDynamic(e,t){return!!e.style.hasDynamicStyles()&&(e.acceptEffector(new Se(t)),e.acceptEffector(we.instance),e.acceptEffector(Ce.instance),e.acceptEffector(ke.instance),!0)}}let ue={styleSheets:[]};class pe{constructor(e,t=ue){this.source=s.normalizeHtml(e),this.styleSheets=[new j(Oe)].concat(t.styleSheets||[]),this.specStyleSheet=this.styleSheets.reduce(((e,t)=>e.mergeStyleSheet(t)),new j({})),this.selectorCache=new jt,this.selectorCache.clear(),this.$document=(new DOMParser).parseFromString(this.source,"text/html"),s.debugLayout&&console.log(this.$document.body),this.documentElement=this.createNehanElement(this.$document.documentElement);const i=this.documentElement.querySelector("body");if(!i)throw new Error("body not found");this.body=i,this.body.parent=this.documentElement,this.body.acceptEffectorAll(new ve(this.specStyleSheet.getPseudoRules())),de.loadAll(this.body),this.body.acceptChildFilter(ge.instance)}querySelectorAll(e){return this.documentElement.querySelectorAll(e)}querySelector(e){return this.documentElement.querySelector(e)}getElementById(e){return this.querySelector("#"+e)}getSelectorCache(e){return this.selectorCache.getCache(e)}addStyleSheet(e){return this.styleSheets.push(e),this}addSelectorCache(e,t){this.selectorCache.addCache(e,t)}createElement(e){let t=this.createNativeElement(e);return this.createNehanElement(t)}createNativeElement(e){return this.$document.createElement(e)}createNehanElement(e){const t=(e instanceof Element?e.tagName:e instanceof Text?"(text)":"??").toLowerCase();if(("body"===t||"html"===t)&&this.selectorCache.hasCache(t))return this.selectorCache.getCache(t)[0];const i=new Be(e,this);return"body"===i.tagName&&(this.body=i),i.root=this,this.selectorCache.addCache(t,i),this.selectorCache.addCache("*",i),i}createTextNode(e){const t=this.$document.createTextNode(e);return this.createNehanElement(t)}}class ge{constructor(){}visit(e){if(e.isTextElement())return!0;if(s.ignoredTags.includes(e.tagName))return!1;if(["br","hr","img","wbr","video","iframe"].includes(e.tagName))return!0;if(Wt.isPseudoElement(e))return!0;const t=Ze.load(e);return!(t.isNone()||t.isBlockLevel()&&(e.acceptChildFilter(this),0===e.childNodes.length||e.childNodes.every((e=>ni.isWhiteSpaceElement(e)))))}}ge.instance=new ge;class me{constructor(){}visit(e){const t=Ze.load(e);if(!t.isListItem()||t.isNone()||!e.parent)return;const i=ft.load(e);if(i.isNone())return;let s=i.getMarkerText(e.indexOfType);const r=e.firstChild;if(!r||r.tagName!==Dt.MARKER)throw new Error("marker element is not created yet!");const n=e.ownerDocument.createTextNode(s);r.appendChild(n)}}me.instance=new me;class fe{constructor(){}visit(e){const t=e.parent;if(!Le.load(e).isCollapse()||!t)return;const i=parseInt(t.computedStyle.getPropertyValue("measure")||"0"),s=oe.load(t).measure,r=oe.load(e).measure,n=i-Math.max(0,r-s);e.computedStyle.setProperty("measure",n+"px")}}fe.instance=new fe;class xe{constructor(){}visit(e){const t=e.parent;if(!Le.load(e).isCollapse()||!t)return;const i=parseInt(t.computedStyle.getPropertyValue("measure")||"0"),s=oe.load(t).measure,r=oe.load(e).measure,n=i-Math.max(0,r-s);e.computedStyle.setProperty("measure",n+"px")}}xe.instance=new xe;class be{constructor(){}getCollapsedInternalEdgeSize(e,t){let i=e.reduce(((t,i,s)=>(t+=i.padding.measure,s<e.length-1?t+Math.max(i.border.width.end,e[s+1].border.width.start):t)),0);return i+=Math.max(0,e[0].border.width.start-t.border.width.start),i+=Math.max(0,e[e.length-1].border.width.end-t.border.width.end),i}getTableCells(e){return e.children.filter((e=>"table-cell"===e.computedStyle.getPropertyValue("display")))}findPrevCells(e,t){let i=e.previousElementSibling;for(;i;){const e=this.getTableCells(i);if(e.length===t)return e;i=i.previousElementSibling}}visit(e){const t=e.parent;if(!t||"table-cell"!==e.computedStyle.getPropertyValue("display"))return;const i=this.getTableCells(t);if(i.every((e=>"auto"!==e.computedStyle.getPropertyValue("measure"))))return;if(Ze.load(t).isTableRow()){const e=this.findPrevCells(t,i.length);if(e)return void i.forEach(((t,i)=>{const s=e[i].computedStyle.getPropertyValue("measure");if(!s)throw new Error("cell partition is not defined properly.");t.computedStyle.setProperty("measure",s)}))}i.forEach((e=>{Y.forEach((t=>{e.computedStyle.setProperty(`margin-${t}`,"0")}))}));const r=le.load(t),n=i.map((e=>le.load(e))),o=Le.load(e).isCollapse()?this.getCollapsedInternalEdgeSize(n,r):n.reduce(((e,t)=>e+t.measure),0),a=parseInt(t.computedStyle.getPropertyValue("measure")||"0",10),l=i.map((e=>{const t=e.computedStyle.getPropertyValue("measure")||"0";return"auto"===t?0:parseInt(t,10)})),c=i.filter((e=>"auto"===e.computedStyle.getPropertyValue("measure"))),h=l.reduce(((e,t)=>e+t),0),d=a-h-o,u=Math.max(Math.floor(d/c.length),0),p=d%c.length;s.debugLayout&&console.log("cell size:(parent:%d, fixedSize:%d, iedge:%d, auto:%d(fraction:%d)), cell:",a,h,o,u,p,e),c.forEach(((e,t)=>{const i=0===t?u+p:u;e.computedStyle.setProperty("measure",i+"px")}))}}be.instance=new be;class ye{constructor(){}visit(e){if("ruby"!==e.tagName)return;const t=e.root;e.childNodes=e.childNodes.filter((e=>"rp"!==e.tagName&&(!e.isTextElement()||""!==e.textContent.trim()))),e.childNodes=e.childNodes.map((i=>{if(!i.isTextElement())return i;const s=t.createElement("rb");return s.parent=e,s.appendChild(i),de.load(s),s}))}}ye.instance=new ye;class ve{constructor(e){this.pseudoRules=e}addMarker(e){const t=e.root.createElement(Dt.MARKER);return t.parent=e,e.insertBefore(t,e.firstChild),t}addBefore(e){const t=e.root.createElement(Dt.BEFORE);return e.insertBefore(t,e.firstChild),t}addAfter(e){const t=e.root.createElement(Dt.AFTER);return e.appendChild(t),t}addFirstLine(e){const t=e.root.createElement(Dt.FIRST_LINE),i=e.firstTextElement;if(!i)return null;const s=i.parent;return s?(t.appendChild(i),s.replaceChild(t,i),t):null}addFirstLetter(e){const t=e.firstTextElement;if(!t)return null;const i=t.parent;if(!i)return null;const s=t.textContent,r=s.trim(),n=(r.length>1?r:s).substring(0,1),o=s.substring(1),a=e.root.createElement(Dt.FIRST_LETTER);a.appendChild(e.root.createTextNode(n));const l=e.root.createTextNode(o);l.appendChild(e.root.createTextNode(o));const c=t.nextSibling;return i.removeChild(t),i.insertBefore(l,c),i.insertBefore(a,l),a}addPseudoElement(e,t){switch(t){case Dt.MARKER:return this.addMarker(e);case Dt.BEFORE:return this.addBefore(e);case Dt.AFTER:return this.addAfter(e);case Dt.FIRST_LETTER:return this.addFirstLetter(e);case Dt.FIRST_LINE:return this.addFirstLine(e)}throw new Error("undefined pseudo element:"+t)}visit(e){this.pseudoRules.forEach((t=>{if(t.test(e,!0)&&t.peSelector){const i=t.peSelector.tagName,s=e.querySelector(i)||this.addPseudoElement(e,i);s&&s.style.mergeFrom(t.style)}}))}}class Ee{constructor(){}visit(e){if(e.isTextElement()||Wt.isPseudoElement(e))return;const t=e.ownerDocument.specStyleSheet.getStyleOfElement(e);e.style=t}}Ee.instance=new Ee;class Se{constructor(e){this.parentCxt=e}visit(e){const t=e.style.getDynamicStyle(e,this.parentCxt);e.style.mergeFrom(t),t.forEach(((t,i)=>{e.computedStyle.removeProperty(t)}))}}class we{constructor(){}visit(e){const t=e.getAttribute("style")||"",i=he.parseInlineStyle(t);e.style.mergeFrom(i)}}we.instance=new we;class Ce{getLineHeightString(e){return Ae.computeLineHeight(e)}setCascadedValue(e,t){const i=Me.getValue(e,t);return e.computedStyle.setProperty(t,i),i}setFontSize(e){const t=Ae.computeFontSize(e);e.computedStyle.setProperty("font-size",t+"px")}setLineHeight(e){const t=this.getLineHeightString(e);e.computedStyle.setProperty("line-height",t)}setBoxLength(e,t){const i=Ae.computeBoxLength(e,t);e.computedStyle.setProperty(t,i+"px")}setAutableBoxLength(e,t){const i=Ae.computeAutableBoxLength(e,t),s="auto"===i?i:i+"px";e.computedStyle.setProperty(t,s)}setOptionalBoxLength(e,t){const i=Ae.computeOptionalBoxLength(e,t),s="none"===i?i:i+"px";e.computedStyle.setProperty(t,s)}setMargin(e){Y.forEach((t=>{this.setAutableBoxLength(e,`margin-${t}`)}))}setPadding(e){Y.forEach((t=>{this.setBoxLength(e,`padding-${t}`)}))}setBorderWidth(e){Y.forEach((t=>{const i=`border-${t}-width`,s=Ae.computeBorderWidth(e,i);e.computedStyle.setProperty(i,s+"px")}))}setBorderStyle(e){Y.forEach((t=>{const i=`border-${t}-style`,s=Me.getValue(e,i);e.computedStyle.setProperty(i,s)}))}setBorderColor(e){Y.forEach((t=>{const i=`border-${t}-color`,s=Me.getValue(e,i);e.computedStyle.setProperty(i,s)}))}setBorderRadius(e){te.corners.forEach((t=>{const i=`border-${t}-radius`,s=Ae.computeBoxLength(e,i);e.computedStyle.setProperty(i,s+"px")}))}setPosition(e){Y.forEach((t=>{this.setAutableBoxLength(e,t)}))}visit(e){e.isTextElement()||"none"!==this.setCascadedValue(e,"display")&&(s.nonLayoutTags.includes(e.tagName)||(this.setCascadedValue(e,"writing-mode"),this.setCascadedValue(e,"color"),this.setFontSize(e),this.setLineHeight(e),s.fontSizeOnlyTags.includes(e.tagName)||(s.edgeSkipTags.includes(e.tagName)||(this.setPadding(e),this.setBorderWidth(e),this.setBorderStyle(e),this.setBorderColor(e),this.setBorderRadius(e)),s.boxSizeSkipTags.includes(e.tagName)||(this.setMargin(e),this.setPosition(e),this.setAutableBoxLength(e,"measure"),this.setAutableBoxLength(e,"extent"),this.setAutableBoxLength(e,"width"),this.setAutableBoxLength(e,"height"),this.setOptionalBoxLength(e,"min-measure"),this.setOptionalBoxLength(e,"max-measure"),this.setOptionalBoxLength(e,"min-extent"),this.setOptionalBoxLength(e,"max-extent")),this.setCascadedValue(e,"box-sizing"),this.setCascadedValue(e,"float"),this.setCascadedValue(e,"font-family"),this.setCascadedValue(e,"font-style"),this.setCascadedValue(e,"font-weight"),this.setCascadedValue(e,"font-variant"),this.setCascadedValue(e,"font-stretch"),this.setCascadedValue(e,"text-orientation"),this.setCascadedValue(e,"text-combine-upright"),this.setCascadedValue(e,"text-emphasis-style"),this.setCascadedValue(e,"text-emphasis-color"),this.setCascadedValue(e,"text-align"),this.setCascadedValue(e,"vertical-align"),this.setCascadedValue(e,"list-style-type"),this.setCascadedValue(e,"list-style-position"),this.setCascadedValue(e,"list-style-image"),this.setCascadedValue(e,"content"),this.setCascadedValue(e,"word-break"),this.setCascadedValue(e,"overflow-wrap"),this.setCascadedValue(e,"white-space"),this.setCascadedValue(e,"page-break-before"),this.setCascadedValue(e,"page-break-after"),this.setCascadedValue(e,"position"),this.setCascadedValue(e,"border-collapse"))))}}Ce.instance=new Ce;class ke{constructor(){}visit(e){const t=Ze.load(e);if(t.isNone())return;if(s.boxSizeSkipTags.includes(e.tagName))return;const i=Pi.load(e);i&&(Ni.select(e).resolve(e,i,t),i.save(e.computedStyle))}}ke.instance=new ke;class Be{constructor(e,t){this.$node=e,this.$dom=void 0,this.tagName=this.getTagName(),this.childNodes=[],this.parent=null,this.root=t,this.style=new q,this.computedStyle=new q,this.id=this.$node instanceof Element?this.$node.id:"",this.classList=this.createClassList(),this.setupChildren(this.$node,t)}acceptChildFilter(e){return this.childNodes=this.childNodes.filter((t=>e.visit(t))),this}acceptEffector(e){return e.visit(this),this}acceptEffectorAll(e){return e.visit(this),this.childNodes.forEach((t=>t.acceptEffectorAll(e))),this}get nextSibling(){if(!this.parent)return null;const e=this.parent.childNodes.indexOf(this);return e<0||e+1>=this.parent.childNodes.length?null:this.parent.childNodes[e+1]}get previousSibling(){if(!this.parent)return null;const e=this.parent.childNodes.indexOf(this);return e>0?this.parent.childNodes[e-1]:null}clone(e=!1){const t=this.ownerDocument.createNehanElement(this.$node.cloneNode(e));return t.style=this.style,t.computedStyle=this.computedStyle,t}createClassList(){if(this.$node instanceof Element){let e=[];for(let t=0;t<this.$node.classList.length;t++){let i=this.$node.classList.item(t);null!==i&&e.push(i)}return new Je(e)}return new Je([])}setupChildren(e,t){if(e instanceof Element)for(let i=0;i<e.childNodes.length;i++){let s=e.childNodes.item(i),r=t.createNehanElement(s);this.appendChild(r)}}set innerHTML(e){this.$node.innerHTML=e,this.childNodes=[],this.setupChildren(this.$node,this.root),de.loadAll(this)}get innerHTML(){return this.isTextElement()?this.textContent:this.$node.innerHTML}get className(){return this.classList.values().join(" ")}set className(e){let t=e.split(" ").filter((e=>""!==e));this.classList=new Je(t)}get pureTagName(){return this.tagName.replace("::","")}get attributes(){return this.$node instanceof Element?this.$node.attributes:null}get dataset(){if(this.$node instanceof Element)return this.$node.dataset;throw new Error("dataset is not defined(not HTMLElement)")}get textContent(){return this.$node.textContent||""}getTagName(){return this.$node instanceof Text?"(text)":this.$node instanceof Element?this.$node.tagName.toLowerCase():(console.info("unsupported node type:%o",this),"???")}getNodeName(){let e=this.tagName;this.id&&(e+="#"+this.id);for(let t=0;t<this.classList.length;t++)e+="."+this.classList.item(t);return e}getPath(e=!1){let t=this.getNodeName();if(!e)return t;let i=this.parent;for(;i;)t=i.getNodeName()+">"+t,i=i.parent;return t}toString(e=!1){let t=this.getPath(!0);return e?(t+="("+this.indexOfType+")",t):t}querySelectorAll(e){const t=new Kt(e);return new Yt(t).parse().querySelectorAll(this)}querySelector(e){const t=new Kt(e);return new Yt(t).parse().querySelector(this)}queryLeafs(e){return this.root.getSelectorCache(e).filter((e=>{let t=e.parent;for(;t;){if(t===this)return!0;t=t.parent}return!1}))}appendChild(e){return e.parent=this,this.childNodes.push(e),this}replaceChild(e,t){if(t){const i=this.childNodes.indexOf(t);i>=0&&(e.parent=this,this.childNodes[i]=e)}return e}removeChild(e){const t=this.childNodes.indexOf(e);return t>=0&&this.childNodes.splice(t,1),e}insertBefore(e,t){if(!t)return this.appendChild(e),null;if(t.parent!==this)throw new Error("reference node is not included in this element");e.parent=this;const i=this.childNodes.indexOf(t);return i>=0&&this.childNodes.splice(i,0,e),t.nextSibling?e:null}hasAttribute(e){return this.$node instanceof Element&&this.$node.hasAttribute(e)}isOnlyChild(){return 1===this.siblings.length}isOnlyOfType(){return 1===this.siblings.filter((e=>e.tagName===this.tagName)).length}isFirstChild(){return!this.parent||0===this.parent.childNodes.indexOf(this)}isLastChild(){if(!this.parent)return!0;const e=this.parent.childNodes;return e[e.length-1]===this}isFirstElementChild(){return!this.parent||this.parent.children[0]===this}isLastElementChild(){if(!this.parent)return!0;const e=this.parent.children;return e[e.length-1]===this}isNthChild(e){return this.index===Math.max(e-1,0)}isElement(){return this.$node instanceof HTMLElement}isTextElement(){return this.$node instanceof Text}setAttribute(e,t){this.$node instanceof Element&&this.$node.setAttribute(e,t)}get ownerDocument(){return this.root}get firstChild(){return this.childNodes[0]||null}get firstTextElement(){const e=this.firstChild;if(!e)return null;if(e.isTextElement())return e;const t=e.nextSibling;return t?t.firstTextElement:null}get lastChild(){return this.childNodes[this.childNodes.length-1]||null}get lastElementChild(){const e=this.children;return e[e.length-1]||null}get firstElementChild(){return this.children[0]||null}get nextElementSibling(){let e=this.nextSibling;for(;e&&!e.isElement();)e=e.nextSibling;return e}get previousElementSibling(){let e=this.previousSibling;for(;e&&!e.isElement();)e=e.previousSibling;return e}get firstAtomChild(){for(let e=0;e<this.childNodes.length;e++){const t=this.childNodes[e];if(t.isTextElement()&&!ni.isWhiteSpaceElement(t))return t;if(Ht.isReplacedElement(t)&&!Vt.load(t).hasZero())return t;const i=t.firstAtomChild;if(i)return i}return null}get siblings(){return this.parent?this.parent.childNodes:[]}get index(){return this.parent?this.parent.childNodes.indexOf(this):0}get indexOfType(){return this.parent?this.parent.childNodes.filter((e=>e.tagName===this.tagName)).indexOf(this):0}get indexOfElement(){return this.parent?this.parent.children.indexOf(this):0}get children(){return this.childNodes.filter((e=>!e.isTextElement()))}getAttribute(e){return this.$node instanceof Element?this.$node.getAttribute(e):null}}class Re extends D{constructor(e,t,i){super(),this.left=e,this.operator=t,this.right=i,this.specificity.b=1}toString(){let e="["+this.left;return this.operator&&(e+=this.operator),this.right&&(e+=this.right),e+="]",e}test(e){if(!this.operator)return this.testAttr(e);switch(this.operator){case"=":return this.testEqual(e);case"*=":return this.testStarEqual(e);case"^=":return this.testCaretEqual(e);case"$=":return this.testDollarEqual(e);case"~=":return this.testTildeEqual(e);case"|=":return this.testPipeEqual(e)}throw new Error("invalid operator["+this.operator+"](attr selector)")}testAttr(e){return e.hasAttribute(this.left)}testEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&t===this.right}testStarEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&t.indexOf(this.right)>=0}testCaretEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&new RegExp("^"+this.right).test(t)}testDollarEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&new RegExp(this.right+"$").test(t)}testTildeEqual(e){let t=e.getAttribute(this.left);if(!t||!this.right)return!1;let i=t.trim().replace(/\s+/g," ").split(" "),s=this.right;return i.some((function(e){return e===s}))}testPipeEqual(e){let t=e.getAttribute(this.left);return!(!t||!this.right)&&(t===this.right||t.indexOf(this.right+"-")>=0)}}class Le{constructor(e){this.value=e}isCollapse(){return"collapse"===this.value}isSeparate(){return"separate"===this.value}static load(e){const t=Me.getValue(e,"border-collapse");return new Le(t)}}class Te extends D{constructor(e){super(),this.className=e,this.specificity.b=1}toString(){return"."+this.className}test(e){return e.classList.contains(this.className)}}class Pe extends D{constructor(e,t){super(),this.selectors=e,this.combinators=t,this.specificity=this.getSpecificity()}getSelectorItem(e){if(e<0||e>=this.selectors.length)throw new Error("getSelectorItem: out of range");return this.selectors[e]}getCombinatorItem(e){if(e<0||e>=this.combinators.length)throw new Error("getCombinatorItem: out of range");return this.combinators[e]}static compare(e,t){return Xt.compare(e.specificity,t.specificity)}getSpecificity(){let e=new Xt(0,0,0);return e=this.selectors.reduce(((e,t)=>Xt.add(e,t.specificity)),e),e}get leafSelector(){return this.selectors[0]}get peSelector(){for(let e=0;e<this.selectors.length;e++){let t=this.selectors[e];if(null!==t.pseudoElement)return t.pseudoElement}return null}toString(){let e=this.leafSelector.toString();for(var t=1,i=0;t<this.selectors.length;t++,i++)e=this.selectors[t].toString()+this.combinators[i]+e;return e}queryDirectParent(e,t){return e.parent&&t.test(e.parent)?e.parent:null}queryParent(e,t){let i=e.parent;for(;i;){if(t.test(i))return i;i=i.parent}return i}queryDirectSibling(e,t){let i=e.previousSibling;return i&&t.test(i)?i:null}querySibling(e,t){let i=e.previousSibling;for(;i;){if(!i.isTextElement()&&t.test(i))return i;i=i.previousSibling}return i}queryLeft(e,t,i){switch(t){case" ":return this.queryParent(i,e);case">":return this.queryDirectParent(i,e);case"+":return this.queryDirectSibling(i,e);case"~":return this.querySibling(i,e);default:throw new Error("Invalid combinator["+t+"]")}}querySelectorAll(e){return this.leafSelector.querySelectorAll(e).filter((e=>this.test(e)))}querySelector(e){let t=this.leafSelector.querySelectorAll(e);for(let e=0;e<t.length;e++){let i=t[e];if(this.test(i))return i}return null}test(e,t=!1){let i=0,s=0,r=this.selectors.length,n=this.combinators.length,o=e;for(;!(i>=r);){let e=this.selectors[i];if(0===i&&!e.test(o,t))return!1;if(s>=n)break;let a=this.combinators[s++];if(i+1>=r)return!1;if(e=this.selectors[i+1],o=this.queryLeft(e,a,o),null===o)return!1;i++}return!0}}class Ne extends D{constructor(e){super(),this.univSelector=e.univSelector||null,this.idSelector=e.idSelector||null,this.typeSelector=e.typeSelector||null,this.attrSelector=e.attrSelector||null,this.classSelectors=e.classSelectors||[],this.pseudoClasses=e.pseudoClasses||[],this.pseudoElement=e.pseudoElement||null,this.specificity=this.getSpecificity()}getTagName(){return this.typeSelector?this.typeSelector.tagName:"*"}getSpecificity(){let e=new Xt(0,0,0);return this.idSelector&&(e=Xt.add(e,this.idSelector.specificity)),this.typeSelector&&(e=Xt.add(e,this.typeSelector.specificity)),this.attrSelector&&(e=Xt.add(e,this.attrSelector.specificity)),this.pseudoElement&&(e=Xt.add(e,this.pseudoElement.specificity)),e=this.classSelectors.reduce(((e,t)=>Xt.add(e,t.specificity)),e),e=this.pseudoClasses.reduce(((e,t)=>Xt.add(e,t.specificity)),e),e}toString(){let e="";return this.univSelector&&(e+=this.univSelector.toString()),this.typeSelector&&(e+=this.typeSelector.toString()),this.idSelector&&(e+=this.idSelector.toString()),e+=this.classSelectors.reduce(((e,t)=>e+t.toString()),""),this.attrSelector&&(e+=this.attrSelector.toString()),e+=this.pseudoClasses.reduce(((e,t)=>e+t.toString()),""),this.pseudoElement&&(e+=this.pseudoElement.toString()),e}get leafSelector(){return this.typeSelector?this.typeSelector.tagName:"*"}querySelector(e){let t=e.queryLeafs(this.leafSelector);for(let e=0;e<t.length;e++){let i=t[e];if(this.test(i))return i}return null}querySelectorAll(e){return e.queryLeafs(this.leafSelector).filter((e=>this.test(e)))}testClasses(e){return this.classSelectors.every((t=>t.test(e)))}testPseudoClasses(e){return this.pseudoClasses.every((t=>t.test(e)))}test(e,t=!1){return!(this.pseudoElement&&!t||null!==this.typeSelector&&!this.typeSelector.test(e)||null!==this.attrSelector&&!this.attrSelector.test(e)||null!==this.idSelector&&!this.idSelector.test(e)||!this.testClasses(e)||!this.testPseudoClasses(e))}}class ze{constructor(e){this.value=this.normalize(e)}isEmpty(){return""===this.value}normalize(e){return e}static load(e){let t=Me.getValue(e,"content");return new ze(t)}}class Me{static getValue(e,t){const i=e.computedStyle.getPropertyValue(t);return null!=i?i:this.getSpecValue(e,t)}static getSpecValue(e,t){var i;const s=null!==(i=e.style.getPropertyValue(t))&&void 0!==i?i:"",r=Fe.get(t);switch(s){case"":return r.inherit&&e.parent?this.getValue(e.parent,t):r.initial;case"initial":return r.initial;case"inherit":return e.parent?r.inherit?this.getValue(e.parent,t):this.getSpecValue(e.parent,t):r.initial;default:return s}}}const Ie=["%","em","rem","px","pt","vw","vh"];class Ae{static hasUnit(e){return void 0!==Ie.find((t=>e.endsWith(t)))}static computeRootFontSize(e){const t=Me.getValue(e.ownerDocument.body,"font-size");return this.computeFontSize(e.ownerDocument.body,t)}static computeContainingMeasure(e){const t=parseInt(Me.getValue(e,"measure"));return"static"===Me.getValue(e,"position")?t:t+kt.load(e).measure}static computeContainingExtent(e){const t=parseInt(Me.getValue(e,"extent"));return"static"===Me.getValue(e,"position")?t:t+kt.load(e).extent}static computeParentFontSize(e){return e.parent?parseInt(Me.getValue(e.parent,"font-size")):s.defaultFontSize}static computeFontSize(e,t){const i=t||Me.getValue(e,"font-size");if(i.endsWith("em")){const t=parseFloat(i),s=this.computeParentFontSize(e);return Math.floor(t*s)}if(i.endsWith("rem")){const t=parseFloat(i),s=this.computeRootFontSize(e);return Math.floor(t*s)}if(i.endsWith("px"))return parseInt(i);if(i.endsWith("pt"))return Math.floor(4*parseInt(i)/3);if(i.endsWith("%")){const t=this.computeParentFontSize(e);return Math.floor(t*parseFloat(i)/100)}return st.includes(i)?this.computeFontSize(e,nt[i]||"1.0em"):it.includes(i)?rt[i]:s.defaultFontSize}static computeLineHeight(e,t){const i=t||Me.getValue(e,"line-height");if("normal"===i)return String(s.defaultLineHeight);if(i.endsWith("em")){const t=parseFloat(i),s=Me.getValue(e,"font-size"),r=this.computeFontSize(e,s);return Math.floor(t*r)+"px"}if(i.endsWith("rem")||i.endsWith("px")||i.endsWith("pt"))return this.computeFontSize(e,i)+"px";if(i.endsWith("vw")||i.endsWith("vh"))return this.computeBoxLength(e,"line-height",i)+"px";if(i.endsWith("%")){const t=parseFloat(i),s=Me.getValue(e,"font-size"),r=this.computeFontSize(e,s);return Math.floor(t*r/100)+"px"}return String(parseFloat(i))}static computeBaseBoxLength(e,t){const i=function(e){if("static"===Me.getValue(e,"position"))return e.parent||e.ownerDocument.body;let t=e.parent;for(;t;){const e=Me.getValue(t,"position");if("absolute"===e||"relative"===e)break;t=t.parent}return t||e.ownerDocument.body}(e),s=ai.load(e).isTextVertical();switch(t){case"width":return s?this.computeContainingExtent(i):this.computeContainingMeasure(i);case"height":return s?this.computeContainingMeasure(i):this.computeContainingExtent(i);case"measure":case"min-measure":case"max-measure":case"start":case"end":case"padding-start":case"padding-end":case"margin-start":case"margin-end":case"border-start-width":case"border-end-width":return this.computeContainingMeasure(i);case"extent":case"min-extent":case"max-extent":case"before":case"after":case"padding-before":case"padding-after":case"margin-after":case"margin-before":case"border-before-width":case"border-after-width":return this.computeContainingExtent(i)}return 0}static computeOptionalBoxLength(e,t,i){const s=i||Me.getValue(e,t);return"none"===s?"none":this.computeBoxLength(e,t,s)}static computeAutableBoxLength(e,t,i){const s=i||Me.getValue(e,t);return"auto"===s?s:this.computeBoxLength(e,t,s)}static computeBoxLength(e,t,i){const s=i||Me.getValue(e,t);if(s.endsWith("em")){const t=parseFloat(s),i=this.computeFontSize(e);return Math.floor(t*i)}if(s.endsWith("rem")||s.endsWith("px")||s.endsWith("pt"))return this.computeFontSize(e,s);if(s.endsWith("vw")){const e=parseFloat(s),t=window.innerWidth;return Math.floor(e*t)}if(s.endsWith("vh")){const e=parseFloat(s),t=window.innerHeight;return Math.floor(e*t)}if(s.endsWith("%")){const i=parseFloat(s),r=this.computeBaseBoxLength(e,t);return Math.floor(i*r/100)}return parseFloat(s)}static computeBorderWidth(e,t,i){const s=i||Me.getValue(e,t);return oe.keywords.includes(s)?ne[s]:this.computeBoxLength(e,t,s)}static computeBorderRadius(e,t,i){throw new Error("todo(compute border radius)")}}let Ve={after:{initial:"auto",inherit:!1},"background-position":{initial:"0% 0%",inherit:!1},before:{initial:"auto",inherit:!1},"box-sizing":{initial:"content-box",inherit:!1},border:{initial:"medium none currentcolor",inherit:!1},"border-collapse":{initial:"collapse",inherit:!0},"border-style":{initial:"0 none black",inherit:!1},"border-color":{initial:s.defaultBorderColor,inherit:!1},"border-width":{initial:"0",inherit:!1},"border-before":{initial:"none",inherit:!1},"border-end":{initial:"none",inherit:!1},"border-after":{initial:"none",inherit:!1},"border-start":{initial:"none",inherit:!1},"border-before-width":{initial:"0",inherit:!1},"border-end-width":{initial:"0",inherit:!1},"border-after-width":{initial:"0",inherit:!1},"border-start-width":{initial:"0",inherit:!1},"border-before-color":{initial:s.defaultBorderColor,inherit:!1},"border-end-color":{initial:s.defaultBorderColor,inherit:!1},"border-after-color":{initial:s.defaultBorderColor,inherit:!1},"border-start-color":{initial:s.defaultBorderColor,inherit:!1},"border-before-style":{initial:"none",inherit:!1},"border-end-style":{initial:"none",inherit:!1},"border-after-style":{initial:"none",inherit:!1},"border-start-style":{initial:"none",inherit:!1},"border-radius":{initial:"0 0 0 0",inherit:!1},"border-before-start-radius":{initial:"0",inherit:!1},"border-before-end-radius":{initial:"0",inherit:!1},"border-after-end-radius":{initial:"0",inherit:!1},"border-after-start-radius":{initial:"0",inherit:!1},"break-after":{initial:"auto",inherit:!1},"break-before":{initial:"auto",inherit:!1},"caption-side":{initial:"before",inherit:!0},clear:{initial:"none",inherit:!1},color:{initial:"black",inherit:!0},content:{initial:"",inherit:!1},direction:{initial:"ltr",inherit:!0},display:{initial:"inline",inherit:!1},end:{initial:"auto",inherit:!1},extent:{initial:"auto",inherit:!1},float:{initial:"none",inherit:!1},font:{initial:s.defaultFont,inherit:!0},"font-family":{initial:s.defaultFontFamily,inherit:!0},"font-size":{initial:s.defaultFontSize+"px",inherit:!0},"font-size-adjust":{initial:"none",inherit:!0},"font-stretch":{initial:"normal",inherit:!0},"font-style":{initial:"normal",inherit:!0},"font-variant":{initial:"normal",inherit:!0},"font-weight":{initial:"normal",inherit:!0},"block-size":{initial:"auto",inherit:!1},height:{initial:"auto",inherit:!1},"letter-spacing":{initial:"normal",inherit:!0},"line-height":{initial:String(s.defaultLineHeight),inherit:!0},"list-style":{initial:"disc outside none",inherit:!0},"list-style-type":{initial:"disc",inherit:!0},"list-style-position":{initial:"outside",inherit:!0},"list-style-image":{initial:"none",inherit:!0},margin:{initial:"0",inherit:!1},"margin-before":{initial:"0",inherit:!1},"margin-end":{initial:"0",inherit:!1},"margin-after":{initial:"0",inherit:!1},"margin-start":{initial:"0",inherit:!1},"max-extent":{initial:"none",inherit:!1},"max-measure":{initial:"none",inherit:!1},measure:{initial:"auto",inherit:!1},"min-extent":{initial:"none",inherit:!1},"min-measure":{initial:"none",inherit:!1},"overflow-wrap":{initial:"normal",inherit:!0},page:{initial:"auto",inherit:!0},padding:{initial:"0",inherit:!1},"padding-before":{initial:"0",inherit:!1},"padding-end":{initial:"0",inherit:!1},"padding-after":{initial:"0",inherit:!1},"padding-start":{initial:"0",inherit:!1},"page-break-after":{initial:"auto",inherit:!1},"page-break-before":{initial:"auto",inherit:!1},position:{initial:"static",inherit:!1},size:{initial:"auto",inherit:!1},start:{initial:"auto",inherit:!1},"table-layout":{initial:"auto",inherit:!1},"text-align":{initial:"start",inherit:!0},"text-combine-upright":{initial:"none",inherit:!0},"text-emphasis-color":{initial:"currentcolor",inherit:!1},"text-emphasis-style":{initial:"none",inherit:!1},"text-emphasis-style-stroke":{initial:"none",inherit:!1},"text-emphasis-style-mark":{initial:"dot",inherit:!1},"text-decoration":{initial:"none",inherit:!1},"text-indent":{initial:"0",inherit:!0},"text-justify":{initial:"none",inherit:!0},"text-orientation":{initial:"mixed",inherit:!0},"text-shadow":{initial:"0",inherit:!1},"text-transform":{initial:"none",inherit:!0},"unicode-bidi":{initial:"normal",inherit:!1},"vertical-align":{initial:"baseline",inherit:!1},visibility:{initial:"inherit",inherit:!1},width:{initial:"auto",inherit:!1},"white-space":{initial:"normal",inherit:!0},"word-break":{initial:"normal",inherit:!0},"writing-mode":{initial:"horizontal-tb",inherit:!0}};class Fe{static selectOrDefault(e,t,i){return r.Choice.select({name:e,value:t,values:i,initial:Fe.getInitialValue(e)})}static get(e){let t=Ve[e];if(!t)throw new Error("Invalid property:"+e);return t}static getInitialValue(e){return this.get(e).initial}static isInheritable(e){return this.get(e).inherit}}const Oe={"*[dir=ltr]":{direction:"ltr","unicode-bidi":"embed"},"*[dir=rtl]":{direction:"rtl","unicode-bidi":"embed"},abbr:{},address:{display:"block","font-style":"italic"},area:{display:"none"},article:{display:"block"},aside:{display:"block"},b:{display:"inline","font-weight":"bold"},base:{},bdi:{},bdo:{display:"inline","unicode-bidi":"bidi-override"},"bdo[dir=ltr]":{direction:"ltr","unicode-bidi":"bidi-override"},"bdo[dir=rtl]":{direction:"rtl","unicode-bidi":"bidi-override"},blockquote:{display:"block",margin:"1.12em 40px"},body:{display:"flow-root","font-size":"16px","overflow-wrap":"break-word",measure:s.defaultBodyMeasure+"px",extent:s.defaultBodyExtent+"px",margin:"0"},br:{display:"inline"},button:{},canvas:{},caption:{display:"table-caption","text-align":"center"},cite:{display:"inline","font-style":"italic"},code:{display:"inline","font-family":"monospace"},col:{display:"table-column"},colgroup:{display:"table-column-group"},datalist:{display:"none"},dd:{display:"block","margin-start":"40px"},del:{"text-decoration":"line-through"},details:{display:"block"},dfn:{display:"inline","font-style":"italic"},dialog:{},div:{display:"block"},dl:{display:"block","unicode-bidi":"embed",margin:"1em 0"},dt:{display:"block","unicode-bidi":"embed"},em:{display:"inline","font-style":"italic"},fieldset:{display:"block","unicode-bidi":"embed",margin:"0 2px",padding:"0.35em 0.75em 0.625em",border:"2px solid #ccc"},figcaption:{display:"block"},figure:{display:"block",margin:"1em 40px"},footer:{display:"block"},form:{display:"none","unicode-bidi":"embed","margin-before":"0"},h1:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":"2em","font-weight":"bold",margin:".67em 0"},h2:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":"1.5em","font-weight":"bold",margin:"0.75em 0"},h3:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":"1.17em","font-weight":"bold",margin:".83em 0"},h4:{display:"block","text-align":"start","unicode-bidi":"embed","font-weight":"bold",margin:"1.12em 0"},h5:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":".83em","font-weight":"bold",margin:"1.5em 0"},h6:{display:"block","text-align":"start","unicode-bidi":"embed","font-size":".75em","font-weight":"bold",margin:"1.67em 0"},head:{display:"none"},header:{display:"block"},hr:{display:"block","unicode-bidi":"embed",margin:"0.5em auto","border-after-width":"1px","border-after-style":"inset"},html:{display:"block"},i:{display:"inline","font-style":"italic"},iframe:{display:"none"},img:{display:"inline"},input:{display:"none"},ins:{"text-decoration":"underline"},kbd:{display:"inline","font-family":"monospace"},label:{display:"inline",cursor:"default"},legend:{display:"block","padding-start":"2px","padding-end":"2px",border:"none"},li:{display:"list-item"},"li::marker":{"margin-end":"0.5em"},link:{display:"none"},main:{display:"block"},map:{display:"inline"},mark:{"background-color":"yellow",color:"black"},menu:{display:"block","unicode-bidi":"embed","list-style-type":"disc",margin:"1.12em 0","padding-start":"40px"},menuitem:{},meta:{display:"none"},meter:{},nav:{display:"block"},noscript:{display:"none"},object:{},ol:{display:"block","unicode-bidi":"embed","list-style-type":"decimal",margin:"1em 0","padding-start":"1em"},"ol ul, ul ol, ul ul, ol ol":{"margin-before":"0","margin-after":"0"},optgroup:{},option:{},output:{display:"inline"},p:{display:"block","unicode-bidi":"embed",margin:"1.12em 0"},param:{display:"none"},picture:{},pre:{display:"block","unicode-bidi":"embed","white-space":"pre",margin:"1em 0"},progress:{},q:{display:"inline"},"q::before":{content:"open-quote"},"q::after":{content:"close-quote"},rb:{display:"ruby-base","white-space":"nowrap","line-height":"1"},rbc:{display:"ruby-base-container"},rp:{display:"none"},rt:{display:"ruby-text","font-size":"0.5em","line-height":"1"},rtc:{display:"ruby-text-container"},ruby:{display:"ruby"},samp:{display:"inline","font-family":"monospace"},script:{display:"none"},section:{display:"block"},select:{display:"inline"},small:{display:"inline","font-size":"smaller"},source:{},span:{display:"inline"},strong:{display:"inline","font-weight":"bold"},style:{display:"none"},sub:{display:"inline","vertical-align":"sub","font-size":"smaller"},summary:{display:"block"},sup:{display:"inline","vertical-align":"super","font-size":"smaller"},svg:{display:"none"},table:{display:"table","border-collapse":"collapse","border-spacing":"2px","border-color":s.defaultTableBorderColor,"border-width":"1px","border-style":"solid","margin-after":"1em"},tbody:{display:"table-row-group","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},td:{display:"table-cell","vertical-align":"inherit","border-width":"1px","border-style":"solid","border-color":"inherit"},template:{},textarea:{display:"inline"},tfoot:{display:"table-footer-group","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},th:{display:"table-cell","vertical-align":"inherit","font-weight":"bold","text-align":"center","border-width":"1px","border-style":"solid","border-color":"inherit"},thead:{display:"table-header-group","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},time:{},title:{display:"none"},tr:{display:"table-row","vertical-align":"middle","border-color":"inherit","border-width":"1px","border-style":"solid"},track:{},ul:{display:"block","unicode-bidi":"embed","list-style-type":"disc",margin:"1em 0","padding-start":"1em"},var:{display:"inline","font-style":"italic"},video:{display:"block"},wbr:{},"::first-line":{display:"block"}};class Ue{static get(e,t){return Oe[e][t]}}class De extends U{hasWord(){return this.tokens.findIndex((e=>e instanceof A))>=0}normalize(e,t){let i=e.replace(/&#x([0-9A-F]+);/gi,((e,t)=>String.fromCodePoint(r.atoi(t,16)))).replace(/&#([0-9]+);/gi,((e,t)=>String.fromCodePoint(r.atoi(t,10))));return t.isPre||(i=i.replace(/^\n+/,""),i=i.replace(/\n+$/,""),i=r.String.multiSpaceToSingle2(i)),i}getShy(){return 0!==this.buff.indexOf(y.softHyphen)?null:(this.stepBuff(y.softHyphen.length),y.softHyphen)}getWord(){let e="";for(;this.hasNextBuff();){let t=s.rexWord.exec(this.buff);if(t){e+=t[0],this.stepBuff(t[0].length);continue}let i=this.getShy();if(!i)break;e+=i}return""===e?null:new A(e)}getSpaceChar(){let e=s.rexSpaceCharRef.exec(this.buff);if(e){let t=e[0];this.stepBuff(t.length);let i=L.charRefToStr(t);return new L(i)}let t=s.rexSpace.exec(this.buff);if(t){let e=t[0];return this.stepBuff(e.length),new L(e)}return null}getRefChar(){let e=s.rexRefChar.exec(this.buff);if(!e)return null;let t=e[0];return this.stepBuff(t.length),new y(t)}getHalfChar(){let e=s.rexHalfChar.exec(this.buff);if(!e)return null;let t=e[0];return this.stepBuff(t.length),new b(t)}getSmpUniChar(){let e=this.buff.charCodeAt(0);if(55296<=e&&e<=56319){let e=this.buff.charCodeAt(1);if(e&&56320<=e&&e<=57343){let e=this.buff.substring(0,2);return this.stepBuff(2),new v(e)}}return null}getMixChar(e){let t=e,i=s.rexVoicedMark.exec(this.buff);return i?(t+=i[0],this.stepBuff(i[0].length),new V(t)):null}getDualChar(e){let t=f.load(e);return t?new x(e,t):null}createToken(){const e=this.peekChar(),t=this.getDualChar(e);if(null!==t)return this.stepBuff(1),t;const i=this.getWord();if(null!==i)return i;const s=this.getSpaceChar();if(null!==s)return s;const r=this.getRefChar();if(null!==r)return r;const o=this.getHalfChar();if(null!==o)return o;const a=this.getSmpUniChar();if(null!==a)return a;const l=this.getChar(),c=this.getMixChar(l);if(null!==c)return c;const h=this.getDualChar(l);return null!==h?h:new n(l)}}class $e extends De{createToken(){const e=new T(this.src);return this.stepBuff(this.src.length),e}}var We,He,_e,Ge,qe,je,Ke,Ye;!function(e){e.BLOCK="block",e.INLINE="inline",e.RUN_IN="run-in"}(We||(We={})),function(e){e.FLOW="flow",e.FLOW_ROOT="flow-root",e.TABLE="table",e.FLEX="flex",e.GRID="grid",e.RUBY="ruby"}(He||(He={})),function(e){e.LIST_ITEM="list-item"}(_e||(_e={})),function(e){e.TABLE_ROW_GROUP="table-row-group",e.TABLE_HEADER_GROUP="table-header-group",e.TABLE_FOOTER_GROUP="table-footer-group",e.TABLE_ROW="table-row",e.TABLE_CELL="table-cell",e.TABLE_COLUMN_GROUP="table-column-group",e.TABLE_COLUMN="table-column",e.TABLE_CAPTION="table-caption",e.RUBY_BASE="ruby-base",e.RUBY_TEXT="ruby-text",e.RUBY_BASE_CONTAINER="ruby-base-container",e.RUBY_TEXT_CONTAINER="ruby-text-container"}(Ge||(Ge={})),function(e){e.NONE="none",e.CONTENTS="contents"}(qe||(qe={})),function(e){e.NONE="none",e.CONTENTS="contents",e.BLOCK="block",e.INLINE="inline",e.INLINE_BLOCK="inline-block",e.FLOW_ROOT="flow-root",e.RUN_IN="run-in",e.LIST_ITEM="list-item",e.INLINE_LIST_ITEM="inline-list-item",e.FLEX="flex",e.INLINE_FLEX="inline-flex",e.GRID="grid",e.INLINE_GRID="inline-grid",e.RUBY="ruby",e.BLOCK_RUBY="block-ruby",e.TABLE="table",e.INLINE_TABLE="inline-table"}(je||(je={}));class Ze{constructor(e){switch(Ze.internalValues.includes(e)&&(this.internal=e),Ze.listItemValues.includes(e)&&(this.listItem=e),Ze.boxValues.includes(e)&&(this.box=e),this.value=Fe.selectOrDefault("display",e,Ze.allValues),this.value){case je.NONE:this.box=qe.NONE;break;case je.CONTENTS:this.box=qe.CONTENTS;break;case je.BLOCK:this.outside=We.BLOCK,this.inside=He.FLOW;break;case je.INLINE_BLOCK:this.outside=We.INLINE,this.inside=He.FLOW_ROOT;break;case je.FLOW_ROOT:this.outside=We.BLOCK,this.inside=He.FLOW_ROOT;break;case je.LIST_ITEM:this.outside=We.BLOCK,this.inside=He.FLOW,this.listItem=_e.LIST_ITEM;break;case je.INLINE_LIST_ITEM:this.outside=We.INLINE,this.inside=He.FLOW,this.listItem=_e.LIST_ITEM;break;case je.RUN_IN:this.outside=We.RUN_IN,this.inside=He.FLOW;break;case je.FLEX:this.outside=We.BLOCK,this.inside=He.FLEX;break;case je.INLINE_FLEX:this.outside=We.INLINE,this.inside=He.FLEX;break;case je.GRID:this.outside=We.BLOCK,this.inside=He.GRID;break;case je.INLINE_GRID:this.outside=We.INLINE,this.inside=He.GRID;break;case je.BLOCK_RUBY:this.outside=We.BLOCK,this.inside=He.RUBY;break;case je.RUBY:this.outside=We.INLINE,this.inside=He.RUBY;break;case je.TABLE:this.outside=We.BLOCK,this.inside=He.TABLE;break;case je.INLINE_TABLE:this.outside=We.INLINE,this.inside=He.TABLE;break;case Ge.TABLE_ROW_GROUP:case Ge.TABLE_HEADER_GROUP:case Ge.TABLE_FOOTER_GROUP:case Ge.TABLE_ROW:this.outside=We.BLOCK,this.inside=He.FLOW;break;case Ge.TABLE_CELL:this.outside=We.INLINE,this.inside=He.FLOW_ROOT;break;case Ge.TABLE_CAPTION:this.outside=We.BLOCK,this.inside=He.FLOW_ROOT;break;case je.INLINE:default:this.outside=We.INLINE,this.inside=He.FLOW}}static load(e){const t=Me.getValue(e,"display"),i=new Ze(t),s=yt.load(e),r=Ft.load(e);return(!s.isNone()||r.isAbsolute()||r.isFixed())&&i.setFlowRoot(),i.isInlineLevel()&&!s.isNone()&&i.setBlockLevel(),i}setBlockLevel(){this.outside=We.BLOCK}setFlowRoot(){this.inside=He.FLOW_ROOT}toString(){return this.value}isNone(){return!!this.box&&this.box===qe.NONE}isContents(){return!!this.box&&this.box===qe.CONTENTS}isListItem(){return!!this.listItem}isTable(){return!!this.inside&&this.inside===He.TABLE}isTableRowGroup(){if(!this.internal)return!1;switch(this.internal){case Ge.TABLE_ROW_GROUP:case Ge.TABLE_HEADER_GROUP:case Ge.TABLE_FOOTER_GROUP:return!0}return!1}isTableRow(){return!!this.internal&&this.internal===Ge.TABLE_ROW}isTableCell(){return!!this.internal&&this.internal===Ge.TABLE_CELL}isBorderCollapsable(){return this.isTableRowGroup()||this.isTableRow()||this.isTableCell()}isRubyChild(){return this.isRubyBase()||this.isRubyText()}isRubyBase(){return!!this.internal&&this.internal===Ge.RUBY_BASE}isRubyText(){return!!this.internal&&this.internal===Ge.RUBY_TEXT}isFlow(){return this.isFlowInside()||this.isFlowRoot()}isInlineFlow(){return this.isInlineLevel()&&this.isFlowInside()}isBlockFlow(){return this.isBlockLevel()&&this.isFlowInside()}isInlineBlockFlow(){return this.isInlineLevel()&&this.isFlowRoot()}isFlowInside(){return!!this.inside&&this.inside===He.FLOW}isFlowRoot(){return!!this.inside&&this.inside===He.FLOW_ROOT}isFlowTable(){return!!this.inside&&this.inside===He.TABLE}isFlowRuby(){return!!this.inside&&this.inside===He.RUBY}isBlockLevel(){return!!this.outside&&this.outside===We.BLOCK}isInlineLevel(){return!!this.outside&&this.outside===We.INLINE}}Ze.values=r.Enum.toValueArray(je),Ze.listItemValues=r.Enum.toValueArray(_e),Ze.internalValues=r.Enum.toValueArray(Ge),Ze.boxValues=r.Enum.toValueArray(qe),Ze.allValues=Ze.values.concat(Ze.listItemValues).concat(Ze.internalValues).concat(Ze.boxValues);class Xe{constructor(e,t,i){this.selector=e,this.name=t,this.callback=i}call(e,t,i){return this.callback({selector:this.selector,name:this.name,box:e,dom:t,flowRoot:i})}}class Je{constructor(e){this.tokens=e||[]}get length(){return this.tokens.length}item(e){return this.tokens[e]}contains(e){return this.tokens.some((t=>t===e))}add(e){this.tokens.push(e)}remove(e){return this.tokens=this.tokens.filter((t=>t!==e))}replace(e,t){return this.tokens=this.tokens.map((i=>i===e?t:i))}supports(e){throw new Error("Sorry, not implemented yet")}toggle(e,t){let i=this.contains(e);return!0===t?(!1===i&&this.add(e),!0):!1===t?(!0===i&&this.remove(e),!1):!0===i?(this.remove(e),!1):(this.add(e),!0)}entries(){return this.tokens}keys(){return Object.keys(this.tokens)}values(){return this.tokens}forEach(e){Array.prototype.forEach.call(this.tokens,e)}}class Qe{constructor(e){this.selector=e.selector,this.name=e.name,this.element=e.element,this.parentContext=e.parentContext}setExternalDOM(e){this.element.$dom=e}get fontSize(){return Ae.computeFontSize(this.element)}get remSize(){return this.parentContext instanceof us&&this.parentContext.pageRoot?this.parentContext.pageRoot.env.font.size:this.emSize}get emSize(){return Ae.computeFontSize(this.element)}get lineHeight(){const e=this.element.computedStyle.getPropertyValue("line-height");if(!e)throw new Error("line-height is not defined!");return e.indexOf("px")<0?Math.floor(this.emSize*parseFloat(e)):r.atoi(e)}get restContextBoxExtent(){if(this.parentContext)return this.parentContext.restExtent;throw new Error("parent context is not defined")}}class et{static requiredExtent(e){return t=>{if(t.parentContext)return t.parentContext.restExtent<e?{"page-break-before":"always"}:{"page-break-before":"auto"}}}static smartHeader(e){let t=e.parentContext;if(t instanceof us&&t.env.display.isInlineLevel()&&(t=t.parentBlock),!t)return;const i=2*e.remSize-.14285714*e.emSize,s={marginBefore:i+"px",marginStart:"0px",marginEnd:"0px",marginAfter:"1rem"};return(0===t.globalPos.before||t.restExtent<i)&&(s.marginBefore="0px"),s}static smartBorderBreak(e){const t=le.load(e.element);if(t.border.width.before<=0)return;if(!e.parentContext)return;const i=e.element.firstAtomChild;var s,r,n;return i&&e.parentContext.restExtent<(s=i,r=e.parentContext.env.font.lineExtent,n=e.parentContext.env.writingMode,(s.isTextElement()?r:Ht.isReplacedElement(s)?Vt.load(s).getLogicalSize(n).extent:0)+t.before)?{"page-break-before":"always"}:void 0}static breakPoint(e){}static replaceContent(e){return t=>{let i=t.element.textContent,s=e(i,t);t.element.innerHTML=s}}}class tt{constructor(e,t,i){this.selector=e,this.name=t,this.callback=i}call(e,t){const i=new Qe({selector:this.selector,name:this.name,element:e,parentContext:t}),s=this.callback(i)||{};if("string"==typeof s){const e={[this.name]:s};return he.parseDeclarationBlock(this.selector,e)}return he.parseDeclarationBlock(this.selector,s)}}!function(e){e.XX_SMALL="xx-small",e.X_SMALL="x-small",e.SMALL="small",e.MEDIUM="medium",e.LARGE="large",e.X_LARGE="x-large",e.XX_LARGE="xx-large"}(Ke||(Ke={})),function(e){e.SMALLER="smaller",e.LARGER="larger"}(Ye||(Ye={}));const it=r.Enum.toValueArray(Ke),st=r.Enum.toValueArray(Ye),rt={"xx-small":8,"x-small":10,small:13,medium:16,large:18,"x-large":24,"xx-large":33},nt={smaller:"0.8em",larger:"1.2em"};class ot extends U{normalize(e){return e.trim()}peekQuotedString(){const e=ot.rexQuotedString.exec(this.buff);if(e){const t=e[0];return this.stepBuff(t.length),t}return""}peekUntilSpace(){const e=this.buff.indexOf(" ");if(e<0){const e=this.buff;return this.stepBuff(this.buff.length),e}const t=this.buff.substring(0,e);return this.stepBuff(e+1),t}createToken(){return this.peekQuotedString()||this.peekUntilSpace()}}ot.rexQuotedString=/^'[^']+'/;class at{constructor(e){this.lexer=e}parseFontSize(e){return e.indexOf("/")<0?e:e.split("/")[0].trim()}parseLineHeight(e){return e.indexOf("/")<0?"normal":e.split("/")[1].trim()}inferOptPropByValue(e,t){if(/^[1-9]00$/.test(e))return"font-weight";if(e.indexOf("condensed")>=0||e.indexOf("expanded")>=0)return"font-stretch";const i=["font-style","font-variant","font-weight","font-stretch"];switch(e){case"normal":return i[t]||"font-style";case"italic":case"oblique":return"font-style";case"none":case"small-caps":return"font-variant";case"bold":case"lighter":case"bolder":return"font-weight"}return console.error(`invalid optinal value for shorthanded font css:${e}`),"font-style"}parse(){const e=this.lexer.src,t=this.lexer.tokens;if(t.length<2)return console.warn(`invalid font shorthand, both font-size and font-family must be specified: ${e}`),[];if(2===t.length){const e=this.parseFontSize(t[0]);return[{prop:"font-family",value:t[1]},{prop:"font-size",value:e},{prop:"line-height",value:this.parseLineHeight(t[0])}]}if(2<t.length&&t.length<6){const e=t.slice(0,-2),i=this.parseFontSize(t[t.length-2]),s=this.parseLineHeight(t[t.length-2]);let r=[{prop:"font-family",value:t[t.length-1]},{prop:"font-size",value:i},{prop:"line-height",value:s}];return e.forEach(((e,t)=>{const i=this.inferOptPropByValue(e,t);r.push({prop:i,value:e})})),r}const i=t[0],s=t[1],r=t[2],n=t[3],o=this.parseFontSize(t[4]),a=this.parseLineHeight(t[4]);return[{prop:"font-style",value:i},{prop:"font-variant",value:s},{prop:"font-weight",value:r},{prop:"font-stretch",value:n},{prop:"font-family",value:t[5]},{prop:"font-size",value:o},{prop:"line-height",value:a}]}}class lt{constructor(){this.style=Fe.getInitialValue("font-style"),this.variant=Fe.getInitialValue("font-variant"),this.weight=Fe.getInitialValue("font-weight"),this.stretch=Fe.getInitialValue("font-stretch"),this.size=s.defaultFontSize,this.lineHeight=String(s.defaultLineHeight),this.family=s.defaultFontFamily}get css(){return[this.style,this.variant,this.weight,this.stretch,[this.size+"px",this.lineHeight].join("/"),this.family].join(" ")}get lineExtent(){return this.lineHeight.indexOf("px")>=0?r.atoi(this.lineHeight):Math.floor(parseFloat(this.lineHeight)*this.size)}static parseShorthand(e){const t=new ot(e.value);return new at(t).parse()}static load(e){let t=new lt;return t.style=Me.getValue(e,"font-style"),t.variant=Me.getValue(e,"font-variant"),t.weight=Me.getValue(e,"font-weight"),t.stretch=Me.getValue(e,"font-stretch"),t.family=Me.getValue(e,"font-family"),t.size=r.atoi(Me.getValue(e,"font-size"),s.defaultFontSize),t.lineHeight=Me.getValue(e,"line-height"),t}acceptCssEvaluator(e){return e.visitFont(this)}}class ct extends D{constructor(e){super(),this.idName=e,this.specificity.a=1}toString(){return"#"+this.idName}test(e){return e.id===this.idName}}class ht{static parseSection(e,t){return t=t||{},e.isRoot()?this.parseSectionRoot(e,t):e.isNode()?this.parseSectionNode(e,t):this.parseSectionLeaf(e,t)}static parseSectionRoot(e,t){let i=t.onRoot?t.onRoot():document.createElement("ul");return this.appendSectionChildren(i,e.children,t),i}static parseSectionNode(e,t){let i=document.createElement("li"),s=document.createElement("ul"),r=t.onSection?t.onSection(e):document.createTextNode(e.title);return i.appendChild(r),this.appendSectionChildren(s,e.children,t),i.appendChild(s),i}static parseSectionLeaf(e,t){let i=document.createElement("li"),s=t.onSection?t.onSection(e):document.createTextNode(e.title);return i.appendChild(s),i}static appendSectionChildren(e,t,i){t.forEach((t=>{e.appendChild(this.parseSection(t,i))}))}}class dt{constructor(){this.headers={},this.rootSection=new ut,this.curSection=this.rootSection}getSectionAt(e){const t=this.rootSection.children;let i=this.rootSection;for(let s=0;s<t.length;s++){const r=t[s].getClosestSectionByPageIndex(e,i);if(r.pageIndex===e)return r;if(r.pageIndex>e)return i;i=r}return i}acceptEvaluator(e){return e.visitSectionRoot(this.rootSection)}createElement(e){return ht.parseSection(this.rootSection,e)}openElement(e,t){return ut.isSectioningRootElement(e)?this.openSectionRoot(e,t):ut.isSectioningElement(e)?this.openSection(t):ut.isHeaderElement(e)?this.openHeader(e,t):void 0}closeElement(e){return e&&!1===ut.isSectioningElement(e)?this.curSection:this.closeSection()}getHeaderSection(e){return this.headers[e.getPath(!0)]}openSectionRoot(e,t){return this.rootElement?(this.rootElement=e,this.openSection(t)):this.curSection}openSection(e){return this.curSection.closed?this.curSection=this.createNextSection(e):this.curSection=this.createSubSection(e),this.curSection}closeSection(){return this.curTitle,this.curSection.parent&&(this.curSection=this.curSection.parent),this.curSection}openHeader(e,t){return this.curSection=this.addHeader(e,t),this.curSection}get curTitle(){let e=this.curSection.closed?"(closed)":"(open)";return this.curSection.title+e}createContextSection(e,t){let i=new ut(t);return i.pageIndex=t?-1:e,t&&(this.headers[t.getPath(!0)]=i),i}createStandAloneSubSection(e,t){const i=this.createContextSection(e,t);return i.closed=!0,this.curSection.addChild(i),i}createSubSection(e,t){const i=this.createContextSection(e,t);return this.curSection.addChild(i),i}createNextSection(e,t){const i=this.createContextSection(e,t);return this.closeSection().addChild(i),i}closeHigherSection(e,t){return!e.parent||!e.parent.parent||e.level<=t?e:(e.closed=!0,this.closeHigherSection(e.parent,t))}createHigherSection(e,t,i){return this.curSection.parent&&(this.curSection=this.closeHigherSection(this.curSection.parent,i)),this.createNextSection(e,t)}addHeader(e,t){if(!this.curSection.header)return this.curSection.parent?(this.curSection.setHeader(e),this.curSection):this.createSubSection(t,e);const i=this.curSection.level,s=ut.getHeaderLevel(e);return s>i?this.createStandAloneSubSection(t,e):s===i?this.createNextSection(t,e):(this.curSection.closed=!0,this.createHigherSection(t,e,s))}}class ut{constructor(e){this.header=e,this.children=[],this.closed=!1,this.pageIndex=0}isRoot(){return!this.parent}isNode(){return this.children.length>0}isLeaf(){return 0===this.children.length}setHeader(e){this.header||(this.header=e)}addChild(e){return this.children.push(e),e.parent=this,this}get level(){return this.header?ut.getHeaderLevel(this.header):-1}get title(){return this.header?this.header.textContent:this.parent?"no title":"(root)"}getClosestSectionByPageIndex(e,t){if(this.pageIndex>=e)return this;let i=this;for(let t=0;t<this.children.length;t++){const s=this.children[t].getClosestSectionByPageIndex(e,i);if(s.pageIndex===e)return s;if(s.pageIndex>e)return i;i=s}return i}static isHeaderElement(e){switch(e.tagName){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":return!0}return!1}static getHeaderLevel(e){switch(e.tagName){case"h1":return 1;case"h2":return 2;case"h3":return 3;case"h4":return 4;case"h5":return 5;case"h6":return 6}throw new Error(`Invalid header:${e.tagName}`)}static isSectioningElement(e){switch(e.tagName){case"body":case"section":case"nav":case"article":case"aside":return!0}return!1}static isSectioningRootElement(e){switch(e.tagName){case"body":case"blockquote":case"fieldset":case"figure":case"td":return!0}return!1}}class pt{constructor(e){this.value=e}isOutside(){return"outside"===this.value}isInside(){return"inside"===this.value}static load(e){let t=Me.getValue(e,"list-style-position");return new pt(t)}}let gt={none:L.markerSpace,disc:"•",circle:"◦",square:"▪"};class mt{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,this.property);return new mt(t)}isNone(){return"none"===this.value}isTcyMarker(){return"decimal"===this.value}getMarkerText(e){switch(this.value){case"none":case"circle":case"disc":case"square":return gt[this.value];case"decimal":return String(e+1)+".";default:return gt.disc}}}mt.property="list-style-type";class ft{isNone(){return this.type_.isNone()}isPositionOutside(){return this.position.isOutside()}isPositionInside(){return this.position.isInside()}isTcyMarker(){return this.type_.isTcyMarker()}getMarkerText(e){return this.type_.getMarkerText(e)}getCssListMarkerHori(){let e=new zt;return e.set("display","inline-block"),e}getCssListBodyHori(){let e=new zt;return e.set("display","inline-block"),e}insertMarkerText(e){const t=e.firstChild;if(!t||t.tagName!==Dt.MARKER)return;if(t.firstChild&&t.firstChild.isTextElement())return;let i=this.getMarkerText(e.indexOfType);e.querySelector("li")&&(i=L.markerSpace);const s=e.root.createTextNode(i);t.appendChild(s)}static load(e){const t=new ft;return t.type_=mt.load(e),t.position=pt.load(e),t.image=ft.loadImage(e),t}static loadImage(e){return Me.getValue(e,"list-style-image")}static inferProp(e){if(e.indexOf("url(")>=0)return"list-style-image";switch(e){case"inside":case"outside":return"list-style-position"}return"list-style-type"}static parseShorthand(e){let t={"list-style-image":"none","list-style-type":"none","list-style-position":"outside"};return e.split().forEach((e=>{const i=ft.inferProp(e);t[i]=e})),Object.keys(t).map((e=>({prop:e,value:t[e]})))}}class xt{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"clear");return new xt(t)}isNone(){return"none"===this.value}isStart(){return"start"===this.value}isEnd(){return"end"===this.value}isBoth(){return"both"===this.value}}class bt{constructor(e){this.start=e.start,this.before=e.before}static get zero(){return new bt(this.zeroValue)}static get zeroValue(){return{start:0,before:0}}zero(){this.start=0,this.before=0}clone(){return new bt({start:this.start,before:this.before})}cloneValue(){return{start:this.start,before:this.before}}get logicalPos(){return new Bt({before:this.before,start:this.start})}toString(){return`(${this.start}, ${this.before})`}translate(e){return new bt({before:this.before+e.before,start:this.start+e.start})}acceptCssEvaluator(e){return e.visitPos(this)}}class yt{constructor(e){this.value="start"!==e&&"end"!==e&&"none"!==e?"none":e}isFloat(){return!1===this.isNone()}isStart(){return"start"===this.value}isEnd(){return"end"===this.value}isNone(){return"none"===this.value}static load(e){let t=Me.getValue(e,"float");return new yt(t)}}class vt extends Map{get(e){const t=super.get(e);if(!t)throw new Error(`property(${e}) is not defined in map`);return t}}class Et{constructor(){this.horiTb=new vt,this.vertRl=new vt,this.vertLr=new vt}select(e){return e.isTextHorizontal()?this.horiTb:e.isVerticalRl()?this.vertRl:this.vertLr}}const St=new class extends Et{constructor(){super(),this.horiTb.set("before","top"),this.horiTb.set("end","right"),this.horiTb.set("after","bottom"),this.horiTb.set("start","left"),this.vertRl.set("before","right"),this.vertRl.set("end","bottom"),this.vertRl.set("after","left"),this.vertRl.set("start","top"),this.vertLr.set("before","left"),this.vertLr.set("end","bottom"),this.vertLr.set("after","right"),this.vertLr.set("start","top")}},wt=new class extends Et{constructor(){super(),this.horiTb.set("before-start","top-left"),this.horiTb.set("before-end","top-right"),this.horiTb.set("after-end","bottom-right"),this.horiTb.set("after-start","bottom-left"),this.vertRl.set("before-start","top-right"),this.vertRl.set("before-end","bottom-right"),this.vertRl.set("after-end","bottom-left"),this.vertRl.set("after-start","top-left"),this.vertLr.set("before-start","top-left"),this.vertLr.set("before-end","bottom-left"),this.vertLr.set("after-end","bottom-right"),this.vertLr.set("after-start","top-right")}};class Ct extends Q{static parseShorthand(e){let t=K.getValue4D(e.value);return[{prop:"margin-before",value:t[0]},{prop:"margin-end",value:t[1]},{prop:"margin-after",value:t[2]},{prop:"margin-start",value:t[3]}]}static load(e){return new Ct(Y.reduce(((t,i)=>(t[i]=Q.loadDirection(e,`margin-${i}`),t)),{}))}static get none(){return new Ct(Q.zeroValue)}clone(){return new Ct(this.values)}getPropByLogicalDirection(e){return`margin-${e}`}acceptCssEvaluator(e){return e.visitLogicalMargin(this)}}class kt extends Q{static parseShorthand(e){let t=K.getValue4D(e.value);return[{prop:"padding-before",value:t[0]},{prop:"padding-end",value:t[1]},{prop:"padding-after",value:t[2]},{prop:"padding-start",value:t[3]}]}static load(e){return new kt(Y.reduce(((t,i)=>(t[i]=Q.loadDirection(e,`padding-${i}`),t)),{}))}static get none(){return new kt(Q.zeroValue)}clone(){return new kt(this.values)}getPropByLogicalDirection(e){return`padding-${e}`}acceptCssEvaluator(e){return e.visitLogicalMargin(this)}}class Bt{constructor(e){this.before=e.before,this.end=e.end,this.after=e.after,this.start=e.start}static load(e){let t={};return t.before=this.loadEach(e,"before"),t.end=this.loadEach(e,"end"),t.after=this.loadEach(e,"after"),t.start=this.loadEach(e,"start"),new Bt(t)}static loadEach(e,t){let i=Me.getValue(e,t);return"auto"===i?void 0:r.atoi(i,10)}hasValue(){return void 0!==this.before||void 0!==this.end||void 0!==this.after||void 0!==this.start}acceptCssEvaluator(e){return e.visitLogicalPos(this)}}class Rt{constructor(e){this.value=e}static load(e){const t=Me.getValue(e,"background-position");return new Rt(t)}acceptCssEvaluator(e){return e.visitBackgroundPos(this)}}class Lt{constructor(e,t){this.pos=e,this.size=t}toString(){return`rect(${JSON.stringify({pos:this.pos,size:this.size})})`}canContain(e){return this.size.canContain(e)}translate(e){return new Lt(this.pos.translate(e),this.size)}collideWith(e){const t=Math.abs(this.start-e.start),i=(this.measure+e.measure)/2,s=Math.abs(this.before-e.before),r=(this.extent+e.extent)/2;return t<i&&s<r}get extent(){return this.size.extent}set extent(e){this.size.extent=e}get measure(){return this.size.measure}set measure(e){this.size.measure=e}get start(){return this.pos.start}set start(e){this.pos.start=e}get before(){return this.pos.before}set before(e){this.pos.before=e}get end(){return this.pos.start+this.size.measure}get after(){return this.pos.before+this.size.extent}}class Tt{constructor(e){this.measure=e.measure,this.extent=e.extent}static load(e){let t=this.loadMeasure(e);if(null===t)return null;let i=this.loadExtent(e);return null===i?null:new Tt({measure:t,extent:i})}static loadMeasure(e){let t=e.computedStyle.getPropertyValue("measure")||"auto";return"auto"===t?null:r.atoi(t)}static loadExtent(e){let t=e.computedStyle.getPropertyValue("extent")||"auto";return"auto"===t?null:r.atoi(t)}static get zero(){return new Tt({measure:0,extent:0})}toString(){return`m:${this.measure}, e:${this.extent}`}clone(){return new Tt({measure:this.measure,extent:this.extent})}canContain(e){return this.measure>=e.measure&&this.extent>=e.extent}isZero(){return 0===this.measure&&0===this.extent}hasZero(){return 0===this.measure||0===this.extent}getPhysicalSize(e){return new Vt({width:this.getWidth(e),height:this.getHeight(e)})}getWidth(e){return e.isTextVertical()?this.extent:this.measure}getHeight(e){return e.isTextVertical()?this.measure:this.extent}resize(e){if(this.measure<=e.measure&&this.extent<=e.extent)return this.clone();const t={measure:this.measure,extent:this.extent},i=this.extent/this.measure,s=this.measure/this.extent;for(;t.measure>e.measure||t.extent>e.extent;){const r=t.measure-e.measure,n=t.extent-e.extent;r>n?(t.measure=e.measure,t.extent=t.extent-r*i):(t.extent=e.extent,t.measure=t.measure-n*s)}return new Tt({measure:Math.floor(t.measure),extent:Math.floor(t.extent)})}acceptCssEvaluator(e){return e.visitSize(this)}getCss(e){return e?this.getCssVert():this.getCssHori()}getCssVert(){const e=new zt;return e.set("width",this.extent+"px"),e.set("height",this.measure+"px"),e}getCssHori(){const e=new zt;return e.set("width",this.measure+"px"),e.set("height",this.extent+"px"),e}}class Pt{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"text-align");return new Pt(t)}isStart(){return"start"===this.value}isEnd(){return"end"===this.value}isCenter(){return"center"===this.value}isJustify(){return"justify"===this.value}}class Nt{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"vertical-align");return new Nt(t)}}class zt{constructor(){this._map=new Map}set(e,t){return this._map.set(e,t),this}delete(e){return this._map.delete(e),this}forEach(e){this._map.forEach(e)}mergeTo(e){return this.forEach(((t,i)=>{e.set(i,t)})),e}applyTo(e){return this._map.forEach(((t,i)=>{e.setProperty(i,t)})),this}}class Mt{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"overflow-wrap");return new Mt(t)}isNormal(){return"normal"===this.value}isBreakWord(){return"break-word"===this.value}}class It{constructor(e){this.value=e}isAlways(){return"always"===this.value}static load(e){let t=Me.getValue(e,"page-break-after");return new It(t)}}class At{constructor(e){this.value=e}isAlways(){return"always"===this.value}static load(e){let t=Me.getValue(e,"page-break-before");return new At(t)}}class Vt{constructor(e){this.width=e.width,this.height=e.height}static load(e){const t=e.getAttribute("width"),i=e.getAttribute("height"),s=t||e.computedStyle.getPropertyValue("width"),n=i||e.computedStyle.getPropertyValue("height"),o="auto"===s?0:r.atoi(t||s||"0"),a="auto"===n?0:r.atoi(i||n||"0");return new Vt({width:o,height:a})}getLogicalSize(e){return new Tt({measure:this.getMeasure(e),extent:this.getExtent(e)})}getExtent(e){return e.isTextVertical()?this.width:this.height}getMeasure(e){return e.isTextVertical()?this.height:this.width}getWidthPerHeight(){return 0===this.height?1:this.width/this.height}isZero(){return 0===this.width&&0===this.height}hasZero(){return 0===this.width||0===this.height}}class Ft{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"position");return new Ft(t)}isAbsolute(){return"absolute"===this.value}isRelative(){return"relative"===this.value}isStatic(){return"static"===this.value}isFixed(){return"fixed"===this.value}isSticky(){return"sticky"===this.value}}class Ot extends D{constructor(e){super(),this.src=e,this.specificity.b=1}toString(){return":"+this.src}testEven(e){return(e.index+1)%2==0}testOdd(e){return!1===this.testEven(e)}getNthExpr(e){return e.replace(/\s/g,"").replace(/^nth-child\((.+)\)/,"$1")}testNthFuncExpr(e,t){let i=t.match(/\d+(?=n)/);if(!i)return console.error("invalid nth-child expr:%s",t),!1;let s=r.atoi(i[0]),n=t.replace(/\d+n/g,"").replace(/[+-]/g,""),o=n?r.atoi(n[0]):0;return 0===s?e===o:!(e<o)&&(e-o)%s==0}testNthExpr(e){let t=this.getNthExpr(this.src);return/^\d+$/.test(t)?e+1===r.atoi(t):this.testNthFuncExpr(e,t)}testNthChild(e){return this.testNthExpr(e.indexOfElement)}testMatch(e){throw new Error("pseudo-class 'match' is not implemented yet")}test(e){return"first-child"===this.src?e.isFirstElementChild():"last-child"===this.src?e.isLastElementChild():"odd"===this.src?this.testOdd(e):"even"===this.src?this.testEven(e):this.src.indexOf("nth-child(")>=0?this.testNthChild(e):this.src.indexOf("match(")>=0&&this.testMatch(e)}}class Ut extends D{constructor(e){super(),this.src=e,this.specificity.c=1,$t.includes(this.tagName)||console.error("pseudo element("+this.pseudoName+") is not defined.")}toString(){return this.tagName}get pseudoName(){return this.src}get tagName(){return"::"+this.pseudoName}test(e){return e.tagName===this.tagName}}var Dt;!function(e){e.MARKER="::marker",e.BEFORE="::before",e.AFTER="::after",e.FIRST_LINE="::first-line",e.FIRST_LETTER="::first-letter"}(Dt||(Dt={}));const $t=r.Enum.toValueArray(Dt);class Wt{static isPseudoElement(e){return"::"===e.tagName.substring(0,2)}static isFirstLine(e){return e.tagName===Dt.FIRST_LINE}}class Ht{static isReplacedElement(e){switch(e.tagName){case"img":case"video":case"iframe":return!0}return!1}}var _t;class Gt{constructor(e){this.totalItemCount=e,this.successCount=0,this.errorCount=0}get progress(){return(this.successCount+this.errorCount)/this.totalItemCount}get percent(){return Math.floor(100*this.progress)}}class qt{constructor(e,t){this.imageElements=e,this.context=t}load(e){return t=this,i=void 0,n=function*(){try{return yield Promise.all(this.imageElements.map((t=>{const i=t.$node;if(i.width&&i.height)return this.context.successCount++,e.onProgressImage&&e.onProgressImage(this.context),Promise.resolve(t);const s=this.getImageAttr(t.tagName);return this.loadImage(t,s,e)}))),e.onCompleteImage&&e.onCompleteImage(this.context),!0}catch(e){return s.debugImageLoader&&console.error(e),!1}},new((r=void 0)||(r=Promise))((function(e,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(e){e(i)}))).then(o,a)}l((n=n.apply(t,i||[])).next())}));var t,i,r,n}getImageAttr(e){switch(e){case"video":return"poster";default:return"src"}}loadImage(e,t,i){return new Promise(((r,n)=>{const o=e.$node,a=document.createElement("img"),l=o.getAttribute(t);l&&a.setAttribute("src",l);const c=o.getAttribute("data-src");if(c&&a.setAttribute("data-src",c),!l&&!c)return s.debugImageLoader&&console.error("Invalid resource. Both src and data-src are not defined:",e),this.context.errorCount++,i.onProgressImage&&i.onProgressImage(this.context),void r(e);a.onload=t=>{o.setAttribute("width",String(a.width)),o.setAttribute("height",String(a.height)),s.debugImageLoader&&console.info("%s is successfully loaded(%dx%d)",a.src,a.width,a.height),this.context.successCount++,i.onProgressImage&&i.onProgressImage(this.context),r(e)},a.onerror=t=>{s.debugImageLoader&&console.error(t),this.context.errorCount++,i.onProgressImage&&i.onProgressImage(this.context),e.getAttribute("alt")||o.setAttribute("style","display:none"),r(e)}}))}}class jt{constructor(){this.cache={}}clear(){this.cache={}}hasCache(e){return void 0!==this.cache[e]}getCache(e){return this.cache[e]||[]}addCache(e,t){return this.hasCache(e)?this.cache[e].push(t):this.cache[e]=[t],t}}class Kt extends U{normalize(e){let t=e.trim();return t=r.String.multiSpaceToSingle(e),t=t.replace(/\s*([=>~+])\s*/g,"$1"),t}addToken(e){this.tokens.unshift(e)}createToken(){let e=this.peekChar();if(","===e)throw new Error("comma separator is not allowed");if("*"===e)return this.stepBuff(1),{type:_t.UNIVERSAL_SELECTOR,value:e};let t=Kt.rexTypeSelector.exec(this.buff);if(null!==t){let e=t[0];return this.stepBuff(e.length),{type:_t.TYPE_SELECTOR,value:e}}let i=Kt.rexClassSelector.exec(this.buff);if(null!==i){let e=i[0],t=e.substring(1);return this.stepBuff(e.length),{type:_t.CLASS_SELECTOR,value:t}}let s=Kt.rexIdSelector.exec(this.buff);if(null!==s){let e=s[0],t=e.substring(1);return this.stepBuff(e.length),{type:_t.ID_SELECTOR,value:t}}let r=Kt.rexAttrSelector.exec(this.buff);if(null!==r){let e=r[0],t=RegExp.$1;return this.stepBuff(e.length),{type:_t.ATTR_SELECTOR,value:t}}let n=Kt.rexPseudoClass.exec(this.buff);if(null!==n){let e=n[0],t=e.substring(1);return this.stepBuff(e.length),{type:_t.PSEUDO_CLASS,value:t}}let o=Kt.rexPseudoElement.exec(this.buff);if(null!==o){let e=o[0],t=e.substring(2);return this.stepBuff(e.length),this.src==e?{type:_t.TYPE_SELECTOR,value:e}:{type:_t.PSEUDO_ELEMENT,value:t}}switch(e){case" ":case"+":case"~":case">":return this.stepBuff(1),{type:_t.COMBINATOR,value:e}}throw new Error(this.src)}}Kt.rexMediaSelector=/^@[a-z]*/,Kt.rexTypeSelector=/^[a-zA-Z][_a-zA-Z0-9-]*/,Kt.rexClassSelector=/^\.[_a-zA-Z][_a-zA-Z0-9-]*/,Kt.rexAttrSelector=/^\[(.*?)\]/,Kt.rexIdSelector=/^#[_a-zA-Z][_a-zA-Z0-9-]*/,Kt.rexPseudoClass=/^:[_a-z][_a-z0-9-]*[_a-z0-9-.,()]*/,Kt.rexPseudoElement=/^::[_a-z][_a-z0-9-]*/;class Yt{constructor(e){this.lexer=e}normalizeAttr(e){return e.trim().replace(/^\[/,"").replace(/\]$/,"").replace(/["']/g,"").replace(/\s/g,"")}parseAttrSelector(e){let t=this.normalizeAttr(e);if(t.indexOf("=")<0)return new Re(t);let i=["*=","^=","$=","~=","|=","="];for(var s=0;s<i.length;s++){let e=i[s],r=t.split(e);if(r.length>=2)return new Re(r[0],e,r[1])}throw new Error("syntax error(attribute selector)")}parseCompoundSelector(){let e=!0,t=0,i={classSelectors:[],pseudoClasses:[]};for(;e&&this.lexer.hasNext();){let s=this.lexer.getNext();switch(s.type){case _t.UNIVERSAL_SELECTOR:i.univSelector=new ri,t++;break;case _t.TYPE_SELECTOR:i.typeSelector=new si(s.value),t++;break;case _t.ID_SELECTOR:i.idSelector=new ct(s.value),t++;break;case _t.CLASS_SELECTOR:i.classSelectors.push(new Te(s.value)),t++;break;case _t.ATTR_SELECTOR:i.attrSelector=this.parseAttrSelector(s.value),t++;break;case _t.PSEUDO_CLASS:i.pseudoClasses.push(new Ot(s.value)),t++;break;case _t.PSEUDO_ELEMENT:i.pseudoElement=new Ut(s.value),t++;break;default:this.lexer.pushBack(1),e=!1}}if(0===t)throw new Error("syntax error. selector required");return new Ne(i)}parseCombinator(){let e=this.lexer.getNext();if(e.type!==_t.COMBINATOR)throw new Error("syntax error. combinator required.");return e.value}parse(){let e=[],t=[],i=null;for(;this.lexer.hasNext()&&(i||(i=this.parseCompoundSelector(),e.push(i)),this.lexer.hasNext());){let s=this.parseCombinator();if(t.push(s),!this.lexer.hasNext())throw new Error("missing left value for combinator["+s+"]");let r=this.parseCompoundSelector();e.push(r),i=r}return new Pe(e,t)}}class Zt{constructor(e){this.value=this.normalize(e)}toString(){return this.value}split(){return this.value.split(",")}normalize(e){let t=e.trim();return t=t.replace(/\s*,\s*/g,","),t=r.String.multiSpaceToSingle(t),t}}!function(e){e[e.UNIVERSAL_SELECTOR=0]="UNIVERSAL_SELECTOR",e[e.TYPE_SELECTOR=1]="TYPE_SELECTOR",e[e.CLASS_SELECTOR=2]="CLASS_SELECTOR",e[e.ID_SELECTOR=3]="ID_SELECTOR",e[e.ATTR_SELECTOR=4]="ATTR_SELECTOR",e[e.PSEUDO_CLASS=5]="PSEUDO_CLASS",e[e.PSEUDO_ELEMENT=6]="PSEUDO_ELEMENT",e[e.COMBINATOR=7]="COMBINATOR"}(_t||(_t={}));class Xt{constructor(e,t,i){this.a=e,this.b=t,this.c=i}static add(e,t){let i=new Xt(0,0,0);return i.a=e.a+t.a,i.b=e.b+t.b,i.c=e.c+t.c,i}static compare(e,t){return e.a>t.a?1:e.a<t.a?-1:e.b>t.b?1:e.b<t.b?-1:e.c>t.c?1:e.c<t.c?-1:0}incA(){return this.a++,this.a}incB(){return this.b++,this.b}incC(){return this.c++,this.c}}class Jt{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"text-combine-upright");return new Jt(t)}isNone(){return"none"===this.value}}const Qt={"filled dot":"•","open dot":"◦","filled circle":"●","open circle":"○","filled double-circle":"◉","open double-circle":"◎","filled triangle":"▲","open triangle":"△","filled sesame":"﹅","open sesame":"﹆"};class ei{constructor(e,t){this.stroke=e,this.mark=t}static isStrokeValue(e){return"filled"===e||"open"===e}static isMarkValue(e){return"dot"===e||"circle"===e||"double-circle"===e||"triangle"===e||"sesame"===e}static load(e){const t=Me.getValue(e,this.property),i=new K({prop:this.property,value:t});let s="none",r="dot";return i.split().forEach((e=>{this.isStrokeValue(e)?s=e:this.isMarkValue(e)&&(r=e)})),new ei(s,r)}get values(){return[this.stroke,this.mark]}get scale(){switch(this.mark){case"circle":case"double-circle":case"triangle":case"sesame":return.5}return 1}get text(){const e=this.values.join(" ");return Qt[e]||"•"}isNone(){return"none"===this.stroke}}ei.property="text-emphasis-style";class ti{constructor(){}static parseShorthand(e){let t=e.split(),i=[];if("none"===e.value||0===t.length)return i;let s="",r="",n="";t.forEach((e=>{ei.isStrokeValue(e)?s=e:ei.isMarkValue(e)?r=e:n=e}));let o=[s,r].join(" ").trim();return""!==o&&i.push({prop:"text-emphasis-style",value:o}),""!==n&&i.push({prop:"text-emphasis-color",value:n}),i}static load(e){let t=new ti;return t.style=ei.load(e),t.color=ti.loadColor(e),t}static loadColor(e){return Me.getValue(e,"text-emphasis-color")}get textEmphaData(){return{text:this.text,styles:this.style.values,scale:this.style.scale}}get text(){return this.style.text}isNone(){return this.style.isNone()}}class ii{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"text-orientation");return new ii(t)}isSideways(){return"sideways"===this.value}isUpright(){return"upright"===this.value}isMixed(){return"mixed"===this.value}}class si extends D{constructor(e){super(),this.tagName=e,this.specificity.c=1}toString(){return this.tagName}test(e){return this.tagName===e.tagName}}class ri extends D{toString(){return"*"}test(e){return!0}}class ni{constructor(e){this.value=e}isPre(){return"pre"===this.value}static load(e){let t=Me.getValue(e,"white-space");return new ni(t)}static isWhiteSpaceElement(e){if(!e.isTextElement())return!1;let t=e.textContent;return!s.nonOmitWhiteSpaces.some((e=>t.indexOf(e)>=0))&&""===t.replace(/\s/gm,"")}}class oi{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"word-break");return new oi(t)}isNormal(){return"normal"===this.value}isBreakAll(){return"break-all"===this.value}isKeepAll(){return"keep-all"===this.value}}class ai{constructor(e){this.value=e}static load(e){let t=Me.getValue(e,"writing-mode");return new ai(t)}isVerticalRl(){return"vertical-rl"===this.value}isVerticalLr(){return"vertical-lr"===this.value}isTextVertical(){return 0===this.value.indexOf("vertical")}isTextHorizontal(){return 0===this.value.indexOf("horizontal")}}const li={".page.break.after":{"page-break-after":"always"},".page.break.before":{"page-break-before":"always"},"hr.page.break.before":{"border-width":"0",extent:"0",margin:"0"},"hr.page.break.after":{"border-width":"0",extent:"0",margin:"0"}},ci={".list.outside":{"list-style-position":"outside"},".list.inside":{"list-style-position":"inside"}},hi={".float.start":{float:"start"},".float.end":{float:"end"},".clear.start":{clear:"start"},".clear.end":{clear:"end"},".clear.both":{clear:"both"}},di={".text.align.start":{"text-align":"start"},".text.align.center":{"text-align":"center"},".text.align.end":{"text-align":"end"}},ui={".text.orientation.mixed":{"text-orientation":"mixed"},".text.orientation.upright":{"text-orientation":"upright"},".text.orientation.sideways":{"text-orientation":"sideways"}},pi={".tcy":{"text-combine-upright":"all"}},gi={".empha.filled.dot":{"text-emphasis":"filled dot"},".empha.open.dot":{"text-emphasis":"open dot"},".empha.filled.circle":{"text-emphasis":"filled circle"},".empha.open.circle":{"text-emphasis":"open circle"},".empha.filled.triangle":{"text-emphasis":"filled triangle"},".empha.open.triangle":{"text-emphasis":"open triangle"},".empha.filled.double.circle":{"text-emphasis":"filled double-circle"},".empha.open.double.circle":{"text-emphasis":"open double-circle"},".empha.filled.sesame":{"text-emphasis":"filled sesame"},".empha.open.sesame":{"text-emphasis":"open sesame"}},mi={".dropcaps::first-letter":{display:"inline-block",measure:"1em",extent:"1em","line-height":"1",float:"start","font-size":"4em","!page-break":e=>{if(!e.parentContext)return;const t=4*e.emSize;return e.parentContext.restExtent>=t?void 0:{"page-break-before":"always"}}}};class fi{static create(e){const t={};return!0!==e.all&&!0!==e.pageBreak||Object.assign(t,li),!0!==e.all&&!0!==e.listStyle||Object.assign(t,ci),!0!==e.all&&!0!==e.logicalFloat||Object.assign(t,hi),!0!==e.all&&!0!==e.textAlign||Object.assign(t,di),!0!==e.all&&!0!==e.textOrientation||Object.assign(t,ui),!0!==e.all&&!0!==e.textCombine||Object.assign(t,pi),!0!==e.all&&!0!==e.textEmphasis||Object.assign(t,gi),!0!==e.all&&!0!==e.typography||Object.assign(t,mi),new j(t)}}class xi{constructor(e){this.createTitle=e}visitSectionRoot(e){const t=document.createElement("ul");return this.visitSectionChildren(e.children,t)}visitSectionNode(e){const t=document.createElement("li"),i=this.createTitle?this.createTitle(e):document.createTextNode(e.title);t.appendChild(i);const s=this.visitSectionChildren(e.children);return t.appendChild(s),t}visitSectionLeaf(e){const t=document.createElement("li"),i=this.createTitle?this.createTitle(e):document.createTextNode(e.title);return t.appendChild(i),t}visitSectionChildren(e,t){const i=t||document.createElement("ul");return e.forEach((e=>{e.isRoot()?i.appendChild(this.visitSectionRoot(e)):e.isNode()?i.appendChild(this.visitSectionNode(e)):i.appendChild(this.visitSectionLeaf(e))})),i}}class bi{static getAbsAncestor(e){let t=e.parent;for(;t&&"static"===t.computedStyle.getPropertyValue("position");)t=t.parent;return t||e.ownerDocument.body}static getBlockAncestor(e){let t=e.parent;for(;t;){const e=Ze.load(t);if(e.isBlockLevel()||e.isFlowRoot())return t;t=t.parent}return e.ownerDocument.body}static get(e){const t=Me.getValue(e,"position");return"body"===e.tagName?e:e.parent?"absolute"===t||"fixed"===t?this.getAbsAncestor(e):Ze.load(e).isBlockLevel()?this.getBlockAncestor(e):e.parent:e.ownerDocument.body}}function yi(e,t){const i=Me.getValue(e,t);return"none"===i?i:parseInt(i,10)}class vi{constructor(e,t){this.length=e,this.prop=t}static load(e,t){const i=function(e,t){const i=Me.getValue(e,t);return"auto"===i?i:parseInt(i,10)}(e,t);return new vi(i,t)}get number(){if("auto"===this.length)throw new Error("length is not resolved.");return this.length}set number(e){this.length=e}isAuto(){return"auto"===this.length}setAutoZero(){this.length="auto"===this.length?0:this.length}save(e){"auto"!==this.length&&e.setProperty(this.prop,this.length+"px")}}class Ei{constructor(e,t,i,s){this.before=e,this.end=t,this.after=i,this.start=s}static load(e){return new Ei(vi.load(e,"before"),vi.load(e,"end"),vi.load(e,"after"),vi.load(e,"start"))}save(e){this.before.save(e),this.end.save(e),this.after.save(e),this.start.save(e)}isAutoInline(){return this.start.isAuto()&&this.end.isAuto()}}class Si{constructor(e,t){this.minSize=e,this.prop=t}static load(e,t){return new Si(yi(e,t),t)}save(e){"none"!==this.minSize&&e.setProperty(this.prop,this.minSize+"px")}apply(e){return"none"!==this.minSize?Math.max(this.minSize,e):e}}class wi{constructor(e,t){this.maxSize=e,this.prop=t}static load(e,t){return new wi(yi(e,t),t)}save(e){"none"!==this.maxSize&&e.setProperty(this.prop,this.maxSize+"px")}apply(e){return"none"!==this.maxSize?Math.min(this.maxSize,e):e}}class Ci{constructor(e,t){this.minSize=e,this.maxSize=t}static load(e,t,i){return new Ci(Si.load(e,t),wi.load(e,i))}save(e){this.minSize.save(e),this.maxSize.save(e)}apply(e){return this.maxSize.apply(this.minSize.apply(e))}}class ki{constructor(e,t){this.minMaxMeasure=e,this.minMaxExtent=t}static load(e){return new ki(Ci.load(e,"min-measure","max-measure"),Ci.load(e,"min-extent","max-extent"))}save(e){this.minMaxMeasure.save(e),this.minMaxExtent.save(e)}apply(e,t){return new Tt({measure:this.minMaxMeasure.apply(e),extent:this.minMaxExtent.apply(t)})}}class Bi{constructor(e,t){this.measure=e,this.extent=t}static load(e){let t=vi.load(e,"measure"),i=vi.load(e,"extent");return e.parent||(t=t.isAuto()?new vi(s.defaultBodyMeasure,"measure"):t,i=i.isAuto()?new vi(s.defaultBodyExtent,"extent"):i),new Bi(t,i)}save(e){this.measure.save(e),this.extent.save(e)}}class Ri{constructor(e,t){this.width=e,this.height=t}static load(e){const t=this.loadPhysicalSize(e,"width"),i=this.loadPhysicalSize(e,"height");return new Ri(t,i)}static loadPhysicalSize(e,t){let i=e.getAttribute(t);return i?new vi(parseInt(i),t):vi.load(e,t)}save(e){this.width.save(e),this.height.save(e)}}class Li{constructor(e,t,i,s){this.before=e,this.end=t,this.after=i,this.start=s}static load(e){return new Li(vi.load(e,"margin-before"),vi.load(e,"margin-end"),vi.load(e,"margin-after"),vi.load(e,"margin-start"))}save(e){this.before.save(e),this.end.save(e),this.after.save(e),this.start.save(e)}get measure(){return this.start.number+this.end.number}get extent(){return this.before.number+this.after.number}isAutoMeasure(){return this.start.isAuto()||this.end.isAuto()}isAutoExtent(){return this.before.isAuto()||this.after.isAuto()}clearAutoInline(){this.start.setAutoZero(),this.end.setAutoZero()}clearAutoBlock(){this.before.setAutoZero(),this.after.setAutoZero()}clearInline(){this.start.number=0,this.end.number=0}clearBlock(){this.before.number=0,this.after.number=0}}class Ti{constructor(e,t,i){this.padding=e,this.border=t,this.margin=i}static load(e){return new Ti(kt.load(e),ae.load(e),Li.load(e))}save(e){this.margin.save(e)}get measure(){return this.borderBoxMeasure+this.margin.measure}get extent(){return this.borderBoxExtent+this.margin.extent}get borderBoxMeasure(){return this.border.width.measure+this.padding.measure}get borderBoxExtent(){return this.border.width.extent+this.padding.extent}}class Pi{constructor(e,t,i,s,r,n,o,a){this.boxSizing=e,this.containingMeasure=t,this.containingExtent=i,this.logicalSize=s,this.physicalSize=r,this.position=n,this.edges=o,this.minMaxBoxSize=a}static load(e){const t=bi.get(e),i=vi.load(t,"measure"),s=vi.load(t,"extent");if(!i.isAuto())return new Pi($.load(e),i.number,s,Bi.load(e),Ri.load(e),Ei.load(e),Ti.load(e),ki.load(e))}save(e){this.logicalSize.save(e),this.physicalSize.save(e),this.position.save(e),this.edges.save(e),this.minMaxBoxSize.save(e)}get borderBoxMeasure(){if("auto"===this.logicalSize.measure.length)throw new Error("measure is not resolved.");return this.boxSizing.isBorderBox()?this.logicalSize.measure.length:this.boxSizing.isPaddingBox()?this.logicalSize.measure.length+this.edges.border.width.measure:this.logicalSize.measure.length+this.edges.borderBoxMeasure}}class Ni{static select(e){const t=Ze.load(e),i=Me.getValue(e,"float"),s=Me.getValue(e,"position"),r=Ht.isReplacedElement(e);return"none"!==i?r?Ai.instance:Ii.instance:"absolute"===s?r?$i.instance:Di.instance:t.isInlineBlockFlow()?r?Ui.instance:Oi.instance:t.isInlineLevel()?r?Fi.instance:Vi.instance:t.isBlockLevel()?r?Mi.instance:zi.instance:(console.error("select resolver failed."),Vi.instance)}}class zi{constructor(){}resolve(e,t,i){if(i.isTableRow()||i.isTableRowGroup()){const t=e.parent,i=Le.load(e);if(t&&i.isCollapse())return parseInt(t.computedStyle.getPropertyValue("measure")||"0")}if("auto"===t.logicalSize.measure.length)return t.edges.margin.clearAutoInline(),void(t.logicalSize.measure.length=t.containingMeasure-t.edges.measure);const s=t.borderBoxMeasure;if(t.boxSizing.isBorderBox()?t.logicalSize.measure.length-=t.edges.borderBoxMeasure:t.boxSizing.isPaddingBox()&&(t.logicalSize.measure.length-=t.edges.padding.measure),s>t.containingMeasure&&t.edges.margin.clearInline(),t.edges.margin.isAutoMeasure()){const e=Math.floor((t.containingMeasure-t.logicalSize.measure.length)/2);t.edges.margin.start.length=t.edges.margin.end.length=e}}}zi.instance=new zi;class Mi{constructor(){}resolve(e,t,i){if("auto"!==t.logicalSize.measure.length){if("auto"===t.edges.margin.start.length&&"auto"===t.edges.margin.end.length){const e=Math.floor((t.containingMeasure-t.logicalSize.measure.length)/2);t.edges.margin.start.length=t.edges.margin.end.length=e}else if("auto"===t.edges.margin.start.length&&"auto"!==t.edges.margin.end.length){const e=t.containingMeasure-t.logicalSize.measure.length-t.edges.margin.end.length;t.edges.margin.start.length=e}else if("auto"!==t.edges.margin.start.length&&"auto"===t.edges.margin.end.length){const e=t.containingMeasure-t.logicalSize.measure.length-t.edges.margin.start.length;t.edges.margin.end.length=e}}else t.edges.margin.clearAutoInline()}}Mi.instance=new Mi;class Ii{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&(s.debugLayout&&console.info("auto measure for float element is not allowed in nehan, so use %dpx by default:",s.defaultFloatMeasure,e),t.logicalSize.measure.length=s.defaultFloatMeasure)}}Ii.instance=new Ii;class Ai{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&(s.debugLayout&&console.info("auto measure for float element is not allowed in nehan, so use %dpx by default:",s.defaultFloatMeasure,e),t.logicalSize.measure.length=s.defaultFloatMeasure)}}Ai.instance=new Ai;class Vi{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline()}}Vi.instance=new Vi;class Fi{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline()}}Fi.instance=new Fi;class Oi{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&"table-cell"!==e.computedStyle.getPropertyValue("display")&&(s.debugLayout&&console.info("auto measure for inline-block element is not allowed in nehan, so use %dpx by default:",s.defaultInlineBlockMeasure,e),t.logicalSize.measure.length=s.defaultInlineBlockMeasure)}}Oi.instance=new Oi;class Ui{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline(),t.logicalSize.measure.isAuto()&&(s.debugLayout&&console.info("auto measure for inline-block element is not allowed in nehan, so use %dpx by default:",s.defaultInlineBlockMeasure,e),t.logicalSize.measure.length=s.defaultInlineBlockMeasure)}}Ui.instance=new Ui;class Di{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline()}}Di.instance=new Di;class $i{constructor(){}resolve(e,t,i){t.edges.margin.clearAutoInline()}}function Wi(e){if(e.isTextElement())return!1;if(!yt.load(e).isNone())return!1;const t=Ft.load(e);return!t.isAbsolute()&&!t.isFixed()}function Hi(e){let t=e.firstChild;for(;t&&t.isTextElement()&&ni.isWhiteSpaceElement(t);)t=t.nextSibling;return t}function _i(e){let t=e.lastChild;for(;t&&t.isTextElement()&&ni.isWhiteSpaceElement(t);)t=t.previousSibling;return t}$i.instance=new $i;class Gi{static getMarginFromParentBlock(e){return parseInt(e.computedStyle.getPropertyValue("margin-start")||"0")}static getMarginFromLastInline(e){const t=e.previousSibling,i=parseInt(e.computedStyle.getPropertyValue("margin-start")||"0");return!t||t.isTextElement()?i:parseInt(t.computedStyle.getPropertyValue("margin-end")||"0")+i}}class qi{static getLastChildren(e){let t=_i(e),i=[];for(;t&&Wi(t)&&"0px"===t.computedStyle.getPropertyValue("border-after-width");)i.push(t),t=_i(t);return i}static getFirstChildren(e){let t=Hi(e),i=[];for(;t&&Wi(t)&&"0px"===t.computedStyle.getPropertyValue("border-before-width");)i.push(t),t=Hi(t);return i}static getMaxMarginBefore(e){const t=this.getFirstChildren(e).concat(e);return Math.max(0,...t.map((e=>parseInt(e.computedStyle.getPropertyValue("margin-before")||"0"))))}static getMaxMarginAfter(e){const t=this.getLastChildren(e).concat(e);return Math.max(0,...t.map((e=>parseInt(e.computedStyle.getPropertyValue("margin-after")||"0"))))}static getFlowMarginFromLastElement(e,t,i){const s=t.context.env;if(s.position.isAbsolute())return 0;const r=i?i.context.env:void 0;if(!s.float.isNone()){if(!r)return parseInt(s.element.computedStyle.getPropertyValue("margin-before")||"0");if(!r.float.isNone())return 0;if(r.position.isAbsolute())return 0;if(i instanceof qs||r.display.isInlineLevel())return 0;if(r.display.isBlockLevel()){const e=parseInt(s.element.computedStyle.getPropertyValue("margin-before")||"0");return this.getMaxMarginAfter(r.element)+e}}if(t instanceof qs||s.display.isInlineLevel()){if(!r)return 0;if(!r.float.isNone())return 0;if(r.position.isAbsolute())return 0;if(i instanceof qs||r.display.isInlineLevel())return 0;if(r.display.isBlockLevel())return this.getMaxMarginAfter(r.element)}if(s.display.isBlockLevel()){if(s.edge.border.width.before>0){if(r){const e=this.getMaxMarginAfter(r.element);return Math.max(s.edge.margin.before,e)}return s.edge.margin.before}const t=!e.display.isFlowRoot()&&e.display.isBlockLevel()&&!e.position.isAbsolute()&&e.float.isNone();if(!r&&t)return 0;const n=this.getMaxMarginBefore(s.element);if(!r)return n;if(i instanceof qs||r.display.isInlineLevel())return n;if(!r.float.isNone())return n;if(r.position.isAbsolute())return n;if(r.display.isBlockLevel()){const e=this.getMaxMarginAfter(r.element);return Math.max(n,e)}}return 0}}class ji{constructor(){this.state={before:!1,end:!1,after:!1,start:!1}}mask(e){Y.forEach((t=>{e[t]=this.state[t]?e[t]:0}))}clear(){this.state.before=!1,this.state.end=!1,this.state.after=!1,this.state.start=!1}clearBlock(){this.state.before=!1,this.state.after=!1}addEdge(e){this.state[e]=!0}isEnable(e){return this.state[e]}}class Ki{constructor(e,t=new ji){this.edgeSize=e,this.edgeState=t}mask(e){this.edgeState.mask(e)}clear(){this.edgeState.clear()}clearBlock(){this.edgeState.clearBlock()}addEdge(e){this.edgeState.addEdge(e)}getSize(e){return this.edgeState.isEnable(e)?this.edgeSize[e]:0}get measure(){return this.getSize("start")+this.getSize("end")}get extent(){return this.getSize("before")+this.getSize("after")}}class Yi{constructor(e){this.envEdge=e,this.padding=new Ki(e.padding),this.margin=new Ki(e.margin),this.borderWidth=new Ki(e.border.width)}clear(){this.padding.clear(),this.margin.clear(),this.borderWidth.clear()}clearBlock(){this.padding.clearBlock(),this.margin.clearBlock(),this.borderWidth.clearBlock()}get currentBorder(){const e=this.envEdge.border.clone();return this.borderWidth.mask(e.width),e}get currentPadding(){const e=this.envEdge.padding.clone();return this.padding.mask(e),e}get currentMargin(){const e=this.envEdge.margin.clone();return this.margin.mask(e),e}get currentBorderBoxEdge(){const e=this.currentBorder,t=this.currentPadding,i=Ct.none;return new le({padding:t,border:e,margin:i})}get currentMarginBoxEdge(){const e=this.currentBorder,t=this.currentPadding,i=this.currentMargin;return new le({padding:t,border:e,margin:i})}getBorderBoxEdgeSize(e){return this.borderWidth.getSize(e)+this.padding.getSize(e)}getMarginBoxEdgeSize(e){return this.borderWidth.getSize(e)+this.padding.getSize(e)+this.margin.getSize(e)}get borderBoxAfterSize(){return this.borderWidth.getSize("after")+this.padding.getSize("after")}get borderBoxStartSize(){return this.borderWidth.getSize("start")+this.padding.getSize("start")}get borderBoxBeforeSize(){return this.borderWidth.getSize("before")+this.padding.getSize("before")}get borderBoxMeasure(){return this.borderWidth.measure+this.padding.measure}get borderBoxExtent(){return this.borderWidth.extent+this.padding.extent}}class Zi{constructor(e,t){this.flowRootRegion=new Lt(bt.zero,e),this.cursorBefore=t,this.startRects=[],this.endRects=[],this.startLedgePositions=new Set,this.endLedgePositions=new Set}toString(){return`FloatRegion(${this.flowRootRegion.toString()})`}isEmpty(){return 0===this.startRects.length&&0===this.endRects.length}get maxRegionExtent(){return Math.max(this.maxStartRegionExtent,this.maxEndRegionExtent)}pushStart(e,t,i){if(!1===this.flowRootRegion.canContain(t))throw new Error("FloatRegion:too large size");this.cursorBefore=Math.max(this.cursorBefore,e);const s=this.getSpaceMeasureAt(this.cursorBefore,i);if(0===this.startRects.length&&0===this.endRects.length&&t.measure>s)throw new Error("FloatRegion:too large size");if(t.measure<s){const e=this.getStartSideRect(this.cursorBefore),i=e?e.end:0,s=this.cursorBefore,r=new bt({start:i,before:s});return this.pushStartRect(new Lt(r,t))}const r=this.getSkipExtentAt(this.cursorBefore);if(this.cursorBefore+=r,this.cursorBefore+t.extent>=this.flowRootRegion.extent)throw new Error("FloatRegion:no more space left.");return this.pushStart(this.cursorBefore,t)}pushEnd(e,t,i){if(!1===this.flowRootRegion.canContain(t))throw new Error("FloatRegion:too large size");this.cursorBefore=Math.max(this.cursorBefore,e);const s=this.getSpaceMeasureAt(this.cursorBefore,i);if(0===this.startRects.length&&0===this.endRects.length&&t.measure>s)throw new Error("FloatRegion:too large size");if(t.measure<s){const e=this.getEndSideRect(this.cursorBefore),s=this.getMaxMeasure(i),r=e?e.start-t.measure:s-t.measure,n=new bt({start:r,before:this.cursorBefore});return this.pushEndRect(new Lt(n,t))}const r=this.getSkipExtentAt(this.cursorBefore);if(this.cursorBefore+=r,this.cursorBefore+t.extent>=this.flowRootRegion.extent)throw new Error("FloatRegion:no more space left.");return this.pushEnd(this.cursorBefore,t)}clearBoth(){const e=Math.max(this.maxStartRegionExtent,this.maxEndRegionExtent);return this.startRects=[],this.endRects=[],this.startLedgePositions.clear(),this.endLedgePositions.clear(),this.cursorBefore=e,e}clearStart(){const e=this.maxStartRegionExtent;return this.startRects=[],this.startLedgePositions.clear(),this.cursorBefore=e,e}clearEnd(){const e=this.maxEndRegionExtent;return this.endRects=[],this.endLedgePositions.clear(),this.cursorBefore=e,e}getSpacePosFromStartBound(e){let t=this.getStartSideRect(e);return t?t.end:0}getSpaceMeasureAt(e,t){return this.getMaxMeasure(t)-this.getSideRectMeasureAt(e)}hasSpaceForSize(e,t,i){if(this.getSpaceMeasureAt(e,i)<t.measure)return!1;const s=new bt({start:this.getSpacePosFromStartBound(e),before:e}),r=new Lt(s,t);return this.allRects.filter((t=>t.after>e)).every((e=>!r.collideWith(e)))}findSpace(e,t,i){if(this.hasSpaceForSize(e,t)){const t=this.getSpacePosFromStartBound(e);return new bt({before:e,start:t})}const s=this.ledgePositions.filter((t=>t>e)).find((e=>this.hasSpaceForSize(e,t,i)));if(void 0===s)return;const r=this.getSpacePosFromStartBound(s);return new bt({before:s,start:r})}getSideRectMeasureAt(e){return this.getStartSideRectMeasure(e)+this.getEndSideRectMeasure(e)}getMaxMeasure(e){return Math.min(this.flowRootRegion.measure,e||1/0)}getSkipExtentAt(e){if(0===this.startRects.length&&0===this.endRects.length)return 0;const t=this.startRects[this.startRects.length-1],i=this.endRects[this.endRects.length-1];return t?i?t.after<i.after?t.extent:i.extent:t.extent:i.extent}get ledgePositions(){const e=new Set;this.startLedgePositions.forEach((t=>e.add(t))),this.endLedgePositions.forEach((t=>e.add(t)));const t=[];return e.forEach((e=>t.push(e))),t.sort()}addLedgePos(e,t,i){t?t.before===i.before?(i.extent>t.extent&&e.delete(t.after),e.add(i.after)):(t.measure===i.measure&&e.delete(t.after),e.add(i.after)):(e.add(0),e.add(i.after))}pushStartRect(e){const t=this.startRects[this.startRects.length-1];return this.addLedgePos(this.startLedgePositions,t,e),this.startRects.push(e),e}pushEndRect(e){const t=this.endRects[this.endRects.length-1];return this.addLedgePos(this.endLedgePositions,t,e),this.endRects.push(e),e}get allRects(){return this.startRects.concat(this.endRects)}get maxStartRegionExtent(){return this.getMaxSideCursorBeforeFrom(this.startRects)}get maxEndRegionExtent(){return this.getMaxSideCursorBeforeFrom(this.endRects)}getStartSideRect(e){return this.getSideRect(this.startRects,e)}getEndSideRect(e){return this.getSideRect(this.endRects,e)}getStartSideRectMeasure(e){let t=this.getStartSideRect(e);return t?t.end:0}getEndSideRectMeasure(e){let t=this.getEndSideRect(e);return t?this.flowRootRegion.measure-t.start:0}getMaxSideCursorBeforeFrom(e){return e.reduce(((e,t)=>Math.max(e,t.after)),this.cursorBefore)}getSideRect(e,t){for(let i=e.length-1;i>=0;i--){let s=e[i];if(s.before<=t&&t<s.after)return s}return null}}class Xi{constructor(e){this.writingMode=e}visitUnmanagedCssProps(e){const t=new zt;return s.unmanagedCssProps.forEach((i=>{const s=e.getPropertyValue(i);null!==s&&t.set(i,s)})),t}visitFont(e){const t=new zt;return t.set("font-style",e.style),t.set("font-variant",e.variant),t.set("font-weight",e.weight),t.set("font-stretch",e.stretch),t.set("font-size",e.size+"px"),t.set("font-family",e.family),t}visitColor(e){const t=new zt;return t.set("color",e.value),t}visitSizeHori(e){const t=new zt;return t.set("width",e.measure+"px"),t.set("height",e.extent+"px"),t}visitSizeVert(e){const t=new zt;return t.set("width",e.extent+"px"),t.set("height",e.measure+"px"),t}visitSize(e){return this.writingMode.isTextHorizontal()?this.visitSizeHori(e):this.visitSizeVert(e)}visitPosHori(e){const t=new zt;return t.set("top",e.before+"px"),t.set("left",e.start+"px"),t}visitPosVertLtr(e){const t=new zt;return t.set("top",e.start+"px"),t.set("left",e.before+"px"),t}visitPosVertRtl(e){const t=new zt;return t.set("top",e.start+"px"),t.set("right",e.before+"px"),t}visitPos(e){return this.writingMode.isTextHorizontal()?this.visitPosHori(e):this.writingMode.isVerticalRl()?this.visitPosVertRtl(e):this.visitPosVertLtr(e)}visitBackgroundPos(e){const t=new zt;let i=e.value;return St.select(this.writingMode).forEach(((e,t)=>{i=i.replace(e,t)})),t.set("background-position",i),t}visitLogicalMargin(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,i)=>t.set(e.getPropByLogicalDirection(i.prop),i.value+"px")),new zt)}visitLogicalPadding(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,i)=>t.set(e.getPropByLogicalDirection(i.prop),i.value+"px")),new zt)}visitLogicalBorderColor(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,i)=>t.set(e.getPropByLogicalDirection(i.prop),String(i.value))),new zt)}visitLogicalBorderWidth(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,i)=>t.set(e.getPropByLogicalDirection(i.prop),i.value+"px")),new zt)}visitLogicalBorderStyle(e){return e.getPhysicalEdge(this.writingMode).items.reduce(((t,i)=>t.set(e.getPropByLogicalDirection(i.prop),String(i.value))),new zt)}visitLogicalBorderRadius(e,t){const i=wt.select(this.writingMode);return e.items.reduce(((e,s)=>s.prop.indexOf("before")>=0&&t.before<=0||s.prop.indexOf("after")>=0&&t.after<=0?e:e.set(`border-${i.get(s.prop)}-radius`,String(s.value))),new zt)}visitLogicalPos(e){const t=new zt,i=St.select(this.writingMode);return void 0!==e.before&&t.set(i.get("before"),e.before+"px"),void 0!==e.end&&t.set(i.get("end"),e.end+"px"),void 0!==e.after&&t.set(i.get("after"),e.after+"px"),void 0!==e.start&&t.set(i.get("start"),e.start+"px"),t}}class Ji{constructor(){}getJustifyTargetChars(e){return e.reduce(((e,t)=>t instanceof is?e.concat(t.children):t instanceof ns?e.concat(this.getJustifyTargetChars(t.children)):e),[])}justify(e){const t=e.env.font.size/4,i=e.env.font.size,r=e.size.measure-e.autoSize.measure;if(r<t||r>i)return;const n=this.getJustifyTargetChars(e.children);if(n.length<=1)return;const o=r/(n.length-1);o>=s.maxJustifyGap||n.forEach((e=>e.spacing=o))}}Ji.instance=new Ji;class Qi{constructor(e,t,i){this.pageRoot=e,this.cssVisitor=t,this.textJustifier=i}visitChar(e){return document.createTextNode(e.text)}visitCharEmpha(e,t){const i=document.createElement("div"),s=document.createElement("div"),r=document.createElement("div");return s.appendChild(document.createTextNode(t.text)),r.appendChild(document.createTextNode(e.text)),t.scale<1&&(s.style.fontSize=String(t.scale)+"em",s.style.paddingBottom=String(t.scale/2)+"em"),i.style.display="inline-block",i.style.textAlign="center",i.appendChild(s),i.appendChild(r),i}visitRefChar(e){return document.createTextNode(e.text)}visitRefCharEmpha(e,t){return this.visitCharEmpha(e,t)}visitSpaceChar(e){const t=document.createElement("span");return t.style.display="inline-block",t.style.width=e.size.measure+"px",t.appendChild(document.createTextNode(e.text)),t}visitHalfChar(e){return document.createTextNode(e.text)}visitMixChar(e){const t=document.createElement("span");return t.style.display="inline-block",t.style.width="1.25em",t.appendChild(document.createTextNode(e.text)),t}visitDualChar(e){return document.createTextNode(e.text)}visitDualCharKern(e){const t=document.createElement("span");return t.style.marginLeft="-0.5em",t.appendChild(document.createTextNode(e.text)),t}visitSmpUniChar(e){return document.createTextNode(e.text)}visitTcy(e){return document.createTextNode(e.text)}visitWord(e){return document.createTextNode(e.text)}visitText(e){const t=document.createElement("div");return t.className="nehan-text",t.style.display="inline-block",t.style.lineHeight="1",e.children.forEach((e=>{const i=e.acceptEvaluator(this);if(e.spacing){const s=document.createElement("span");s.style.paddingRight=e.spacing+"px",s.appendChild(i),t.appendChild(s)}else t.appendChild(i)})),t.normalize(),t}visitRuby(e){const t=document.createElement("div");t.className="nehan-ruby";const i=document.createElement("div").appendChild(e.rb.acceptEvaluator(this)),s=document.createElement("div").appendChild(e.rt.acceptEvaluator(this));return i.style.display="block",s.style.display="block",s.style.lineHeight="1",t.appendChild(s),t.appendChild(i),t.style.display="inline-block",t.style.textAlign="center",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitLine(e){const t=document.createElement("div");t.className="nehan-line",t.style.boxSizing="content-box",t.style.position="absolute",t.style.overflow="visible",t.style.top=e.linePos.before+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style);const i=document.createElement("div");return i.className="nehan-baseline",i.style.position="absolute",i.style.left=e.linePos.start+e.baseline.startOffset+"px",i.style.width=e.size.measure+2*e.env.font.size+"px",i.style.height=e.baseline.size.extent+"px",i.style.bottom=e.baseline.blockOffset+"px",e.env.textAlign.isJustify()&&this.textJustifier.justify(e),t.appendChild(i),e.children.forEach((e=>{i.appendChild(e.acceptEvaluator(this))})),t}visitInline(e){const t=this.pageRoot.createElement("span",["inline"],e);return t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineEmpha(e){const t=this.pageRoot.createElement("span",["inline","empha"],e);return t.style.display="inline-block",t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineBlock(e){const t=this.pageRoot.createElement("span",["iblock"],e);return t.style.display="inline-block",t.style.boxSizing="content-box",t.style.position="relative",t.style.paddingLeft=e.env.edge.padding.start+"px",t.style.paddingRight=e.env.edge.padding.end+"px",t.style.marginLeft=e.env.edge.margin.start+"px",t.style.marginRight=e.env.edge.margin.end+"px",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlock(e){const t=this.pageRoot.createElement("div",["block"],e);return t.style.boxSizing="content-box",t.style.position=e.env.element.tagName===s.pageRootTagName?"relative":"absolute",t.style.paddingLeft=e.env.edge.padding.start+"px",t.style.paddingRight=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitRootBlock(e){const t=this.pageRoot.createElement("div",["root"],e),i=le.loadBoxEdge(e.env.element);return t.className="nehan-root",t.style.width=e.measure+i.measure+"px",t.style.height=e.extent+i.extent+"px",i.margin.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),i.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),i.padding.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitTableCells(e){const t=this.pageRoot.createElement("div",["table-cells"],e);return t.style.boxSizing="content-box",t.style.position="absolute",e.rowPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockImage(e){const t=this.pageRoot.createElement("img",["block"],e);return t.style.position="absolute",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineImage(e){const t=this.pageRoot.createElement("img",["inline"],e);return t.style.display="inline",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",t.style.verticalAlign="bottom",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitBlockVideo(e){const t=e.env.element.$node.cloneNode(!0);return t.setAttribute("width",String(e.physicalSize.width)),t.setAttribute("height",String(e.physicalSize.height)),t.removeAttribute("style"),t.style.position="absolute",t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",t.style.verticalAlign="bottom",e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineVideo(e){const t=this.pageRoot.createElement("span",["inline"],e);return t.style.display="none",t.style.width="0",t.style.height="0",t.innerHTML="Sorry, inline video is not supported yet!",t}visitBlockReFixed(e,t){const i=this.pageRoot.createElement("div",["block"],e);return i.style.position="absolute",i.style.width=e.physicalSize.width+"px",i.style.height=e.physicalSize.height+"px",i.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(i.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),i}visitInlineReFixed(e,t){const i=this.pageRoot.createElement("div",["inline"],e);return i.style.display="inline-block",i.style.width=e.physicalSize.width+"px",i.style.height=e.physicalSize.height+"px",i.style.marginLeft=e.edge.margin.start+"px",i.style.marginRight=e.edge.margin.end+"px",i.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),i}visitInlineLink(e){const t=this.pageRoot.createElement("a",["inline"],e);return t.style.marginLeft=e.edge.margin.start+"px",t.style.marginRight=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockLink(e){const t=this.pageRoot.createElement("a",["block"],e);return t.style.boxSizing="content-box",t.style.position="absolute",t.style.paddingLeft=e.env.edge.padding.start+"px",t.style.paddingRight=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{const i=e.acceptEvaluator(this);t.appendChild(i)})),t}}class es{constructor(e,t,i){this.pageRoot=e,this.cssVisitor=t,this.textJustifier=i}isReOrIblock(e){return e instanceof hs||e instanceof as||e instanceof ns&&e.children.some((e=>this.isReOrIblock(e)))}visitChar(e){return document.createTextNode(e.text)}visitCharEmpha(e,t){const i=document.createElement("div"),s=document.createElement("div"),r=document.createElement("div");return r.appendChild(document.createTextNode(e.text)),s.appendChild(document.createTextNode(t.text)),t.scale<1&&(s.style.fontSize=String(t.scale)+"em",s.style.paddingLeft=String(t.scale/2)+"em"),i.style.textAlign="center",i.style.display="flex",i.style.alignItems="center",i.appendChild(r),i.appendChild(s),i}visitRefChar(e){return document.createTextNode(e.text)}visitRefCharEmpha(e,t){return this.visitCharEmpha(e,t)}visitSpaceChar(e){const t=document.createElement("div");return t.style.height=e.size.measure+"px",t}visitHalfChar(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e.text)),t.style.textAlign="center",t.style.width="1em",t}visitMixChar(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e.text)),t}visitDualChar(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.appendChild(document.createTextNode(e.text)),t}visitDualCharKern(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.style.marginTop="-0.5em",t.appendChild(document.createTextNode(e.text)),t}visitSmpUniChar(e){return document.createTextNode(e.text)}visitTcy(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.style.textCombineUpright="all",t.style.setProperty("-webkit-text-combine","horizontal"),t.appendChild(document.createTextNode(e.text)),t}visitWord(e){const t=document.createElement("div");return t.style.writingMode="vertical-rl",t.style.textOrientation="sideways",t.appendChild(document.createTextNode(e.text)),t}visitText(e){const t=document.createElement("div");return t.className="nehan-text",t.style.lineHeight="1",e.children.forEach((e=>{const i=e.acceptEvaluator(this);if(t.appendChild(i),i instanceof Text&&t.appendChild(document.createElement("br")),e.spacing){const i=document.createElement("div");i.style.height=e.spacing+"px",i.appendChild(document.createTextNode(" ")),t.appendChild(i)}})),t.normalize(),t}visitRuby(e){const t=document.createElement("div");t.className="nehan-ruby";const i=document.createElement("div").appendChild(e.rb.acceptEvaluator(this)),s=document.createElement("div").appendChild(e.rt.acceptEvaluator(this));return t.appendChild(i),t.appendChild(s),t.style.display="flex",t.style.textAlign="center",t.style.alignItems="center",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitLine(e){const t=e.env.writingMode.isVerticalLr()?"left":"right",i=document.createElement("div");i.className="nehan-line",i.style.boxSizing="content-box",i.style.position="absolute",i.style.overflow="visible",i.style[t]=e.linePos.before+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(i.style);const s=document.createElement("div");return s.className="nehan-baseline",s.style.position="absolute",s.style.top=e.linePos.start+e.baseline.startOffset+"px",s.style.height="100%",s.style.width=e.baseline.size.extent+"px",s.style.left=e.baseline.blockOffset+"px",i.appendChild(s),e.env.textAlign.isJustify()&&this.textJustifier.justify(e),e.children.forEach((t=>{const i=t.acceptEvaluator(this),r=this.isReOrIblock(t)?t.extent:t.env.font.size,n=Math.floor((e.baseline.textBodySize.extent-r)/2);if(0===n)s.appendChild(i);else{const e=document.createElement("div");e.style.marginLeft=Math.max(0,n)+"px",e.appendChild(i),s.appendChild(e)}})),i}visitInline(e){const t=this.pageRoot.createElement("div",["inline"],e);return t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineEmpha(e){const t=this.pageRoot.createElement("div",["inline","empha"],e);return t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitInlineBlock(e){const t=this.pageRoot.createElement("div",["iblock"],e);return t.style.boxSizing="content-box",t.style.position="relative",t.style.paddingTop=e.env.edge.padding.start+"px",t.style.paddingBottom=e.env.edge.padding.end+"px",t.style.marginTop=e.env.edge.margin.start+"px",t.style.marginBottom=e.env.edge.margin.end+"px",e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlock(e){const t=this.pageRoot.createElement("div",["block"],e);return t.style.boxSizing="content-box",t.style.position=e.env.element.tagName===s.pageRootTagName?"relative":"absolute",t.style.paddingTop=e.env.edge.padding.start+"px",t.style.paddingBottom=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitRootBlock(e){const t=this.pageRoot.createElement("div",["root"],e),i=le.loadBoxEdge(e.env.element);return t.style.width=e.extent+i.extent+"px",t.style.height=e.measure+i.measure+"px",i.margin.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),i.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),i.padding.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitTableCells(e){const t=this.pageRoot.createElement("div",["table-cells"],e);return t.style.boxSizing="content-box",t.style.position="absolute",e.rowPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockImage(e){const t=this.pageRoot.createElement("img",["block"],e);return t.style.position="absolute",t.style.display="block",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineImage(e){const t=this.pageRoot.createElement("img",["inline"],e);return t.style.display="block",t.style.width=e.physicalSize.width+"px",t.style.height=e.physicalSize.height+"px",t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",t.setAttribute("src",e.env.element.getAttribute("src")||""),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitBlockVideo(e){const t=e.env.element.$node.cloneNode(!0);return t.setAttribute("width",String(e.physicalSize.width)),t.setAttribute("height",String(e.physicalSize.height)),t.removeAttribute("style"),t.style.position="absolute",t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),t}visitInlineVideo(e){const t=this.pageRoot.createElement("div",["inline"],e);return t.style.display="none",t.style.width="0",t.style.height="0",t.innerHTML="Sorry, inline video is not supported yet!",t}visitBlockReFixed(e,t){const i=this.pageRoot.createElement("div",["block"],e);return i.style.position="absolute",i.style.width=e.physicalSize.width+"px",i.style.height=e.physicalSize.height+"px",i.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(i.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),i}visitInlineReFixed(e,t){const i=this.pageRoot.createElement("div",["inline"],e);return i.style.display="block",i.style.width=e.physicalSize.width+"px",i.style.height=e.physicalSize.height+"px",i.style.marginLeft=e.edge.margin.start+"px",i.style.marginRight=e.edge.margin.end+"px",i.appendChild(t),e.edge.border.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(i.style),i}visitInlineLink(e){const t=this.pageRoot.createElement("a",["inline"],e);return t.style.textDecoration="none",t.style.marginTop=e.edge.margin.start+"px",t.style.marginBottom=e.edge.margin.end+"px",e.env.font.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.color.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{t.appendChild(e.acceptEvaluator(this))})),t}visitBlockLink(e){const t=this.pageRoot.createElement("a",["block"],e);return t.style.boxSizing="content-box",t.style.position="absolute",t.style.paddingTop=e.env.edge.padding.start+"px",t.style.paddingBottom=e.env.edge.padding.end+"px",e.env.position.isAbsolute()?e.env.absPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style):e.layoutPos.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.size.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.border.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.env.element.style.acceptCssEvaluator(this.cssVisitor).applyTo(t.style),e.children.forEach((e=>{const i=e.acceptEvaluator(this);t.appendChild(i)})),t}}class ts{constructor(e){this.pageRoot=e}visitNode(e){e.dom&&e.env.element.style.hasDomCallbacks()&&e.env.element.style.callDomCallbacks(e,e.dom,this.pageRoot)}visitTree(e){this.visitNode(e),this.visitChildren(e.children)}visitChildren(e){e.forEach((e=>e.acceptEffector(this)))}visitLine(e){this.visitChildren(e.children)}visitRuby(e){this.visitNode(e),this.visitNode(e.rt),this.visitNode(e.rb)}visitInline(e){this.visitTree(e)}visitBlock(e){this.visitTree(e)}visitInlineBlock(e){this.visitTree(e)}visitTableCells(e){e.children.forEach((e=>e.acceptEffector(this)))}visitBlockImage(e){this.visitNode(e)}visitInlineImage(e){this.visitNode(e)}visitBlockVideo(e){this.visitNode(e)}visitInlineVideo(e){this.visitNode(e)}}class is{constructor(e,t,i,s,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=i,this.text=s,this.skipBr=r,this.children=n,this.progress=o,this.dom=a}get measure(){return this.size.measure}get extent(){return this.size.extent}acceptEvaluator(e){return e.visitText(this)}acceptEffector(e){}}class ss{constructor(e,t,i,s,r,n,o,a,l=1,c){this.env=e,this.boxPos=t,this.linePos=i,this.size=s,this.autoSize=r,this.text=n,this.children=o,this.baseline=a,this.progress=l,this.dom=c,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure}get extent(){return this.size.extent}acceptEvaluator(e){return e.visitLine(this)}acceptEffector(e){e.visitLine(this)}}class rs{constructor(e,t,i,s,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=i,this.text=s,this.rb=r,this.rt=n,this.progress=o,this.dom=a}get measure(){return this.size.measure}get extent(){return this.size.extent}get lineExtent(){const e=this.env.font.lineHeight;return e.indexOf("px")<0?Math.floor(this.rb.env.font.size*parseFloat(e)):parseInt(e)}acceptEvaluator(e){return e.visitRuby(this)}acceptEffector(e){e.visitRuby(this)}}class ns{constructor(e,t,i,s,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=i,this.text=s,this.edge=r,this.children=n,this.progress=o,this.dom=a,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure+this.edge.measure}get extent(){return this.size.extent+this.edge.extent}acceptEvaluator(e){return this.env.textEmphasis.isNone()?"a"===this.env.element.tagName?e.visitInlineLink(this):e.visitInline(this):e.visitInlineEmpha(this)}acceptEffector(e){e.visitInline(this)}}class os{constructor(e,t,i,s,r,n,o,a,l,c){this.env=e,this.boxPos=t,this.layoutPos=i,this.size=s,this.autoSize=r,this.text=n,this.border=o,this.children=a,this.progress=l,this.dom=c,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure+this.env.edge.measure}get extent(){return this.size.extent+this.border.width.extent}acceptEvaluator(e){switch(this.env.element.tagName){case"a":return e.visitBlockLink(this);case s.pageRootTagName:const t=e.visitRootBlock(this);return t.appendChild(e.visitBlock(this)),t}return e.visitBlock(this)}acceptEffector(e){e.visitBlock(this)}}class as{constructor(e,t,i,s,r,n,o,a,l=1,c){this.env=e,this.boxPos=t,this.layoutPos=i,this.size=s,this.autoSize=r,this.text=n,this.edge=o,this.children=a,this.progress=l,this.dom=c,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure+this.edge.measure}get extent(){return this.size.extent+this.edge.extent}acceptEvaluator(e){return e.visitInlineBlock(this)}acceptEffector(e){e.visitInlineBlock(this)}}class ls{constructor(e,t,i,s,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=i,this.rowPos=s,this.text=r,this.children=n,this.progress=o,this.dom=a,this.children.forEach((e=>e.parent=this))}get measure(){return this.size.measure}get extent(){return this.size.extent}acceptEvaluator(e){return e.visitTableCells(this)}acceptEffector(e){e.visitTableCells(this)}}class cs{constructor(e,t,i,s,r,n,o,a=1,l){this.env=e,this.boxPos=t,this.size=i,this.physicalSize=s,this.edge=r,this.layoutPos=n,this.text=o,this.progress=a,this.dom=l}get measure(){return this.size.measure+this.edge.borderBoxMeasure}get extent(){return this.size.extent+this.env.edge.borderBoxExtent}acceptEvaluator(e){if(this.env.element.$dom)return e.visitBlockReFixed(this,this.env.element.$dom);switch(this.env.element.tagName){case"img":return e.visitBlockImage(this);case"video":return e.visitBlockVideo(this)}throw console.error("unsupported replaced element:",this),new Error("unsupported replaced element")}acceptEffector(e){switch(this.env.element.tagName){case"img":e.visitBlockImage(this);break;case"video":e.visitBlockVideo(this)}}}class hs{constructor(e,t,i,s,r,n,o=1,a){this.env=e,this.boxPos=t,this.size=i,this.physicalSize=s,this.edge=r,this.text=n,this.progress=o,this.dom=a}get measure(){return this.size.measure+this.edge.measure}get extent(){return this.size.extent+this.edge.extent}acceptEvaluator(e){if(this.env.element.$dom)return e.visitInlineReFixed(this,this.env.element.$dom);switch(this.env.element.tagName){case"img":return e.visitInlineImage(this);case"video":return e.visitInlineVideo(this)}throw console.error("unsupported replaced element:",this),new Error("unsupported replaced element")}acceptEffector(e){switch(this.env.element.tagName){case"img":e.visitInlineImage(this);break;case"video":e.visitInlineVideo(this)}}}class ds{constructor(e,t){this.type=e,this.body=t}static skip(e,t=""){return s.debugLayout&&console.log("created skip(%s):",t,e),new ds("skip",e)}static lineBreak(e,t=""){return s.debugLayout&&console.log("created line-break(%s):",t,e),new ds("line-break",e)}static iblockInlineBreak(e,t=""){return s.debugLayout&&console.log("created iblock-inline-break(%s):",t,e),new ds("iblock-inline-break",e)}static pageBreak(e,t=""){return s.debugLayout&&console.log("created page break(%s):",t,e),new ds("page-break",e)}static logicalNode(e,t){return new ds(e,t)}isFloatable(){switch(this.type){case"block":case"inline-block":case"re-block":return!0}return!1}isBlockLevel(){switch(this.type){case"block":case"block-link":case"re-block":case"table":case"table-cells":case"table-row-group":case"table-row":return!0}return!1}getBodyAsBlockNode(){if(this.body&&this.body instanceof os)return this.body;throw console.log("Type error: body is not LogicalBlockNode. %o",this),new Error("Type error: body is not LogicalBlockNode")}}class us{constructor(e,t){this.env=e,this.parent=t,this.name=s.useStrictFormatContextName?e.element.toString(!0):e.element.getNodeName(),this.cursorPos=bt.zero,this.contextBoxEdge=new Yi(e.edge),this.suspendedGens=[],this.curChildStartMargin=0,this.blockNodes=[],this.inlineNodes=[],this.blockNodeHistory=[],this.inlineText="",this.text="",this.progress=0}get inlineRoot(){let e=this;for(;e;){if(e.env.display.isBlockLevel()||e.env.display.isFlowRoot())return e;e=e.parent}throw new Error("inline root not found!")}get pageRoot(){let e=this;for(;e;){if(e instanceof gs)return e;e=e.parent}throw new Error(`[${this.env.element.tagName}] root context not found!`)}get flowRoot(){let e=this;for(;e;){if(e.env.display.isFlowRoot()||e instanceof gs)return e;e=e.parent}throw new Error(`[${this.env.element.tagName}] flow root context not found!`)}get parentBlock(){let e=this.parent;for(;e;){if(e.env.display.isBlockLevel()||e.env.display.isFlowRoot())return e;e=e.parent}}acceptLayoutReducer(e,...t){return e.visit(this,...t)}get restExtent(){const e=this.parentBlock;return e?e.restExtent-this.cursorPos.before:this.maxExtent-this.cursorPos.before}get lastBlockNode(){return this.blockNodeHistory[this.blockNodeHistory.length-1]||void 0}get totalLineCount(){return this.blockNodeHistory.filter((e=>e instanceof ss)).length}get localLineCount(){return this.blockNodes.filter((e=>e instanceof ss)).length}get listMarkerOffset(){return this.listMarker?this.env.listStyle.isPositionInside()?0:this.totalLineCount>0?this.listMarker.measure:0:0}get floatStartOffset(){if(!this.flowRoot.floatRegion)return 0;const e=this.contextBoxEdge.borderWidth.getSize("start"),t=this.flowRoot.floatRegion.getSpacePosFromStartBound(this.flowRootPos.before);return e>t?e:t-e}get textAlignOffset(){return this.env.textAlign.isEnd()?this.maxMeasure-this.textStartPos:this.env.textAlign.isCenter()?Math.floor((this.maxMeasure-this.textStartPos)/2):0}get textStartPos(){let e=this.cursorPos.start;return e+=this.listMarkerOffset,e}get parentInlineEdgeSize(){let e=this.parent,t=0;for(;e&&(t+=e.env.edge.measure,e!==this.flowRoot);)e=e.parent;return t}get contextRestMeasure(){if(this.flowRoot.floatRegion){const e=this.contextBoxEdge.borderBoxMeasure+this.parentInlineEdgeSize,t=this.flowRoot.floatRegion.getSpaceMeasureAt(this.flowRootPos.before)-e;return Math.min(t,this.maxMeasure)-this.textStartPos}return this.restMeasure}get lineBoxStartOffset(){let e=0;return e+=this.floatStartOffset,e+=this.listMarkerOffset,e+=this.textAlignOffset,e}get restMeasure(){return this.parent?Math.min(this.parent.restMeasure,this.maxMeasure)-this.cursorPos.start:this.maxMeasure-this.textStartPos}get rootMeasure(){if(this.parent)return this.parent.rootMeasure;if(!this.env.measure)throw new Error("root measure is not defined!");return this.env.measure}get rootExtent(){if(this.parent)return this.parent.rootExtent;if(!this.env.extent)throw new Error("root extent is not defined!");return this.env.extent}get maxMeasure(){return null!==this.env.measure?this.env.measure:this.parent?this.parent.maxMeasure:this.rootMeasure}get maxExtent(){return null!==this.env.extent?this.env.extent:this.rootExtent}get contentBlockSize(){const e=this.maxMeasure,t=(this.env.extent||this.cursorPos.before)-this.contextBoxEdge.borderWidth.extent;return new Tt({measure:e,extent:t})}get autoContentBlockSize(){return new Tt({measure:this.maxMeasure,extent:this.cursorPos.before-this.contextBoxEdge.borderWidth.extent})}get contentInlineBlockSize(){const e=null!==this.env.measure?this.env.measure:Math.max(...this.blockNodes.map((e=>e.measure))),t=(null!==this.env.extent?this.env.extent:this.cursorPos.before)-this.contextBoxEdge.borderWidth.extent;return new Tt({measure:e,extent:t})}get autoContentInlineBlockSize(){const e=null!==this.env.measure?this.env.measure:Math.max(...this.blockNodes.map((e=>e.measure))),t=this.cursorPos.before-this.contextBoxEdge.borderWidth.extent;return new Tt({measure:e,extent:t})}get boxPos(){return{offsetPos:this.parent?this.parent.flowRootPos.translate({start:this.curChildStartMargin,before:this.contextBoxEdge.margin.getSize("before")}):this.cursorPos.cloneValue(),clientPos:{start:this.contextBoxEdge.borderBoxStartSize,before:this.contextBoxEdge.borderBoxBeforeSize}}}get localPos(){return new bt({start:this.cursorPos.start+this.curChildStartMargin+this.contextBoxEdge.borderBoxStartSize,before:this.cursorPos.before})}get flowRootPos(){return!this.parent||this.env.display.isFlowRoot()?this.localPos:this.parent.flowRootPos.translate(this.localPos)}get globalPos(){return this.parent?this.parent.globalPos.translate(this.localPos):this.localPos}get blockPos(){const e=this.parentBlock;return e?e.localPos:bt.zero}get lineHeadPos(){const e=this.cursorPos.before-this.contextBoxEdge.borderWidth.getSize("before");return new bt({start:0,before:e})}addBorderBoxEdge(e){if(this.contextBoxEdge.padding.addEdge(e),this.contextBoxEdge.borderWidth.addEdge(e),"before"===e||"after"===e){const t=this.cursorPos.before;this.cursorPos.before+=this.contextBoxEdge.padding.getSize(e),this.cursorPos.before+=this.contextBoxEdge.borderWidth.getSize(e),s.debugLayout&&console.log("[%s] addBorderBoxEdge(%s): %d -> %d",this.name,e,t,this.cursorPos.before)}}addInlineMarginEdge(e,t){this.contextBoxEdge.margin.addEdge(e),this.cursorPos.start+=t}addBlockMarginEdge(e,t){const i=this.cursorPos.before;this.contextBoxEdge.margin.addEdge(e),this.cursorPos.before+=t,s.debugLayout&&console.log("[%s] addBlockMarginEdge(%s): %d -> %d",this.name,e,i,this.cursorPos.before)}getBorderCollapseAfterSize(){const e=this.contextBoxEdge.borderWidth.getSize("after");if(e<=0)return 0;const t=this.blockNodes.find((e=>e instanceof ls));if(t instanceof ls)return Math.min(e,...t.children.map((e=>e instanceof os?e.border.width.after:0)));const i=this.blockNodes[this.blockNodes.length-1];return i instanceof os?Math.min(i.border.width.after,e):0}setFloat(e,t){this.flowRoot.addFloat(e,t,this.maxMeasure,this.flowRootPos)}addLine(e){s.ignoreEmptyLine&&0===e.children.length||this.pushBlockNode(e)}addBlock(e){this.pushBlockNode(e)}addBlockRe(e){s.ignoreZeroRe&&e.size.hasZero()||this.pushBlockNode(e)}addTable(e){this.pushBlockNode(e)}addTableRowGroup(e){this.env.borderCollapse.isCollapse()&&this.collapseBeforeStartBorder(e),this.pushBlockNode(e)}addTableRow(e){this.env.borderCollapse.isCollapse()&&this.collapseBeforeStartBorder(e),this.pushBlockNode(e)}addTableCells(e){if(this.env.borderCollapse.isCollapse()&&e.children.some((e=>e instanceof os&&e.border.width.before>0))){const t=e.children.map((e=>e instanceof os?e.border.width.before:0)),i=this.contextBoxEdge.borderWidth.getSize("before");if(Math.min(...t)>0&&i>0){const r=Math.min(i,...t);e.rowPos.before-=r,this.cursorPos.before-=r,s.debugLayout&&console.log("[%s] collapse before %d",this.name,r)}}this.pushBlockNode(e)}addBlockLink(e){this.pushBlockNode(e)}addInlineBlock(e){s.ignoreEmptyInline&&e.size.hasZero()&&0===e.children.length||this.pushInlineNode(e)}addInline(e){s.ignoreEmptyInline&&0===e.children.length||this.pushInlineNode(e)}addInlineRe(e){s.ignoreZeroRe&&e.size.hasZero()||this.pushInlineNode(e)}addInlineLink(e){const t=e.env.element.id;!t&&s.ignoreEmptyInline&&0===e.children.length||(t&&0===e.children.length&&(e.size.extent=0),this.pushInlineNode(e))}addListMarker(e){this.pushInlineNode(e,!1)}addText(e){0!==e.children.length&&this.pushInlineNode(e)}addRuby(e){this.pushInlineNode(e)}addAnchorElement(e,t){const i=this.pageRoot.getAnchor(e);i&&(i.box=t,i.pageIndex<0&&(i.pageIndex=this.pageRoot.pageCount))}pushInlineNode(e,t=!0){const i=this.cursorPos.start;this.inlineNodes.push(e),this.cursorPos.start+=e.measure,t&&(this.inlineText+=e.text),e.env.element.id&&this.addAnchorElement(e.env.element.id,e),s.debugLayout&&console.log("[%s] pushInlineNode:%o(%d -> %d)",this.name,e,i,this.cursorPos.start)}pushBlockNode(e){const t=this.cursorPos.before;switch(this.text+=e.text,this.progress=Math.min(1,this.progress+e.progress/this.env.element.childNodes.length),this.blockNodes.push(e),this.blockNodeHistory.push(e),e.env.position.isAbsolute()||(this.cursorPos.before+=e.extent),e.env.element.id&&this.addAnchorElement(e.env.element.id,e),e.env.element.tagName){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":const t=this.pageRoot.getHeaderSection(e.env.element);t&&t.pageIndex<0&&(t.pageIndex=this.pageRoot.pageCount)}s.debugLayout&&console.log("[%s] pushBlockNode:%o(%d -> %d)",this.name,e,t,this.cursorPos.before)}getBorderCollapseStartSize(e){return Math.min(this.contextBoxEdge.borderWidth.getSize("start"),e.border.width.start)}getBorderCollapseBeforeSize(e){const t=this.blockNodes[this.blockNodes.length-1];return t instanceof os?Math.min(t.border.width.after,e.border.width.before):Math.min(this.contextBoxEdge.borderWidth.getSize("before"),e.border.width.before)}collapseBeforeStartBorder(e){const t=this.getBorderCollapseStartSize(e),i=this.getBorderCollapseBeforeSize(e);e.layoutPos.start=-t,e.layoutPos.before-=this.contextBoxEdge.borderWidth.getSize("before")+i,this.cursorPos.before-=i}}class ps extends us{constructor(e,t){super(e,t),this.env=e,this.parent=t,this.floatNodes=[],this.pageCount=0,this.anchors={},this.outline=new dt}get flowRoot(){return this}getSectionAt(e){return this.outline.getSectionAt(e)}get boxPos(){return{offsetPos:{start:0,before:0},clientPos:{start:this.contextBoxEdge.borderBoxStartSize,before:this.contextBoxEdge.borderBoxBeforeSize}}}openElement(e){this.outline.openElement(e,this.pageCount)}closeElement(e){this.outline.closeElement(e)}createOutline(e){return this.outline.acceptEvaluator(e)}createElement(e,t,i){const s=document.createElement(e),r=i.env.element,n=r.tagName,o=i.env.element.id,a=this.getAnchor(o);switch(a&&!a.dom&&(a.dom=s),n){case"a":const e=r.getAttribute("href");e&&s.setAttribute("href",e);const t=r.getAttribute("name");t&&s.setAttribute("name",t)}return s.className=t.concat(n).map((e=>`nehan-${e}`)).concat(r.classList.values().map((e=>`nehan-e-${e}`))).join(" "),i.dom=s,s}createLogicalNodeEvaluator(){const e=new Xi(this.env.writingMode);switch(this.env.writingMode.value){case"horizontal-tb":return new Qi(this,e,Ji.instance);case"vertical-rl":case"vertical-lr":return new es(this,e,Ji.instance);default:throw new Error(`undefined writing mode: ${this.env.writingMode.value}`)}}setAnchor(e,t){this.anchors[e]=t}getAnchor(e){return this.anchors[e]}getHeaderSection(e){return this.outline.getHeaderSection(e)}clearFloat(e){if(!this.floatRegion)throw new Error("float region is not defined");if(e.isStart())return this.floatRegion.clearStart();if(e.isEnd())return this.floatRegion.clearEnd();if(e.isBoth())return this.floatRegion.clearBoth();throw new Error("clear direction is not defined")}addFloat(e,t,i,r){if(t.isNone())console.error("float direction is not set! ignored.");else{if(!this.floatRegion){const e=new Tt({measure:this.maxMeasure,extent:this.maxExtent});this.floatRegion=new Zi(e,r.before)}try{s.debugLayout&&console.log("addFloat(%o, %o, ctxM:%d, flowRootPos:%o)",e,t,i,r);const n=new Tt({measure:e.size.measure+e.env.edge.measure,extent:e.size.extent+e.env.edge.extent}),o=t.isStart()?this.floatRegion.pushStart(r.before,n,i):this.floatRegion.pushEnd(r.before,n,i),a=t.isStart()?r.start:o.start+e.env.edge.start;e.layoutPos=new bt({start:a,before:o.before}),this.floatNodes.push(e),s.debugLayout&&(console.log("added float. rect:%o, pos:%o",o,e.layoutPos),console.log("spaceMeasure at %d = %d",e.layoutPos.before,this.floatRegion.getSpaceMeasureAt(e.layoutPos.before)))}catch(e){console.error(e)}}}}class gs extends ps{}class ms extends us{addLine(e){0===this.totalLineCount&&this.parent&&(this.env=this.parent.env),super.addLine(e)}}class fs{constructor(){}hyphenate(e){const t=e.lexer,i=this.getHyphenateCount(t);if(i<0){const s=-i;if(s>=e.characters.length)return 0;e.characters=e.characters.slice(0,-s),e.text=e.characters.reduce(((e,t)=>e+t.text),""),t.pushBack(s)}else if(i>0)for(let s=0;s<i;s++)e.addCharacter(t.getNext());return i}getHyphenateCount(e){const t=e.peek(-1),i=e.peek(0),s=e.peek(1);if(i instanceof x&&i.isHeadNg()&&i.isHangEnable()){if(null===s||s instanceof x==0)return 1;if(s&&s instanceof x&&!1===s.isHeadNg())return 1;if(t&&t instanceof x==0)return-1;if(t&&t instanceof x&&!1===t.isHeadNg())return-1}if(t instanceof x&&t.isTailNg()){let t=-1;for(;;){let i=e.peek(t-1);if(!i)break;if(i&&i instanceof x==0)break;if(i&&i instanceof x&&!1===i.isTailNg())break;t--}return t}return 0}}fs.instance=new fs;class xs{constructor(){}set(e,t){return!(!t.isKernEnable()||t.isOpenParen()&&e.isCloseParen()||t.isCloseParen()&&e.isOpenParen()||t.isOpenParen()&&!e.isParen()||!e.isKernEnable()||(e.kerning=!0,0))}}xs.instance=new xs;class bs{constructor(e,t){this.lexer=e,this.parent=t,this.name="(text)",this.progress=1,this.cursorPos=bt.zero,this.characters=[],this.text=""}get env(){return this.parent.env}get boxPos(){return{offsetPos:this.parent.flowRootPos,clientPos:{start:0,before:0}}}get globalPos(){return this.parent.globalPos.translate(this.cursorPos)}get flowRootPos(){return this.parent.flowRootPos.translate(this.cursorPos)}get localPos(){return this.parent.localPos.translate(this.cursorPos)}get lineHeadPos(){return this.parent.lineHeadPos}get pageRoot(){return this.parent.pageRoot}get flowRoot(){return this.parent.flowRoot}get inlineRoot(){return this.parent.inlineRoot}isLineHead(){if(this.cursorPos.start>0)return!1;let e=this.parent;for(;e;){if(e.env.display.isBlockLevel()||e.env.display.isFlowRoot())return 0===e.inlineNodes.length;if(e.cursorPos.start>0)return!1;e=e.parent}throw new Error("inline root not found!")}get maxMeasure(){return this.parent.maxMeasure}get maxExtent(){return this.parent.maxExtent}get rootMeasure(){return this.parent.rootMeasure}get rootExtent(){return this.parent.rootExtent}get contextRestMeasure(){return this.parent.contextRestMeasure}get restMeasure(){return this.parent.contextRestMeasure-this.cursorPos.start}get restExtent(){return this.parent.restExtent-this.cursorPos.before}addCharacter(e){this.characters.push(e),this.cursorPos.start+=e.size.measure,this.text+=e.text}acceptLayoutReducer(e,t){return e.visit(this,t)}}class ys extends us{get restMeasure(){return 1/0}get restExtent(){return 1/0}}class vs{constructor(e,t){this.env=e,this.parent=t,this.cursorPos=bt.zero,this.rubyGroups=[],this.progress=1}acceptLayoutReducer(e,t){return e.visit(this,t)}get boxPos(){return{offsetPos:this.parent.flowRootPos,clientPos:{start:0,before:0}}}get globalPos(){return this.parent.globalPos.translate(this.cursorPos)}get flowRootPos(){return this.parent.flowRootPos.translate(this.cursorPos)}get localPos(){return this.parent.localPos.translate(this.cursorPos)}get lineHeadPos(){return this.parent.lineHeadPos}get pageRoot(){return this.parent.pageRoot}get flowRoot(){return this.parent.flowRoot}get inlineRoot(){return this.parent.inlineRoot}get contextRestMeasure(){return this.parent.contextRestMeasure}get restMeasure(){return this.parent.contextRestMeasure-this.cursorPos.start}get restExtent(){return this.parent.restExtent-this.cursorPos.before}get maxMeasure(){return this.parent.maxMeasure}get maxExtent(){return this.parent.maxExtent}get rootMeasure(){return this.parent.rootMeasure}get rootExtent(){return this.parent.rootExtent}addRubyBase(e){this.rb=e,this.groupRuby()}addRubyText(e){this.rt=e,this.groupRuby()}groupRuby(){this.rb&&this.rt&&(this.rubyGroups.push({rb:this.rb,rt:this.rt}),this.rb=this.rt=void 0)}}class Es extends us{constructor(e,t,i){super(t,i),this.elements=e,this.env=t,this.parent=i,this.cells=[]}acceptLayoutReducer(e){return e.visit(this)}setCells(e){this.cells=e;const t=this.env.borderCollapse.isCollapse(),i=e.reduce(((e,t)=>e.size.extent>t.size.extent?e:t),e[0]),s=i.size.extent,r=Math.max(...e.map((e=>e.extent)));let n=0;this.cells.forEach(((e,o)=>{if(e.size.extent=s,e.size.extent+=r-e.extent,e.layoutPos.start=n,n+=e.measure,e.autoSize.extent!==i.extent&&0===i.border.afterWidth&&e.border.clearAfter(),t){const t=0===o?this.env.edge.border.width.start:this.cells[o-1].border.width.end,i=Math.min(t,e.border.width.start);e.layoutPos.start-=i,n-=i}const a=e.size.extent-e.autoSize.extent,l=e.env.verticalAlign.value;if(a>0&&("middle"===l||"after"===l)){const t="middle"===l?Math.floor(a/2):a;e.children.forEach((e=>{e instanceof ss?e.linePos.before+=t:(e instanceof os||e instanceof cs)&&(e.layoutPos.before+=t)}))}}))}}class Ss extends us{get maxMeasure(){return this.parent?this.parent.maxMeasure:super.maxMeasure}get maxExtent(){return this.parent?this.parent.maxExtent:super.maxExtent}}class ws{constructor(){}resize(e,t,i){return t.resize(i)}}ws.instance=new ws;class Cs{constructor(){}resize(e,t,i){return t}}Cs.instance=new Cs;class ks{constructor(){}visit(e,t=!1){const i=e.cursorPos.start,s=e.env.font.size,r=new Tt({measure:i,extent:s}),n=e.text,o=e.characters,a=!e.lexer.hasNext()&&t,l=new is(e.env,e.boxPos,r,n,a,o);return e.characters=[],e.text="",t&&(e.cursorPos.start=0),ds.logicalNode("text",l)}}ks.instance=new ks;class Bs{constructor(e){this.type=e}visit(e,t){const i=e.cursorPos.start,s=Math.max(e.env.font.size,...e.inlineNodes.map((e=>e.extent))),r=e.inlineNodes,n=e.inlineText,o=new Tt({measure:i,extent:s}),a=e.contextBoxEdge.currentMarginBoxEdge,l=new ns(e.env,e.boxPos,o,n,a,r);return e.contextBoxEdge.clear(),e.inlineNodes=[],e.inlineText="",t&&(e.cursorPos.start=0),ds.logicalNode(this.type,l)}}Bs.instance=new Bs("inline");class Rs{constructor(){}visit(e,t){const i=t.rb,s=t.rt,r=Math.max(i.size.measure,s.size.measure),n=i.size.extent+s.size.extent,o=new Tt({measure:r,extent:n}),a=i.text,l=new rs(e.env,e.boxPos,o,a,i,s);return ds.logicalNode("ruby",l)}}Rs.instance=new Rs;class Ls extends Bs{}Ls.instance=new Ls("ruby-base");class Ts extends Bs{}Ts.instance=new Ts("ruby-text");class Ps extends Bs{}Ps.instance=new Ps("list-marker");class Ns{constructor(){}isDecoratedText(e){return!e.env.textEmphasis.isNone()||e instanceof rs}getDecoratedExtent(e){return e.env.textEmphasis.isNone()?e instanceof rs?e.extent:0:2*e.env.font.size}isReChild(e){return e instanceof hs||e instanceof ns&&e.children.some((e=>this.isReChild(e)))}isEmptyLine(e,t){return 0===e.length||""===e[0].text.trim()&&""===t.trim()}visit(e,t=!1){const i=e.lineHeadPos,s=e.env.display.isInlineBlockFlow()?e.cursorPos.start:e.maxMeasure,r=e.inlineNodes,n=r.filter((e=>this.isReChild(e))),o=r.filter((e=>e instanceof as)),a=r.filter((e=>this.isDecoratedText(e))),l=r.reduce(((e,t)=>t.env.font.size>e.size?t.env.font:e),e.env.font),c=Math.min(...r.map((e=>e.extent))),h=Math.max(...a.map((e=>this.getDecoratedExtent(e)))),d=Math.max(...n.map((e=>e.extent))),u=Math.max(...o.map((e=>e.extent))),p=Math.max(d,u),g=Math.max(l.size,h,p),m=l.lineExtent,f=Math.max(m,...r.map((e=>e.extent))),x=Math.max(m,f),b=Math.max(l.size,p),y=m-l.size,v=r.length===o.length+n.length;let E=x===p&&e.restExtent>=y?x+y:x;E=Math.min(E,e.rootExtent);const S=new Tt({measure:s,extent:E}),w=e.inlineText,C=Math.floor(y/2),k={size:new Tt({measure:s,extent:g}),textBodySize:new Tt({measure:e.cursorPos.start,extent:b}),startOffset:e.lineBoxStartOffset,blockOffset:C},B=k.startOffset+e.cursorPos.start,R=new Tt({measure:B,extent:E});if(0===r.length||c<e.env.font.size&&v){const t=v&&r.length>0?c:e.env.font.size;S.extent=R.extent=k.size.extent=k.textBodySize.extent=t,k.blockOffset=0}const L=new ss(e.env,e.boxPos,i,S,R,w,r,k);return!t&&this.isEmptyLine(r,w)&&(L.size.extent=k.size.extent=0),e.cursorPos.start=0,e.inlineNodes=[],e.inlineText="",ds.logicalNode("line",L)}}Ns.instance=new Ns;class zs{constructor(e){this.type=e}visit(e){const t=e.blockPos,i=e.contentBlockSize,s=e.autoContentBlockSize,r=e.contextBoxEdge.currentBorder,n=e.text,o=e.blockNodes;e.env.borderCollapse.isCollapse()&&(i.extent-=e.getBorderCollapseAfterSize());const a=new os(e.env,e.boxPos,t,i,s,n,r,o,e.progress);return e.text="",e.blockNodes=[],e.cursorPos=bt.zero,e.contextBoxEdge.clearBlock(),ds.logicalNode(this.type,a)}}zs.instance=new zs("block");class Ms{constructor(e){this.type=e}visit(e){const t=e.blockPos,i=e.contentBlockSize,s=e.autoContentBlockSize;if(e.floatRegion){const t=e.floatRegion.maxRegionExtent;i.extent=Math.max(i.extent,t),s.extent=Math.max(s.extent,t)}const r=e.contextBoxEdge.currentBorder,n=e.text,o=e.floatNodes?e.blockNodes.concat(e.floatNodes):e.blockNodes,a=new os(e.env,e.boxPos,t,i,s,n,r,o,e.progress);return e.text="",e.blockNodes=[],e.floatNodes=[],e.cursorPos=bt.zero,e.contextBoxEdge.clearBlock(),e.floatRegion&&(delete e.floatRegion,e.floatRegion=void 0),e.pageCount++,ds.logicalNode(this.type,a)}}Ms.instance=new Ms("block");class Is{visit(e){const t=e.blockPos,i=e.contentInlineBlockSize;e.floatRegion&&(i.extent=Math.max(i.extent,e.floatRegion.maxRegionExtent));const s=e.autoContentInlineBlockSize,r=e.contextBoxEdge.currentBorder,n=e.env.edge.clone();n.border=r;const o=e.text,a=e.floatNodes?e.blockNodes.concat(e.floatNodes):e.blockNodes,l=new as(e.env,e.boxPos,t,i,s,o,n,a);return e.text="",e.blockNodes=[],e.floatNodes=[],e.cursorPos=bt.zero,e.contextBoxEdge.clearBlock(),e.floatRegion&&(delete e.floatRegion,e.floatRegion=void 0),ds.logicalNode("inline-block",l)}}Is.instance=new Is;class As extends Ms{}As.instance=new As("table-cell");class Vs{constructor(){}visit(e){const t=e.maxMeasure,i=Math.max(...e.cells.map((e=>e.extent))),s=new Tt({measure:t,extent:i}),r=bt.zero,n=e.cells.reduce(((e,t)=>e+t.text),""),o=new ls(e.env,e.boxPos,s,r,n,e.cells);return e.contextBoxEdge.clearBlock(),e.cursorPos=bt.zero,ds.logicalNode("table-cells",o)}}Vs.instance=new Vs;class Fs extends zs{}Fs.instance=new Fs("table");class Os extends zs{}Os.instance=new Os("table-row-group");class Us extends zs{}Us.instance=new Us("table-row");class Ds extends zs{}Ds.instance=new zs("block-link");class $s extends Bs{}$s.instance=new Bs("inline-link");class Ws{constructor(){}visitBlock(e,t,i){const s=e.env.edge,r=e.parent?e.parent.localPos:bt.zero,n=`(${e.env.element.tagName})`,o=new cs(e.env,e.boxPos,t,i,s,r,n);return ds.logicalNode("re-block",o)}visitInline(e,t,i){const s=e.env.edge,r=`(${e.env.element.tagName})`,n=new hs(e.env,e.boxPos,t,i,s,r);return ds.logicalNode("re-inline",n)}visit(e,t,i){return e.env.display.isBlockLevel()?this.visitBlock(e,t,i):this.visitInline(e,t,i)}}Ws.instance=new Ws;class Hs{static createRoot(e){const t=new W(e),i=new gs(t);return new Xs(i,Ms.instance)}static createTextLexer(e,t){const i=t.whiteSpace.isPre(),s=e.textContent||e.computedStyle.getPropertyValue("content")||"",r=t.textCombineUpright.isNone()?new De(s,{isPre:i}):new $e(s);return t.textOrientation.isUpright()?r.acceptTokenMapper(new F):r.hasWord()&&r.acceptTokenMapper(new O),r}static createChild(e,t){if(e.isTextElement()){const i=this.createTextLexer(e,t.env),s=e.nextSibling;return{generator:new qs(new bs(i,t)),nextElement:s}}s.debugLayout&&console.log("createChild, element: %o, parentContext: %o",e,t),de.loadDynamic(e,t);const i=new W(e),r=i.display;if(r.isNone())return{generator:new Ys(new us(i,t),ds.skip(t,"display:none")),nextElement:e.nextSibling};if(e.id){const i=t.flowRoot,s={name:e.id,element:e,pageIndex:-1};i.setAnchor(e.id,s)}if(Ht.isReplacedElement(e))return{generator:new Zs(new Ss(i,t),Ws.instance,ws.instance),nextElement:e.nextSibling};if(e.$dom)return{generator:new Zs(new Ss(i,t),Ws.instance,Cs.instance),nextElement:e.nextSibling};if("a"===e.tagName){const s=new us(i,t);return{generator:r.isInlineLevel()?new js(s,$s.instance):new Xs(s,Ds.instance),nextElement:e.nextSibling}}if("br"===e.tagName)return{generator:new Ks(new us(i,t)),nextElement:e.nextSibling};if(r.isFlowRuby())return i.element.acceptEffector(ye.instance),{generator:new Gs(new vs(i,t)),nextElement:e.nextSibling};if(r.isRubyBase())return{generator:new js(new ys(i,t),Ls.instance),nextElement:e.nextSibling};if(r.isRubyText())return{generator:new js(new ys(i,t),Ts.instance),nextElement:e.nextSibling};if(e.tagName===Dt.FIRST_LINE)return{generator:new Xs(new ms(i,t)),nextElement:e.nextSibling};if(e.tagName===Dt.MARKER)return{generator:new js(new us(i,t),Ps.instance),nextElement:e.nextSibling};if(r.isTableCell()&&e.parent){e.acceptEffector(be.instance);const i=e.parent.children.filter((e=>Ze.load(e).isTableCell()));return{generator:new _s(new Es(i,t.env,t)),nextElement:i[i.length-1].nextSibling}}return r.isTable()?{generator:new Xs(new us(i,t),Fs.instance),nextElement:e.nextSibling}:r.isTableRowGroup()?(e.acceptEffector(fe.instance),{generator:new Xs(new us(i,t),Os.instance),nextElement:e.nextElementSibling}):r.isTableRow()?(e.acceptEffector(xe.instance),{generator:new Xs(new us(i,t),Us.instance),nextElement:e.nextElementSibling}):r.isInlineBlockFlow()?{generator:new Xs(new ps(i,t),Is.instance),nextElement:e.nextSibling}:r.isInlineLevel()?{generator:new js(new us(i,t)),nextElement:e.nextSibling}:r.isFlowRoot()?{generator:new Xs(new ps(i,t)),nextElement:e.nextSibling}:(r.isListItem()&&e.acceptEffector(me.instance),{generator:new Xs(new us(i,t)),nextElement:e.nextSibling})}}class _s{constructor(e,t=Vs.instance){this.context=e,this.reducer=t,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){s.debugLayout&&console.group(`table-cells: ${this.context.name}`);const e=this.context.elements.map((e=>{de.loadDynamic(e,this),e.acceptEffectorAll(ke.instance);const t=new W(e);return new Xs(new ps(t,this.context),As.instance)}));let t=0;for(;;){const i=e.map((e=>e.getNext()));if(i.every((e=>void 0===e)))break;if(0===t&&i.some((e=>e&&"page-break"===e.type)))yield ds.pageBreak(this.context,"some table-cell has page-break, propagate to parent");else{if(t%2==0){const s=i.map(((i,s)=>{if(i&&"table-cell"===i.type)return i.body;const r=e[s].context;return r.addBorderBoxEdge("start"),r.addBorderBoxEdge("end"),0===t&&r.addBorderBoxEdge("before"),t>=2&&r.addBorderBoxEdge("after"),r.acceptLayoutReducer(As.instance).body}));this.context.setCells(s)}else yield this.context.acceptLayoutReducer(this.reducer),yield ds.pageBreak(this.context,"table devided.");t++}}yield this.context.acceptLayoutReducer(this.reducer),s.debugLayout&&console.groupEnd()}}class Gs{constructor(e,t=Rs.instance){this.context=e,this.reducer=t,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){s.debugLayout&&console.group("ruby");let e=this.context.env.element.firstChild;for(;null!==e;){const t=Hs.createChild(e,this.context);for(this.context.child=t.generator;;){const e=this.context.child.getNext();if(!e)break;switch(e.type){case"ruby-base":this.context.addRubyBase(e.body);break;case"ruby-text":this.context.addRubyText(e.body)}}e=t.nextElement}for(let e of this.context.rubyGroups){const t=this.context.acceptLayoutReducer(this.reducer,e),i=t.body,s=i.lineExtent;if(i.size.measure>this.context.maxMeasure)console.warn("too large ruby, can't be included, ignored:%o(maxM=%d)",t,this.context.maxMeasure);else{for(;this.context.restExtent<s;)yield ds.pageBreak(this.context,`restExtent is not enough for rubyNode.lineExtent(${s})`);for(;this.context.restMeasure<i.measure;)yield ds.lineBreak(this.context,"restMeasure is not enough for rubyNode.measure");for(;this.context.restExtent<s;)yield ds.pageBreak(this.context,`restExtent is not enough for rubyNode.lineExtent(${s}) even after pageBreak`);yield t}}s.debugLayout&&console.groupEnd()}}class qs{constructor(e,t=ks.instance,i=fs.instance,s=xs.instance){this.context=e,this.reducer=t,this.hyphenator=i,this.kerning=s,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){const e=this.context.lexer;for(;this.context.lexer.hasNext();){const t=this.context.env.font,i=t.lineExtent,r=this.context.env.textEmphasis.isNone()?void 0:this.context.env.textEmphasis.textEmphaData,n=this.context.env.whiteSpace.isPre(),o={font:t,isVertical:this.context.env.writingMode.isTextVertical(),empha:r},a=this.context.isLineHead();if(this.context.restExtent<i&&(yield ds.pageBreak(this.context,"lineExtent is not enough for text-fmt-context")),a&&this.context.restMeasure<t.size){if(!this.context.inlineRoot.env.display.isInlineBlockFlow()){const e=`too narrow space: restM:${this.context.restMeasure}, start:${this.context.inlineRoot.cursorPos.start}`;yield ds.skip(this.context,e);break}yield ds.iblockInlineBreak(this.context,"iblock starts from too narrow space")}const l=e.getNext();if(s.debugCharacter&&console.log("restM:%d, token:%o",this.context.restMeasure,l),n&&"\n"===l.text)yield this.context.acceptLayoutReducer(this.reducer,!1),yield ds.lineBreak(this.context,"CRLF in white-space:pre");else{if((0===l.size.measure||l instanceof A)&&l.setMetrics(o),l instanceof x&&l.isKernEnable()){const t=e.peek(-2);t instanceof x&&this.kerning.set(l,t)&&l.setMetrics(o)}if(this.context.restMeasure<l.size.measure)if(l instanceof A)a&&this.context.env.overflowWrap.isBreakWord()||this.context.env.wordBreak.isBreakAll()?(e.pushBack(1),this.context.addCharacter(l.breakWord(this.context.restMeasure))):a?this.context.addCharacter(l):(e.pushBack(1),this.hyphenator.hyphenate(this.context)),yield this.context.acceptLayoutReducer(this.reducer,!0),yield ds.lineBreak(this.context,"long word is broken by word-break: break-all");else if(l instanceof L){const t=e.peek(-2),i=e.peek(0);t instanceof A&&i instanceof A||e.pushBack(1),this.hyphenator.hyphenate(this.context),yield this.context.acceptLayoutReducer(this.reducer,!0),yield ds.lineBreak(this.context,"char token overflows measure(by spaceChar)")}else e.pushBack(1),this.hyphenator.hyphenate(this.context),this.context.characters.length>0&&(yield this.context.acceptLayoutReducer(this.reducer,!0)),yield ds.lineBreak(this.context,"char token overflows measure");else this.context.addCharacter(l)}}this.context.characters.length>0&&(yield this.context.acceptLayoutReducer(this.reducer,!1))}}class js{constructor(e,t=Bs.instance){this.context=e,this.reducer=t,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){let e;if(s.debugLayout&&console.group(`inline: ${this.context.name}`),this.context.rootExtent<this.context.contextBoxEdge.borderBoxExtent||this.context.rootMeasure<this.context.contextBoxEdge.borderBoxMeasure)return void(yield ds.skip(this.context,"Too large edge size: this layout can't be included!"));this.context.restExtent<this.context.contextBoxEdge.borderBoxExtent&&(yield ds.pageBreak(this.context,"inline rest extent not enough for border size")),this.context.addBorderBoxEdge("before"),this.context.addBorderBoxEdge("after");const t=this.context.contextBoxEdge.getBorderBoxEdgeSize("start");this.context.restMeasure<t&&(yield ds.lineBreak(this.context,"Start edge is not enough for restMeasure")),this.context.addBorderBoxEdge("start");let i=this.context.env.element.firstChild;for(;null!==i;){const t=Gi.getMarginFromLastInline(i);t>0&&this.context.restMeasure>t&&this.context.addInlineMarginEdge("start",t);const s=Hs.createChild(i,this.context);this.context.child=s.generator,this.context.child.context.env.display.isBlockLevel()&&(this.context.inlineNodes.length>0&&(yield this.context.acceptLayoutReducer(this.reducer,!0),yield ds.lineBreak(this.context,"sweep out inlines for next block(inside inline)")),this.context.parentBlock&&this.context.parentBlock.localPos.start>0&&(yield ds.lineBreak(this.context,"line break from inner inline")));const r=qi.getFlowMarginFromLastElement(this.context.env,this.context.child,e),n=this.context.parentBlock;for(n&&r>0&&(n.restExtent<r&&(yield ds.pageBreak(this.context,`block-fmt-context: before-margin(${r}) is not enough.`)),n instanceof us&&n.addBlockMarginEdge("before",r));;){const e=this.context.child.getNext();if(!e)break;if("skip"===e.type)break;if("line-break"===e.type)yield this.context.acceptLayoutReducer(this.reducer,!0),yield e;else if("iblock-inline-break"==e.type)this.context.inlineNodes.length>0?(yield this.context.acceptLayoutReducer(this.reducer,!0),yield ds.lineBreak(this.context,"inline: iblock-inline-break -> line-break")):yield e;else if("page-break"===e.type)this.context.inlineNodes.length>0?(yield this.context.acceptLayoutReducer(this.reducer,!0),yield e):yield e;else if("inline"===e.type)this.context.addInline(e.body);else if("text"===e.type){const t=e.body;t.skipBr&&s.nextElement&&"br"===s.nextElement.tagName&&(s.nextElement=s.nextElement.nextSibling),this.context.addText(t)}else"ruby"===e.type?this.context.addRuby(e.body):"inline-link"===e.type?this.context.addInlineLink(e.body):"re-inline"===e.type?this.context.addInlineRe(e.body):"inline-block"===e.type?this.context.addInlineBlock(e.body):e.isBlockLevel()&&(yield e)}e=s.generator,i=s.nextElement}this.context.contextBoxEdge.getBorderBoxEdgeSize("end")<this.context.restMeasure&&this.context.addBorderBoxEdge("end");const r=this.context.contextBoxEdge.margin.getSize("end");r<this.context.restMeasure&&this.context.addInlineMarginEdge("end",r),yield this.context.acceptLayoutReducer(this.reducer,!1),s.debugLayout&&console.groupEnd()}}class Ks extends js{*createGenerator(){for(;this.context.restExtent<this.context.env.font.lineExtent;)yield ds.pageBreak(this.context,"line break, lineExtent not enough");yield ds.lineBreak(this.context,"<br>")}}class Ys extends js{constructor(e,t){super(e),this.value=t}*createGenerator(){yield this.value}}class Zs{constructor(e,t=Ws.instance,i=ws.instance){this.context=e,this.reducer=t,this.resizer=i,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){s.debugLayout&&console.group(`${this.context.name}`);const e=this.context.env.writingMode,t=new Tt({measure:this.context.maxMeasure-this.context.env.edge.measure,extent:this.context.maxExtent-this.context.env.edge.extent});let i=Vt.load(this.context.env.element),r=i.getLogicalSize(e);(r.extent>t.extent||r.measure>t.measure)&&(r=this.resizer.resize(this.context,r,t),i=r.getPhysicalSize(e)),this.context.restExtent<r.extent&&(yield ds.pageBreak(this.context,"re extent is not enough for restExtent")),this.context.env.display.isInlineLevel()&&this.context.restMeasure<r.measure&&(yield ds.lineBreak(this.context,"restMeasure is not enough for inline re")),this.context.restExtent<r.extent&&(yield ds.pageBreak(this.context,"re extent is not enough for restExtent"));const n=this.context.restMeasure;yield this.context.acceptLayoutReducer(this.reducer,r,i),this.context.env.display.isInlineLevel()&&n===r.measure&&(yield ds.lineBreak(this.context,"restMeasure is just filled by measure of re(inline)")),s.debugLayout&&console.groupEnd()}}class Xs{constructor(e,t=zs.instance,i=Ns.instance){this.context=e,this.blockReducer=t,this.lineReducer=i,this.generator=this.createGenerator()}getNext(){const e=this.generator.next();return e.done?void 0:e.value}*createGenerator(){s.debugLayout&&console.group(`block: ${this.context.name}`),this.context.flowRoot.openElement(this.context.env.element);const e=1/this.context.env.element.childNodes.length,t=this.context instanceof gs;let i;if(this.context.env.pageBreakBefore.isAlways()&&(yield ds.pageBreak(this.context,"block-fmt-context: page-break-before")),this.context.env.measure&&this.context.env.measure<=0)return void(yield ds.skip(this.context,"Minus size measure"));!t&&this.context.restExtent<this.context.env.edge.borderBoxBefore&&(yield ds.pageBreak(this.context,"block-fmt-context: before border can't be included")),this.context.addBorderBoxEdge("before"),this.context.addBorderBoxEdge("start"),this.context.addBorderBoxEdge("end");let r=this.context.env.element.firstChild;for(;null!==r;){const n=Ze.load(r),o=ni.load(r);if(n.isNone()||!o.isPre()&&ni.isWhiteSpaceElement(r)){r=r.nextSibling;continue}const a=yt.load(r);if((!a.isNone()||n.isBlockLevel())&&this.context.inlineNodes.length>0){const e=this.context.acceptLayoutReducer(this.lineReducer);this.context.addLine(e.body)}this.context.curChildStartMargin=Gi.getMarginFromParentBlock(r);const l=Hs.createChild(r,this.context);this.context.child=l.generator;const c=xt.load(r);if(!c.isNone()&&this.context.flowRoot.floatRegion){const e=this.context.flowRoot.clearFloat(c);s.debugLayout&&console.log("float clearance:%d (cur before = %d)",e,this.context.cursorPos.before),this.context.cursorPos.before=Math.max(this.context.cursorPos.before,e)}const h=qi.getFlowMarginFromLastElement(this.context.env,this.context.child,i);for(this.context.restExtent<h&&(yield this.context.acceptLayoutReducer(this.blockReducer),t||(yield ds.pageBreak(this.context,`block-fmt-context: before-margin(${h}) overflow.`))),h>0&&this.context.addBlockMarginEdge("before",h);;){this.context.suspendedGens=this.context.suspendedGens.filter((e=>{const t=e.getNext();if(!t)return!1;if("block"===t.type){const i=e.context.env.float;this.context.setFloat(t.body,i)}return!0}));const e=this.context.child.getNext();if(!e)break;if(!a.isNone()&&e.isFloatable()){this.context.setFloat(e.body,a),this.context.suspendedGens.push(this.context.child);break}if("skip"===e.type)break;if("line-break"===e.type){const t="br"===e.body.env.element.tagName,i=this.context.acceptLayoutReducer(this.lineReducer,t);this.context.addLine(i.body)}else if("iblock-inline-break"===e.type)if(this.context.env.display.isInlineBlockFlow()){const t=this.context.acceptLayoutReducer(this.lineReducer,!1);t.body.size.hasZero()?yield e:this.context.addLine(t.body)}else{const e=this.context.acceptLayoutReducer(this.lineReducer,!1);this.context.addLine(e.body)}else if("page-break"===e.type){if(this.context.inlineNodes.length>0){const e=this.context.acceptLayoutReducer(this.lineReducer,!1);this.context.addLine(e.body)}const i=this.context.acceptLayoutReducer(this.blockReducer);t?""!==i.body.text.trim()&&(yield i):(yield i,yield e)}else if("block"===e.type)this.context.addBlock(e.body);else if("inline-block"===e.type)this.context.addInlineBlock(e.body);else if("table"===e.type)this.context.addTable(e.body);else if("table-row-group"===e.type)this.context.addTableRowGroup(e.body);else if("table-row"===e.type)this.context.addTableRow(e.body);else if("table-cells"===e.type)this.context.addTableCells(e.body);else if("inline"===e.type)this.context.addInline(e.body);else if("list-marker"===e.type)this.context.addListMarker(e.body);else if("text"===e.type){const t=e.body;t.skipBr&&l.nextElement&&"br"===l.nextElement.tagName&&(l.nextElement=l.nextElement.nextSibling),this.context.addText(t)}else"ruby"===e.type?this.context.addRuby(e.body):"re-block"===e.type?this.context.addBlockRe(e.body):"re-inline"===e.type?this.context.addInlineRe(e.body):"inline-link"===e.type?this.context.addInlineLink(e.body):"block-link"===e.type&&this.context.addBlockLink(e.body)}this.context.progress=(r.index+1)*e,i=l.generator,r=l.nextElement}if(this.context.inlineNodes.length>0){const e=this.context.acceptLayoutReducer(this.lineReducer,!1);this.context.addLine(e.body)}!t&&this.context.restExtent<this.context.contextBoxEdge.getBorderBoxEdgeSize("after")&&(yield ds.pageBreak(this.context,"block-fmt-context: after border can't be included")),this.context.addBorderBoxEdge("after");const n=this.context.contextBoxEdge.margin.getSize("after");!this.context.env.float.isNone()&&this.context.restExtent>=n&&this.context.addBlockMarginEdge("after",n),this.context.flowRoot.closeElement(this.context.env.element),yield this.context.acceptLayoutReducer(this.blockReducer),!t&&this.context.env.pageBreakAfter.isAlways()&&(yield ds.pageBreak(this.context,"block-fmt-context: page-break-after")),s.debugLayout&&console.groupEnd()}}class Js extends pe{constructor(e,t={styleSheets:[]}){super(e,t),this.generator=t.generator||Hs.createRoot(this.body),this.evaluator=t.evaluator||this.generator.context.pageRoot.createLogicalNodeEvaluator(),this.effector=new ts(this.generator.context.pageRoot),this.pages=[],this.timestamp=0}addPageNode(e){const t=this.pages.length,i=0===t?this.evalNode(e,!0):void 0,s=this.pages[t-1],r=e.progress,n=e.text.length,o={node:e,dom:i,index:t,progress:r,charCount:n,acmCharCount:s?s.acmCharCount+n:n};return this.pages.push(o),o}get pageCount(){return this.pages.length}getAnchor(e){return this.generator.context.pageRoot.getAnchor(e)}getAnchorPage(e){const t=this.getAnchor(e);if(!t)throw new Error(`anchor(${e}) is not found!`);return this.getPage(t.pageIndex)}evalNode(e,t=!0){const i=e.acceptEvaluator(this.evaluator);return t&&e.acceptEffector(this.effector),i}getPage(e){const t=this.pages[e];if(!t)throw new Error(`page ${e} is not found!`);return t.dom||(t.dom=this.evalNode(t.node,!0)),t}createOutline(e){const t=e||new xi;return this.generator.context.flowRoot.createOutline(t)}getSectionAt(e){return this.generator.context.flowRoot.getSectionAt(e)}render(e={}){const t=this.querySelectorAll("img").concat(this.querySelectorAll("video")),i=new Gt(t.length);return new qt(t,i).load(e).then((t=>{this.timestamp=performance.now(),this.renderAsync(e)})),this}renderAsync(e){return requestAnimationFrame((()=>{const t=this.generator.getNext();if(!t){const t=performance.now()-this.timestamp,i=this.pages.length;return void(e.onComplete&&e.onComplete({caller:this,time:t,pageCount:i}))}const i=t.getBodyAsBlockNode();if(i.children.some((e=>e.extent>0))){const t=this.addPageNode(i);e.onPage&&e.onPage({caller:this,page:t})}this.pages.length>s.maxPageCount?console.error("too many pages, abort."):this.renderAsync(e)})),this}}},4121:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getDeviceFontFamily=void 0;const i={windows:{normal:'"游明朝", "Yu Mincho", YuMincho, "ipa-mincho", "IPA明朝", "IPA Mincho", "ＭＳ 明朝", "MS Mincho", monospace',gothic:'"游ゴシック", "Yu Gothic", YuGothic, "Meiryo", "メイリオ"'},android:{normal:'"ipa-mincho", "IPA明朝", "IPA Mincho", monospace',gothic:'"游ゴシック", "Yu Gothic", YuGothic, "Osaka", "Meiryo", "メイリオ"'},mac:{normal:'"ヒラギノ明朝 Pro W3", "Hiragino Mincho Pro", "Hiragino Mincho ProN", "HiraMinProN - W3", monospace',gothic:'"Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W3", "Hiragino Sans", "Osaka", monospace'},ios:{normal:'"ヒラギノ明朝 Pro W3", "Hiragino Mincho Pro", "Hiragino Mincho ProN", "HiraMinProN - W3", monospace',gothic:'"Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W3", "Hiragino Sans", "Osaka", monospace'},chromeos:{normal:'"ipa-mincho", "IPA明朝", "IPA Mincho", "ＭＳ 明朝", "MS Mincho", monospace',gothic:'"游ゴシック", "Yu Gothic", YuGothic, "Osaka", "Meiryo", "メイリオ"'},others:{normal:'"ipa-mincho", "IPA明朝", "IPA Mincho", "ＭＳ 明朝", "MS Mincho", monospace',gothic:'"游ゴシック", "Yu Gothic", YuGothic, "Osaka", "Meiryo", "メイリオ"'}};t.getDeviceFontFamily=function(e){const t=(s=window.navigator.userAgent.toLowerCase()).indexOf("iphone")>=0||s.indexOf("ipod")>=0||s.indexOf("ipad")>=0?"ios":s.indexOf("windows")>=0?"windows":s.indexOf("android")>=0?"android":s.indexOf("macintosh")>=0?"mac":s.indexOf("cros")>=0?"chromeos":"others";var s;return i[t][e]}}},t={};function i(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,i),n.exports}i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=i(6773),t=i(7240),s=i(4121);window.addEventListener("load",(()=>{e.NehanPlayer.initialize({cssFiles:[],onCreateNehanStyles(e){let i=function(){const e=s.getDeviceFontFamily("gothic");return[1,2,3,4,5,6].reduce(((t,i)=>(t[`h${i}`]={fontFamily:e},t)),{})}();if(e.writingMode.indexOf("vertical")>=0){const e=s.getDeviceFontFamily("normal");i=Object.assign(Object.assign({},i),{body:{fontFamily:e}})}return[new t.CssStyleSheet(i)]},onFetchContent:(e,t)=>e.endsWith(".txt")?t.replace(/^\n*/,"").replace(/\n/g,"<br>"):t,onParseComplete(e,t,i){if("wikipedia"!==e.id)return;const s=e.createOutline((t=>{e.gotoPage(t.pageIndex)})),r=document.querySelector("#wikipedia-toc");r&&(r.innerHTML="",r.appendChild(s))},onSetPage(e,t){const i=e.currentSection;i.isRoot()||e.setSubTitle(`&gt; ${i.title}`)},onClickLeftPage(e){e.gotoLeftPage()},onClickRightPage(e){e.gotoRightPage()}})}))})()})();